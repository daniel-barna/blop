<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<link href="../default.css" type="text/css" rel="stylesheet">
<title> BLOP: graph_drawer.cc </title>
</head>
<body>

<a href="../index.html" title="Home"> 
<img src="../home.png"  style="border-width:0cm;"> 
</a>
<a href="source.html" title="List of sourcefiles"> 
<img src="../up.png"    style="border-width:0cm;"> 
</a>
 <hr>
<pre>
<a name="__line0"></a>#include "<a href="config.h.html">config.h</a>"
<a name="__line1"></a>#include "<a href="graph_drawer.h.html">graph_drawer.h</a>"
<a name="__line2"></a>#include "<a href="point_drawer.h.html">point_drawer.h</a>"
<a name="__line3"></a>#include "<a href="exc.hh.html">exc.hh</a>"
<a name="__line4"></a>#include "<a href="terminal.h.html">terminal.h</a>"
<a name="__line5"></a>#include "<a href="plottable.h.html">plottable.h</a>"
<a name="__line6"></a>#include "<a href="fgraph.h.html">fgraph.h</a>"
<a name="__line7"></a>#include "<a href="axis.h.html">axis.h</a>"
<a name="__line8"></a>#include "<a href="frame.h.html">frame.h</a>"
<a name="__line9"></a>#include "<a href="warning.h.html">warning.h</a>"
<a name="__line10"></a>#include "<a href="ignore.h.html">ignore.h</a>"
<a name="__line11"></a>#include "<a href="color_legend.h.html">color_legend.h</a>"
<a name="__line12"></a>#include "<a href="mframe.h.html">mframe.h</a>"
<a name="__line13"></a>#include "<a href="global.h.html">global.h</a>"
<a name="__line14"></a>#include "<a href="blop_gts.h.html">blop_gts.h</a>"
<a name="__line15"></a>#include &lt;iostream&gt;
<a name="__line16"></a>#include &lt;cstdio&gt;
<a name="__line17"></a>#include &lt;map&gt;
<a name="__line18"></a>#include &lt;limits&gt;
<a name="__line19"></a>#include &lt;stdlib.h&gt;
<a name="__line20"></a>
<a name="__line21"></a>using namespace std;
<a name="__line22"></a>
<a name="__line23"></a>namespace blop
<a name="__line24"></a>{
<a name="__line25"></a>    inline double sq(double a) { return a*a; }
<a name="__line26"></a>
<a name="__line27"></a>    double linear(double x,double x1,double y1,double x2,double y2)
<a name="__line28"></a>    {
<a name="__line29"></a>	return y1 + (y2-y1)/(x2-x1)*(x-x1);
<a name="__line30"></a>    }
<a name="__line31"></a>
<a name="__line32"></a><span class=comment>//    color color_mapping_function::the_color_;</span>
<a name="__line33"></a>
<a name="__line34"></a>    blop::color color_mapping_interpolated::map(double value, double mini, double maxi, bool logscale) const
<a name="__line35"></a>    {
<a name="__line36"></a>        if(value&lt;=mini) return colors_.front();
<a name="__line37"></a>        if(value&gt;=maxi) return colors_.back();
<a name="__line38"></a>        if(values_normalized_)
<a name="__line39"></a>        {
<a name="__line40"></a>            if(logscale)
<a name="__line41"></a>            {
<a name="__line42"></a>                value = std::log10(value);
<a name="__line43"></a>                mini = std::log10(mini);
<a name="__line44"></a>                maxi = std::log10(maxi);
<a name="__line45"></a>            }
<a name="__line46"></a>            
<a name="__line47"></a>            const double v = (value-mini)/(maxi-mini);
<a name="__line48"></a>            auto pos = lower_bound(values_.begin(), values_.end(), v);
<a name="__line49"></a>            unsigned int n = pos-values_.begin();
<a name="__line50"></a>            if(n&lt;1) n=1;
<a name="__line51"></a>            if(n&gt;values_.size()-1) n=values_.size()-1;
<a name="__line52"></a>            const blop::color c1 = colors_[n-1];
<a name="__line53"></a>            const blop::color c2 = colors_[n];
<a name="__line54"></a>            const double v1 = values_[n-1];
<a name="__line55"></a>            const double v2 = values_[n];
<a name="__line56"></a>            const double t = (v-v1)/(v2-v1);
<a name="__line57"></a>            return c1*(1-t)+c2*t;
<a name="__line58"></a>        }
<a name="__line59"></a>        else
<a name="__line60"></a>        {
<a name="__line61"></a>            std::vector&lt;double&gt; values = values_;
<a name="__line62"></a>            if(logscale)
<a name="__line63"></a>            {
<a name="__line64"></a>                value = std::log10(value);
<a name="__line65"></a>                mini = std::log10(mini);
<a name="__line66"></a>                maxi = std::log10(maxi);
<a name="__line67"></a>                for(unsigned int i=0; i&lt;values_.size(); ++i) values[i] = std::log10(values_[i]);
<a name="__line68"></a>            }
<a name="__line69"></a>            auto pos = lower_bound(values.begin(), values.end(), value);
<a name="__line70"></a>            unsigned int n = pos-values.begin();
<a name="__line71"></a>            if(n&lt;1) n=1;
<a name="__line72"></a>            if(n&gt;values.size()-1) n=values.size()-1;
<a name="__line73"></a>            const blop::color c1 = colors_[n-1];
<a name="__line74"></a>            const blop::color c2 = colors_[n];
<a name="__line75"></a>            const double v1 = values[n-1];
<a name="__line76"></a>            const double v2 = values[n];
<a name="__line77"></a>            const double t = (value-v1)/(v2-v1);
<a name="__line78"></a>            return c1*(1-t)+c2*t;
<a name="__line79"></a>        }
<a name="__line80"></a>        return black;
<a name="__line81"></a>    }
<a name="__line82"></a>
<a name="__line83"></a>    color_mapping_function::color_mapping_function()
<a name="__line84"></a>    {
<a name="__line85"></a>	p2f_ = def;
<a name="__line86"></a>	p2f_cint_ = 0;
<a name="__line87"></a>	fname_ = "color_mapping_function::def";
<a name="__line88"></a>    }
<a name="__line89"></a>
<a name="__line90"></a>    color color_mapping_function::def(double value,double mini,double maxi)
<a name="__line91"></a>    {
<a name="__line92"></a>	double norm = (value - mini) / (maxi - mini);
<a name="__line93"></a>	if(norm &lt; 0)
<a name="__line94"></a>	{
<a name="__line95"></a>	    warning::print("Too small value","color_mapping_function::def(...)");
<a name="__line96"></a>	    norm = 0;
<a name="__line97"></a>	}
<a name="__line98"></a>	if(norm &gt; 1)
<a name="__line99"></a>	{
<a name="__line100"></a>	    warning::print("Too large value","color_mapping_function::def");
<a name="__line101"></a>	    norm = 1;
<a name="__line102"></a>	}
<a name="__line103"></a>
<a name="__line104"></a>	double red = 0,green = 0,blue = 0;
<a name="__line105"></a>
<a name="__line106"></a>	if(norm&lt;0.33)
<a name="__line107"></a>	{
<a name="__line108"></a>	    blue = linear(norm,0,0.3,0.33,1);
<a name="__line109"></a>	}
<a name="__line110"></a>	if(0.33&lt;=norm &amp;&amp; norm&lt;0.8)
<a name="__line111"></a>	{
<a name="__line112"></a>	    blue = linear(norm,0.33,1,0.8,0);
<a name="__line113"></a>	}
<a name="__line114"></a>
<a name="__line115"></a>	
<a name="__line116"></a>	if(0.15 &lt; norm &amp;&amp; norm &lt; 0.8)
<a name="__line117"></a>	{
<a name="__line118"></a>	    red = linear(norm,0.15,0,0.8,1);
<a name="__line119"></a>	}
<a name="__line120"></a>	if(norm &gt;= 0.8) red = 1;
<a name="__line121"></a>
<a name="__line122"></a>	if(norm &gt; 0.66)
<a name="__line123"></a>	{
<a name="__line124"></a>	    green = linear(norm,0.66,0,1,1);
<a name="__line125"></a>	}
<a name="__line126"></a>	
<a name="__line127"></a>	return color(red,green,blue);
<a name="__line128"></a>    }
<a name="__line129"></a>
<a name="__line130"></a>    color color_mapping_function::cold_warm(double value, double mini, double maxi)
<a name="__line131"></a>    {
<a name="__line132"></a>        <span class=comment>// http://www.kennethmoreland.com/color-maps/</span>
<a name="__line133"></a>        const static int N = 257;
<a name="__line134"></a>        const static double Blue[N]   = {0.753683153,
<a name="__line135"></a>                                         0.759874796
<a name="__line136"></a>                                         ,0.766005866
<a name="__line137"></a>                                         ,0.772075394
<a name="__line138"></a>                                         ,0.778082421
<a name="__line139"></a>                                         ,0.784026001
<a name="__line140"></a>                                         ,0.789905199
<a name="__line141"></a>                                         ,0.79571909
<a name="__line142"></a>                                         ,0.801466763
<a name="__line143"></a>                                         ,0.807147315
<a name="__line144"></a>                                         ,0.812759858
<a name="__line145"></a>                                         ,0.818303516
<a name="__line146"></a>                                         ,0.823777422
<a name="__line147"></a>                                         ,0.829180725
<a name="__line148"></a>                                         ,0.834512584
<a name="__line149"></a>                                         ,0.839772171
<a name="__line150"></a>                                         ,0.84495867
<a name="__line151"></a>                                         ,0.850071279
<a name="__line152"></a>                                         ,0.855109207
<a name="__line153"></a>                                         ,0.860071679
<a name="__line154"></a>                                         ,0.864957929
<a name="__line155"></a>                                         ,0.869767207
<a name="__line156"></a>                                         ,0.874498775
<a name="__line157"></a>                                         ,0.87915191
<a name="__line158"></a>                                         ,0.883725899
<a name="__line159"></a>                                         ,0.888220047
<a name="__line160"></a>                                         ,0.892633669
<a name="__line161"></a>                                         ,0.896966095
<a name="__line162"></a>                                         ,0.90121667
<a name="__line163"></a>                                         ,0.905384751
<a name="__line164"></a>                                         ,0.909469711
<a name="__line165"></a>                                         ,0.913470934
<a name="__line166"></a>                                         ,0.917387822
<a name="__line167"></a>                                         ,0.921219788
<a name="__line168"></a>                                         ,0.924966262
<a name="__line169"></a>                                         ,0.928626686
<a name="__line170"></a>                                         ,0.932200518
<a name="__line171"></a>                                         ,0.93568723
<a name="__line172"></a>                                         ,0.939086309
<a name="__line173"></a>                                         ,0.942397257
<a name="__line174"></a>                                         ,0.945619588
<a name="__line175"></a>                                         ,0.948752835
<a name="__line176"></a>                                         ,0.951796543
<a name="__line177"></a>                                         ,0.954750272
<a name="__line178"></a>                                         ,0.957613599
<a name="__line179"></a>                                         ,0.960386113
<a name="__line180"></a>                                         ,0.96306742
<a name="__line181"></a>                                         ,0.96565714
<a name="__line182"></a>                                         ,0.968154911
<a name="__line183"></a>                                         ,0.970560381
<a name="__line184"></a>                                         ,0.972873218
<a name="__line185"></a>                                         ,0.975093102
<a name="__line186"></a>                                         ,0.97721973
<a name="__line187"></a>                                         ,0.979252813
<a name="__line188"></a>                                         ,0.981192078
<a name="__line189"></a>                                         ,0.983037268
<a name="__line190"></a>                                         ,0.98478814
<a name="__line191"></a>                                         ,0.986444467
<a name="__line192"></a>                                         ,0.988006036
<a name="__line193"></a>                                         ,0.989472652
<a name="__line194"></a>                                         ,0.990844132
<a name="__line195"></a>                                         ,0.99212031
<a name="__line196"></a>                                         ,0.993301037
<a name="__line197"></a>                                         ,0.994386177
<a name="__line198"></a>                                         ,0.995375608
<a name="__line199"></a>                                         ,0.996269227
<a name="__line200"></a>                                         ,0.997066945
<a name="__line201"></a>                                         ,0.997768685
<a name="__line202"></a>                                         ,0.99837439
<a name="__line203"></a>                                         ,0.998884016
<a name="__line204"></a>                                         ,0.999297533
<a name="__line205"></a>                                         ,0.999614929
<a name="__line206"></a>                                         ,0.999836203
<a name="__line207"></a>                                         ,0.999961374
<a name="__line208"></a>                                         ,0.999990472
<a name="__line209"></a>                                         ,0.999923544
<a name="__line210"></a>                                         ,0.999760652
<a name="__line211"></a>                                         ,0.999501871
<a name="__line212"></a>                                         ,0.999147293
<a name="__line213"></a>                                         ,0.998697024
<a name="__line214"></a>                                         ,0.998151185
<a name="__line215"></a>                                         ,0.99750991
<a name="__line216"></a>                                         ,0.996773351
<a name="__line217"></a>                                         ,0.995941671
<a name="__line218"></a>                                         ,0.995015049
<a name="__line219"></a>                                         ,0.993993679
<a name="__line220"></a>                                         ,0.992877768
<a name="__line221"></a>                                         ,0.991667539
<a name="__line222"></a>                                         ,0.990363227
<a name="__line223"></a>                                         ,0.988965083
<a name="__line224"></a>                                         ,0.987473371
<a name="__line225"></a>                                         ,0.985888369
<a name="__line226"></a>                                         ,0.984210369
<a name="__line227"></a>                                         ,0.982439677
<a name="__line228"></a>                                         ,0.980576612
<a name="__line229"></a>                                         ,0.978621507
<a name="__line230"></a>                                         ,0.976574709
<a name="__line231"></a>                                         ,0.974436577
<a name="__line232"></a>                                         ,0.972207484
<a name="__line233"></a>                                         ,0.969887816
<a name="__line234"></a>                                         ,0.967477972
<a name="__line235"></a>                                         ,0.964978364
<a name="__line236"></a>                                         ,0.962389418
<a name="__line237"></a>                                         ,0.959711569
<a name="__line238"></a>                                         ,0.956945269
<a name="__line239"></a>                                         ,0.95409098
<a name="__line240"></a>                                         ,0.951149176
<a name="__line241"></a>                                         ,0.948120345
<a name="__line242"></a>                                         ,0.945004985
<a name="__line243"></a>                                         ,0.941803607
<a name="__line244"></a>                                         ,0.938516733
<a name="__line245"></a>                                         ,0.935144898
<a name="__line246"></a>                                         ,0.931688648
<a name="__line247"></a>                                         ,0.928148539
<a name="__line248"></a>                                         ,0.92452514
<a name="__line249"></a>                                         ,0.92081903
<a name="__line250"></a>                                         ,0.917030798
<a name="__line251"></a>                                         ,0.913161047
<a name="__line252"></a>                                         ,0.909210387
<a name="__line253"></a>                                         ,0.90517944
<a name="__line254"></a>                                         ,0.901068838
<a name="__line255"></a>                                         ,0.896879224
<a name="__line256"></a>                                         ,0.892611249
<a name="__line257"></a>                                         ,0.888265576
<a name="__line258"></a>                                         ,0.883842876
<a name="__line259"></a>                                         ,0.87934383
<a name="__line260"></a>                                         ,0.874769128
<a name="__line261"></a>                                         ,0.870119469
<a name="__line262"></a>                                         ,0.865395561
<a name="__line263"></a>                                         ,0.859948576
<a name="__line264"></a>                                         ,0.854466231
<a name="__line265"></a>                                         ,0.848949435
<a name="__line266"></a>                                         ,0.843399101
<a name="__line267"></a>                                         ,0.837816138
<a name="__line268"></a>                                         ,0.832201453
<a name="__line269"></a>                                         ,0.826555954
<a name="__line270"></a>                                         ,0.820880546
<a name="__line271"></a>                                         ,0.815176131
<a name="__line272"></a>                                         ,0.809443611
<a name="__line273"></a>                                         ,0.803683885
<a name="__line274"></a>                                         ,0.79789785
<a name="__line275"></a>                                         ,0.792086401
<a name="__line276"></a>                                         ,0.786250429
<a name="__line277"></a>                                         ,0.780390824
<a name="__line278"></a>                                         ,0.774508472
<a name="__line279"></a>                                         ,0.768604257
<a name="__line280"></a>                                         ,0.76267906
<a name="__line281"></a>                                         ,0.756733758
<a name="__line282"></a>                                         ,0.750769226
<a name="__line283"></a>                                         ,0.744786333
<a name="__line284"></a>                                         ,0.738785947
<a name="__line285"></a>                                         ,0.732768931
<a name="__line286"></a>                                         ,0.726736146
<a name="__line287"></a>                                         ,0.720688446
<a name="__line288"></a>                                         ,0.714626683
<a name="__line289"></a>                                         ,0.708551706
<a name="__line290"></a>                                         ,0.702464356
<a name="__line291"></a>                                         ,0.696365473
<a name="__line292"></a>                                         ,0.690255891
<a name="__line293"></a>                                         ,0.68413644
<a name="__line294"></a>                                         ,0.678007945
<a name="__line295"></a>                                         ,0.671871226
<a name="__line296"></a>                                         ,0.665727098
<a name="__line297"></a>                                         ,0.659576372
<a name="__line298"></a>                                         ,0.653419853
<a name="__line299"></a>                                         ,0.647258341
<a name="__line300"></a>                                         ,0.64109263
<a name="__line301"></a>                                         ,0.634923509
<a name="__line302"></a>                                         ,0.628751763
<a name="__line303"></a>                                         ,0.62257817
<a name="__line304"></a>                                         ,0.616403502
<a name="__line305"></a>                                         ,0.610228525
<a name="__line306"></a>                                         ,0.604054002
<a name="__line307"></a>                                         ,0.597880686
<a name="__line308"></a>                                         ,0.591709328
<a name="__line309"></a>                                         ,0.585540669
<a name="__line310"></a>                                         ,0.579375448
<a name="__line311"></a>                                         ,0.573214394
<a name="__line312"></a>                                         ,0.567058232
<a name="__line313"></a>                                         ,0.560907681
<a name="__line314"></a>                                         ,0.554763452
<a name="__line315"></a>                                         ,0.54862625
<a name="__line316"></a>                                         ,0.542496774
<a name="__line317"></a>                                         ,0.536375716
<a name="__line318"></a>                                         ,0.530263762
<a name="__line319"></a>                                         ,0.524161591
<a name="__line320"></a>                                         ,0.518069875
<a name="__line321"></a>                                         ,0.511989279
<a name="__line322"></a>                                         ,0.505920462
<a name="__line323"></a>                                         ,0.499864075
<a name="__line324"></a>                                         ,0.493820764
<a name="__line325"></a>                                         ,0.487791167
<a name="__line326"></a>                                         ,0.481775914
<a name="__line327"></a>                                         ,0.475775629
<a name="__line328"></a>                                         ,0.46979093
<a name="__line329"></a>                                         ,0.463822426
<a name="__line330"></a>                                         ,0.457870719
<a name="__line331"></a>                                         ,0.451936407
<a name="__line332"></a>                                         ,0.446020077
<a name="__line333"></a>                                         ,0.440122312
<a name="__line334"></a>                                         ,0.434243684
<a name="__line335"></a>                                         ,0.428384763
<a name="__line336"></a>                                         ,0.422546107
<a name="__line337"></a>                                         ,0.41672827
<a name="__line338"></a>                                         ,0.410931798
<a name="__line339"></a>                                         ,0.40515723
<a name="__line340"></a>                                         ,0.399405096
<a name="__line341"></a>                                         ,0.393675922
<a name="__line342"></a>                                         ,0.387970225
<a name="__line343"></a>                                         ,0.382288516
<a name="__line344"></a>                                         ,0.376631297
<a name="__line345"></a>                                         ,0.370999065
<a name="__line346"></a>                                         ,0.36539231
<a name="__line347"></a>                                         ,0.359811513
<a name="__line348"></a>                                         ,0.354257151
<a name="__line349"></a>                                         ,0.348729691
<a name="__line350"></a>                                         ,0.343229596
<a name="__line351"></a>                                         ,0.33775732
<a name="__line352"></a>                                         ,0.332313313
<a name="__line353"></a>                                         ,0.326898016
<a name="__line354"></a>                                         ,0.321511863
<a name="__line355"></a>                                         ,0.316155284
<a name="__line356"></a>                                         ,0.310828702
<a name="__line357"></a>                                         ,0.305532531
<a name="__line358"></a>                                         ,0.300267182
<a name="__line359"></a>                                         ,0.295033059
<a name="__line360"></a>                                         ,0.289830559
<a name="__line361"></a>                                         ,0.284660075
<a name="__line362"></a>                                         ,0.279521991
<a name="__line363"></a>                                         ,0.27441669
<a name="__line364"></a>                                         ,0.269344545
<a name="__line365"></a>                                         ,0.264305927
<a name="__line366"></a>                                         ,0.259301199
<a name="__line367"></a>                                         ,0.254330723
<a name="__line368"></a>                                         ,0.249394851
<a name="__line369"></a>                                         ,0.244493934
<a name="__line370"></a>                                         ,0.239628318
<a name="__line371"></a>                                         ,0.234798343
<a name="__line372"></a>                                         ,0.230004348
<a name="__line373"></a>                                         ,0.225246666
<a name="__line374"></a>                                         ,0.220525627
<a name="__line375"></a>                                         ,0.215841558
<a name="__line376"></a>                                         ,0.211194782
<a name="__line377"></a>                                         ,0.20658562
<a name="__line378"></a>                                         ,0.202014392
<a name="__line379"></a>                                         ,0.197481414
<a name="__line380"></a>                                         ,0.192987001
<a name="__line381"></a>                                         ,0.188531467
<a name="__line382"></a>                                         ,0.184115123
<a name="__line383"></a>                                         ,0.179738284
<a name="__line384"></a>                                         ,0.175401259
<a name="__line385"></a>                                         ,0.171104363
<a name="__line386"></a>                                         ,0.166847907
<a name="__line387"></a>                                         ,0.162632207
<a name="__line388"></a>                                         ,0.158457578
<a name="__line389"></a>                                         ,0.154324339
<a name="__line390"></a>                                         ,0.150232812
<a name="__line391"></a>        };
<a name="__line392"></a>
<a name="__line393"></a>        const static double Green[N] = {0.298717966,
<a name="__line394"></a>                                        0.305559204
<a name="__line395"></a>                                        ,0.312388385
<a name="__line396"></a>                                        ,0.319205292
<a name="__line397"></a>                                        ,0.326009656
<a name="__line398"></a>                                        ,0.332801165
<a name="__line399"></a>                                        ,0.339579464
<a name="__line400"></a>                                        ,0.346344164
<a name="__line401"></a>                                        ,0.353094838
<a name="__line402"></a>                                        ,0.359831032
<a name="__line403"></a>                                        ,0.36655226
<a name="__line404"></a>                                        ,0.373258014
<a name="__line405"></a>                                        ,0.379947761
<a name="__line406"></a>                                        ,0.386620945
<a name="__line407"></a>                                        ,0.393276993
<a name="__line408"></a>                                        ,0.399915313
<a name="__line409"></a>                                        ,0.406535296
<a name="__line410"></a>                                        ,0.413136319
<a name="__line411"></a>                                        ,0.419717745
<a name="__line412"></a>                                        ,0.426278924
<a name="__line413"></a>                                        ,0.432819194
<a name="__line414"></a>                                        ,0.439337884
<a name="__line415"></a>                                        ,0.445834313
<a name="__line416"></a>                                        ,0.45230779
<a name="__line417"></a>                                        ,0.458757618
<a name="__line418"></a>                                        ,0.465183092
<a name="__line419"></a>                                        ,0.471583499
<a name="__line420"></a>                                        ,0.477958123
<a name="__line421"></a>                                        ,0.484306241
<a name="__line422"></a>                                        ,0.490627125
<a name="__line423"></a>                                        ,0.496920043
<a name="__line424"></a>                                        ,0.503184261
<a name="__line425"></a>                                        ,0.50941904
<a name="__line426"></a>                                        ,0.515623638
<a name="__line427"></a>                                        ,0.521797312
<a name="__line428"></a>                                        ,0.527939316
<a name="__line429"></a>                                        ,0.534048902
<a name="__line430"></a>                                        ,0.540125323
<a name="__line431"></a>                                        ,0.546167829
<a name="__line432"></a>                                        ,0.552175668
<a name="__line433"></a>                                        ,0.558148092
<a name="__line434"></a>                                        ,0.564084349
<a name="__line435"></a>                                        ,0.56998369
<a name="__line436"></a>                                        ,0.575845364
<a name="__line437"></a>                                        ,0.581668623
<a name="__line438"></a>                                        ,0.587452719
<a name="__line439"></a>                                        ,0.593196905
<a name="__line440"></a>                                        ,0.598900436
<a name="__line441"></a>                                        ,0.604562568
<a name="__line442"></a>                                        ,0.61018256
<a name="__line443"></a>                                        ,0.615759672
<a name="__line444"></a>                                        ,0.621293167
<a name="__line445"></a>                                        ,0.626782311
<a name="__line446"></a>                                        ,0.632226371
<a name="__line447"></a>                                        ,0.637624618
<a name="__line448"></a>                                        ,0.642976326
<a name="__line449"></a>                                        ,0.648280772
<a name="__line450"></a>                                        ,0.653537236
<a name="__line451"></a>                                        ,0.658745003
<a name="__line452"></a>                                        ,0.66390336
<a name="__line453"></a>                                        ,0.669011598
<a name="__line454"></a>                                        ,0.674069012
<a name="__line455"></a>                                        ,0.679074903
<a name="__line456"></a>                                        ,0.684028574
<a name="__line457"></a>                                        ,0.688929332
<a name="__line458"></a>                                        ,0.693776492
<a name="__line459"></a>                                        ,0.698569369
<a name="__line460"></a>                                        ,0.703307287
<a name="__line461"></a>                                        ,0.707989572
<a name="__line462"></a>                                        ,0.712615557
<a name="__line463"></a>                                        ,0.717184578
<a name="__line464"></a>                                        ,0.721695979
<a name="__line465"></a>                                        ,0.726149107
<a name="__line466"></a>                                        ,0.730543315
<a name="__line467"></a>                                        ,0.734877964
<a name="__line468"></a>                                        ,0.739152418
<a name="__line469"></a>                                        ,0.743366047
<a name="__line470"></a>                                        ,0.747518228
<a name="__line471"></a>                                        ,0.751608345
<a name="__line472"></a>                                        ,0.755635786
<a name="__line473"></a>                                        ,0.759599947
<a name="__line474"></a>                                        ,0.763500228
<a name="__line475"></a>                                        ,0.767336039
<a name="__line476"></a>                                        ,0.771106793
<a name="__line477"></a>                                        ,0.774811913
<a name="__line478"></a>                                        ,0.778450826
<a name="__line479"></a>                                        ,0.782022968
<a name="__line480"></a>                                        ,0.78552778
<a name="__line481"></a>                                        ,0.788964712
<a name="__line482"></a>                                        ,0.792333219
<a name="__line483"></a>                                        ,0.795632765
<a name="__line484"></a>                                        ,0.798862821
<a name="__line485"></a>                                        ,0.802022864
<a name="__line486"></a>                                        ,0.805112381
<a name="__line487"></a>                                        ,0.808130864
<a name="__line488"></a>                                        ,0.811077814
<a name="__line489"></a>                                        ,0.813952739
<a name="__line490"></a>                                        ,0.816755156
<a name="__line491"></a>                                        ,0.81948459
<a name="__line492"></a>                                        ,0.82214057
<a name="__line493"></a>                                        ,0.824722639
<a name="__line494"></a>                                        ,0.827230344
<a name="__line495"></a>                                        ,0.829663241
<a name="__line496"></a>                                        ,0.832020895
<a name="__line497"></a>                                        ,0.834302879
<a name="__line498"></a>                                        ,0.836508774
<a name="__line499"></a>                                        ,0.838638169
<a name="__line500"></a>                                        ,0.840690662
<a name="__line501"></a>                                        ,0.842665861
<a name="__line502"></a>                                        ,0.84456338
<a name="__line503"></a>                                        ,0.846382843
<a name="__line504"></a>                                        ,0.848123884
<a name="__line505"></a>                                        ,0.849786142
<a name="__line506"></a>                                        ,0.85136927
<a name="__line507"></a>                                        ,0.852872925
<a name="__line508"></a>                                        ,0.854296776
<a name="__line509"></a>                                        ,0.855640499
<a name="__line510"></a>                                        ,0.856903782
<a name="__line511"></a>                                        ,0.85808632
<a name="__line512"></a>                                        ,0.859187816
<a name="__line513"></a>                                        ,0.860207984
<a name="__line514"></a>                                        ,0.861146547
<a name="__line515"></a>                                        ,0.862003236
<a name="__line516"></a>                                        ,0.862777795
<a name="__line517"></a>                                        ,0.863469972
<a name="__line518"></a>                                        ,0.864079527
<a name="__line519"></a>                                        ,0.864606232
<a name="__line520"></a>                                        ,0.865049863
<a name="__line521"></a>                                        ,0.86541021
<a name="__line522"></a>                                        ,0.863633958
<a name="__line523"></a>                                        ,0.861776352
<a name="__line524"></a>                                        ,0.859837644
<a name="__line525"></a>                                        ,0.857818097
<a name="__line526"></a>                                        ,0.85571798
<a name="__line527"></a>                                        ,0.853537573
<a name="__line528"></a>                                        ,0.851277164
<a name="__line529"></a>                                        ,0.848937047
<a name="__line530"></a>                                        ,0.846517528
<a name="__line531"></a>                                        ,0.844018919
<a name="__line532"></a>                                        ,0.841441541
<a name="__line533"></a>                                        ,0.838785722
<a name="__line534"></a>                                        ,0.836051799
<a name="__line535"></a>                                        ,0.833240115
<a name="__line536"></a>                                        ,0.830351023
<a name="__line537"></a>                                        ,0.827384882
<a name="__line538"></a>                                        ,0.824342058
<a name="__line539"></a>                                        ,0.821222926
<a name="__line540"></a>                                        ,0.818027865
<a name="__line541"></a>                                        ,0.814757264
<a name="__line542"></a>                                        ,0.811411517
<a name="__line543"></a>                                        ,0.807991025
<a name="__line544"></a>                                        ,0.804496196
<a name="__line545"></a>                                        ,0.800927443
<a name="__line546"></a>                                        ,0.797285187
<a name="__line547"></a>                                        ,0.793569853
<a name="__line548"></a>                                        ,0.789781872
<a name="__line549"></a>                                        ,0.785921682
<a name="__line550"></a>                                        ,0.781989725
<a name="__line551"></a>                                        ,0.777986449
<a name="__line552"></a>                                        ,0.773912305
<a name="__line553"></a>                                        ,0.769767752
<a name="__line554"></a>                                        ,0.765553251
<a name="__line555"></a>                                        ,0.761269267
<a name="__line556"></a>                                        ,0.756916272
<a name="__line557"></a>                                        ,0.752494738
<a name="__line558"></a>                                        ,0.748005143
<a name="__line559"></a>                                        ,0.743447967
<a name="__line560"></a>                                        ,0.738823693
<a name="__line561"></a>                                        ,0.734132809
<a name="__line562"></a>                                        ,0.729375802
<a name="__line563"></a>                                        ,0.724553162
<a name="__line564"></a>                                        ,0.719665383
<a name="__line565"></a>                                        ,0.714712956
<a name="__line566"></a>                                        ,0.709696378
<a name="__line567"></a>                                        ,0.704616143
<a name="__line568"></a>                                        ,0.699472746
<a name="__line569"></a>                                        ,0.694266682
<a name="__line570"></a>                                        ,0.688998447
<a name="__line571"></a>                                        ,0.683668532
<a name="__line572"></a>                                        ,0.678277431
<a name="__line573"></a>                                        ,0.672825633
<a name="__line574"></a>                                        ,0.667313624
<a name="__line575"></a>                                        ,0.661741889
<a name="__line576"></a>                                        ,0.656110908
<a name="__line577"></a>                                        ,0.650421156
<a name="__line578"></a>                                        ,0.644673104
<a name="__line579"></a>                                        ,0.638867216
<a name="__line580"></a>                                        ,0.63300395
<a name="__line581"></a>                                        ,0.627083758
<a name="__line582"></a>                                        ,0.621107082
<a name="__line583"></a>                                        ,0.615074355
<a name="__line584"></a>                                        ,0.608986
<a name="__line585"></a>                                        ,0.602842431
<a name="__line586"></a>                                        ,0.596644046
<a name="__line587"></a>                                        ,0.590391232
<a name="__line588"></a>                                        ,0.584084361
<a name="__line589"></a>                                        ,0.57772379
<a name="__line590"></a>                                        ,0.571309856
<a name="__line591"></a>                                        ,0.564842879
<a name="__line592"></a>                                        ,0.558323158
<a name="__line593"></a>                                        ,0.551750968
<a name="__line594"></a>                                        ,0.545126562
<a name="__line595"></a>                                        ,0.538450165
<a name="__line596"></a>                                        ,0.531721972
<a name="__line597"></a>                                        ,0.524942147
<a name="__line598"></a>                                        ,0.518110821
<a name="__line599"></a>                                        ,0.511228087
<a name="__line600"></a>                                        ,0.504293997
<a name="__line601"></a>                                        ,0.49730856
<a name="__line602"></a>                                        ,0.490271735
<a name="__line603"></a>                                        ,0.483183431
<a name="__line604"></a>                                        ,0.476043498
<a name="__line605"></a>                                        ,0.468851724
<a name="__line606"></a>                                        ,0.461607831
<a name="__line607"></a>                                        ,0.454311462
<a name="__line608"></a>                                        ,0.446962183
<a name="__line609"></a>                                        ,0.439559467
<a name="__line610"></a>                                        ,0.43210269
<a name="__line611"></a>                                        ,0.424591118
<a name="__line612"></a>                                        ,0.417023898
<a name="__line613"></a>                                        ,0.409400045
<a name="__line614"></a>                                        ,0.401718425
<a name="__line615"></a>                                        ,0.393977745
<a name="__line616"></a>                                        ,0.386176527
<a name="__line617"></a>                                        ,0.378313092
<a name="__line618"></a>                                        ,0.370385535
<a name="__line619"></a>                                        ,0.362391695
<a name="__line620"></a>                                        ,0.354329127
<a name="__line621"></a>                                        ,0.346195061
<a name="__line622"></a>                                        ,0.337986361
<a name="__line623"></a>                                        ,0.329699471
<a name="__line624"></a>                                        ,0.32133036
<a name="__line625"></a>                                        ,0.312874446
<a name="__line626"></a>                                        ,0.304326513
<a name="__line627"></a>                                        ,0.295680611
<a name="__line628"></a>                                        ,0.286929926
<a name="__line629"></a>                                        ,0.278066636
<a name="__line630"></a>                                        ,0.269081721
<a name="__line631"></a>                                        ,0.259964733
<a name="__line632"></a>                                        ,0.250703507
<a name="__line633"></a>                                        ,0.24128379
<a name="__line634"></a>                                        ,0.231688768
<a name="__line635"></a>                                        ,0.221898442
<a name="__line636"></a>                                        ,0.211888813
<a name="__line637"></a>                                        ,0.201630762
<a name="__line638"></a>                                        ,0.191088518
<a name="__line639"></a>                                        ,0.180217488
<a name="__line640"></a>                                        ,0.168961101
<a name="__line641"></a>                                        ,0.157246067
<a name="__line642"></a>                                        ,0.144974956
<a name="__line643"></a>                                        ,0.132014017
<a name="__line644"></a>                                        ,0.1181719
<a name="__line645"></a>                                        ,0.103159409
<a name="__line646"></a>                                        ,0.086504694
<a name="__line647"></a>                                        ,0.067344036
<a name="__line648"></a>                                        ,0.043755173
<a name="__line649"></a>                                        ,0.01555616
<a name="__line650"></a>        };
<a name="__line651"></a>
<a name="__line652"></a>
<a name="__line653"></a>        const static double Red[N]  = {0.2298057,
<a name="__line654"></a>                                       0.234299935
<a name="__line655"></a>                                       ,0.238810063
<a name="__line656"></a>                                       ,0.243336663
<a name="__line657"></a>                                       ,0.247880265
<a name="__line658"></a>                                       ,0.25244136
<a name="__line659"></a>                                       ,0.257020396
<a name="__line660"></a>                                       ,0.261617779
<a name="__line661"></a>                                       ,0.26623388
<a name="__line662"></a>                                       ,0.270869029
<a name="__line663"></a>                                       ,0.275523523
<a name="__line664"></a>                                       ,0.28019762
<a name="__line665"></a>                                       ,0.284891546
<a name="__line666"></a>                                       ,0.289605495
<a name="__line667"></a>                                       ,0.294339624
<a name="__line668"></a>                                       ,0.299094064
<a name="__line669"></a>                                       ,0.30386891
<a name="__line670"></a>                                       ,0.308664231
<a name="__line671"></a>                                       ,0.313480065
<a name="__line672"></a>                                       ,0.318316422
<a name="__line673"></a>                                       ,0.323173283
<a name="__line674"></a>                                       ,0.328050603
<a name="__line675"></a>                                       ,0.332948312
<a name="__line676"></a>                                       ,0.337866311
<a name="__line677"></a>                                       ,0.342804478
<a name="__line678"></a>                                       ,0.347762667
<a name="__line679"></a>                                       ,0.352740705
<a name="__line680"></a>                                       ,0.357738399
<a name="__line681"></a>                                       ,0.362755532
<a name="__line682"></a>                                       ,0.367791863
<a name="__line683"></a>                                       ,0.372847134
<a name="__line684"></a>                                       ,0.37792106
<a name="__line685"></a>                                       ,0.38301334
<a name="__line686"></a>                                       ,0.38812365
<a name="__line687"></a>                                       ,0.39325165
<a name="__line688"></a>                                       ,0.398396976
<a name="__line689"></a>                                       ,0.40355925
<a name="__line690"></a>                                       ,0.408738074
<a name="__line691"></a>                                       ,0.413933033
<a name="__line692"></a>                                       ,0.419143694
<a name="__line693"></a>                                       ,0.424369608
<a name="__line694"></a>                                       ,0.429610311
<a name="__line695"></a>                                       ,0.434865321
<a name="__line696"></a>                                       ,0.440134144
<a name="__line697"></a>                                       ,0.445416268
<a name="__line698"></a>                                       ,0.450711169
<a name="__line699"></a>                                       ,0.456018308
<a name="__line700"></a>                                       ,0.461337134
<a name="__line701"></a>                                       ,0.46666708
<a name="__line702"></a>                                       ,0.472007569
<a name="__line703"></a>                                       ,0.477358011
<a name="__line704"></a>                                       ,0.482717804
<a name="__line705"></a>                                       ,0.488086336
<a name="__line706"></a>                                       ,0.493462982
<a name="__line707"></a>                                       ,0.498847107
<a name="__line708"></a>                                       ,0.504238066
<a name="__line709"></a>                                       ,0.509635204
<a name="__line710"></a>                                       ,0.515037856
<a name="__line711"></a>                                       ,0.520445349
<a name="__line712"></a>                                       ,0.525857
<a name="__line713"></a>                                       ,0.531272118
<a name="__line714"></a>                                       ,0.536690004
<a name="__line715"></a>                                       ,0.542109949
<a name="__line716"></a>                                       ,0.54753124
<a name="__line717"></a>                                       ,0.552953156
<a name="__line718"></a>                                       ,0.558374965
<a name="__line719"></a>                                       ,0.563795935
<a name="__line720"></a>                                       ,0.569215322
<a name="__line721"></a>                                       ,0.574632379
<a name="__line722"></a>                                       ,0.580046354
<a name="__line723"></a>                                       ,0.585456486
<a name="__line724"></a>                                       ,0.590862011
<a name="__line725"></a>                                       ,0.596262162
<a name="__line726"></a>                                       ,0.601656165
<a name="__line727"></a>                                       ,0.607043242
<a name="__line728"></a>                                       ,0.61242261
<a name="__line729"></a>                                       ,0.617793485
<a name="__line730"></a>                                       ,0.623155076
<a name="__line731"></a>                                       ,0.628506592
<a name="__line732"></a>                                       ,0.633847237
<a name="__line733"></a>                                       ,0.639176211
<a name="__line734"></a>                                       ,0.644492714
<a name="__line735"></a>                                       ,0.649795942
<a name="__line736"></a>                                       ,0.655085089
<a name="__line737"></a>                                       ,0.660359348
<a name="__line738"></a>                                       ,0.665617908
<a name="__line739"></a>                                       ,0.670859959
<a name="__line740"></a>                                       ,0.676084688
<a name="__line741"></a>                                       ,0.681291281
<a name="__line742"></a>                                       ,0.686478925
<a name="__line743"></a>                                       ,0.691646803
<a name="__line744"></a>                                       ,0.696794099
<a name="__line745"></a>                                       ,0.701919999
<a name="__line746"></a>                                       ,0.707023684
<a name="__line747"></a>                                       ,0.712104339
<a name="__line748"></a>                                       ,0.717161148
<a name="__line749"></a>                                       ,0.722193294
<a name="__line750"></a>                                       ,0.727199962
<a name="__line751"></a>                                       ,0.732180337
<a name="__line752"></a>                                       ,0.737133606
<a name="__line753"></a>                                       ,0.742058956
<a name="__line754"></a>                                       ,0.746955574
<a name="__line755"></a>                                       ,0.751822652
<a name="__line756"></a>                                       ,0.756659379
<a name="__line757"></a>                                       ,0.761464949
<a name="__line758"></a>                                       ,0.766238556
<a name="__line759"></a>                                       ,0.770979397
<a name="__line760"></a>                                       ,0.775686671
<a name="__line761"></a>                                       ,0.780359577
<a name="__line762"></a>                                       ,0.78499732
<a name="__line763"></a>                                       ,0.789599105
<a name="__line764"></a>                                       ,0.79416414
<a name="__line765"></a>                                       ,0.798691636
<a name="__line766"></a>                                       ,0.803180808
<a name="__line767"></a>                                       ,0.807630872
<a name="__line768"></a>                                       ,0.812041048
<a name="__line769"></a>                                       ,0.81641056
<a name="__line770"></a>                                       ,0.820738635
<a name="__line771"></a>                                       ,0.825024503
<a name="__line772"></a>                                       ,0.829267397
<a name="__line773"></a>                                       ,0.833466556
<a name="__line774"></a>                                       ,0.837621221
<a name="__line775"></a>                                       ,0.841730637
<a name="__line776"></a>                                       ,0.845794055
<a name="__line777"></a>                                       ,0.849810727
<a name="__line778"></a>                                       ,0.853779913
<a name="__line779"></a>                                       ,0.857700874
<a name="__line780"></a>                                       ,0.861572878
<a name="__line781"></a>                                       ,0.865395197
<a name="__line782"></a>                                       ,0.86977749
<a name="__line783"></a>                                       ,0.874064226
<a name="__line784"></a>                                       ,0.878255583
<a name="__line785"></a>                                       ,0.882351728
<a name="__line786"></a>                                       ,0.886352818
<a name="__line787"></a>                                       ,0.890259
<a name="__line788"></a>                                       ,0.89407041
<a name="__line789"></a>                                       ,0.897787179
<a name="__line790"></a>                                       ,0.901409427
<a name="__line791"></a>                                       ,0.904937269
<a name="__line792"></a>                                       ,0.908370816
<a name="__line793"></a>                                       ,0.911710171
<a name="__line794"></a>                                       ,0.914955433
<a name="__line795"></a>                                       ,0.918106696
<a name="__line796"></a>                                       ,0.921164054
<a name="__line797"></a>                                       ,0.924127593
<a name="__line798"></a>                                       ,0.926997401
<a name="__line799"></a>                                       ,0.929773562
<a name="__line800"></a>                                       ,0.932456159
<a name="__line801"></a>                                       ,0.935045272
<a name="__line802"></a>                                       ,0.937540984
<a name="__line803"></a>                                       ,0.939943375
<a name="__line804"></a>                                       ,0.942252526
<a name="__line805"></a>                                       ,0.944468518
<a name="__line806"></a>                                       ,0.946591434
<a name="__line807"></a>                                       ,0.948621357
<a name="__line808"></a>                                       ,0.950558373
<a name="__line809"></a>                                       ,0.952402567
<a name="__line810"></a>                                       ,0.954154029
<a name="__line811"></a>                                       ,0.955812849
<a name="__line812"></a>                                       ,0.957379123
<a name="__line813"></a>                                       ,0.958852946
<a name="__line814"></a>                                       ,0.960234418
<a name="__line815"></a>                                       ,0.961523642
<a name="__line816"></a>                                       ,0.962720725
<a name="__line817"></a>                                       ,0.963825777
<a name="__line818"></a>                                       ,0.964838913
<a name="__line819"></a>                                       ,0.965760251
<a name="__line820"></a>                                       ,0.966589914
<a name="__line821"></a>                                       ,0.96732803
<a name="__line822"></a>                                       ,0.967974729
<a name="__line823"></a>                                       ,0.96853015
<a name="__line824"></a>                                       ,0.968994435
<a name="__line825"></a>                                       ,0.969367729
<a name="__line826"></a>                                       ,0.969650186
<a name="__line827"></a>                                       ,0.969841963
<a name="__line828"></a>                                       ,0.969943224
<a name="__line829"></a>                                       ,0.969954137
<a name="__line830"></a>                                       ,0.969874878
<a name="__line831"></a>                                       ,0.969705626
<a name="__line832"></a>                                       ,0.96944657
<a name="__line833"></a>                                       ,0.969097901
<a name="__line834"></a>                                       ,0.968659818
<a name="__line835"></a>                                       ,0.968132528
<a name="__line836"></a>                                       ,0.967516241
<a name="__line837"></a>                                       ,0.966811177
<a name="__line838"></a>                                       ,0.966017559
<a name="__line839"></a>                                       ,0.965135621
<a name="__line840"></a>                                       ,0.964165599
<a name="__line841"></a>                                       ,0.963107739
<a name="__line842"></a>                                       ,0.961962293
<a name="__line843"></a>                                       ,0.960729521
<a name="__line844"></a>                                       ,0.959409687
<a name="__line845"></a>                                       ,0.958003065
<a name="__line846"></a>                                       ,0.956509936
<a name="__line847"></a>                                       ,0.954930586
<a name="__line848"></a>                                       ,0.95326531
<a name="__line849"></a>                                       ,0.951514411
<a name="__line850"></a>                                       ,0.949678196
<a name="__line851"></a>                                       ,0.947756983
<a name="__line852"></a>                                       ,0.945751096
<a name="__line853"></a>                                       ,0.943660866
<a name="__line854"></a>                                       ,0.941486631
<a name="__line855"></a>                                       ,0.939228739
<a name="__line856"></a>                                       ,0.936887543
<a name="__line857"></a>                                       ,0.934463404
<a name="__line858"></a>                                       ,0.931956691
<a name="__line859"></a>                                       ,0.929367782
<a name="__line860"></a>                                       ,0.92669706
<a name="__line861"></a>                                       ,0.923944917
<a name="__line862"></a>                                       ,0.921111753
<a name="__line863"></a>                                       ,0.918197974
<a name="__line864"></a>                                       ,0.915203996
<a name="__line865"></a>                                       ,0.912130241
<a name="__line866"></a>                                       ,0.908977139
<a name="__line867"></a>                                       ,0.905745128
<a name="__line868"></a>                                       ,0.902434654
<a name="__line869"></a>                                       ,0.89904617
<a name="__line870"></a>                                       ,0.895580136
<a name="__line871"></a>                                       ,0.892037022
<a name="__line872"></a>                                       ,0.888417303
<a name="__line873"></a>                                       ,0.884721464
<a name="__line874"></a>                                       ,0.880949996
<a name="__line875"></a>                                       ,0.877103399
<a name="__line876"></a>                                       ,0.873182178
<a name="__line877"></a>                                       ,0.869186849
<a name="__line878"></a>                                       ,0.865117934
<a name="__line879"></a>                                       ,0.860975962
<a name="__line880"></a>                                       ,0.85676147
<a name="__line881"></a>                                       ,0.852475004
<a name="__line882"></a>                                       ,0.848117114
<a name="__line883"></a>                                       ,0.843688361
<a name="__line884"></a>                                       ,0.839189312
<a name="__line885"></a>                                       ,0.834620542
<a name="__line886"></a>                                       ,0.829982631
<a name="__line887"></a>                                       ,0.82527617
<a name="__line888"></a>                                       ,0.820501754
<a name="__line889"></a>                                       ,0.815659988
<a name="__line890"></a>                                       ,0.810751482
<a name="__line891"></a>                                       ,0.805776855
<a name="__line892"></a>                                       ,0.800736732
<a name="__line893"></a>                                       ,0.795631745
<a name="__line894"></a>                                       ,0.790462533
<a name="__line895"></a>                                       ,0.785229744
<a name="__line896"></a>                                       ,0.779934029
<a name="__line897"></a>                                       ,0.774576051
<a name="__line898"></a>                                       ,0.769156474
<a name="__line899"></a>                                       ,0.763675975
<a name="__line900"></a>                                       ,0.758135232
<a name="__line901"></a>                                       ,0.752534934
<a name="__line902"></a>                                       ,0.746875773
<a name="__line903"></a>                                       ,0.741158452
<a name="__line904"></a>                                       ,0.735383675
<a name="__line905"></a>                                       ,0.729552157
<a name="__line906"></a>                                       ,0.723664618
<a name="__line907"></a>                                       ,0.717721782
<a name="__line908"></a>                                       ,0.711724383
<a name="__line909"></a>                                       ,0.705673158
<a name="__line910"></a>        };
<a name="__line911"></a>
<a name="__line912"></a>        const double index = (value - mini) / (maxi - mini) * (N-1);
<a name="__line913"></a>        if(index&lt;=0)   return color(Red[0],Green[0],Blue[0]);
<a name="__line914"></a>        if(index&gt;=N-1) return color(Red[N-1],Green[N-1],Blue[N-1]);
<a name="__line915"></a>        const int i1 = (int)index;
<a name="__line916"></a>        const int i2 = std::min(i1+1,N-1);
<a name="__line917"></a>        const double t = index-i1;
<a name="__line918"></a>        return color((1-t)*Red  [i1]+t*Red  [i2],
<a name="__line919"></a>                     (1-t)*Green[i1]+t*Green[i2],
<a name="__line920"></a>                     (1-t)*Blue [i1]+t*Blue [i2]);
<a name="__line921"></a>    }
<a name="__line922"></a>
<a name="__line923"></a>
<a name="__line924"></a>    color color_mapping_function::map(double val, double mini, double maxi, bool logscale) const
<a name="__line925"></a>    {
<a name="__line926"></a>	if(p2f_) return p2f_(val,mini,maxi);
<a name="__line927"></a>	else if(p2f_cint_) return map_interpreted(val,mini,maxi);
<a name="__line928"></a>        return cold_warm(val,mini,maxi);
<a name="__line929"></a>    }
<a name="__line930"></a>
<a name="__line931"></a>    function graph_drawer::get_x(const plottable *g) const
<a name="__line932"></a>    {
<a name="__line933"></a>	function result = g-&gt;x_hint();
<a name="__line934"></a>	if(!result.initialized()) result = _1;
<a name="__line935"></a>	return result;
<a name="__line936"></a>    }
<a name="__line937"></a>    function graph_drawer::get_y(const plottable *g) const
<a name="__line938"></a>    {
<a name="__line939"></a>	function result = g-&gt;y_hint();
<a name="__line940"></a>	if(!result.initialized()) result = _2;
<a name="__line941"></a>	return result;
<a name="__line942"></a>    }
<a name="__line943"></a>
<a name="__line944"></a>    void set_ranges_default(plottable *g,axis *xaxis,axis *yaxis,int i1,int i2)
<a name="__line945"></a>	TRY
<a name="__line946"></a>    {
<a name="__line947"></a>
<a name="__line948"></a>	if(!g) err("Plottable to draw not set");
<a name="__line949"></a>	if(!xaxis) err("Xaxis not set");
<a name="__line950"></a>	if(!yaxis) err("Yaxis not set");
<a name="__line951"></a>
<a name="__line952"></a>
<a name="__line953"></a>	if(g-&gt;empty())
<a name="__line954"></a>	{                                                                       
<a name="__line955"></a>	    warning::print("Warning: empty plottable!",
<a name="__line956"></a>			   "void set_ranges_default(plottable*, axis*, axis*, int, int)");
<a name="__line957"></a>	    return;                                                             
<a name="__line958"></a>	}
<a name="__line959"></a>
<a name="__line960"></a>	if(g-&gt;xmin()!=unset) { xaxis-&gt;extend_range(g-&gt;xmin()); }
<a name="__line961"></a>	if(g-&gt;xmax()!=unset) { xaxis-&gt;extend_range(g-&gt;xmax()); }
<a name="__line962"></a>        if(g-&gt;ymin()!=unset) { yaxis-&gt;extend_range(g-&gt;ymin()); }
<a name="__line963"></a>        if(g-&gt;ymax()!=unset) { yaxis-&gt;extend_range(g-&gt;ymax()); }
<a name="__line964"></a>
<a name="__line965"></a>	<span class=comment>// if all ranges are defined, then simply return at this point</span>
<a name="__line966"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmax()!=unset &amp;&amp;
<a name="__line967"></a>	   g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymax()!=unset) return;
<a name="__line968"></a>
<a name="__line969"></a>	double xmin=unset;
<a name="__line970"></a>	double xmax=unset;
<a name="__line971"></a>	double ymin=unset;
<a name="__line972"></a>	double ymax=unset;
<a name="__line973"></a>	function getx=g-&gt;x_hint();
<a name="__line974"></a>	if (!getx.initialized()) getx=ARG(i1);
<a name="__line975"></a>	function gety=g-&gt;y_hint();
<a name="__line976"></a>	if (!gety.initialized()) gety=ARG(i2);
<a name="__line977"></a>
<a name="__line978"></a>	for ( unsigned int i=0 ; i&lt;g-&gt;size() ; ++i )
<a name="__line979"></a>	{
<a name="__line980"></a>	    const var xorig_var=getx.eval(*g-&gt;get(i));
<a name="__line981"></a>	    if( ignore::it(xorig_var) ) continue;
<a name="__line982"></a>	    const double xorig=xorig_var.dbl();
<a name="__line983"></a>	    if( xaxis-&gt;logscale() &amp;&amp; xorig&lt;=0.0 ) continue;
<a name="__line984"></a>            
<a name="__line985"></a>            <span class=comment>// If axis min or max is fixed, and the point falls below/above the fixed min/max, skip this point</span>
<a name="__line986"></a>            <span class=comment>// (i.e. do not use for extending the range of the *other* axis)</span>
<a name="__line987"></a>            if(xaxis-&gt;min_fixed() &amp;&amp; xorig&lt;xaxis-&gt;min()) continue;
<a name="__line988"></a>            if(xaxis-&gt;max_fixed() &amp;&amp; xorig&gt;xaxis-&gt;max()) continue;
<a name="__line989"></a>
<a name="__line990"></a>	    if( g-&gt;xmin() != unset &amp;&amp; xorig&lt;g-&gt;xmin() ) continue;
<a name="__line991"></a>	    if( g-&gt;xmax() != unset &amp;&amp; xorig&gt;g-&gt;xmax() ) continue;
<a name="__line992"></a>	    if(xmin == unset || xorig&lt;xmin) xmin = xorig;
<a name="__line993"></a>	    if(xmax == unset || xorig&gt;xmax) xmax = xorig;
<a name="__line994"></a>
<a name="__line995"></a>	    const var yorig_var=gety.eval(*g-&gt;get(i));
<a name="__line996"></a>	    if ( ignore::it(yorig_var) ) continue;
<a name="__line997"></a>	    const double yorig=yorig_var.dbl();
<a name="__line998"></a>	    if( yaxis-&gt;logscale() &amp;&amp; yorig&lt;=0.0 ) continue;
<a name="__line999"></a>
<a name="__line1000"></a>            if(yaxis-&gt;min_fixed() &amp;&amp; yorig&lt;yaxis-&gt;min()) continue;
<a name="__line1001"></a>            if(yaxis-&gt;max_fixed() &amp;&amp; yorig&gt;yaxis-&gt;max()) continue;
<a name="__line1002"></a>
<a name="__line1003"></a>	    if( g-&gt;ymin()!=unset &amp;&amp; yorig&lt;g-&gt;ymin()) continue;
<a name="__line1004"></a>	    if( g-&gt;ymax()!=unset &amp;&amp; yorig&gt;g-&gt;ymax()) continue;
<a name="__line1005"></a>	    if(ymin == unset || yorig &lt; ymin) ymin = yorig;
<a name="__line1006"></a>	    if(ymax == unset || yorig &gt; ymax) ymax = yorig;
<a name="__line1007"></a>
<a name="__line1008"></a>	}
<a name="__line1009"></a>
<a name="__line1010"></a>	if (g-&gt;xmin()==unset &amp;&amp; xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line1011"></a>	if (g-&gt;xmax()==unset &amp;&amp; xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line1012"></a>	if (g-&gt;ymin()==unset &amp;&amp; ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line1013"></a>	if (g-&gt;ymax()==unset &amp;&amp; ymax!=unset) yaxis-&gt;extend_range(ymax);
<a name="__line1014"></a>    }
<a name="__line1015"></a>    CATCH("set_ranges_default(...)")
<a name="__line1016"></a>
<a name="__line1017"></a>    <span class=comment>// ---------- graphd_dots ---------------------------------------------------------</span>
<a name="__line1018"></a>
<a name="__line1019"></a>    void dots::set_ranges(plottable *g, axis *x, axis *y)
<a name="__line1020"></a>    {
<a name="__line1021"></a>	set_ranges_default(g,x,y,1,2);
<a name="__line1022"></a>    }
<a name="__line1023"></a>
<a name="__line1024"></a>    void dots::draw(plottable *g,frame *f,terminal *term)
<a name="__line1025"></a>    {
<a name="__line1026"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1027"></a>	if(g-&gt;empty()) return;
<a name="__line1028"></a>
<a name="__line1029"></a>	function getx = g-&gt;x_hint();
<a name="__line1030"></a>	function gety = g-&gt;y_hint();
<a name="__line1031"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1032"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1033"></a>	
<a name="__line1034"></a>	term-&gt;set_color(g-&gt;pointcolor());
<a name="__line1035"></a>	term-&gt;reset_transformation();
<a name="__line1036"></a>
<a name="__line1037"></a>	axis *xaxis =
<a name="__line1038"></a>	    (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1039"></a>	axis *yaxis =
<a name="__line1040"></a>	    (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1041"></a>
<a name="__line1042"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1043"></a>	{
<a name="__line1044"></a>	    if(ignore::it(getx.eval(*(g-&gt;get(i))))) continue;
<a name="__line1045"></a>	    if(ignore::it(gety.eval(*(g-&gt;get(i))))) continue;
<a name="__line1046"></a>
<a name="__line1047"></a>	    double xorig = getx.eval(*(g-&gt;get(i))).dbl();
<a name="__line1048"></a>	    if ( xaxis-&gt;logscale() &amp;&amp; !(xorig&gt;0.0) ) continue;
<a name="__line1049"></a>	    if(g-&gt;xmin() != unset &amp;&amp;  xorig &lt; g-&gt;xmin()) continue;
<a name="__line1050"></a>	    if(g-&gt;xmax() != unset &amp;&amp;  xorig &gt; g-&gt;xmax()) continue;
<a name="__line1051"></a>	    double x = xaxis-&gt;map_point(xorig);
<a name="__line1052"></a>	    if(x&lt;0 || 1&lt;x) continue;
<a name="__line1053"></a>
<a name="__line1054"></a>	    double yorig = gety.eval(*(g-&gt;get(i))).dbl();
<a name="__line1055"></a>	    if ( yaxis-&gt;logscale() &amp;&amp; !(yorig&gt;0.0) ) continue;
<a name="__line1056"></a>	    if(g-&gt;ymin() != unset &amp;&amp; yorig &lt; g-&gt;ymin()) continue;
<a name="__line1057"></a>	    if(g-&gt;ymax() != unset &amp;&amp; yorig &gt; g-&gt;ymax()) continue;
<a name="__line1058"></a>	    double y = yaxis-&gt;map_point(yorig);
<a name="__line1059"></a>	    if(y&lt;0 || 1&lt;y) continue;
<a name="__line1060"></a>
<a name="__line1061"></a>	    term-&gt;draw_dot(terminal::coord(terminal::id(x,1),terminal::id(y,2)));
<a name="__line1062"></a>	}
<a name="__line1063"></a>    }
<a name="__line1064"></a>
<a name="__line1065"></a>    void dots::draw_sample(const length &amp;x,
<a name="__line1066"></a>			   const length &amp;y,
<a name="__line1067"></a>			   const length &amp;size,
<a name="__line1068"></a>			   const plottable *style,
<a name="__line1069"></a>			   terminal *t)
<a name="__line1070"></a>    {
<a name="__line1071"></a>	t-&gt;set_color(style-&gt;pointcolor());
<a name="__line1072"></a>	for(int i=0; i&lt;15; ++i)
<a name="__line1073"></a>	{
<a name="__line1074"></a>	    length l1 = !x + (drand48()-0.5)*!size;
<a name="__line1075"></a>	    length l2 = !y + ((drand48()-0.5)*0.8)*EM;
<a name="__line1076"></a>	    l1.specialize(t);
<a name="__line1077"></a>	    l2.specialize(t);
<a name="__line1078"></a>	    t-&gt;draw_dot(terminal::coord(l1.termspecific_id(), l2.termspecific_id()));
<a name="__line1079"></a>	}
<a name="__line1080"></a>    }
<a name="__line1081"></a>    
<a name="__line1082"></a>    graph_drawer *dots::clone() const
<a name="__line1083"></a>    {
<a name="__line1084"></a>	return new dots;
<a name="__line1085"></a>    }
<a name="__line1086"></a>
<a name="__line1087"></a>    <span class=comment>// ---------- lines ---------------------------------------------------------------</span>
<a name="__line1088"></a>
<a name="__line1089"></a>    void lines::prepare_for_draw(plottable *g, frame *, int count)
<a name="__line1090"></a>    {
<a name="__line1091"></a>	if(count==1) g-&gt;linewidth().register_me();
<a name="__line1092"></a>    }
<a name="__line1093"></a>
<a name="__line1094"></a>    void lines::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line1095"></a>	TRY
<a name="__line1096"></a>    {
<a name="__line1097"></a>	set_ranges_default(g,xaxis,yaxis,1,2);
<a name="__line1098"></a>    }
<a name="__line1099"></a>    CATCH("lines::set_ranges(...)")
<a name="__line1100"></a>
<a name="__line1101"></a>    graph_drawer *lines::clone() const
<a name="__line1102"></a>    {
<a name="__line1103"></a>	return new lines(*this);
<a name="__line1104"></a>    }
<a name="__line1105"></a>
<a name="__line1106"></a>    void draw_lines_raw(const vector&lt;double&gt; &amp;x, const vector&lt;double&gt; &amp;y,
<a name="__line1107"></a>			double xmin_a, double xmax_a, double ymin_a, double ymax_a,
<a name="__line1108"></a>			terminal *term,bool fill, bool break_line = true)
<a name="__line1109"></a>    {
<a name="__line1110"></a>        if(global::debug) cerr&lt;&lt;"[blop] [draw_lines_raw] starts"&lt;&lt;endl;
<a name="__line1111"></a>
<a name="__line1112"></a>	const int n = ::min(x.size(),y.size());
<a name="__line1113"></a>
<a name="__line1114"></a>	vector&lt;terminal::coord&gt; c;
<a name="__line1115"></a>
<a name="__line1116"></a>	if(term-&gt;clip(terminal::coord(terminal::id(xmin_a,1), terminal::id(ymin_a,2)),
<a name="__line1117"></a>		      terminal::coord(terminal::id(xmax_a,1), terminal::id(ymax_a,2))))
<a name="__line1118"></a>	{
<a name="__line1119"></a>	    for(int i=0; i&lt;n; ++i)
<a name="__line1120"></a>	    {
<a name="__line1121"></a>		if(x[i] == unset || y[i] == unset)
<a name="__line1122"></a>		{
<a name="__line1123"></a>                    <span class=comment>// If the line should be broken at empty (unset) values, then flush the</span>
<a name="__line1124"></a>                    <span class=comment>// current stack of points, and start it again. Otherwise just skip this point.</span>
<a name="__line1125"></a>                    if(break_line)
<a name="__line1126"></a>                    {
<a name="__line1127"></a>                        if(!fill &amp;&amp; !c.empty())
<a name="__line1128"></a>                        {
<a name="__line1129"></a>                            if(c.size()&gt;1)
<a name="__line1130"></a>                            {
<a name="__line1131"></a>                                if(fill) term-&gt;fill_polygon(c);
<a name="__line1132"></a>                                else term-&gt;draw_lines(c);
<a name="__line1133"></a>                            }
<a name="__line1134"></a>                            else
<a name="__line1135"></a>                            {
<a name="__line1136"></a>                                warning::print("Separated single point skipped when drawing a line",
<a name="__line1137"></a>                                               "draw_lines_raw(...)");
<a name="__line1138"></a>                            }
<a name="__line1139"></a>                            c.clear();
<a name="__line1140"></a>                        }
<a name="__line1141"></a>                    }
<a name="__line1142"></a>		    continue;
<a name="__line1143"></a>		}
<a name="__line1144"></a>		c.push_back(terminal::coord(terminal::id(x[i],1),terminal::id(y[i],2)));
<a name="__line1145"></a>	    }
<a name="__line1146"></a>	    if(fill) term-&gt;fill_polygon(c);
<a name="__line1147"></a>	    else term-&gt;draw_lines(c);
<a name="__line1148"></a>	    term-&gt;noclip();
<a name="__line1149"></a>            if(global::debug) cerr&lt;&lt;"[blop] [draw_lines_raw] starts"&lt;&lt;endl;
<a name="__line1150"></a>	    return;
<a name="__line1151"></a>	}
<a name="__line1152"></a>
<a name="__line1153"></a>	warning::print("This terminal does not support clipping. Trying own algorithm, "
<a name="__line1154"></a>		       "no guarantee for complicated filled polygons ...","draw_lines_raw(...)");
<a name="__line1155"></a>
<a name="__line1156"></a>	for(int i=1; i&lt;n; ++i)
<a name="__line1157"></a>	{
<a name="__line1158"></a>	    if(x[i] == unset ||
<a name="__line1159"></a>	       std::isinf(x[i]) ||
<a name="__line1160"></a>	       std::isnan(x[i]) ||
<a name="__line1161"></a>	       y[i] == unset ||
<a name="__line1162"></a>	       std::isinf(y[i]) ||
<a name="__line1163"></a>	       std::isnan(y[i]))
<a name="__line1164"></a>	    {
<a name="__line1165"></a>		if(!c.empty())
<a name="__line1166"></a>		{
<a name="__line1167"></a>		    if(fill) term-&gt;fill_polygon(c);
<a name="__line1168"></a>		    else term-&gt;draw_lines(c);
<a name="__line1169"></a>		    c.clear();
<a name="__line1170"></a>		    ++i;
<a name="__line1171"></a>		}
<a name="__line1172"></a>	    }
<a name="__line1173"></a>	    else
<a name="__line1174"></a>	    {
<a name="__line1175"></a>		double x2 = x[i];
<a name="__line1176"></a>		double y2 = y[i];
<a name="__line1177"></a>
<a name="__line1178"></a>		double x1 = x[i-1];
<a name="__line1179"></a>		double y1 = y[i-1];
<a name="__line1180"></a>
<a name="__line1181"></a>		double xf_1 = (xmin_a - x1)/(x2 - x1);
<a name="__line1182"></a>		double xf_2 = (xmax_a - x1)/(x2 - x1);
<a name="__line1183"></a>		double yf_1 = (ymin_a - y1)/(y2 - y1);
<a name="__line1184"></a>		double yf_2 = (ymax_a - y1)/(y2 - y1);
<a name="__line1185"></a>		double f_min = ::max(::min(xf_1,xf_2),::min(yf_1,yf_2));
<a name="__line1186"></a>		double f_max = ::min(::max(xf_1,xf_2),::max(yf_1,yf_2));
<a name="__line1187"></a>
<a name="__line1188"></a>		if( (f_min&lt;=0 &amp;&amp; 1&lt;=f_max) ||
<a name="__line1189"></a>		    (0&lt;=f_min &amp;&amp; f_min&lt;=1 &amp;&amp; 1&lt;=f_max) ||
<a name="__line1190"></a>		    (f_min&lt;=0 &amp;&amp; 0&lt;=f_max &amp;&amp; f_max&lt;=1) ||
<a name="__line1191"></a>		    (0&lt;=f_min &amp;&amp; f_min&lt;=1 &amp;&amp; 0&lt;=f_max &amp;&amp; f_max&lt;=1) )
<a name="__line1192"></a>		{
<a name="__line1193"></a>		    const double x_in = x1+::max(f_min,0.0)*(x2-x1);
<a name="__line1194"></a>		    const double y_in = y1+::max(f_min,0.0)*(y2-y1);
<a name="__line1195"></a>		    const double x_out = x1+::min(f_max,1.0)*(x2-x1);
<a name="__line1196"></a>		    const double y_out = y1+::min(f_max,1.0)*(y2-y1);
<a name="__line1197"></a>
<a name="__line1198"></a>		    if(f_min&gt;0.00001 || c.empty())
<a name="__line1199"></a>		    {
<a name="__line1200"></a>			if(!c.empty())
<a name="__line1201"></a>			{
<a name="__line1202"></a>			    if(!fill) cerr&lt;&lt;"Strange ....."&lt;&lt;endl;
<a name="__line1203"></a>			    if(::fabs(c[c.size()-1].x.relcoord - x_in) &gt; 0.001 &amp;&amp;
<a name="__line1204"></a>			       ::fabs(c[c.size()-1].y.relcoord - y_in) &gt; 0.001)
<a name="__line1205"></a>			    {
<a name="__line1206"></a>				double x_extra=0, y_extra=0;
<a name="__line1207"></a>				if(x1 &gt; xmax_a) x_extra = xmax_a;
<a name="__line1208"></a>				else if(x1 &lt; xmin_a) x_extra = xmin_a;
<a name="__line1209"></a>				else cerr&lt;&lt;"I don't understsand this 1"&lt;&lt;endl;
<a name="__line1210"></a>				if(y1 &gt; ymax_a) y_extra = ymax_a;
<a name="__line1211"></a>				else if(y1 &lt; ymin_a) y_extra = ymin_a;
<a name="__line1212"></a>				else cerr&lt;&lt;"I don't understsand this 2"&lt;&lt;endl;
<a name="__line1213"></a>				c.push_back(terminal::coord(terminal::id(x_extra,1),
<a name="__line1214"></a>							    terminal::id(y_extra,2)));
<a name="__line1215"></a>			    }
<a name="__line1216"></a>			}
<a name="__line1217"></a>			c.push_back(terminal::coord(terminal::id(x_in,1),
<a name="__line1218"></a>						    terminal::id(y_in,2)));
<a name="__line1219"></a>		    }
<a name="__line1220"></a>		    c.push_back(terminal::coord(terminal::id(x_out,1),
<a name="__line1221"></a>						terminal::id(y_out,2)));
<a name="__line1222"></a>		    if(f_max&lt;0.999999)
<a name="__line1223"></a>		    {
<a name="__line1224"></a>			if(!fill)
<a name="__line1225"></a>			{
<a name="__line1226"></a>			    term-&gt;draw_lines(c);
<a name="__line1227"></a>			    c.clear();
<a name="__line1228"></a>			}
<a name="__line1229"></a>		    }
<a name="__line1230"></a>		}
<a name="__line1231"></a>	    }
<a name="__line1232"></a>	}
<a name="__line1233"></a>	if(!c.empty())
<a name="__line1234"></a>	{
<a name="__line1235"></a>	    if(fill) term-&gt;fill_polygon(c);
<a name="__line1236"></a>	    else term-&gt;draw_lines(c);
<a name="__line1237"></a>	}
<a name="__line1238"></a>
<a name="__line1239"></a>        if(global::debug) cerr&lt;&lt;"[blop] [draw_lines_raw] starts"&lt;&lt;endl;
<a name="__line1240"></a>    }
<a name="__line1241"></a>
<a name="__line1242"></a>    void lines::draw(plottable *g,frame *f,terminal *term)
<a name="__line1243"></a>	TRY
<a name="__line1244"></a>    {
<a name="__line1245"></a>        if(global::debug) cerr&lt;&lt;"[blop] [lines] draw(...) starts"&lt;&lt;endl;
<a name="__line1246"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1247"></a>	if(g-&gt;size() &lt; 2)  return;
<a name="__line1248"></a>
<a name="__line1249"></a>	function getx = g-&gt;x_hint();
<a name="__line1250"></a>	function gety = g-&gt;y_hint();
<a name="__line1251"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1252"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1253"></a>
<a name="__line1254"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1255"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1256"></a>
<a name="__line1257"></a>	double xmin = xaxis-&gt;min();
<a name="__line1258"></a>	if(g-&gt;xmin() != unset &amp;&amp; g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line1259"></a>	double xmax = xaxis-&gt;max();
<a name="__line1260"></a>	if(g-&gt;xmax() != unset &amp;&amp; g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line1261"></a>
<a name="__line1262"></a>	double ymin = yaxis-&gt;min();
<a name="__line1263"></a>	if(g-&gt;ymin() != unset &amp;&amp; g-&gt;ymin() &gt; ymin) ymin = g-&gt;ymin();
<a name="__line1264"></a>	double ymax = yaxis-&gt;max();
<a name="__line1265"></a>	if(g-&gt;ymax() != unset &amp;&amp; g-&gt;ymax() &lt; ymax) ymax = g-&gt;ymax();
<a name="__line1266"></a>
<a name="__line1267"></a>	vector&lt;double&gt; xx(g-&gt;size());
<a name="__line1268"></a>	vector&lt;double&gt; yy(g-&gt;size());
<a name="__line1269"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1270"></a>	{
<a name="__line1271"></a>	    const var xorig = getx.eval(*(g-&gt;get(i)));
<a name="__line1272"></a>	    const var yorig = gety.eval(*(g-&gt;get(i)));
<a name="__line1273"></a>	    if(ignore::it(xorig) || (xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0))) xx[i] = unset;
<a name="__line1274"></a>	    else xx[i] = xaxis-&gt;map_point(xorig.dbl());
<a name="__line1275"></a>	    if(ignore::it(yorig) || (yaxis-&gt;logscale() &amp;&amp; !(yorig.dbl()&gt;0.0))) yy[i] = unset;
<a name="__line1276"></a>	    else yy[i] = yaxis-&gt;map_point(yorig.dbl());
<a name="__line1277"></a>	}	
<a name="__line1278"></a>
<a name="__line1279"></a>	term-&gt;reset_transformation();
<a name="__line1280"></a>	if(g-&gt;fill())
<a name="__line1281"></a>	{
<a name="__line1282"></a>	    term-&gt;set_color(g-&gt;fillcolor());
<a name="__line1283"></a>	    draw_lines_raw(xx, yy,
<a name="__line1284"></a>			   xaxis-&gt;map_point(xmin), xaxis-&gt;map_point(xmax),
<a name="__line1285"></a>			   yaxis-&gt;map_point(ymin), yaxis-&gt;map_point(ymax), term, true, break_line_);
<a name="__line1286"></a>	}
<a name="__line1287"></a>
<a name="__line1288"></a>	term-&gt;set_color(g-&gt;linecolor());
<a name="__line1289"></a>	term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line1290"></a>	term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line1291"></a>
<a name="__line1292"></a>	draw_lines_raw(xx, yy,
<a name="__line1293"></a>		       xaxis-&gt;map_point(xmin), xaxis-&gt;map_point(xmax),
<a name="__line1294"></a>		       yaxis-&gt;map_point(ymin), yaxis-&gt;map_point(ymax), term, false, break_line_);
<a name="__line1295"></a>
<a name="__line1296"></a>        if(global::debug) cerr&lt;&lt;"[blop] [lines] draw(...) starts"&lt;&lt;endl;
<a name="__line1297"></a>    }
<a name="__line1298"></a>    CATCH("graphd_line::draw(terminal *)")
<a name="__line1299"></a>
<a name="__line1300"></a>    void lines::draw_sample(const length &amp;x,
<a name="__line1301"></a>			    const length &amp;y,
<a name="__line1302"></a>			    const length &amp;size,
<a name="__line1303"></a>			    const plottable *s,
<a name="__line1304"></a>			    terminal *t)
<a name="__line1305"></a>    {
<a name="__line1306"></a>	t-&gt;set_linewidth(s-&gt;linewidth().termspecific_id());
<a name="__line1307"></a>	t-&gt;set_color(s-&gt;linecolor());
<a name="__line1308"></a>	t-&gt;set_linestyle(s-&gt;linestyle());
<a name="__line1309"></a>
<a name="__line1310"></a>	length l1 = !x - 0.5*!size;
<a name="__line1311"></a>	length l2 = !x + 0.5*!size;
<a name="__line1312"></a>
<a name="__line1313"></a>	l1.specialize(t);
<a name="__line1314"></a>	l2.specialize(t);
<a name="__line1315"></a>
<a name="__line1316"></a>	t-&gt;draw_line(terminal::coord(l1.termspecific_id(), y.termspecific_id()),
<a name="__line1317"></a>		     terminal::coord(l2.termspecific_id(), y.termspecific_id()));
<a name="__line1318"></a>    }
<a name="__line1319"></a>
<a name="__line1320"></a>    lines lines;
<a name="__line1321"></a>
<a name="__line1322"></a>    <span class=comment>// ---------- splines -------------------------------------------------------------</span>
<a name="__line1323"></a>
<a name="__line1324"></a>    graph_drawer *splines::clone() const
<a name="__line1325"></a>    {
<a name="__line1326"></a>	return new splines(*this);
<a name="__line1327"></a>    }
<a name="__line1328"></a>
<a name="__line1329"></a>    void splines::draw_sample(const length &amp;x,const length &amp;y,
<a name="__line1330"></a>			      const length &amp;size,
<a name="__line1331"></a>			      const plottable *g,terminal *t)
<a name="__line1332"></a>    {
<a name="__line1333"></a>	if(g-&gt;fill())
<a name="__line1334"></a>	{
<a name="__line1335"></a>	    length x1 = -0.5*!size;
<a name="__line1336"></a>	    length x2 =  0.5*!size;
<a name="__line1337"></a>	    length y1 = -0.5*EX;
<a name="__line1338"></a>	    length y2 = 0.5*EX;
<a name="__line1339"></a>	    
<a name="__line1340"></a>	    x1.specialize(t);
<a name="__line1341"></a>	    x2.specialize(t);
<a name="__line1342"></a>	    y1.specialize(t);
<a name="__line1343"></a>	    y2.specialize(t);
<a name="__line1344"></a>	    
<a name="__line1345"></a>	    vector&lt;terminal::coord&gt; c;
<a name="__line1346"></a>	    
<a name="__line1347"></a>	    c.push_back(terminal::coord(x1.termspecific_id(),y1.termspecific_id()));
<a name="__line1348"></a>	    c.push_back(terminal::coord(x2.termspecific_id(),y1.termspecific_id()));
<a name="__line1349"></a>	    c.push_back(terminal::coord(x2.termspecific_id(),y2.termspecific_id()));
<a name="__line1350"></a>	    c.push_back(terminal::coord(x1.termspecific_id(),y2.termspecific_id()));
<a name="__line1351"></a>	    c.push_back(terminal::coord(x1.termspecific_id(),y1.termspecific_id()));
<a name="__line1352"></a>	    t-&gt;translate(x.termspecific_id(),y.termspecific_id());
<a name="__line1353"></a>	    t-&gt;set_color(g-&gt;fillcolor());
<a name="__line1354"></a>	    t-&gt;fill_polygon(c);
<a name="__line1355"></a>	    t-&gt;reset_transformation();
<a name="__line1356"></a>	}
<a name="__line1357"></a>	else
<a name="__line1358"></a>	{
<a name="__line1359"></a>	    lines::draw_sample(x,y,size,g,t);
<a name="__line1360"></a>	}
<a name="__line1361"></a>    }
<a name="__line1362"></a>
<a name="__line1363"></a>
<a name="__line1364"></a>    void splines::draw(plottable *g,frame *f,terminal *term)
<a name="__line1365"></a>    {
<a name="__line1366"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1367"></a>	if(g-&gt;size() &lt; 2)
<a name="__line1368"></a>	{
<a name="__line1369"></a>	    warning::print("Can't draw plottable with 1 points","splines::draw(...)");
<a name="__line1370"></a>	    return;
<a name="__line1371"></a>	}
<a name="__line1372"></a>	if(g-&gt;size() &lt; 3)
<a name="__line1373"></a>	{
<a name="__line1374"></a>	    warning::print("Plottable with 2 points is drawn with a line","splines::draw(...)");
<a name="__line1375"></a>	    lines::draw(g,f,term);
<a name="__line1376"></a>	    return;
<a name="__line1377"></a>	}
<a name="__line1378"></a>
<a name="__line1379"></a>	function getx = g-&gt;x_hint();
<a name="__line1380"></a>	function gety = g-&gt;y_hint();
<a name="__line1381"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1382"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1383"></a>
<a name="__line1384"></a>	if(g-&gt;fill()) term-&gt;set_color(g-&gt;fillcolor());
<a name="__line1385"></a>	else
<a name="__line1386"></a>	{
<a name="__line1387"></a>	    term-&gt;set_color(g-&gt;linecolor());
<a name="__line1388"></a>	    term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line1389"></a>	    term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line1390"></a>	}
<a name="__line1391"></a>	term-&gt;reset_transformation();
<a name="__line1392"></a>
<a name="__line1393"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1394"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1395"></a>
<a name="__line1396"></a>	double xmin = xaxis-&gt;min();
<a name="__line1397"></a>	if(g-&gt;xmin() != unset &amp;&amp; g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line1398"></a>	double xmax = xaxis-&gt;max();
<a name="__line1399"></a>	if(g-&gt;xmax() != unset &amp;&amp; g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line1400"></a>
<a name="__line1401"></a>	double ymin = yaxis-&gt;min();
<a name="__line1402"></a>	if(g-&gt;ymin() != unset &amp;&amp; g-&gt;ymin() &gt; ymin) ymin = g-&gt;ymin();
<a name="__line1403"></a>	double ymax = yaxis-&gt;max();
<a name="__line1404"></a>	if(g-&gt;ymax() != unset &amp;&amp; g-&gt;ymax() &lt; ymax) ymax = g-&gt;ymax();
<a name="__line1405"></a>
<a name="__line1406"></a>	vector&lt;double&gt; xa(g-&gt;size());
<a name="__line1407"></a>	vector&lt;double&gt; ya(g-&gt;size());
<a name="__line1408"></a>
<a name="__line1409"></a>	const int n=g-&gt;size();
<a name="__line1410"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1411"></a>	{
<a name="__line1412"></a>	    const var xorig = getx.eval(*(g-&gt;get(i)));
<a name="__line1413"></a>	    const var yorig = gety.eval(*(g-&gt;get(i)));
<a name="__line1414"></a>	    if(ignore::it(xorig) || (xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0))) xa[i] = unset;
<a name="__line1415"></a>	    else xa[i] = xaxis-&gt;map_point(xorig.dbl());
<a name="__line1416"></a>	    if(ignore::it(yorig) || (yaxis-&gt;logscale() &amp;&amp; !(yorig.dbl()&gt;0.0))) ya[i] = unset;
<a name="__line1417"></a>	    else ya[i] = yaxis-&gt;map_point(yorig.dbl());
<a name="__line1418"></a>	}
<a name="__line1419"></a>	function the_spline = function::interpolate_spline(xa,ya);
<a name="__line1420"></a>
<a name="__line1421"></a>	vector&lt;double&gt; xx,yy;
<a name="__line1422"></a>
<a name="__line1423"></a>	const double step = (xa.back()-xa.front())/100;
<a name="__line1424"></a>
<a name="__line1425"></a>	double current_x = xa.front();
<a name="__line1426"></a>	if(g-&gt;fill())
<a name="__line1427"></a>	{
<a name="__line1428"></a>	    xx.push_back(current_x);
<a name="__line1429"></a>	    yy.push_back(0);
<a name="__line1430"></a>	}
<a name="__line1431"></a>
<a name="__line1432"></a>	xx.push_back(current_x);
<a name="__line1433"></a>	yy.push_back(the_spline(current_x));
<a name="__line1434"></a>
<a name="__line1435"></a>	for(int i=1; i&lt;n; ++i)
<a name="__line1436"></a>	{
<a name="__line1437"></a>	    if(xa[i] == unset)
<a name="__line1438"></a>	    {
<a name="__line1439"></a>		if(!xx.empty())
<a name="__line1440"></a>		{
<a name="__line1441"></a>		    xx.push_back(xx.back());
<a name="__line1442"></a>		    yy.push_back(0);
<a name="__line1443"></a>		}
<a name="__line1444"></a>		xx.push_back(unset);
<a name="__line1445"></a>		yy.push_back(unset);
<a name="__line1446"></a>		if(i+1 &lt; n)
<a name="__line1447"></a>		{
<a name="__line1448"></a>		    current_x = xa[i+1];
<a name="__line1449"></a>		    xx.push_back(current_x);
<a name="__line1450"></a>		    yy.push_back(0);
<a name="__line1451"></a>		}
<a name="__line1452"></a>	    }
<a name="__line1453"></a>	    else
<a name="__line1454"></a>	    {
<a name="__line1455"></a>		for(; current_x&lt;xa[i]; current_x += step)
<a name="__line1456"></a>		{
<a name="__line1457"></a>		    if(current_x&gt;xa[i]-0.5*step) current_x = xa[i]-0.5*step;
<a name="__line1458"></a>		    xx.push_back(current_x);
<a name="__line1459"></a>		    yy.push_back(the_spline(current_x));
<a name="__line1460"></a>		}
<a name="__line1461"></a>		current_x = xa[i];
<a name="__line1462"></a>		xx.push_back(current_x);
<a name="__line1463"></a>		yy.push_back(the_spline(current_x));
<a name="__line1464"></a>	    }
<a name="__line1465"></a>	}
<a name="__line1466"></a>
<a name="__line1467"></a>	if(g-&gt;fill())
<a name="__line1468"></a>	{
<a name="__line1469"></a>	    xx.push_back(xx.back());
<a name="__line1470"></a>	    yy.push_back(0);
<a name="__line1471"></a>	}
<a name="__line1472"></a>
<a name="__line1473"></a>	draw_lines_raw(xx, yy,
<a name="__line1474"></a>		       xaxis-&gt;map_point(xmin),
<a name="__line1475"></a>		       xaxis-&gt;map_point(xmax),
<a name="__line1476"></a>		       yaxis-&gt;map_point(ymin),
<a name="__line1477"></a>		       yaxis-&gt;map_point(ymax),
<a name="__line1478"></a>		       term, g-&gt;fill());
<a name="__line1479"></a>
<a name="__line1480"></a>    }
<a name="__line1481"></a>
<a name="__line1482"></a>    <span class=comment>// ---------- graphd_symbol -------------------------------------------------------</span>
<a name="__line1483"></a>
<a name="__line1484"></a>    graph_drawer *points::clone() const
<a name="__line1485"></a>    {
<a name="__line1486"></a>	return new points(*this);
<a name="__line1487"></a>    }
<a name="__line1488"></a>
<a name="__line1489"></a>    void points::prepare_for_draw(plottable *g, frame *, int count)
<a name="__line1490"></a>    {
<a name="__line1491"></a>	if(count==1)
<a name="__line1492"></a>	{
<a name="__line1493"></a>	    point_drawer_ = g-&gt;pointtype();
<a name="__line1494"></a>	    if(point_drawer_ == 0) point_drawer_ = new square;
<a name="__line1495"></a>	    point_drawer_-&gt;prepare_for_draw(g-&gt;pointsize());
<a name="__line1496"></a>	    g-&gt;linewidth().register_me();
<a name="__line1497"></a>	}
<a name="__line1498"></a>    }
<a name="__line1499"></a>
<a name="__line1500"></a>    void points::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line1501"></a>	TRY
<a name="__line1502"></a>    {
<a name="__line1503"></a>	set_ranges_default(g,xaxis,yaxis,1,2);
<a name="__line1504"></a>    }
<a name="__line1505"></a>    CATCH("points::set_ranges(...)")
<a name="__line1506"></a>
<a name="__line1507"></a>
<a name="__line1508"></a>    void points::draw(plottable *g,frame *f,terminal *term)
<a name="__line1509"></a>    TRY
<a name="__line1510"></a>    {
<a name="__line1511"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1512"></a>	if(g-&gt;empty())  return;
<a name="__line1513"></a>
<a name="__line1514"></a>	function getx = g-&gt;x_hint();
<a name="__line1515"></a>	function gety = g-&gt;y_hint();
<a name="__line1516"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1517"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1518"></a>
<a name="__line1519"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1520"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1521"></a>
<a name="__line1522"></a>	double xmin = xaxis-&gt;min();
<a name="__line1523"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line1524"></a>	double xmax = xaxis-&gt;max();
<a name="__line1525"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line1526"></a>
<a name="__line1527"></a>	double ymin = yaxis-&gt;min();
<a name="__line1528"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line1529"></a>	double ymax = yaxis-&gt;max();
<a name="__line1530"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line1531"></a>
<a name="__line1532"></a>	term-&gt;set_color(g-&gt;pointcolor());
<a name="__line1533"></a>	term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line1534"></a>	term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line1535"></a>
<a name="__line1536"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1537"></a>	{
<a name="__line1538"></a>	    const var xorig = getx.eval(*(g-&gt;get(i))).dbl();
<a name="__line1539"></a>	    const var yorig = gety.eval(*(g-&gt;get(i))).dbl();
<a name="__line1540"></a>	    if(ignore::it(xorig) || ignore::it(yorig)) continue;
<a name="__line1541"></a>	    if(xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0)) continue;
<a name="__line1542"></a>	    if(yaxis-&gt;logscale() &amp;&amp; !(yorig.dbl()&gt;0.0)) continue;
<a name="__line1543"></a>	    if(xorig.dbl() &lt; xmin) continue;
<a name="__line1544"></a>	    if(xorig.dbl() &gt; xmax) continue;
<a name="__line1545"></a>	    if(yorig.dbl() &lt; ymin) continue;
<a name="__line1546"></a>	    if(yorig.dbl() &gt; ymax) continue;
<a name="__line1547"></a>
<a name="__line1548"></a>	    double x = xaxis-&gt;map_point(xorig.dbl());
<a name="__line1549"></a>	    double y = yaxis-&gt;map_point(yorig.dbl());
<a name="__line1550"></a>	    if(0&lt;=x &amp;&amp; x&lt;=1 &amp;&amp; 0&lt;=y &amp;&amp; y&lt;=1)
<a name="__line1551"></a>	    {
<a name="__line1552"></a>		term-&gt;translate(terminal::id(x,1),terminal::id(y,2));
<a name="__line1553"></a>		point_drawer_-&gt;draw(term);
<a name="__line1554"></a>		term-&gt;reset_transformation();
<a name="__line1555"></a>	    }
<a name="__line1556"></a>	}
<a name="__line1557"></a>    }
<a name="__line1558"></a>    CATCH("graphd_symbol::draw(...)")
<a name="__line1559"></a>
<a name="__line1560"></a>    void points::draw_sample(const length &amp;x,
<a name="__line1561"></a>			     const length &amp;y,
<a name="__line1562"></a>			     const length &amp;size,
<a name="__line1563"></a>			     const plottable *s,terminal *t)
<a name="__line1564"></a>    {
<a name="__line1565"></a>	t-&gt;set_color(s-&gt;pointcolor());
<a name="__line1566"></a>	t-&gt;set_linewidth(s-&gt;linewidth().termspecific_id());
<a name="__line1567"></a>	t-&gt;set_linestyle(s-&gt;linestyle());
<a name="__line1568"></a>	t-&gt;translate(x.termspecific_id(),y.termspecific_id());
<a name="__line1569"></a>	point_drawer_-&gt;draw(t);
<a name="__line1570"></a>	t-&gt;reset_transformation();
<a name="__line1571"></a>    }
<a name="__line1572"></a>
<a name="__line1573"></a>
<a name="__line1574"></a>    <span class=comment>// ---------- linespoints ---------------------------------------------------------</span>
<a name="__line1575"></a>
<a name="__line1576"></a>    graph_drawer *linespoints::clone() const
<a name="__line1577"></a>    {
<a name="__line1578"></a>	return new linespoints(*this);
<a name="__line1579"></a>    }
<a name="__line1580"></a>
<a name="__line1581"></a>    void linespoints::prepare_for_draw(plottable *g, frame *, int count)
<a name="__line1582"></a>    {
<a name="__line1583"></a>	if(count==1)
<a name="__line1584"></a>	{
<a name="__line1585"></a>	    point_drawer_ = g-&gt;pointtype();
<a name="__line1586"></a>	    if(point_drawer_ == 0) point_drawer_ = new square;
<a name="__line1587"></a>	    point_drawer_-&gt;prepare_for_draw(g-&gt;pointsize());
<a name="__line1588"></a>	    g-&gt;linewidth().register_me();
<a name="__line1589"></a>	}
<a name="__line1590"></a>    }
<a name="__line1591"></a>
<a name="__line1592"></a>    void linespoints::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line1593"></a>	TRY
<a name="__line1594"></a>    {
<a name="__line1595"></a>	set_ranges_default(g,xaxis,yaxis,1,2);
<a name="__line1596"></a>    }
<a name="__line1597"></a>    CATCH("linespoints::set_ranges(...)")
<a name="__line1598"></a>
<a name="__line1599"></a>
<a name="__line1600"></a>    void linespoints::draw(plottable *g,frame *f,terminal *term)
<a name="__line1601"></a>    TRY
<a name="__line1602"></a>    {
<a name="__line1603"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1604"></a>	if(g-&gt;empty())  return;
<a name="__line1605"></a>
<a name="__line1606"></a>	function getx = g-&gt;x_hint();
<a name="__line1607"></a>	function gety = g-&gt;y_hint();
<a name="__line1608"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1609"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1610"></a>
<a name="__line1611"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1612"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1613"></a>
<a name="__line1614"></a>	double xmin = xaxis-&gt;min();
<a name="__line1615"></a>	if(g-&gt;xmin() != unset &amp;&amp; g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line1616"></a>	double xmax = xaxis-&gt;max();
<a name="__line1617"></a>	if(g-&gt;xmax() != unset &amp;&amp; g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line1618"></a>
<a name="__line1619"></a>	double ymin = yaxis-&gt;min();
<a name="__line1620"></a>	if(g-&gt;ymin() != unset &amp;&amp; g-&gt;ymin() &gt; ymin) ymin = g-&gt;ymin();
<a name="__line1621"></a>	double ymax = yaxis-&gt;max();
<a name="__line1622"></a>	if(g-&gt;ymax() != unset &amp;&amp; g-&gt;ymax() &lt; ymax) ymax = g-&gt;ymax();
<a name="__line1623"></a>
<a name="__line1624"></a>	term-&gt;set_color(g-&gt;pointcolor());
<a name="__line1625"></a>	term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line1626"></a>	term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line1627"></a>
<a name="__line1628"></a>	vector&lt;double&gt; xx(g-&gt;size());
<a name="__line1629"></a>	vector&lt;double&gt; yy(g-&gt;size());
<a name="__line1630"></a>
<a name="__line1631"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1632"></a>	{
<a name="__line1633"></a>	    const var xorig = getx.eval(*(g-&gt;get(i)));
<a name="__line1634"></a>	    const var yorig = gety.eval(*(g-&gt;get(i)));
<a name="__line1635"></a>	    double x,y;
<a name="__line1636"></a>
<a name="__line1637"></a>	    if(ignore::it(xorig) || (xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0))) x=unset;
<a name="__line1638"></a>	    else x = xaxis-&gt;map_point(xorig.dbl());
<a name="__line1639"></a>	    if(ignore::it(yorig) || (yaxis-&gt;logscale() &amp;&amp; !(yorig.dbl()&gt;0.0))) y=unset;
<a name="__line1640"></a>	    else y = yaxis-&gt;map_point(yorig.dbl());
<a name="__line1641"></a>
<a name="__line1642"></a>	    xx[i] = x;
<a name="__line1643"></a>	    yy[i] = y;
<a name="__line1644"></a>
<a name="__line1645"></a>	    if(xorig.dbl() &lt; xmin) continue;
<a name="__line1646"></a>	    if(xorig.dbl() &gt; xmax) continue;
<a name="__line1647"></a>	    if(yorig.dbl() &lt; ymin) continue;
<a name="__line1648"></a>	    if(yorig.dbl() &gt; ymax) continue;
<a name="__line1649"></a>
<a name="__line1650"></a>	    if(0&lt;=x &amp;&amp; x&lt;=1 &amp;&amp; 0&lt;=y &amp;&amp; y&lt;=1 &amp;&amp; x!=unset &amp;&amp; y!=unset)
<a name="__line1651"></a>	    {
<a name="__line1652"></a>		term-&gt;translate(terminal::id(x,1),terminal::id(y,2));
<a name="__line1653"></a>		point_drawer_-&gt;draw(term);
<a name="__line1654"></a>		term-&gt;reset_transformation();
<a name="__line1655"></a>	    }
<a name="__line1656"></a>	}
<a name="__line1657"></a><span class=comment>//	term-&gt;reset_transformation();</span>
<a name="__line1658"></a>	draw_lines_raw(xx, yy,
<a name="__line1659"></a>		       xaxis-&gt;map_point(xmin), xaxis-&gt;map_point(xmax),
<a name="__line1660"></a>		       yaxis-&gt;map_point(ymin), yaxis-&gt;map_point(ymax), term, false, break_line_);
<a name="__line1661"></a>    }
<a name="__line1662"></a>    CATCH("linespoints::draw(...)")
<a name="__line1663"></a>
<a name="__line1664"></a>    void linespoints::draw_sample(const length &amp;x,
<a name="__line1665"></a>				  const length &amp;y,
<a name="__line1666"></a>				  const length &amp;size,
<a name="__line1667"></a>				  const plottable *s,terminal *t)
<a name="__line1668"></a>    {
<a name="__line1669"></a>	t-&gt;set_color(s-&gt;pointcolor());
<a name="__line1670"></a>	t-&gt;set_linewidth(s-&gt;linewidth().termspecific_id());
<a name="__line1671"></a>	t-&gt;set_linestyle(s-&gt;linestyle());
<a name="__line1672"></a>	t-&gt;translate(x.termspecific_id(),y.termspecific_id());
<a name="__line1673"></a>
<a name="__line1674"></a>	point_drawer_-&gt;draw(t);
<a name="__line1675"></a>
<a name="__line1676"></a>	length l1 = - 0.5*!size;
<a name="__line1677"></a>	length l2 =   0.5*!size;
<a name="__line1678"></a>	l1.specialize(t);
<a name="__line1679"></a>	l2.specialize(t);
<a name="__line1680"></a>	t-&gt;draw_line(terminal::coord(l1.termspecific_id(), terminal::ZERO),
<a name="__line1681"></a>		     terminal::coord(l2.termspecific_id(), terminal::ZERO));
<a name="__line1682"></a>	t-&gt;reset_transformation();
<a name="__line1683"></a>    }
<a name="__line1684"></a>
<a name="__line1685"></a>    <span class=comment>// --------------------------------------------------------------------------------</span>
<a name="__line1686"></a>
<a name="__line1687"></a>    graph_drawer *cpoints::clone() const
<a name="__line1688"></a>    {
<a name="__line1689"></a>	return new cpoints(*this);
<a name="__line1690"></a>    }
<a name="__line1691"></a>
<a name="__line1692"></a>    void cpoints::draw(plottable *g,frame *f,terminal *term)
<a name="__line1693"></a>	TRY
<a name="__line1694"></a>    {
<a name="__line1695"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1696"></a>	if(g-&gt;empty())  return;
<a name="__line1697"></a>
<a name="__line1698"></a>	function getx = g-&gt;x_hint();
<a name="__line1699"></a>	function gety = g-&gt;y_hint();
<a name="__line1700"></a>	function getr = _3; <span class=comment>// red</span>
<a name="__line1701"></a>	function getg = _4; <span class=comment>// green</span>
<a name="__line1702"></a>	function getb = _5; <span class=comment>// blue</span>
<a name="__line1703"></a>
<a name="__line1704"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1705"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1706"></a>
<a name="__line1707"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1708"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1709"></a>
<a name="__line1710"></a>	double xmin = xaxis-&gt;min();
<a name="__line1711"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line1712"></a>	double xmax = xaxis-&gt;max();
<a name="__line1713"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line1714"></a>
<a name="__line1715"></a>	double ymin = yaxis-&gt;min();
<a name="__line1716"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line1717"></a>	double ymax = yaxis-&gt;max();
<a name="__line1718"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line1719"></a>
<a name="__line1720"></a>	term-&gt;set_color(g-&gt;pointcolor());
<a name="__line1721"></a>	term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line1722"></a>	term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line1723"></a>
<a name="__line1724"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1725"></a>	{
<a name="__line1726"></a>	    const var xorig = getx.eval(*(g-&gt;get(i)));
<a name="__line1727"></a>	    const var yorig = gety.eval(*(g-&gt;get(i)));
<a name="__line1728"></a>	    if(ignore::it(xorig) || ignore::it(yorig)) continue;
<a name="__line1729"></a>	    if(xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0)) continue;
<a name="__line1730"></a>	    if(yaxis-&gt;logscale() &amp;&amp; !(yorig.dbl()&gt;0.0)) continue;
<a name="__line1731"></a>
<a name="__line1732"></a>	    if(xorig.dbl() &lt; xmin) continue;
<a name="__line1733"></a>	    if(xorig.dbl() &gt; xmax) continue;
<a name="__line1734"></a>	    if(yorig.dbl() &lt; ymin) continue;
<a name="__line1735"></a>	    if(yorig.dbl() &gt; ymax) continue;
<a name="__line1736"></a>
<a name="__line1737"></a>	    double x = xaxis-&gt;map_point(xorig.dbl());
<a name="__line1738"></a>	    double y = yaxis-&gt;map_point(yorig.dbl());
<a name="__line1739"></a>	    if(0&lt;=x &amp;&amp; x&lt;=1 &amp;&amp; 0&lt;=y &amp;&amp; y&lt;=1)
<a name="__line1740"></a>	    {
<a name="__line1741"></a>		double red   = getr.eval(*(g-&gt;get(i))).dbl(); 
<a name="__line1742"></a>		double green = getg.eval(*(g-&gt;get(i))).dbl(); 
<a name="__line1743"></a>		double blue  = getb.eval(*(g-&gt;get(i))).dbl(); 
<a name="__line1744"></a>
<a name="__line1745"></a>		term-&gt;set_color(color(red,green,blue));
<a name="__line1746"></a>		term-&gt;translate(terminal::id(x,1),terminal::id(y,2));
<a name="__line1747"></a>		point_drawer_-&gt;draw(term);
<a name="__line1748"></a>		term-&gt;reset_transformation();
<a name="__line1749"></a>	    }
<a name="__line1750"></a>	}
<a name="__line1751"></a>    }
<a name="__line1752"></a>    CATCH("cpoints::draw(...)")
<a name="__line1753"></a>
<a name="__line1754"></a>    cpoints cpoints;
<a name="__line1755"></a>
<a name="__line1756"></a>
<a name="__line1757"></a>    <span class=comment>// --------------------------------------------------------------------------------</span>
<a name="__line1758"></a>
<a name="__line1759"></a>    graph_drawer *spoints::clone() const
<a name="__line1760"></a>    {
<a name="__line1761"></a>	return new spoints(*this);
<a name="__line1762"></a>    }
<a name="__line1763"></a>
<a name="__line1764"></a>    void spoints::draw(plottable *g,frame *f,terminal *term)
<a name="__line1765"></a>	TRY
<a name="__line1766"></a>    {
<a name="__line1767"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1768"></a>	if(g-&gt;empty())  return;
<a name="__line1769"></a>
<a name="__line1770"></a>	function getx = g-&gt;x_hint();
<a name="__line1771"></a>	function gety = g-&gt;y_hint();
<a name="__line1772"></a>	function getz = g-&gt;z_hint();
<a name="__line1773"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1774"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1775"></a>	if(!getz.initialized()) getz = _3;
<a name="__line1776"></a>
<a name="__line1777"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line1778"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line1779"></a>
<a name="__line1780"></a>	double xmin = xaxis-&gt;min();
<a name="__line1781"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line1782"></a>	double xmax = xaxis-&gt;max();
<a name="__line1783"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line1784"></a>
<a name="__line1785"></a>	double ymin = yaxis-&gt;min();
<a name="__line1786"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line1787"></a>	double ymax = yaxis-&gt;max();
<a name="__line1788"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line1789"></a>
<a name="__line1790"></a>	term-&gt;set_color(g-&gt;pointcolor());
<a name="__line1791"></a>	term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line1792"></a>	term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line1793"></a>
<a name="__line1794"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1795"></a>	{
<a name="__line1796"></a>	    const var xorig = getx.eval(*(g-&gt;get(i)));
<a name="__line1797"></a>	    const var yorig = gety.eval(*(g-&gt;get(i)));
<a name="__line1798"></a>	    const var zorig = getz.eval(*(g-&gt;get(i)));
<a name="__line1799"></a>
<a name="__line1800"></a>	    if(ignore::it(xorig) ||
<a name="__line1801"></a>	       ignore::it(yorig) ||
<a name="__line1802"></a>	       ignore::it(zorig)) continue;
<a name="__line1803"></a>	    if(xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0)) continue;
<a name="__line1804"></a>	    if(yaxis-&gt;logscale() &amp;&amp; !(yorig.dbl()&gt;0.0)) continue;
<a name="__line1805"></a>	    if(xorig.dbl() &lt; xmin) continue;
<a name="__line1806"></a>	    if(xorig.dbl() &gt; xmax) continue;
<a name="__line1807"></a>	    if(yorig.dbl() &lt; ymin) continue;
<a name="__line1808"></a>	    if(yorig.dbl() &gt; ymax) continue;
<a name="__line1809"></a>
<a name="__line1810"></a>	    double x = xaxis-&gt;map_point(xorig.dbl());
<a name="__line1811"></a>	    double y = yaxis-&gt;map_point(yorig.dbl());
<a name="__line1812"></a>	    if(0&lt;=x &amp;&amp; x&lt;=1 &amp;&amp; 0&lt;=y &amp;&amp; y&lt;=1)
<a name="__line1813"></a>	    {
<a name="__line1814"></a>		length l = !g-&gt;pointsize() * zorig.dbl();
<a name="__line1815"></a>		term-&gt;translate(terminal::id(x,1),terminal::id(y,2));
<a name="__line1816"></a>		point_drawer_-&gt;draw(term,l);
<a name="__line1817"></a>		term-&gt;reset_transformation();
<a name="__line1818"></a>	    }
<a name="__line1819"></a>	}
<a name="__line1820"></a>    }
<a name="__line1821"></a>    CATCH("spoints::draw(...)")
<a name="__line1822"></a>
<a name="__line1823"></a>    spoints spoints;
<a name="__line1824"></a>
<a name="__line1825"></a>
<a name="__line1826"></a>
<a name="__line1827"></a>    <span class=comment>// ---------- histo ---------------------------------------------------------------</span>
<a name="__line1828"></a>
<a name="__line1829"></a>    graph_drawer *histo::clone() const
<a name="__line1830"></a>    {
<a name="__line1831"></a>	return new histo(*this);
<a name="__line1832"></a>    }
<a name="__line1833"></a>
<a name="__line1834"></a>    void histo::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line1835"></a>	TRY
<a name="__line1836"></a>    {
<a name="__line1837"></a>	if(!g) err("Plottable to draw not set");
<a name="__line1838"></a>	if(!xaxis) err("Xaxis not set");
<a name="__line1839"></a>	if(!yaxis) err("Yaxis not set");
<a name="__line1840"></a>	if(g-&gt;empty()) return;
<a name="__line1841"></a>
<a name="__line1842"></a>	function getx = g-&gt;x_hint();
<a name="__line1843"></a>	function gety = g-&gt;y_hint();
<a name="__line1844"></a>	if(!getx.initialized()) getx = _1;
<a name="__line1845"></a>	if(!gety.initialized()) gety = _2;
<a name="__line1846"></a>
<a name="__line1847"></a>	function getx1 = g-&gt;x1_hint();
<a name="__line1848"></a>	function getx2 = g-&gt;x2_hint();
<a name="__line1849"></a>
<a name="__line1850"></a>	yaxis-&gt;autoextend_min_soft(false);
<a name="__line1851"></a>
<a name="__line1852"></a>
<a name="__line1853"></a>	if(g-&gt;xmin() != unset &amp;&amp; (xaxis-&gt;logscale() == false || g-&gt;xmin()&gt;0))
<a name="__line1854"></a>	{
<a name="__line1855"></a>	    xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line1856"></a>	}
<a name="__line1857"></a>	else
<a name="__line1858"></a>	{
<a name="__line1859"></a>	    if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin() &lt;= 0 &amp;&amp; xaxis-&gt;logscale())
<a name="__line1860"></a>	    {
<a name="__line1861"></a>		warning::print("xmin set to negative value with logscale, ignoring xmin");
<a name="__line1862"></a>	    }
<a name="__line1863"></a>
<a name="__line1864"></a>	    double xfirst=unset;
<a name="__line1865"></a>	    double xsec=unset;
<a name="__line1866"></a>	    int indfirst=0;
<a name="__line1867"></a>	    int indsec=1;
<a name="__line1868"></a>	    for ( unsigned int i=0 ; i&lt;g-&gt;size() ; ++i )
<a name="__line1869"></a>	    {
<a name="__line1870"></a>		var xorig=getx.eval(*(g-&gt;get(i)));
<a name="__line1871"></a>		if(ignore::it(xorig) || (xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0))) continue;
<a name="__line1872"></a>		if( xfirst==unset) { xfirst=xorig.dbl(); indfirst=i; continue; }
<a name="__line1873"></a>		xsec=xorig.dbl(); 
<a name="__line1874"></a>		indsec=i;
<a name="__line1875"></a>		break; 
<a name="__line1876"></a>	    }
<a name="__line1877"></a>	    if (getx1.initialized())
<a name="__line1878"></a>	    {
<a name="__line1879"></a>		xaxis-&gt;extend_range(getx1.eval(*(g-&gt;get(indfirst))).dbl());
<a name="__line1880"></a>	    }
<a name="__line1881"></a>	    else if ( xsec!=unset )
<a name="__line1882"></a>	    {
<a name="__line1883"></a>		xaxis-&gt;extend_range(xfirst-0.5*(xsec - xfirst)/(indsec-indfirst));
<a name="__line1884"></a>	    }
<a name="__line1885"></a>	    else if ( xfirst!=unset )
<a name="__line1886"></a>	    {
<a name="__line1887"></a>		xaxis-&gt;extend_range(xfirst- 0.5);
<a name="__line1888"></a>	    }
<a name="__line1889"></a>	    else
<a name="__line1890"></a>	    {
<a name="__line1891"></a>		warning::print("Could not set range with histogram style");
<a name="__line1892"></a>	    }
<a name="__line1893"></a>	}
<a name="__line1894"></a>
<a name="__line1895"></a>	if(g-&gt;xmax() != unset &amp;&amp; (xaxis-&gt;logscale() == false || g-&gt;xmax()&gt;0))
<a name="__line1896"></a>	{
<a name="__line1897"></a>	    xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line1898"></a>	}
<a name="__line1899"></a>	else
<a name="__line1900"></a>	{
<a name="__line1901"></a>	    if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;=0 &amp;&amp; xaxis-&gt;logscale())
<a name="__line1902"></a>	    {
<a name="__line1903"></a>		warning::print("xmax set to negative value with logscale, ignoring xmax");
<a name="__line1904"></a>	    }
<a name="__line1905"></a>	    double xfirst=unset;
<a name="__line1906"></a>	    double xsec=unset;
<a name="__line1907"></a>	    int indfirst=g-&gt;size()-1;
<a name="__line1908"></a>	    int indsec=g-&gt;size()-2;
<a name="__line1909"></a>	    for ( unsigned int i=g-&gt;size()-1 ; i&gt;=0 ; --i )
<a name="__line1910"></a>	    {
<a name="__line1911"></a>		var xorig=getx.eval(*(g-&gt;get(i)));
<a name="__line1912"></a>		if(ignore::it(xorig) || (xaxis-&gt;logscale() &amp;&amp; !(xorig.dbl()&gt;0.0))) continue;
<a name="__line1913"></a>		if ( xfirst==unset &amp;&amp; xsec==unset ) { xfirst=xorig.dbl(); indfirst=i; continue; }
<a name="__line1914"></a>		if ( xfirst!=unset &amp;&amp; xsec==unset ) { xsec=xorig.dbl(); indsec=i;  break; }
<a name="__line1915"></a>	    }
<a name="__line1916"></a>	    if (getx2.initialized())
<a name="__line1917"></a>	    {
<a name="__line1918"></a>		xaxis-&gt;extend_range(getx2.eval(*(g-&gt;get(indfirst))).dbl());
<a name="__line1919"></a>	    }
<a name="__line1920"></a>	    if ( xsec!=unset )
<a name="__line1921"></a>	    {
<a name="__line1922"></a>		xaxis-&gt;extend_range(xfirst+0.5*(xfirst - xsec)/(indfirst-indsec));
<a name="__line1923"></a>	    }
<a name="__line1924"></a>	    else if ( xfirst!=unset )
<a name="__line1925"></a>	    {
<a name="__line1926"></a>		xaxis-&gt;extend_range(xfirst + 0.5);
<a name="__line1927"></a>	    }
<a name="__line1928"></a>	    else
<a name="__line1929"></a>	    {
<a name="__line1930"></a>		warning::print("Could not set x range with histogram style");
<a name="__line1931"></a>	    }
<a name="__line1932"></a>	}
<a name="__line1933"></a>
<a name="__line1934"></a>	bool ymin_set = false, ymax_set = false;
<a name="__line1935"></a>	if(g-&gt;ymin()!=unset)
<a name="__line1936"></a>	{
<a name="__line1937"></a>	    if(g-&gt;ymin()&gt;0 || yaxis-&gt;logscale()==false)
<a name="__line1938"></a>	    {
<a name="__line1939"></a>		yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line1940"></a>		ymin_set = true;
<a name="__line1941"></a>	    }
<a name="__line1942"></a>	    else
<a name="__line1943"></a>	    {
<a name="__line1944"></a>		warning::print("ymin set to negative value with logscale y, ignoring");
<a name="__line1945"></a>	    }
<a name="__line1946"></a>	}
<a name="__line1947"></a>	if(g-&gt;ymax()!=unset)
<a name="__line1948"></a>	{
<a name="__line1949"></a>	    if(g-&gt;ymax()&gt;0 || yaxis-&gt;logscale()==false)
<a name="__line1950"></a>	    {
<a name="__line1951"></a>		yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line1952"></a>		ymax_set = true;
<a name="__line1953"></a>	    }
<a name="__line1954"></a>	    else
<a name="__line1955"></a>	    {
<a name="__line1956"></a>		warning::print("ymax set to negative value with logscale y, ignoring");
<a name="__line1957"></a>	    }
<a name="__line1958"></a>	}
<a name="__line1959"></a>	if(ymin_set &amp;&amp; ymax_set) return;
<a name="__line1960"></a>
<a name="__line1961"></a>	double min_y = unset;
<a name="__line1962"></a>	double max_y = unset;
<a name="__line1963"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line1964"></a>	{
<a name="__line1965"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line1966"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line1967"></a>	    if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line1968"></a>	    const double xorig = xorig_var.dbl();
<a name="__line1969"></a>	    const double yorig = yorig_var.dbl();
<a name="__line1970"></a>	    
<a name="__line1971"></a>	    if(xaxis-&gt;logscale() &amp;&amp; xorig&lt;=0)        continue;
<a name="__line1972"></a>	    if(g-&gt;xmin()!=unset  &amp;&amp; xorig&lt;g-&gt;xmin()) continue;
<a name="__line1973"></a>	    if(g-&gt;xmax()!=unset  &amp;&amp; xorig&gt;g-&gt;xmax()) continue;
<a name="__line1974"></a>
<a name="__line1975"></a>	    if(yaxis-&gt;logscale() &amp;&amp; yorig&lt;=0) continue;
<a name="__line1976"></a>	    if(min_y == unset || yorig&lt;min_y) min_y = yorig;
<a name="__line1977"></a>	    if(max_y == unset || yorig&gt;max_y) max_y = yorig;
<a name="__line1978"></a>	}
<a name="__line1979"></a>
<a name="__line1980"></a>	<span class=comment>// have not set ymin before yet</span>
<a name="__line1981"></a>	if(ymin_set == false)
<a name="__line1982"></a>	{
<a name="__line1983"></a>	    if(!yaxis-&gt;logscale())
<a name="__line1984"></a>	    {
<a name="__line1985"></a>		if(min_y!=unset) yaxis-&gt;extend_range(min_y);
<a name="__line1986"></a>		yaxis-&gt;extend_range(0);
<a name="__line1987"></a>	    }
<a name="__line1988"></a>	    else if(min_y &gt; 0 &amp;&amp; min_y!=unset) yaxis-&gt;extend_range(min_y * 0.5);
<a name="__line1989"></a>	}
<a name="__line1990"></a>
<a name="__line1991"></a>	if(ymax_set == false)
<a name="__line1992"></a>	{
<a name="__line1993"></a>	    if(max_y != unset) yaxis-&gt;extend_range(max_y);
<a name="__line1994"></a>	}
<a name="__line1995"></a>
<a name="__line1996"></a>    }
<a name="__line1997"></a>    CATCH("histo::set_ranges(plottable *,axis *,axis *)")
<a name="__line1998"></a>
<a name="__line1999"></a>    
<a name="__line2000"></a>    void histo::draw(plottable *g,frame *f,terminal *term)
<a name="__line2001"></a>    TRY
<a name="__line2002"></a>    {
<a name="__line2003"></a>	if(!g) err("Plottable to draw not set");
<a name="__line2004"></a>	if(g-&gt;empty())
<a name="__line2005"></a>	{
<a name="__line2006"></a>	    warning::print("Empty graph","histo::draw(...)");
<a name="__line2007"></a>	    return;
<a name="__line2008"></a>	}
<a name="__line2009"></a>	if(g-&gt;size() == 1)
<a name="__line2010"></a>	{
<a name="__line2011"></a>	    warning::print("Can't yet draw a histo with 1 entries","histo::draw(...)");
<a name="__line2012"></a>	    return;
<a name="__line2013"></a>	}
<a name="__line2014"></a>
<a name="__line2015"></a>	function getx = g-&gt;x_hint();
<a name="__line2016"></a>	function gety = g-&gt;y_hint();
<a name="__line2017"></a>	if(!getx.initialized()) getx = _1;
<a name="__line2018"></a>	if(!gety.initialized()) gety = _2;
<a name="__line2019"></a>
<a name="__line2020"></a>	function getx1 = g-&gt;x1_hint();
<a name="__line2021"></a>	function getx2 = g-&gt;x2_hint();
<a name="__line2022"></a>
<a name="__line2023"></a>	if(g-&gt;fill()) term-&gt;set_color(g-&gt;fillcolor());
<a name="__line2024"></a>	else term-&gt;set_color(g-&gt;linecolor());
<a name="__line2025"></a>
<a name="__line2026"></a>	term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line2027"></a>	term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line2028"></a>	term-&gt;reset_transformation();
<a name="__line2029"></a>
<a name="__line2030"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line2031"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line2032"></a>	
<a name="__line2033"></a>	vector&lt;double&gt;  xxx,yyy;
<a name="__line2034"></a>
<a name="__line2035"></a>	double xmin = xaxis-&gt;min();
<a name="__line2036"></a>	if(g-&gt;xmin() != unset &amp;&amp; g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line2037"></a>	double xmax = xaxis-&gt;max();
<a name="__line2038"></a>	if(g-&gt;xmax() != unset &amp;&amp; g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line2039"></a>
<a name="__line2040"></a>	double xmin_a = xaxis-&gt;map_point(xmin);
<a name="__line2041"></a>	double xmax_a = xaxis-&gt;map_point(xmax);
<a name="__line2042"></a>	double ymin_a = 0;
<a name="__line2043"></a>	if(g-&gt;ymin() != unset) ymin_a = ::max(yaxis-&gt;map_point(g-&gt;ymin()), 0.0);
<a name="__line2044"></a>	double ymax_a = 1;
<a name="__line2045"></a>	if(g-&gt;ymax() != unset) ymax_a = ::min(yaxis-&gt;map_point(g-&gt;ymax()), 1.0);
<a name="__line2046"></a>
<a name="__line2047"></a>	<span class=comment>// the first entry:</span>
<a name="__line2048"></a>
<a name="__line2049"></a>	for(plottable::size_type index = 0; index &lt; g-&gt;size(); ++index)
<a name="__line2050"></a>	{
<a name="__line2051"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(index)));
<a name="__line2052"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(index)));
<a name="__line2053"></a>	    if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line2054"></a>
<a name="__line2055"></a>	    double x1=0, x2=0;
<a name="__line2056"></a>
<a name="__line2057"></a>	    if(getx1.initialized() &amp;&amp; getx2.initialized())
<a name="__line2058"></a>	    {
<a name="__line2059"></a>		x1 = getx1.eval(*(g-&gt;get(index))).dbl();
<a name="__line2060"></a>		x2 = getx2.eval(*(g-&gt;get(index))).dbl();
<a name="__line2061"></a>	    }
<a name="__line2062"></a>	    else
<a name="__line2063"></a>	    {
<a name="__line2064"></a>		plottable::size_type next_index = index+1;
<a name="__line2065"></a>		if (next_index&lt;g-&gt;size())
<a name="__line2066"></a>		{
<a name="__line2067"></a>		    var xnew=getx.eval(*(g-&gt;get(next_index)));
<a name="__line2068"></a>		    while(next_index&lt;g-&gt;size() &amp;&amp; (ignore::it(xnew) || (xaxis-&gt;logscale() &amp;&amp; !(xnew.dbl()&gt;0.0)))) { ++next_index; xnew=getx.eval(*(g-&gt;get(next_index))); }
<a name="__line2069"></a>		}
<a name="__line2070"></a>
<a name="__line2071"></a>		int prev_index = index-1;
<a name="__line2072"></a>		if ( prev_index&gt;=0)
<a name="__line2073"></a>		{
<a name="__line2074"></a>		    var xold=getx.eval(*(g-&gt;get(prev_index)));
<a name="__line2075"></a>		    while(prev_index &gt;= 0 &amp;&amp; (ignore::it(xold) || (xaxis-&gt;logscale() &amp;&amp; !(xold.dbl()&gt;0.0)))) { --prev_index; xold=getx.eval(*(g-&gt;get(prev_index))); }
<a name="__line2076"></a>		}
<a name="__line2077"></a>
<a name="__line2078"></a>		if(next_index &gt;= g-&gt;size() &amp;&amp; prev_index &lt; 0)
<a name="__line2079"></a>		{
<a name="__line2080"></a>		    cerr&lt;&lt;"Strange, please report this problem [next_index&gt;=g-&gt;size() &amp;&amp; prev_index&lt;0"
<a name="__line2081"></a>			" in histo::draw(...)]"&lt;&lt;endl;
<a name="__line2082"></a>		    continue;
<a name="__line2083"></a>		}
<a name="__line2084"></a>
<a name="__line2085"></a>		<span class=comment>//- modifiactions begin</span>
<a name="__line2086"></a>
<a name="__line2087"></a>		<span class=comment>/*
<a name="__line2088"></a>		  if(next_index &lt; g-&gt;size())
<a name="__line2089"></a>		  {
<a name="__line2090"></a>		  x2 = ( getx.eval(*(g-&gt;get(index))).dbl() + getx.eval(*(g-&gt;get(next_index))).dbl() ) /2;
<a name="__line2091"></a>		  }
<a name="__line2092"></a>		  else
<a name="__line2093"></a>		  {
<a name="__line2094"></a>		  x2 = ( 1.5*getx.eval(*(g-&gt;get(index))).dbl() - 0.5*getx.eval(*(g-&gt;get(prev_index))).dbl() );
<a name="__line2095"></a>		  }
<a name="__line2096"></a>
<a name="__line2097"></a>		  if(prev_index &gt;= 0)
<a name="__line2098"></a>		  {
<a name="__line2099"></a>		  x1 = ( getx.eval(*(g-&gt;get(prev_index))).dbl() + getx.eval(*(g-&gt;get(index))).dbl() )/2;
<a name="__line2100"></a>		  }
<a name="__line2101"></a>		  else
<a name="__line2102"></a>		  {
<a name="__line2103"></a>		  x1 = ( 1.5*getx.eval(*(g-&gt;get(index))).dbl() - 0.5*getx.eval(*(g-&gt;get(next_index))).dbl() );
<a name="__line2104"></a>		  }
<a name="__line2105"></a>		*/</span>
<a name="__line2106"></a>
<a name="__line2107"></a>		if (ignore::it(xorig_var) || (xaxis-&gt;logscale() &amp;&amp; !(xorig_var.dbl()&gt;0.0)))
<a name="__line2108"></a>		{
<a name="__line2109"></a>		    if(next_index &gt;= g-&gt;size()) continue;
<a name="__line2110"></a>		    else if(prev_index &lt; 0) continue;
<a name="__line2111"></a>		    else
<a name="__line2112"></a>		    {
<a name="__line2113"></a>			double xother=getx.eval(*(g-&gt;get(prev_index))).dbl();
<a name="__line2114"></a>			double xoother=getx.eval(*(g-&gt;get(next_index))).dbl();
<a name="__line2115"></a>			x1 = xother + 0.5*( xoother - xother )/(next_index-prev_index);
<a name="__line2116"></a>			x2 = xoother - 0.5*( xoother - xother )/(next_index-prev_index);
<a name="__line2117"></a>			if ( xxx.size()&gt;0 )
<a name="__line2118"></a>			{
<a name="__line2119"></a>			    if ( ::fabs(xxx[xxx.size()-1]-xaxis-&gt;map_point(x1))&lt;0.000001*(xaxis-&gt;map_point(x2)-xaxis-&gt;map_point(x1)) ) continue;
<a name="__line2120"></a>			}
<a name="__line2121"></a>		    }
<a name="__line2122"></a>		}
<a name="__line2123"></a>		else
<a name="__line2124"></a>		{
<a name="__line2125"></a>		    if(next_index &lt; g-&gt;size())
<a name="__line2126"></a>		    {
<a name="__line2127"></a>			double xother=getx.eval(*(g-&gt;get(next_index))).dbl();
<a name="__line2128"></a>			x2 = 0.5*( getx.eval(*(g-&gt;get(index))).dbl() + xother )/(next_index-index);
<a name="__line2129"></a>		    }
<a name="__line2130"></a>		    else
<a name="__line2131"></a>		    {
<a name="__line2132"></a>			double xother=0.5*getx.eval(*(g-&gt;get(prev_index))).dbl();
<a name="__line2133"></a>			x2 = ( 1.5*getx.eval(*(g-&gt;get(index))).dbl() - xother )/(index-prev_index);
<a name="__line2134"></a>		    }
<a name="__line2135"></a>
<a name="__line2136"></a>		    if(prev_index &gt;= 0)
<a name="__line2137"></a>		    {
<a name="__line2138"></a>			double xother=getx.eval(*(g-&gt;get(index))).dbl();
<a name="__line2139"></a>			x1 = 0.5*( getx.eval(*(g-&gt;get(prev_index))).dbl() + xother )/(index-prev_index);
<a name="__line2140"></a>		    }
<a name="__line2141"></a>		    else
<a name="__line2142"></a>		    {
<a name="__line2143"></a>			double xother=0.5*getx.eval(*(g-&gt;get(next_index))).dbl();
<a name="__line2144"></a>			x1 = ( 1.5*getx.eval(*(g-&gt;get(index))).dbl() - xother )/(next_index-index);
<a name="__line2145"></a>		    }
<a name="__line2146"></a>		}
<a name="__line2147"></a>	    }
<a name="__line2148"></a>
<a name="__line2149"></a>	    if(x2&lt;xmin || xmax&lt;x1) continue;
<a name="__line2150"></a>
<a name="__line2151"></a>	    double x1_inrange = x1;
<a name="__line2152"></a>	    if(x1 &lt; xmin) x1_inrange = xmin;
<a name="__line2153"></a>
<a name="__line2154"></a>	    double x2_inrange = x2;
<a name="__line2155"></a>	    if(x2 &gt; xmax) x2_inrange = xmax;
<a name="__line2156"></a>
<a name="__line2157"></a>	    double x1a = xaxis-&gt;map_point(x1_inrange);
<a name="__line2158"></a>	    double x2a = xaxis-&gt;map_point(x2_inrange);
<a name="__line2159"></a>
<a name="__line2160"></a>	    double ya = 0;
<a name="__line2161"></a>	    const var yorig = gety.eval(*(g-&gt;get(index)));
<a name="__line2162"></a>	    if(!ignore::it(xorig_var) &amp;&amp;
<a name="__line2163"></a>	       (!xaxis-&gt;logscale() || xorig_var.dbl()&gt;0.0) &amp;&amp;
<a name="__line2164"></a>	       !ignore::it(yorig) &amp;&amp;
<a name="__line2165"></a>	       (!yaxis-&gt;logscale() || yorig.dbl()&gt;0))
<a name="__line2166"></a>	    {
<a name="__line2167"></a>		ya = yaxis-&gt;map_point(yorig.dbl());
<a name="__line2168"></a>	    }
<a name="__line2169"></a>	    else
<a name="__line2170"></a>	    {
<a name="__line2171"></a>		ya = unset;
<a name="__line2172"></a>	    }
<a name="__line2173"></a>
<a name="__line2174"></a>	    <span class=comment>// if first bin's low edge fully contained in the xaxis range,</span>
<a name="__line2175"></a>	    <span class=comment>// add an y=0 value</span>
<a name="__line2176"></a>	    if(xxx.empty() &amp;&amp; (x1 == x1_inrange || g-&gt;fill()))
<a name="__line2177"></a>	    {
<a name="__line2178"></a>		xxx.push_back(x1a);
<a name="__line2179"></a>		double map0;
<a name="__line2180"></a>		if(!yaxis-&gt;logscale()) map0 = yaxis-&gt;map_point(0);
<a name="__line2181"></a>		else map0 = 0;
<a name="__line2182"></a>		yyy.push_back(map0);
<a name="__line2183"></a>	    }
<a name="__line2184"></a>
<a name="__line2185"></a>	    if(ya != unset)
<a name="__line2186"></a>	    {
<a name="__line2187"></a>		xxx.push_back(x1a);
<a name="__line2188"></a>		yyy.push_back(ya);
<a name="__line2189"></a>		xxx.push_back(x2a);
<a name="__line2190"></a>		yyy.push_back(ya);
<a name="__line2191"></a>	    }
<a name="__line2192"></a>	    else
<a name="__line2193"></a>	    {
<a name="__line2194"></a>		if(g-&gt;fill())
<a name="__line2195"></a>		{
<a name="__line2196"></a>		    xxx.push_back(x1a);
<a name="__line2197"></a>		    yyy.push_back(0);
<a name="__line2198"></a>		}
<a name="__line2199"></a>		xxx.push_back(unset);
<a name="__line2200"></a>		yyy.push_back(unset);
<a name="__line2201"></a>		if(g-&gt;fill())
<a name="__line2202"></a>		{
<a name="__line2203"></a>		    xxx.push_back(x2a);
<a name="__line2204"></a>		    yyy.push_back(0);
<a name="__line2205"></a>		}
<a name="__line2206"></a>	    }
<a name="__line2207"></a>
<a name="__line2208"></a>	    if( (index == g-&gt;size()-1 &amp;&amp; x2&lt;=xmax) || <span class=comment>// last point fully contained in displayed range</span>
<a name="__line2209"></a>		(xmax &lt;= x2 &amp;&amp; g-&gt;fill()))            <span class=comment>// next point will be outside</span>
<a name="__line2210"></a>	    {
<a name="__line2211"></a>		xxx.push_back(x2a);
<a name="__line2212"></a>		double map0;
<a name="__line2213"></a>		if(!yaxis-&gt;logscale()) map0 = yaxis-&gt;map_point(0);
<a name="__line2214"></a>		else map0 = 0;
<a name="__line2215"></a>		yyy.push_back(map0);
<a name="__line2216"></a>	    }
<a name="__line2217"></a>
<a name="__line2218"></a>	}
<a name="__line2219"></a>
<a name="__line2220"></a>	draw_lines_raw(xxx, yyy, xmin_a, xmax_a, ymin_a, ymax_a, term, g-&gt;fill());
<a name="__line2221"></a>
<a name="__line2222"></a>    }
<a name="__line2223"></a>    CATCH("histo::draw(plottable *,frame *,terminal *)")
<a name="__line2224"></a>
<a name="__line2225"></a>
<a name="__line2226"></a>    <span class=comment>// ---------- bars ----------------------------------------------------------------</span>
<a name="__line2227"></a>
<a name="__line2228"></a>
<a name="__line2229"></a>    bars::bars(const length &amp;width, const length &amp;offset)
<a name="__line2230"></a>    {
<a name="__line2231"></a>	l1_ = offset - 0.5*width;
<a name="__line2232"></a>	l2_ = offset + 0.5*width;
<a name="__line2233"></a>    }
<a name="__line2234"></a>
<a name="__line2235"></a>
<a name="__line2236"></a>    bars &amp;bars::operator() (const length &amp;width, const length &amp;offset=0.0)
<a name="__line2237"></a>    {
<a name="__line2238"></a>	l1_ = offset - 0.5*width;
<a name="__line2239"></a>	l2_ = offset + 0.5*width;
<a name="__line2240"></a>	return *this;
<a name="__line2241"></a>    }
<a name="__line2242"></a>
<a name="__line2243"></a>    void bars::set_ranges(plottable *g,axis *x,axis *y)
<a name="__line2244"></a>    {
<a name="__line2245"></a>	set_ranges_default(g,x,y,1,2);
<a name="__line2246"></a>	if(!y-&gt;logscale()) y-&gt;extend_range(0);
<a name="__line2247"></a>    }
<a name="__line2248"></a>
<a name="__line2249"></a>    void bars::draw_sample(const length &amp;x,
<a name="__line2250"></a>			   const length &amp;y,
<a name="__line2251"></a>			   const length &amp;size,
<a name="__line2252"></a>			   const plottable *style,
<a name="__line2253"></a>			   terminal *t)
<a name="__line2254"></a>    {
<a name="__line2255"></a>	length x1 = -0.5*!size;
<a name="__line2256"></a>	length x2 =  0.5*!size;
<a name="__line2257"></a>	length y1 = -0.5*EX;
<a name="__line2258"></a>	length y2 = 0.5*EX;
<a name="__line2259"></a>
<a name="__line2260"></a>	x1.specialize(t);
<a name="__line2261"></a>	x2.specialize(t);
<a name="__line2262"></a>	y1.specialize(t);
<a name="__line2263"></a>	y2.specialize(t);
<a name="__line2264"></a>	
<a name="__line2265"></a>	vector&lt;terminal::coord&gt; c;
<a name="__line2266"></a>
<a name="__line2267"></a>	c.push_back(terminal::coord(x1.termspecific_id(),y1.termspecific_id()));
<a name="__line2268"></a>	c.push_back(terminal::coord(x2.termspecific_id(),y1.termspecific_id()));
<a name="__line2269"></a>	c.push_back(terminal::coord(x2.termspecific_id(),y2.termspecific_id()));
<a name="__line2270"></a>	c.push_back(terminal::coord(x1.termspecific_id(),y2.termspecific_id()));
<a name="__line2271"></a>	c.push_back(terminal::coord(x1.termspecific_id(),y1.termspecific_id()));
<a name="__line2272"></a>	t-&gt;translate(x.termspecific_id(),y.termspecific_id());
<a name="__line2273"></a>	t-&gt;set_color(style-&gt;fillcolor());
<a name="__line2274"></a>	t-&gt;fill_polygon(c);
<a name="__line2275"></a>	t-&gt;reset_transformation();
<a name="__line2276"></a>    }
<a name="__line2277"></a>
<a name="__line2278"></a>    void bars::draw(plottable *g,frame *f,terminal *term)
<a name="__line2279"></a>    {
<a name="__line2280"></a>	if(!g) err("Plottable to draw not set");
<a name="__line2281"></a>	if(g-&gt;empty()) return;
<a name="__line2282"></a>
<a name="__line2283"></a>	function getx = g-&gt;x_hint();
<a name="__line2284"></a>	function gety = g-&gt;y_hint();
<a name="__line2285"></a>	if(!getx.initialized()) getx = _1;
<a name="__line2286"></a>	if(!gety.initialized()) gety = _2;
<a name="__line2287"></a>
<a name="__line2288"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line2289"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line2290"></a>
<a name="__line2291"></a>	double xmin = xaxis-&gt;min();
<a name="__line2292"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line2293"></a>	double xmax = xaxis-&gt;max();
<a name="__line2294"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line2295"></a>
<a name="__line2296"></a>	double ymin = yaxis-&gt;min();
<a name="__line2297"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line2298"></a>	double ymax = yaxis-&gt;max();
<a name="__line2299"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line2300"></a>
<a name="__line2301"></a>	term-&gt;set_color(g-&gt;fillcolor());
<a name="__line2302"></a>	vector&lt;terminal::coord&gt; c;
<a name="__line2303"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line2304"></a>	{
<a name="__line2305"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line2306"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line2307"></a>	    if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line2308"></a>	    const double xorig = xorig_var.dbl();
<a name="__line2309"></a>	    const double yorig = yorig_var.dbl();
<a name="__line2310"></a>	    if ( xaxis-&gt;logscale() &amp;&amp; xorig&lt;=0.0 ) continue;
<a name="__line2311"></a>	    if ( yaxis-&gt;logscale() &amp;&amp; yorig&lt;=0.0 ) continue;
<a name="__line2312"></a>	    if(xorig &lt; xmin) continue;
<a name="__line2313"></a>	    if(xorig &gt; xmax) continue;
<a name="__line2314"></a>	    if(yorig &lt; ymin) continue;
<a name="__line2315"></a>	    if(yorig &gt; ymax) continue;
<a name="__line2316"></a>
<a name="__line2317"></a>	    double x = xaxis-&gt;map_point(xorig);
<a name="__line2318"></a>	    double y2 = yaxis-&gt;map_point(yorig);
<a name="__line2319"></a>	    double y1 = yaxis-&gt;map_point(0);
<a name="__line2320"></a>
<a name="__line2321"></a>	    term-&gt;translate(terminal::id(x,1),0);
<a name="__line2322"></a>	    c.clear();
<a name="__line2323"></a>	    c.push_back(terminal::coord(l1_.termspecific_id(),terminal::id(y1,2)));
<a name="__line2324"></a>	    c.push_back(terminal::coord(l2_.termspecific_id(),terminal::id(y1,2)));
<a name="__line2325"></a>	    c.push_back(terminal::coord(l2_.termspecific_id(),terminal::id(y2,2)));
<a name="__line2326"></a>	    c.push_back(terminal::coord(l1_.termspecific_id(),terminal::id(y2,2)));
<a name="__line2327"></a>	    term-&gt;fill_polygon(c);
<a name="__line2328"></a>	    term-&gt;reset_transformation();
<a name="__line2329"></a>	}
<a name="__line2330"></a>    }
<a name="__line2331"></a>
<a name="__line2332"></a>    graph_drawer *bars::clone() const
<a name="__line2333"></a>    {
<a name="__line2334"></a>	return new bars(*this);
<a name="__line2335"></a>    }
<a name="__line2336"></a>
<a name="__line2337"></a>    void bars::prepare_for_draw(plottable *, frame *, int count)
<a name="__line2338"></a>    {
<a name="__line2339"></a>	if(count==1)
<a name="__line2340"></a>	{
<a name="__line2341"></a>	    l1_.register_me();
<a name="__line2342"></a>	    l2_.register_me();
<a name="__line2343"></a>	}
<a name="__line2344"></a>    }
<a name="__line2345"></a>
<a name="__line2346"></a>    <span class=comment>// ---------- labels --------------------------------------------------------------</span>
<a name="__line2347"></a>
<a name="__line2348"></a>    labels &amp;labels::xalign(sym::position a)
<a name="__line2349"></a>    {
<a name="__line2350"></a>	xalign_ = a;
<a name="__line2351"></a>	return *this;
<a name="__line2352"></a>    }
<a name="__line2353"></a>    labels &amp;labels::yalign(sym::position a)
<a name="__line2354"></a>    {
<a name="__line2355"></a>	yalign_ = a;
<a name="__line2356"></a>	return *this;
<a name="__line2357"></a>    }
<a name="__line2358"></a>    labels &amp;labels::align(sym::position xa, sym::position ya)
<a name="__line2359"></a>    {
<a name="__line2360"></a>	xalign_ = xa;
<a name="__line2361"></a>	yalign_ = ya;
<a name="__line2362"></a>	return *this;
<a name="__line2363"></a>    }
<a name="__line2364"></a>    labels &amp;labels::angle(double a)
<a name="__line2365"></a>    {
<a name="__line2366"></a>	angle_ = a;
<a name="__line2367"></a>	return *this;
<a name="__line2368"></a>    }
<a name="__line2369"></a>    labels &amp;labels::xoffset(const length &amp;l)
<a name="__line2370"></a>    {
<a name="__line2371"></a>	x_offset_ = l;
<a name="__line2372"></a>	return *this;
<a name="__line2373"></a>    }
<a name="__line2374"></a>    labels &amp;labels::yoffset(const length &amp;l)
<a name="__line2375"></a>    {
<a name="__line2376"></a>	y_offset_ = l;
<a name="__line2377"></a>	return *this;
<a name="__line2378"></a>    }
<a name="__line2379"></a>    labels &amp;labels::offset(const length &amp;xoff, const length &amp;yoff)
<a name="__line2380"></a>    {
<a name="__line2381"></a>	x_offset_ = xoff;
<a name="__line2382"></a>	y_offset_ = yoff;
<a name="__line2383"></a>	return *this;
<a name="__line2384"></a>    }
<a name="__line2385"></a>
<a name="__line2386"></a>    void labels::prepare_for_draw(plottable *g, frame *, int count)
<a name="__line2387"></a>    {
<a name="__line2388"></a>	if(count==1)
<a name="__line2389"></a>	{
<a name="__line2390"></a>	    x_offset_.register_me();
<a name="__line2391"></a>	    y_offset_.register_me();
<a name="__line2392"></a>	}
<a name="__line2393"></a>    }
<a name="__line2394"></a>
<a name="__line2395"></a>    void labels::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line2396"></a>	TRY
<a name="__line2397"></a>    {
<a name="__line2398"></a>	set_ranges_default(g,xaxis,yaxis,1,2);
<a name="__line2399"></a>    }
<a name="__line2400"></a>    CATCH("labels::set_ranges(...)")
<a name="__line2401"></a>
<a name="__line2402"></a>    graph_drawer *labels::clone() const
<a name="__line2403"></a>    {
<a name="__line2404"></a>	return new labels(*this);
<a name="__line2405"></a>    }
<a name="__line2406"></a>
<a name="__line2407"></a>    void labels::draw(plottable *g,frame *f,terminal *term)
<a name="__line2408"></a>	TRY
<a name="__line2409"></a>    {
<a name="__line2410"></a>	if(!g) err("Plottable to draw not set");
<a name="__line2411"></a>	if(g-&gt;empty()) return;
<a name="__line2412"></a>
<a name="__line2413"></a>	function getx = g-&gt;x_hint();
<a name="__line2414"></a>	function gety = g-&gt;y_hint();
<a name="__line2415"></a>	function getz = g-&gt;z_hint();
<a name="__line2416"></a>	if(!getx.initialized()) getx = _1;
<a name="__line2417"></a>	if(!gety.initialized()) gety = _2;
<a name="__line2418"></a>	if(!getz.initialized()) getz = _3;
<a name="__line2419"></a>
<a name="__line2420"></a>	term-&gt;set_color(g-&gt;linecolor());
<a name="__line2421"></a>
<a name="__line2422"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line2423"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line2424"></a>
<a name="__line2425"></a>
<a name="__line2426"></a>	double xmin = xaxis-&gt;min();
<a name="__line2427"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line2428"></a>	double xmax = xaxis-&gt;max();
<a name="__line2429"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line2430"></a>
<a name="__line2431"></a>	double ymin = yaxis-&gt;min();
<a name="__line2432"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line2433"></a>	double ymax = yaxis-&gt;max();
<a name="__line2434"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line2435"></a>
<a name="__line2436"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line2437"></a>	{
<a name="__line2438"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line2439"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line2440"></a>	    if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line2441"></a>	    const std::string  zorig = getz.eval(*(g-&gt;get(i))).str();
<a name="__line2442"></a>	    const double xorig = xorig_var.dbl();
<a name="__line2443"></a>	    const double yorig = yorig_var.dbl();
<a name="__line2444"></a>	    if ( xaxis-&gt;logscale() &amp;&amp; !(xorig&gt;0.0) ) continue;
<a name="__line2445"></a>	    if ( yaxis-&gt;logscale() &amp;&amp; !(yorig&gt;0.0) ) continue;
<a name="__line2446"></a>	    if(xorig &lt; xmin || xmax &lt; xorig || yorig &lt; ymin || ymax &lt; yorig) continue;
<a name="__line2447"></a>
<a name="__line2448"></a>	    double xm = xaxis-&gt;map_point(xorig);
<a name="__line2449"></a>	    double ym = yaxis-&gt;map_point(yorig);
<a name="__line2450"></a>
<a name="__line2451"></a>	    term-&gt;translate(terminal::id(xm,1),terminal::id(ym,2));
<a name="__line2452"></a>	    term-&gt;draw_text(terminal::coord(x_offset_.termspecific_id(),
<a name="__line2453"></a>					    y_offset_.termspecific_id()),
<a name="__line2454"></a>			    zorig,
<a name="__line2455"></a>			    xalign_,yalign_,angle_);
<a name="__line2456"></a>	    term-&gt;reset_transformation();
<a name="__line2457"></a>	}
<a name="__line2458"></a>    }
<a name="__line2459"></a>    CATCH("labels::draw(terminal *)")
<a name="__line2460"></a>
<a name="__line2461"></a>    labels::labels(sym::position xal, sym::position yal,
<a name="__line2462"></a>		   double ang, const length &amp;xoff, const length &amp;yoff)
<a name="__line2463"></a>    {
<a name="__line2464"></a>	x_offset_ = xoff;
<a name="__line2465"></a>	y_offset_ = yoff;
<a name="__line2466"></a>	xalign_ = xal;
<a name="__line2467"></a>	yalign_ = yal;
<a name="__line2468"></a>	angle_ = ang;
<a name="__line2469"></a>    }
<a name="__line2470"></a>
<a name="__line2471"></a>    labels &amp;labels::operator() (sym::position xal, sym::position yal, double angle,
<a name="__line2472"></a>				const length &amp;xoff, const length &amp;yoff)
<a name="__line2473"></a>    {
<a name="__line2474"></a>	x_offset_ = xoff;
<a name="__line2475"></a>	y_offset_ = yoff;
<a name="__line2476"></a>	xalign_ = xal;
<a name="__line2477"></a>	yalign_ = yal;
<a name="__line2478"></a>	angle_ = angle;
<a name="__line2479"></a>	return *this;
<a name="__line2480"></a>    }
<a name="__line2481"></a>
<a name="__line2482"></a>    void labels::draw_sample(const length &amp;x,
<a name="__line2483"></a>			     const length &amp;y,
<a name="__line2484"></a>			     const length &amp;size,
<a name="__line2485"></a>			     const plottable *s,
<a name="__line2486"></a>			     terminal *t)
<a name="__line2487"></a>    {
<a name="__line2488"></a>    }
<a name="__line2489"></a>
<a name="__line2490"></a>    <span class=comment>// ---------- graphd_errorbar   ---------------------------------------------------</span>
<a name="__line2491"></a>
<a name="__line2492"></a>    bool errorbars::default_clip_points_ = true;
<a name="__line2493"></a>    bool errorbars::default_clip_errorbars_ = false;
<a name="__line2494"></a>
<a name="__line2495"></a>    errorbars &amp;errorbars::endmarker_size(const length &amp;l) { endmarker_size_ = l; return *this; }
<a name="__line2496"></a>
<a name="__line2497"></a>    length &amp;errorbars::default_endmarker_size_()
<a name="__line2498"></a>    {
<a name="__line2499"></a>        static length &amp;s = PS;
<a name="__line2500"></a>        return s;
<a name="__line2501"></a>    }
<a name="__line2502"></a>
<a name="__line2503"></a>    int errorbars::req_components() const
<a name="__line2504"></a>    {
<a name="__line2505"></a>	int n = 2;
<a name="__line2506"></a>	if(x_) {if(symmetric_x_) n += 1; else n += 2;}
<a name="__line2507"></a>	if(y_) {if(symmetric_y_) n += 1; else n += 2;}
<a name="__line2508"></a>	return n;
<a name="__line2509"></a>    }
<a name="__line2510"></a>
<a name="__line2511"></a>    void errorbars::get_functions(const plottable *g,
<a name="__line2512"></a>				  function &amp;getx, function &amp;getx1, function &amp;getx2,
<a name="__line2513"></a>				  function &amp;gety, function &amp;gety1, function &amp;gety2)
<a name="__line2514"></a>    {
<a name="__line2515"></a>	getx = g-&gt;x_hint();
<a name="__line2516"></a>	if(!getx.initialized()) getx = _1;
<a name="__line2517"></a>
<a name="__line2518"></a>	gety = g-&gt;y_hint();
<a name="__line2519"></a>	if(!gety.initialized()) gety = _2;
<a name="__line2520"></a>
<a name="__line2521"></a>	getx1 = g-&gt;x1_hint();
<a name="__line2522"></a>	getx2 = g-&gt;x2_hint();
<a name="__line2523"></a>
<a name="__line2524"></a>	if(x_ &amp;&amp; (!getx1.initialized() || !getx2.initialized()))
<a name="__line2525"></a>	{
<a name="__line2526"></a>	    if(symmetric_x_)
<a name="__line2527"></a>	    {
<a name="__line2528"></a>		function getdx = g-&gt;dx_hint();
<a name="__line2529"></a>
<a name="__line2530"></a>		<span class=comment>// if plottable did not specify a dx_hint, or if it's an fgraph, then</span>
<a name="__line2531"></a>		<span class=comment>// use the 3rd column. </span>
<a name="__line2532"></a>		<span class=comment>// This is a dirty code. Think it over!!!!</span>
<a name="__line2533"></a>		if(!getdx.initialized() || dynamic_cast&lt;const fgraph *&gt;(g))
<a name="__line2534"></a>		{
<a name="__line2535"></a>		    getx1 = getx - _3;
<a name="__line2536"></a>		    getx2 = getx + _3;
<a name="__line2537"></a>		}
<a name="__line2538"></a>		else
<a name="__line2539"></a>		{
<a name="__line2540"></a>		    getx1 = getx - getdx/2;
<a name="__line2541"></a>		    getx2 = getx + getdx/2;
<a name="__line2542"></a>		}
<a name="__line2543"></a>	    }
<a name="__line2544"></a>	    else
<a name="__line2545"></a>	    {
<a name="__line2546"></a>		getx1 = _3;
<a name="__line2547"></a>		getx2 = _4;
<a name="__line2548"></a>	    }
<a name="__line2549"></a>	}
<a name="__line2550"></a>
<a name="__line2551"></a>	gety1 = g-&gt;y1_hint();
<a name="__line2552"></a>	gety2 = g-&gt;y2_hint();
<a name="__line2553"></a>
<a name="__line2554"></a>	if(y_ &amp;&amp; (!gety1.initialized() || !gety2.initialized()))
<a name="__line2555"></a>	{
<a name="__line2556"></a>	    if(symmetric_y_)
<a name="__line2557"></a>	    {
<a name="__line2558"></a>		function getdy = g-&gt;dy_hint();
<a name="__line2559"></a>		if(!getdy.initialized())
<a name="__line2560"></a>		{
<a name="__line2561"></a>		    if(!x_) getdy = _3*2;
<a name="__line2562"></a>		    else
<a name="__line2563"></a>		    {
<a name="__line2564"></a>			if(symmetric_x_) getdy = _4*2;
<a name="__line2565"></a>			else             getdy = _5*2;
<a name="__line2566"></a>		    }
<a name="__line2567"></a>		}
<a name="__line2568"></a>		gety1 = gety - getdy/2;
<a name="__line2569"></a>		gety2 = gety + getdy/2;
<a name="__line2570"></a>	    }
<a name="__line2571"></a>	    else
<a name="__line2572"></a>	    {
<a name="__line2573"></a>		if(!x_)
<a name="__line2574"></a>		{
<a name="__line2575"></a>		    gety1 = _3;
<a name="__line2576"></a>		    gety2 = _4;
<a name="__line2577"></a>		}
<a name="__line2578"></a>		else
<a name="__line2579"></a>		{
<a name="__line2580"></a>		    gety1 = _4;
<a name="__line2581"></a>		    gety2 = _5;
<a name="__line2582"></a>		}
<a name="__line2583"></a>	    }
<a name="__line2584"></a>	}
<a name="__line2585"></a>	if(!getx1.initialized()) getx1 = getx;
<a name="__line2586"></a>	if(!getx2.initialized()) getx2 = getx;
<a name="__line2587"></a>	if(!gety1.initialized()) gety1 = gety;
<a name="__line2588"></a>	if(!gety2.initialized()) gety2 = gety;
<a name="__line2589"></a>    }
<a name="__line2590"></a>
<a name="__line2591"></a>    void errorbars::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line2592"></a>    {
<a name="__line2593"></a>	if(!g) return;
<a name="__line2594"></a>
<a name="__line2595"></a>	if(g-&gt;empty())
<a name="__line2596"></a>	{
<a name="__line2597"></a>	    warning::print("Empty plottable","errorbars::set_ranges(...)");
<a name="__line2598"></a>	    return;
<a name="__line2599"></a>	}
<a name="__line2600"></a>
<a name="__line2601"></a>	function getx, getx1, getx2, gety, gety1, gety2;
<a name="__line2602"></a>	get_functions(g,getx, getx1, getx2, gety, gety1, gety2);
<a name="__line2603"></a>
<a name="__line2604"></a>	if(g-&gt;xmin()!=unset) xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line2605"></a>	if(g-&gt;xmax()!=unset) xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line2606"></a>	if(g-&gt;ymin()!=unset) yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line2607"></a>	if(g-&gt;ymax()!=unset) yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line2608"></a>
<a name="__line2609"></a>	if ( g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmax()!=unset &amp;&amp; g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymax()!=unset ) return;
<a name="__line2610"></a>
<a name="__line2611"></a>	double xmin=unset;
<a name="__line2612"></a>	double xmax=unset;
<a name="__line2613"></a>	double ymin=unset;
<a name="__line2614"></a>	double ymax=unset;
<a name="__line2615"></a>
<a name="__line2616"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line2617"></a>	{
<a name="__line2618"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line2619"></a>	    const var x1orig_var = getx1.eval(*(g-&gt;get(i)));
<a name="__line2620"></a>	    const var x2orig_var = getx2.eval(*(g-&gt;get(i)));
<a name="__line2621"></a>	    if(ignore::it(xorig_var) || ignore::it(x1orig_var) || ignore::it(x2orig_var)) continue;
<a name="__line2622"></a>	    const double xorig = xorig_var.dbl();
<a name="__line2623"></a>	    const double x1orig = x1orig_var.dbl();
<a name="__line2624"></a>	    const double x2orig = x2orig_var.dbl();
<a name="__line2625"></a>	    if(xaxis-&gt;logscale() &amp;&amp; !(xorig&gt;0.0)) continue;
<a name="__line2626"></a>	    if((g-&gt;xmin()!=unset &amp;&amp; xorig&lt;g-&gt;xmin()) || (g-&gt;xmax()!=unset &amp;&amp; xorig&gt;g-&gt;xmax())) continue;
<a name="__line2627"></a>	    if(xmin==unset &amp;&amp; xmax==unset) { xmin = xorig; xmax=xorig; }
<a name="__line2628"></a>	    if(xorig &lt; xmin) xmin = xorig;
<a name="__line2629"></a>	    if(xorig &gt; xmax) xmax = xorig;
<a name="__line2630"></a>	    if(x2orig &gt; xmax) xmax = x2orig;
<a name="__line2631"></a>	    if( !(xaxis-&gt;logscale() &amp;&amp; !(x1orig&gt;0.0)) ) { if(x1orig &lt; xmin) xmin = x1orig; }
<a name="__line2632"></a>
<a name="__line2633"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line2634"></a>	    const var y1orig_var = gety1.eval(*(g-&gt;get(i)));
<a name="__line2635"></a>	    const var y2orig_var = gety2.eval(*(g-&gt;get(i)));
<a name="__line2636"></a>	    if(ignore::it(yorig_var) || ignore::it(y1orig_var) || ignore::it(y2orig_var)) continue;
<a name="__line2637"></a>	    const double yorig = yorig_var.dbl();
<a name="__line2638"></a>	    const double y1orig = y1orig_var.dbl();
<a name="__line2639"></a>	    const double y2orig = y2orig_var.dbl();
<a name="__line2640"></a>	    if(yaxis-&gt;logscale() &amp;&amp; !(yorig&gt;0.0)) continue;
<a name="__line2641"></a>	    if((g-&gt;ymin()!=unset &amp;&amp; yorig&lt;g-&gt;ymin()) || (g-&gt;ymax()!=unset &amp;&amp; yorig&gt;g-&gt;ymax())) continue;
<a name="__line2642"></a>	    if(ymin==unset &amp;&amp; ymax==unset) { ymin = yorig; ymax=yorig; }
<a name="__line2643"></a>	    if(yorig &lt; ymin) ymin = yorig;
<a name="__line2644"></a>	    if(yorig &gt; ymax) ymax = yorig;
<a name="__line2645"></a>	    if(y2orig &gt; ymax) ymax = y2orig;
<a name="__line2646"></a>	    if( !(yaxis-&gt;logscale() &amp;&amp; !(y1orig&gt;0.0)) ) { if(y1orig &lt; ymin) ymin = y1orig; }
<a name="__line2647"></a>
<a name="__line2648"></a>	}
<a name="__line2649"></a>	if(g-&gt;xmin()==unset &amp;&amp; xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line2650"></a>	if(g-&gt;xmax()==unset &amp;&amp; xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line2651"></a>	if(g-&gt;ymin()==unset &amp;&amp; ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line2652"></a>	if(g-&gt;ymax()==unset &amp;&amp; ymax!=unset) yaxis-&gt;extend_range(ymax);
<a name="__line2653"></a>    }
<a name="__line2654"></a>
<a name="__line2655"></a>    void errorbars::draw(plottable *g,frame *f,terminal *t)
<a name="__line2656"></a>    {
<a name="__line2657"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line2658"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line2659"></a>
<a name="__line2660"></a>	double xmin = xaxis-&gt;min();
<a name="__line2661"></a>	if(g-&gt;xmin() != unset) xmin = ::max(xmin, g-&gt;xmin());
<a name="__line2662"></a>
<a name="__line2663"></a>	double xmax = xaxis-&gt;max();
<a name="__line2664"></a>	if(g-&gt;xmax() != unset) xmax = ::min(xmax, g-&gt;xmax());
<a name="__line2665"></a>
<a name="__line2666"></a>	double ymin = yaxis-&gt;min();
<a name="__line2667"></a>	if(g-&gt;ymin() != unset) ymin = ::max(ymin, g-&gt;ymin());
<a name="__line2668"></a>
<a name="__line2669"></a>	double ymax = yaxis-&gt;max();
<a name="__line2670"></a>	if(g-&gt;ymax() != unset) ymax = ::min(ymax, g-&gt;ymax());
<a name="__line2671"></a>
<a name="__line2672"></a>	t-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line2673"></a>	t-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line2674"></a>
<a name="__line2675"></a>	bool call_noclip = false;
<a name="__line2676"></a>	if(clip_errorbars_)
<a name="__line2677"></a>	{
<a name="__line2678"></a>	    if(t-&gt;clip(terminal::coord(terminal::id(xaxis-&gt;map_point(xmin),1),
<a name="__line2679"></a>				       terminal::id(yaxis-&gt;map_point(ymin),2)),
<a name="__line2680"></a>		       terminal::coord(terminal::id(xaxis-&gt;map_point(xmax),1),
<a name="__line2681"></a>				       terminal::id(yaxis-&gt;map_point(ymax),2))))
<a name="__line2682"></a>	    {
<a name="__line2683"></a>		call_noclip = true;
<a name="__line2684"></a>	    }
<a name="__line2685"></a>	    else
<a name="__line2686"></a>	    {
<a name="__line2687"></a>		warning::print("This terminal does not support clipping, you might see something different from what you expect",
<a name="__line2688"></a>			       "errorbars::draw(...)");
<a name="__line2689"></a>	    }
<a name="__line2690"></a>	}
<a name="__line2691"></a>
<a name="__line2692"></a>	function getx, getx1, getx2, gety, gety1, gety2;
<a name="__line2693"></a>	get_functions(g,getx, getx1, getx2, gety, gety1, gety2);
<a name="__line2694"></a>
<a name="__line2695"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line2696"></a>	{
<a name="__line2697"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i))); 
<a name="__line2698"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i))); 
<a name="__line2699"></a>	    if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line2700"></a>
<a name="__line2701"></a>	    const double xorig = xorig_var.dbl();
<a name="__line2702"></a>	    const double yorig = yorig_var.dbl();
<a name="__line2703"></a>
<a name="__line2704"></a>	    if(clip_points_)
<a name="__line2705"></a>	    {
<a name="__line2706"></a>		if(xorig &lt; xmin || xmax &lt; xorig) continue;
<a name="__line2707"></a>		if(yorig &lt; ymin || ymax &lt; yorig) continue;
<a name="__line2708"></a>	    }
<a name="__line2709"></a>
<a name="__line2710"></a>	    if(xaxis-&gt;logscale() &amp;&amp; xorig &lt;= 0) continue;
<a name="__line2711"></a>	    if(yaxis-&gt;logscale() &amp;&amp; yorig &lt;= 0) continue;
<a name="__line2712"></a>
<a name="__line2713"></a>	    double x_m = xaxis-&gt;map_point(xorig);
<a name="__line2714"></a>	    double x1_m=-0.1,x2_m=1.1;
<a name="__line2715"></a>	    if(x_)
<a name="__line2716"></a>	    {
<a name="__line2717"></a>		var x1_var = getx1.eval(*(g-&gt;get(i)));
<a name="__line2718"></a>		var x2_var = getx2.eval(*(g-&gt;get(i)));
<a name="__line2719"></a>		if(ignore::it(x1_var) || ignore::it(x2_var)) continue;
<a name="__line2720"></a>		double x1=x1_var.dbl();
<a name="__line2721"></a>		double x2=x2_var.dbl();
<a name="__line2722"></a>
<a name="__line2723"></a>		if(x1 &gt; xorig)
<a name="__line2724"></a>		{
<a name="__line2725"></a>		    warning::print("Lower edge of x-errorbar larger than the point itself. Correcting",
<a name="__line2726"></a>				   "errorbars::draw(...)");
<a name="__line2727"></a>		    x1 = xorig;
<a name="__line2728"></a>		}
<a name="__line2729"></a>		if(x2 &lt; xorig)
<a name="__line2730"></a>		{
<a name="__line2731"></a>		    warning::print("Upper edge of x-errorbar smaller than the point itself. Correcting",
<a name="__line2732"></a>				   "errorbars::draw(...)");
<a name="__line2733"></a>		    x2 = xorig;
<a name="__line2734"></a>		}
<a name="__line2735"></a>
<a name="__line2736"></a>		if(!xaxis-&gt;logscale())
<a name="__line2737"></a>		{
<a name="__line2738"></a>		    x1_m = xaxis-&gt;map_point(x1);
<a name="__line2739"></a>		    x2_m = xaxis-&gt;map_point(x2);
<a name="__line2740"></a>		}
<a name="__line2741"></a>		else
<a name="__line2742"></a>		{
<a name="__line2743"></a>		    if(x1 &gt; 0) x1_m = xaxis-&gt;map_point(x1);
<a name="__line2744"></a>		    else x1_m = 0;
<a name="__line2745"></a>		    if(x2 &gt; 0) x2_m = xaxis-&gt;map_point(x2);
<a name="__line2746"></a>		    else x2_m = 0;
<a name="__line2747"></a>		}
<a name="__line2748"></a>	    }
<a name="__line2749"></a>
<a name="__line2750"></a>	    double y_m = yaxis-&gt;map_point(yorig);
<a name="__line2751"></a>	    double y1_m=-0.1,y2_m=1.1;
<a name="__line2752"></a>	    if(y_)
<a name="__line2753"></a>	    {
<a name="__line2754"></a>		var y1_var = gety1.eval(*(g-&gt;get(i)));
<a name="__line2755"></a>		var y2_var = gety2.eval(*(g-&gt;get(i)));
<a name="__line2756"></a>		if(ignore::it(y1_var) || ignore::it(y2_var)) continue;
<a name="__line2757"></a>		double y1=y1_var.dbl();
<a name="__line2758"></a>		double y2=y2_var.dbl();
<a name="__line2759"></a>
<a name="__line2760"></a>		if(y1 &gt; yorig)
<a name="__line2761"></a>		{
<a name="__line2762"></a>		    warning::print("Lower edge of y-errorbar larger than the point itself. Correcting",
<a name="__line2763"></a>				   "errorbars::draw(...)");
<a name="__line2764"></a>		    y1 = yorig;
<a name="__line2765"></a>		}
<a name="__line2766"></a>		if(y2 &lt; yorig)
<a name="__line2767"></a>		{
<a name="__line2768"></a>		    warning::print("Upper edge of y-errorbar smaller than the point itself. Correcting",
<a name="__line2769"></a>				   "errorbars::draw(...)");
<a name="__line2770"></a>		    y2 = yorig;
<a name="__line2771"></a>		}
<a name="__line2772"></a>
<a name="__line2773"></a>		if(!yaxis-&gt;logscale())
<a name="__line2774"></a>		{
<a name="__line2775"></a>		    y1_m = yaxis-&gt;map_point(y1);
<a name="__line2776"></a>		    y2_m = yaxis-&gt;map_point(y2);
<a name="__line2777"></a>		}
<a name="__line2778"></a>		else
<a name="__line2779"></a>		{
<a name="__line2780"></a>		    if(y1 &gt; 0) y1_m = yaxis-&gt;map_point(y1);
<a name="__line2781"></a>		    else y1_m = 0;
<a name="__line2782"></a>		    if(y2 &gt; 0) y2_m = yaxis-&gt;map_point(y2);
<a name="__line2783"></a>		    else y2_m = 0;
<a name="__line2784"></a>		}
<a name="__line2785"></a>	    }
<a name="__line2786"></a>
<a name="__line2787"></a>	    t-&gt;set_color(g-&gt;linecolor());
<a name="__line2788"></a>            int i1 = t-&gt;newlength();
<a name="__line2789"></a>            int i2 = t-&gt;newlength();
<a name="__line2790"></a>	    if(x_)
<a name="__line2791"></a>	    {
<a name="__line2792"></a>		t-&gt;draw_line(terminal::coord(terminal::id(x1_m,1),terminal::id(y_m,2)),
<a name="__line2793"></a>			     terminal::coord(terminal::id(x2_m,1),terminal::id(y_m,2)));
<a name="__line2794"></a>                t-&gt;overwrite(i1,1,terminal::id(y_m,2),-0.5,endmarker_size_.termspecific_id());
<a name="__line2795"></a>                t-&gt;overwrite(i2,1,terminal::id(y_m,2),+0.5,endmarker_size_.termspecific_id());
<a name="__line2796"></a>                t-&gt;draw_line(terminal::coord(terminal::id(x1_m,1),terminal::id(i1)),
<a name="__line2797"></a>                             terminal::coord(terminal::id(x1_m,1),terminal::id(i2)));
<a name="__line2798"></a>                t-&gt;draw_line(terminal::coord(terminal::id(x2_m,1),terminal::id(i1)),
<a name="__line2799"></a>                             terminal::coord(terminal::id(x2_m,1),terminal::id(i2)));
<a name="__line2800"></a>	    }
<a name="__line2801"></a>	    if(y_)
<a name="__line2802"></a>	    {
<a name="__line2803"></a>		t-&gt;draw_line(terminal::coord(terminal::id(x_m,1),terminal::id(y1_m,2)),
<a name="__line2804"></a>			     terminal::coord(terminal::id(x_m,1),terminal::id(y2_m,2)));
<a name="__line2805"></a>                t-&gt;overwrite(i1,1,terminal::id(x_m,1),-0.5,endmarker_size_.termspecific_id());
<a name="__line2806"></a>                t-&gt;overwrite(i2,1,terminal::id(x_m,1),+0.5,endmarker_size_.termspecific_id());
<a name="__line2807"></a>                t-&gt;draw_line(terminal::coord(terminal::id(i1),terminal::id(y1_m,2)),
<a name="__line2808"></a>                             terminal::coord(terminal::id(i2),terminal::id(y1_m,2)));
<a name="__line2809"></a>                t-&gt;draw_line(terminal::coord(terminal::id(i1),terminal::id(y2_m,2)),
<a name="__line2810"></a>                             terminal::coord(terminal::id(i2),terminal::id(y2_m,2)));
<a name="__line2811"></a>	    }
<a name="__line2812"></a>		
<a name="__line2813"></a>	    if(g-&gt;pointtype())
<a name="__line2814"></a>	    {
<a name="__line2815"></a>		t-&gt;set_color(g-&gt;pointcolor());
<a name="__line2816"></a>		t-&gt;translate(terminal::id(x_m,1), terminal::id(y_m,2));
<a name="__line2817"></a>		g-&gt;pointtype()-&gt;draw(t);
<a name="__line2818"></a>		t-&gt;reset_transformation();
<a name="__line2819"></a>	    }
<a name="__line2820"></a>	}
<a name="__line2821"></a>	if(call_noclip) t-&gt;noclip();
<a name="__line2822"></a>    }
<a name="__line2823"></a>
<a name="__line2824"></a>    void errorbars::draw_sample(const length &amp;x,const length &amp;y,const length &amp;size,
<a name="__line2825"></a>				const plottable *style, terminal *t)
<a name="__line2826"></a>    {
<a name="__line2827"></a>	t-&gt;set_color(style-&gt;linecolor());
<a name="__line2828"></a>	t-&gt;set_linewidth(style-&gt;linewidth().termspecific_id());
<a name="__line2829"></a>	t-&gt;set_linestyle(style-&gt;linestyle());
<a name="__line2830"></a>
<a name="__line2831"></a>	length l1 = !x - 0.5*!size;
<a name="__line2832"></a>	length l2 = !x + 0.5*!size;
<a name="__line2833"></a>
<a name="__line2834"></a>	l1.specialize(t);
<a name="__line2835"></a>	l2.specialize(t);
<a name="__line2836"></a>
<a name="__line2837"></a>	t-&gt;draw_line(terminal::coord(l1.termspecific_id(), y.termspecific_id()),
<a name="__line2838"></a>		     terminal::coord(l2.termspecific_id(), y.termspecific_id()));
<a name="__line2839"></a>
<a name="__line2840"></a>	if(style-&gt;pointtype())
<a name="__line2841"></a>	{
<a name="__line2842"></a>	    t-&gt;set_color(style-&gt;pointcolor());
<a name="__line2843"></a>	    t-&gt;translate(x.termspecific_id(), y.termspecific_id());
<a name="__line2844"></a>	    style-&gt;pointtype()-&gt;draw(t);
<a name="__line2845"></a>	    t-&gt;reset_transformation();
<a name="__line2846"></a>	}
<a name="__line2847"></a>    }
<a name="__line2848"></a>
<a name="__line2849"></a>    errorbars &amp;errorbars::clip_points(bool f)
<a name="__line2850"></a>    {
<a name="__line2851"></a>	clip_points_ = f;
<a name="__line2852"></a>	return *this;
<a name="__line2853"></a>    }
<a name="__line2854"></a>
<a name="__line2855"></a>    errorbars &amp;errorbars::clip_errorbars(bool f)
<a name="__line2856"></a>    {
<a name="__line2857"></a>	clip_errorbars_ = f;
<a name="__line2858"></a>	return *this;
<a name="__line2859"></a>    }
<a name="__line2860"></a>
<a name="__line2861"></a>    
<a name="__line2862"></a>
<a name="__line2863"></a>    graph_drawer *errorbars::clone() const
<a name="__line2864"></a>    {
<a name="__line2865"></a>	return new errorbars(*this);
<a name="__line2866"></a>    }
<a name="__line2867"></a>
<a name="__line2868"></a>    errorbars::errorbars(bool x,bool sx,bool y,bool sy)
<a name="__line2869"></a>    {
<a name="__line2870"></a>	x_ = x;
<a name="__line2871"></a>	symmetric_x_ = sx;
<a name="__line2872"></a>	y_ = y;
<a name="__line2873"></a>	symmetric_y_ = sy;
<a name="__line2874"></a>	clip_errorbars_ = default_clip_errorbars_;
<a name="__line2875"></a>	clip_points_    = default_clip_points_;
<a name="__line2876"></a>        endmarker_size_ = default_endmarker_size_();
<a name="__line2877"></a>    }
<a name="__line2878"></a>
<a name="__line2879"></a>    errorbars::errorbars(const errorbars &amp;rhs)
<a name="__line2880"></a>    {
<a name="__line2881"></a>	x_ = rhs.x_;
<a name="__line2882"></a>	symmetric_x_ = rhs.symmetric_x_;
<a name="__line2883"></a>	y_ = rhs.y_;
<a name="__line2884"></a>	symmetric_y_ = rhs.symmetric_y_;
<a name="__line2885"></a>	clip_errorbars_ = rhs.clip_errorbars_;
<a name="__line2886"></a>	clip_points_    = rhs.clip_points_;
<a name="__line2887"></a>        endmarker_size_ = rhs.endmarker_size_;
<a name="__line2888"></a>    }
<a name="__line2889"></a>
<a name="__line2890"></a>    void errorbars::prepare_for_draw(plottable *g, frame *, int count)
<a name="__line2891"></a>    {
<a name="__line2892"></a>	if(count==1)
<a name="__line2893"></a>	{
<a name="__line2894"></a>	    if(g-&gt;pointtype()) g-&gt;pointtype()-&gt;prepare_for_draw(g-&gt;pointsize());
<a name="__line2895"></a>	    g-&gt;linewidth().register_me();
<a name="__line2896"></a>            endmarker_size_.register_me();
<a name="__line2897"></a>	}
<a name="__line2898"></a>    }
<a name="__line2899"></a>    
<a name="__line2900"></a>
<a name="__line2901"></a>    <span class=comment>// ---------- graphd_ticlabels  ---------------------------------------------------</span>
<a name="__line2902"></a>
<a name="__line2903"></a>
<a name="__line2904"></a>    ticlabels::ticlabels(bool x, bool y,const graph_drawer &amp;d) : x_(x), y_(y)
<a name="__line2905"></a>    {
<a name="__line2906"></a>	drawer_ = d.clone();
<a name="__line2907"></a>    }
<a name="__line2908"></a>
<a name="__line2909"></a>    ticlabels::ticlabels(const ticlabels &amp;rhs)
<a name="__line2910"></a>    {
<a name="__line2911"></a>	x_ = rhs.x_;
<a name="__line2912"></a>	y_ = rhs.y_;
<a name="__line2913"></a>	drawer_ = rhs.drawer_-&gt;clone();
<a name="__line2914"></a>    }
<a name="__line2915"></a>
<a name="__line2916"></a>    ticlabels ticlabels::operator() (const graph_drawer &amp;d)
<a name="__line2917"></a>    {
<a name="__line2918"></a>	if(drawer_) cerr&lt;&lt;"drawer_ should be deleted in ticlabels::operator()"&lt;&lt;endl;
<a name="__line2919"></a>	drawer_ = d.clone();
<a name="__line2920"></a>	return *this;
<a name="__line2921"></a>    }
<a name="__line2922"></a>
<a name="__line2923"></a>    void ticlabels::set_ranges(plottable *g, axis *xaxis, axis *yaxis)
<a name="__line2924"></a>    {
<a name="__line2925"></a>	if(drawer_ == 0)
<a name="__line2926"></a>	{
<a name="__line2927"></a>	    cerr&lt;&lt;"This should not happen: drawer_ = 0 in ticlabels::set_ranges(...)"&lt;&lt;endl;
<a name="__line2928"></a>	    exit(1);
<a name="__line2929"></a>	}
<a name="__line2930"></a>
<a name="__line2931"></a>	drawer_-&gt;set_ranges(g,xaxis,yaxis);
<a name="__line2932"></a>
<a name="__line2933"></a>	<span class=comment>// set the tic labels first</span>
<a name="__line2934"></a>
<a name="__line2935"></a>	vector&lt;double&gt; xtic_pos, ytic_pos;
<a name="__line2936"></a>	vector&lt;var&gt;    xtic_lab, ytic_lab;
<a name="__line2937"></a>
<a name="__line2938"></a>	function getx = drawer_-&gt;get_x(g);
<a name="__line2939"></a>	function gety = drawer_-&gt;get_y(g);
<a name="__line2940"></a>	function getxl = 0;
<a name="__line2941"></a>	function getyl = 0;
<a name="__line2942"></a>	if(x_)
<a name="__line2943"></a>	{
<a name="__line2944"></a>	    if(g-&gt;columns() &lt; drawer_-&gt;req_components()+1)
<a name="__line2945"></a>	    {
<a name="__line2946"></a>		warning::print("Graph has too few columns, using x values as xlabels",
<a name="__line2947"></a>			       "ticlabels::set_scale");
<a name="__line2948"></a>		getxl = getx;
<a name="__line2949"></a>	    }
<a name="__line2950"></a>	    else
<a name="__line2951"></a>	    {
<a name="__line2952"></a>		getxl = ARG(drawer_-&gt;req_components()+1);
<a name="__line2953"></a>	    }
<a name="__line2954"></a>
<a name="__line2955"></a>	    if(y_)
<a name="__line2956"></a>	    {
<a name="__line2957"></a>		if(g-&gt;columns() &lt; drawer_-&gt;req_components()+2)
<a name="__line2958"></a>		{
<a name="__line2959"></a>		    warning::print("Graph has too few columns, using y values as ylabels",
<a name="__line2960"></a>				   "ticlabels::set_scale");
<a name="__line2961"></a>		    getyl = gety;
<a name="__line2962"></a>		}
<a name="__line2963"></a>		else
<a name="__line2964"></a>		{
<a name="__line2965"></a>		    getyl = ARG(drawer_-&gt;req_components()+2);
<a name="__line2966"></a>		}
<a name="__line2967"></a>	    }
<a name="__line2968"></a>	}
<a name="__line2969"></a>	else
<a name="__line2970"></a>	{
<a name="__line2971"></a>	    if(g-&gt;columns() &lt; drawer_-&gt;req_components()+1)
<a name="__line2972"></a>	    {
<a name="__line2973"></a>		warning::print("Graph has too few colums, using y values as ylabels",
<a name="__line2974"></a>			       "ticlabels::set_scale");
<a name="__line2975"></a>		getyl = gety;
<a name="__line2976"></a>	    }
<a name="__line2977"></a>	    else
<a name="__line2978"></a>	    {
<a name="__line2979"></a>		getyl = ARG(drawer_-&gt;req_components()+1);
<a name="__line2980"></a>	    }
<a name="__line2981"></a>	}
<a name="__line2982"></a>
<a name="__line2983"></a>	double xmin = xaxis-&gt;min();
<a name="__line2984"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line2985"></a>	double xmax = xaxis-&gt;max();
<a name="__line2986"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line2987"></a>
<a name="__line2988"></a>	double ymin = yaxis-&gt;min();
<a name="__line2989"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line2990"></a>	double ymax = yaxis-&gt;max();
<a name="__line2991"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line2992"></a>
<a name="__line2993"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line2994"></a>	{
<a name="__line2995"></a>	    const var x_var = getx.eval(*(g-&gt;get(i)));
<a name="__line2996"></a>	    if ( ignore::it(x_var) ) continue;
<a name="__line2997"></a>	    const double x = x_var.dbl(); 
<a name="__line2998"></a>	    if ( xaxis-&gt;logscale() &amp;&amp; !(x&gt;0.0) ) continue;
<a name="__line2999"></a>	    if ( x&lt;xmin || x&gt;xmax ) continue;
<a name="__line3000"></a>	    const var y_var = gety.eval(*(g-&gt;get(i)));
<a name="__line3001"></a>	    if ( ignore::it(y_var) ) continue;
<a name="__line3002"></a>	    const double y = y_var.dbl(); 
<a name="__line3003"></a>	    if ( yaxis-&gt;logscale() &amp;&amp; !(y&gt;0.0) ) continue;
<a name="__line3004"></a>	    if ( y&lt;ymin || y&gt;ymax ) continue;
<a name="__line3005"></a>
<a name="__line3006"></a>	    if(x_)
<a name="__line3007"></a>	    {
<a name="__line3008"></a>		var label = getxl.eval(*(g-&gt;get(i)));
<a name="__line3009"></a>		bool already_put = false;
<a name="__line3010"></a>		for(unsigned int i=0; i&lt;xtic_pos.size(); ++i)
<a name="__line3011"></a>		{
<a name="__line3012"></a>		    if(xtic_pos[i] == x &amp;&amp; xtic_lab[i].str() == label.str())
<a name="__line3013"></a>		    {
<a name="__line3014"></a>			already_put = true;
<a name="__line3015"></a>			break;
<a name="__line3016"></a>		    }
<a name="__line3017"></a>		}
<a name="__line3018"></a>		if(!already_put)
<a name="__line3019"></a>		{
<a name="__line3020"></a>		    xaxis-&gt;tics(x,label);
<a name="__line3021"></a>		    xtic_pos.push_back(x);
<a name="__line3022"></a>		    xtic_lab.push_back(label);
<a name="__line3023"></a>		}
<a name="__line3024"></a>	    }
<a name="__line3025"></a>
<a name="__line3026"></a>	    if(y_)
<a name="__line3027"></a>	    {
<a name="__line3028"></a>		const double y = gety.eval(*(g-&gt;get(i))).dbl();
<a name="__line3029"></a>		var label      = getyl.eval(*(g-&gt;get(i)));
<a name="__line3030"></a>		bool already_put = false;
<a name="__line3031"></a>		for(unsigned int i=0; i&lt;ytic_pos.size(); ++i)
<a name="__line3032"></a>		{
<a name="__line3033"></a>		    if(ytic_pos[i] == y &amp;&amp; ytic_lab[i].str() == label.str())
<a name="__line3034"></a>		    {
<a name="__line3035"></a>			already_put = true;
<a name="__line3036"></a>			break;
<a name="__line3037"></a>		    }
<a name="__line3038"></a>		}
<a name="__line3039"></a>		if(!already_put)
<a name="__line3040"></a>		{
<a name="__line3041"></a>		    yaxis-&gt;tics(y,label);
<a name="__line3042"></a>		    ytic_pos.push_back(y);
<a name="__line3043"></a>		    ytic_lab.push_back(label);
<a name="__line3044"></a>		}
<a name="__line3045"></a>	    }
<a name="__line3046"></a>	}
<a name="__line3047"></a>    }
<a name="__line3048"></a>
<a name="__line3049"></a>    void ticlabels::draw(plottable *g, frame *f, terminal *t)
<a name="__line3050"></a>    {
<a name="__line3051"></a>	drawer_-&gt;draw(g,f,t);
<a name="__line3052"></a>    }
<a name="__line3053"></a>
<a name="__line3054"></a>    void ticlabels::draw_sample(const length &amp;x, const length &amp;y,
<a name="__line3055"></a>				const length &amp;size, const plottable *style, terminal *t)
<a name="__line3056"></a>    {
<a name="__line3057"></a>	drawer_-&gt;draw_sample(x,y,size,style,t);
<a name="__line3058"></a>    }
<a name="__line3059"></a>
<a name="__line3060"></a>    graph_drawer *ticlabels::clone() const
<a name="__line3061"></a>    {
<a name="__line3062"></a>	return new ticlabels(*this);
<a name="__line3063"></a>    }
<a name="__line3064"></a>
<a name="__line3065"></a>    void ticlabels::prepare_for_draw(plottable *g, frame *f, int count)
<a name="__line3066"></a>    {
<a name="__line3067"></a>	if(count==1) drawer_-&gt;prepare_for_draw(g,f,count);
<a name="__line3068"></a>    }
<a name="__line3069"></a>
<a name="__line3070"></a>    int ticlabels::req_components() const
<a name="__line3071"></a>    {
<a name="__line3072"></a>	<span class=comment>// Since the ticlabels drawstyle uses the x/y values,</span>
<a name="__line3073"></a>	<span class=comment>// if no extra colums are provided, therefore it return</span>
<a name="__line3074"></a>	<span class=comment>// the same number of required columns as the wrapped drawstyle</span>
<a name="__line3075"></a>	return drawer_-&gt;req_components();
<a name="__line3076"></a>    }
<a name="__line3077"></a>
<a name="__line3078"></a>
<a name="__line3079"></a>    <span class=comment>// ---------- graphd_colorscale ---------------------------------------------------</span>
<a name="__line3080"></a>
<a name="__line3081"></a>
<a name="__line3082"></a>    graphd_colorscale &amp;graphd_colorscale::draw_colorlegend(bool f)
<a name="__line3083"></a>    {
<a name="__line3084"></a>	if(f) draw_colorlegend_ = 2;
<a name="__line3085"></a>	else draw_colorlegend_ = 1;
<a name="__line3086"></a>	return *this;
<a name="__line3087"></a>    }
<a name="__line3088"></a>
<a name="__line3089"></a>    graphd_colorscale &amp;graphd_colorscale::color_min(double v)
<a name="__line3090"></a>    {
<a name="__line3091"></a>	color_min_ = v;
<a name="__line3092"></a>	if(color_min_ == unset) color_min_fixed_ = false;
<a name="__line3093"></a>	else color_min_fixed_ = true;
<a name="__line3094"></a>	return *this;
<a name="__line3095"></a>    }
<a name="__line3096"></a>    graphd_colorscale &amp;graphd_colorscale::color_max(double v)
<a name="__line3097"></a>    {
<a name="__line3098"></a>	color_max_ = v;
<a name="__line3099"></a>	if(color_max_ == unset) color_max_fixed_ = false;
<a name="__line3100"></a>	else color_max_fixed_ = true;
<a name="__line3101"></a>	return *this; 
<a name="__line3102"></a>    }
<a name="__line3103"></a>
<a name="__line3104"></a>    graphd_colorscale &amp;graphd_colorscale::color_range(double min, double max)
<a name="__line3105"></a>    {
<a name="__line3106"></a>	color_min(min);
<a name="__line3107"></a>	color_max(max);
<a name="__line3108"></a>	return *this;
<a name="__line3109"></a>    }
<a name="__line3110"></a>
<a name="__line3111"></a>    graphd_colorscale &amp;graphd_colorscale::color_range(const color &amp;startcolor, const color &amp;endcolor)
<a name="__line3112"></a>    {
<a name="__line3113"></a>        if(color_mapping_) delete color_mapping_;
<a name="__line3114"></a>        color_mapping_ = new color_mapping_interpolated({startcolor,endcolor});
<a name="__line3115"></a>	return *this; 
<a name="__line3116"></a>    }
<a name="__line3117"></a>
<a name="__line3118"></a>    void graphd_colorscale::set_colorlegend(color_legend *l)
<a name="__line3119"></a>    {
<a name="__line3120"></a>	<span class=comment>// If it has already a colorlegend, unregister myself</span>
<a name="__line3121"></a>	<span class=comment>// from that colorlegend's owners, and delete it</span>
<a name="__line3122"></a>	if(colorlegend_)
<a name="__line3123"></a>	{
<a name="__line3124"></a>	    colorlegend_-&gt;remove_owner(this);
<a name="__line3125"></a>	    if(colorlegend_-&gt;owners_.empty() &amp;&amp; colorlegend_-&gt;autodel())
<a name="__line3126"></a>		delete colorlegend_;
<a name="__line3127"></a>	    colorlegend_ = 0;
<a name="__line3128"></a>	}
<a name="__line3129"></a>
<a name="__line3130"></a>	<span class=comment>// and set now the new link</span>
<a name="__line3131"></a>	colorlegend_ = l;
<a name="__line3132"></a>	if(colorlegend_) colorlegend_-&gt;owners_.push_back(this);
<a name="__line3133"></a>    }
<a name="__line3134"></a>
<a name="__line3135"></a>    void graphd_colorscale::setup_when_added(plottable *p, frame *f)
<a name="__line3136"></a>    {
<a name="__line3137"></a>	<span class=comment>// If the colorlegend has already been specified, we have</span>
<a name="__line3138"></a>	<span class=comment>// nothing to do here...</span>
<a name="__line3139"></a>	if(colorlegend_ != 0) return;
<a name="__line3140"></a>
<a name="__line3141"></a>	if(!f || !p) return;
<a name="__line3142"></a>	
<a name="__line3143"></a>	if(draw_colorlegend_ == 0)  <span class=comment>// do not create at all (i.e. delete it)</span>
<a name="__line3144"></a>	{
<a name="__line3145"></a>	    if(colorlegend_)
<a name="__line3146"></a>	    {
<a name="__line3147"></a>		colorlegend_-&gt;remove_owner(this);
<a name="__line3148"></a>		if(colorlegend_-&gt;owners_.empty() &amp;&amp; colorlegend_-&gt;autodel())
<a name="__line3149"></a>		    delete colorlegend_;
<a name="__line3150"></a>		colorlegend_ = 0;
<a name="__line3151"></a>	    }
<a name="__line3152"></a>	    return;
<a name="__line3153"></a>	}
<a name="__line3154"></a>
<a name="__line3155"></a>	<span class=comment>// If the user specified a legendname (i.e. a name identifying a legend</span>
<a name="__line3156"></a>	<span class=comment>// to be shared), first of all search for it:</span>
<a name="__line3157"></a>	if(legendname_ != "")
<a name="__line3158"></a>	{
<a name="__line3159"></a>	    <span class=comment>// Search for the topmost container, i.e. the canvas</span>
<a name="__line3160"></a>	    container *topcanvas = f;
<a name="__line3161"></a>	    for(; topcanvas-&gt;parent(); topcanvas=topcanvas-&gt;parent());
<a name="__line3162"></a>
<a name="__line3163"></a>	    <span class=comment>// If a colorlegend with this name is already present in the canvas,</span>
<a name="__line3164"></a>	    <span class=comment>// use that one, and return.</span>
<a name="__line3165"></a>	    if(color_legend *l = dynamic_cast&lt;color_legend*&gt;(topcanvas-&gt;find("colorlegend_" + legendname_)))
<a name="__line3166"></a>	    {
<a name="__line3167"></a>		colorlegend_ = l;
<a name="__line3168"></a>		colorlegend_-&gt;owners_.push_back(this);
<a name="__line3169"></a>		return;
<a name="__line3170"></a>	    }
<a name="__line3171"></a>	}
<a name="__line3172"></a>
<a name="__line3173"></a>	<span class=comment>// loop over all the graphs in the given frame</span>
<a name="__line3174"></a>	for(int i=0; i&lt;f-&gt;ngraphs(); ++i)
<a name="__line3175"></a>	{
<a name="__line3176"></a>	    plottable *g = f-&gt;get_graph(i);
<a name="__line3177"></a>
<a name="__line3178"></a>	    <span class=comment>// Check if the drawstyle of this graph is a graphd_colorscale type</span>
<a name="__line3179"></a>	    <span class=comment>// if so, share the color_legend with that graph</span>
<a name="__line3180"></a>	    if(graphd_colorscale *c = dynamic_cast&lt;graphd_colorscale*&gt;(g-&gt;drawstyle()))
<a name="__line3181"></a>	    {
<a name="__line3182"></a>		if(c-&gt;colorlegend_)
<a name="__line3183"></a>		{
<a name="__line3184"></a>		    colorlegend_ = c-&gt;colorlegend_;
<a name="__line3185"></a>		    colorlegend_-&gt;owners_.push_back(this);
<a name="__line3186"></a>		    break;
<a name="__line3187"></a>		}
<a name="__line3188"></a>	    }
<a name="__line3189"></a>	}
<a name="__line3190"></a>
<a name="__line3191"></a>	<span class=comment>// If no such graph was found, i.e. colorlegend is still 0,</span>
<a name="__line3192"></a>	<span class=comment>// create it.</span>
<a name="__line3193"></a>	if(!colorlegend_)
<a name="__line3194"></a>	{
<a name="__line3195"></a>            <span class=comment>// If we are within an mframe, check all graphs in the same row of the mframe</span>
<a name="__line3196"></a>            <span class=comment>// whether they have a colorlegend. If they do, just share it.</span>
<a name="__line3197"></a>            if(mframe *mf = dynamic_cast&lt;mframe*&gt;(f-&gt;parent()))
<a name="__line3198"></a>            {
<a name="__line3199"></a>                int row = mf-&gt;row(f);
<a name="__line3200"></a>                if(row==0) warning::print("This should never happen","graphd_colorscale::setup_when_added(...)");
<a name="__line3201"></a>                else
<a name="__line3202"></a>                {
<a name="__line3203"></a>                    for(int col=1; col&lt;=mf-&gt;ncols(); ++col)
<a name="__line3204"></a>                    {
<a name="__line3205"></a>                        for(int i=0; i&lt;(*mf)(col,row)-&gt;ngraphs(); ++i)
<a name="__line3206"></a>                        {
<a name="__line3207"></a>                            plottable *g = (*mf)(col,row)-&gt;get_graph(i);
<a name="__line3208"></a>                            if(graphd_colorscale *c = dynamic_cast&lt;graphd_colorscale*&gt;(g-&gt;drawstyle()))
<a name="__line3209"></a>                            {
<a name="__line3210"></a>                                if(c-&gt;colorlegend_)
<a name="__line3211"></a>                                {
<a name="__line3212"></a>                                    colorlegend_ = c-&gt;colorlegend_;
<a name="__line3213"></a>                                    colorlegend_-&gt;owners_.push_back(this);
<a name="__line3214"></a>                                    break;
<a name="__line3215"></a>                                }
<a name="__line3216"></a>                            }
<a name="__line3217"></a>                        }
<a name="__line3218"></a>                    }
<a name="__line3219"></a>                }
<a name="__line3220"></a>            }
<a name="__line3221"></a>        }
<a name="__line3222"></a>        if(!colorlegend_)
<a name="__line3223"></a>        {
<a name="__line3224"></a>            colorlegend_ = new color_legend(this);
<a name="__line3225"></a>            colorlegend_-&gt;autodel(true);
<a name="__line3226"></a>            f-&gt;rmarginobject(colorlegend_);
<a name="__line3227"></a>            
<a name="__line3228"></a>            <span class=comment>// if the legendname (for sharing) is specified, but it did not exist before,</span>
<a name="__line3229"></a>            <span class=comment>// then we need to set its name now.</span>
<a name="__line3230"></a>            colorlegend_-&gt;name("colorlegend_" + legendname_);
<a name="__line3231"></a>	}
<a name="__line3232"></a>    }
<a name="__line3233"></a>
<a name="__line3234"></a>    graphd_colorscale::~graphd_colorscale()
<a name="__line3235"></a>    {
<a name="__line3236"></a>	if(colorlegend_)
<a name="__line3237"></a>	{
<a name="__line3238"></a>	    <span class=comment>// Remove myself (this) from the owners of the colorlegend first</span>
<a name="__line3239"></a>	    colorlegend_-&gt;remove_owner(this);
<a name="__line3240"></a>	    
<a name="__line3241"></a>	    <span class=comment>// If there are no more owners of the colorlegend, delete it.</span>
<a name="__line3242"></a>	    if(colorlegend_-&gt;owners_.empty()) delete colorlegend_;
<a name="__line3243"></a>	}
<a name="__line3244"></a>    }
<a name="__line3245"></a>
<a name="__line3246"></a>    graphd_colorscale::graphd_colorscale()
<a name="__line3247"></a>    {
<a name="__line3248"></a>	legendname_ = "";
<a name="__line3249"></a>	colorlegend_ = 0;
<a name="__line3250"></a>	color_min_ = color_max_ = unset;
<a name="__line3251"></a>	color_min_fixed_ = color_max_fixed_ = false;
<a name="__line3252"></a>        color_mapping_ = new color_mapping_function();
<a name="__line3253"></a>	color_logscale_ = false;
<a name="__line3254"></a>	color_samples_ = 80;
<a name="__line3255"></a>	underflow_color_ = transparent;
<a name="__line3256"></a>	overflow_color_ = transparent;
<a name="__line3257"></a>	draw_colorlegend_ = 2;
<a name="__line3258"></a>    }
<a name="__line3259"></a>
<a name="__line3260"></a>    graphd_colorscale::graphd_colorscale(const graphd_colorscale &amp;rhs)
<a name="__line3261"></a>    {
<a name="__line3262"></a>	copy(rhs);
<a name="__line3263"></a>    }
<a name="__line3264"></a>    
<a name="__line3265"></a>    void graphd_colorscale::copy(const graphd_colorscale &amp;rhs)
<a name="__line3266"></a>    {
<a name="__line3267"></a>	color_min_ = rhs.color_min_;
<a name="__line3268"></a>	color_max_ = rhs.color_max_;
<a name="__line3269"></a>	color_logscale_ = rhs.color_logscale_;
<a name="__line3270"></a>	color_min_fixed_ = rhs.color_min_fixed_;
<a name="__line3271"></a>	color_max_fixed_ = rhs.color_max_fixed_;
<a name="__line3272"></a>	color_samples_ = rhs.color_samples_;
<a name="__line3273"></a>	color_mapping_ = rhs.color_mapping_-&gt;clone();
<a name="__line3274"></a>	underflow_color_ = rhs.underflow_color_;
<a name="__line3275"></a>	overflow_color_  = rhs.overflow_color_;
<a name="__line3276"></a>	color_title_ = rhs.color_title_;
<a name="__line3277"></a>	draw_colorlegend_ = rhs.draw_colorlegend_;
<a name="__line3278"></a>	colorlegend_ = rhs.colorlegend_;
<a name="__line3279"></a>	if(colorlegend_) colorlegend_-&gt;owners_.push_back(this);
<a name="__line3280"></a>	legendname_ = rhs.legendname_;
<a name="__line3281"></a>    }
<a name="__line3282"></a>
<a name="__line3283"></a>    color graphd_colorscale::map_color(double val, double mini, double maxi) const
<a name="__line3284"></a>    {
<a name="__line3285"></a>	if(color_logscale_ &amp;&amp; (val&lt;=0 || mini&lt;=0 || maxi&lt;=0))
<a name="__line3286"></a>	{
<a name="__line3287"></a>	    warning::print("Range must be positive for logscale",
<a name="__line3288"></a>			   "graphd_colorscale::map_color(...)");
<a name="__line3289"></a>	    return color(0,0,0);
<a name="__line3290"></a>	}
<a name="__line3291"></a>
<a name="__line3292"></a>	if(val &lt; mini &amp;&amp; underflow_color_ != transparent) return underflow_color_;
<a name="__line3293"></a>	if(val &gt; maxi &amp;&amp; overflow_color_  != transparent) return overflow_color_;
<a name="__line3294"></a>
<a name="__line3295"></a>	val  = (color_logscale_?::log10(val):val);
<a name="__line3296"></a>	mini = (color_logscale_?::log10(mini):mini);
<a name="__line3297"></a>	maxi = (color_logscale_?::log10(maxi):maxi);
<a name="__line3298"></a>	if(val&lt;mini) val=mini;
<a name="__line3299"></a>	if(val&gt;maxi) val=maxi;
<a name="__line3300"></a>	return color_mapping_-&gt;map(val,mini,maxi);
<a name="__line3301"></a>    }
<a name="__line3302"></a>
<a name="__line3303"></a>
<a name="__line3304"></a>
<a name="__line3305"></a>    <span class=comment>// ---------- cbox_base  ----------------------------------------------------------</span>
<a name="__line3306"></a>
<a name="__line3307"></a>    void cbox_base::init_lengths()
<a name="__line3308"></a>    {
<a name="__line3309"></a>    }
<a name="__line3310"></a>
<a name="__line3311"></a>    cbox_base::~cbox_base()
<a name="__line3312"></a>    {
<a name="__line3313"></a>    }
<a name="__line3314"></a>
<a name="__line3315"></a>    <span class=comment>// for some reason this construction does not work, the default constructor of</span>
<a name="__line3316"></a>    <span class=comment>// colorscale is called, I don't know why...</span>
<a name="__line3317"></a>    <span class=comment>//cbox_base::cbox_base(const cbox_base &amp;rhs) : colorscale((colorscale)rhs)</span>
<a name="__line3318"></a>    cbox_base::cbox_base(const cbox_base &amp;rhs)
<a name="__line3319"></a>    {
<a name="__line3320"></a>	graphd_colorscale::copy(rhs);
<a name="__line3321"></a>    }
<a name="__line3322"></a>
<a name="__line3323"></a>    cbox_base::cbox_base(void *cmapfunc)
<a name="__line3324"></a>    {
<a name="__line3325"></a>	if(cmapfunc != 0) color_mapping(cmapfunc);
<a name="__line3326"></a>	init_lengths();
<a name="__line3327"></a>    }
<a name="__line3328"></a>
<a name="__line3329"></a>    cbox_base::cbox_base(color (*cmapfunc)(double,double,double))
<a name="__line3330"></a>    {
<a name="__line3331"></a>	if(cmapfunc != 0) color_mapping(cmapfunc);
<a name="__line3332"></a>	init_lengths();
<a name="__line3333"></a>    }
<a name="__line3334"></a>
<a name="__line3335"></a>    cbox_base::cbox_base(double mini, double maxi)
<a name="__line3336"></a>    {
<a name="__line3337"></a>	color_range(mini,maxi);
<a name="__line3338"></a>	init_lengths();
<a name="__line3339"></a>    }
<a name="__line3340"></a>
<a name="__line3341"></a>    cbox_base::cbox_base(const color &amp;start, const color &amp;end)
<a name="__line3342"></a>    {
<a name="__line3343"></a>	color_range(start,end);
<a name="__line3344"></a>	init_lengths();
<a name="__line3345"></a>    }
<a name="__line3346"></a>
<a name="__line3347"></a>    cbox_base::cbox_base()
<a name="__line3348"></a>    {
<a name="__line3349"></a>	color_range(unset,unset);
<a name="__line3350"></a>	init_lengths();
<a name="__line3351"></a>    }
<a name="__line3352"></a>    
<a name="__line3353"></a>    void cbox_base::draw_sample(const length &amp;x,
<a name="__line3354"></a>				const length &amp;y,
<a name="__line3355"></a>				const length &amp;size,
<a name="__line3356"></a>				const plottable *s,
<a name="__line3357"></a>				terminal *t)
<a name="__line3358"></a>    {
<a name="__line3359"></a>	vector&lt;terminal::coord&gt; c;
<a name="__line3360"></a>	length l1 = !x - 0.5*!size;
<a name="__line3361"></a>	length l2 = !x + 0.5*!size;
<a name="__line3362"></a>	l1.specialize(t);
<a name="__line3363"></a>	l2.specialize(t);
<a name="__line3364"></a>	int nsample=(color_samples()&gt;10 ? 10 : color_samples());
<a name="__line3365"></a>	for ( int i=0 ; i&lt;nsample ; ++i )
<a name="__line3366"></a>	{
<a name="__line3367"></a>	    double val = 0.0 + (1.0-0.0)/nsample*(i+1);
<a name="__line3368"></a>	    color the_color = map_color(val,0.0,1.0);
<a name="__line3369"></a>	    length l3 = !y - 0.5*0.8*EM + 0.8*(double)i/nsample*EM;
<a name="__line3370"></a>	    length l4 = !y - 0.5*0.8*EM + 0.8*(double)(i+1)/nsample*EM;
<a name="__line3371"></a>	    l3.specialize(t);
<a name="__line3372"></a>	    l4.specialize(t);
<a name="__line3373"></a>	    c.clear();
<a name="__line3374"></a>	    c.push_back(terminal::coord(l1.termspecific_id(),l3.termspecific_id()));
<a name="__line3375"></a>	    c.push_back(terminal::coord(l2.termspecific_id(),l3.termspecific_id()));
<a name="__line3376"></a>	    c.push_back(terminal::coord(l2.termspecific_id(),l4.termspecific_id()));
<a name="__line3377"></a>	    c.push_back(terminal::coord(l1.termspecific_id(),l4.termspecific_id()));
<a name="__line3378"></a>	    c.push_back(terminal::coord(l1.termspecific_id(),l3.termspecific_id()));
<a name="__line3379"></a>	    t-&gt;set_color(the_color);
<a name="__line3380"></a>	    t-&gt;fill_polygon(c);
<a name="__line3381"></a>	}
<a name="__line3382"></a>    }
<a name="__line3383"></a>
<a name="__line3384"></a>    <span class=comment>// ---------- graphd_cbox  --------------------------------------------------------</span>
<a name="__line3385"></a>
<a name="__line3386"></a><span class=comment>/*
<a name="__line3387"></a>  bool cboxes::default_frame_foreground_ = true;
<a name="__line3388"></a>  bool cboxes::default_grid_foreground_ = false;
<a name="__line3389"></a>
<a name="__line3390"></a>  cboxes &amp;cboxes::legend(color_legend *l)
<a name="__line3391"></a>  {
<a name="__line3392"></a>  draw_clegend_ = 2;
<a name="__line3393"></a>  set_clegend(l);
<a name="__line3394"></a>  return *this; 
<a name="__line3395"></a>  }
<a name="__line3396"></a>
<a name="__line3397"></a>  cboxes &amp;cboxes::legend(const var &amp;legendname)
<a name="__line3398"></a>  {
<a name="__line3399"></a>  legendname_ = legendname.str();
<a name="__line3400"></a>  return *this;
<a name="__line3401"></a>  }
<a name="__line3402"></a>
<a name="__line3403"></a>
<a name="__line3404"></a>  void cboxes::prepare_for_draw(plottable *g, frame *f, int count)
<a name="__line3405"></a>  {
<a name="__line3406"></a>  if(global::debug&gt;0) cout&lt;&lt;"[blop] [cboxes] prepare_for_draw starts... pass="&lt;&lt;count&lt;&lt;endl;
<a name="__line3407"></a>  if(count==1)
<a name="__line3408"></a>  {
<a name="__line3409"></a>  if(frame_foreground_) f-&gt;foreground(true);
<a name="__line3410"></a>  if(grid_foreground_) f-&gt;grid_foreground(true);
<a name="__line3411"></a>	    
<a name="__line3412"></a>  axis *xaxis =
<a name="__line3413"></a>  (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line3414"></a>  axis *yaxis =
<a name="__line3415"></a>  (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line3416"></a>	    
<a name="__line3417"></a>  calc(g,xaxis,yaxis);
<a name="__line3418"></a>  if(colorlegend_)
<a name="__line3419"></a>  {
<a name="__line3420"></a>  colorlegend_-&gt;clear_tics();
<a name="__line3421"></a>  if(draw_clegend_&lt;2) colorlegend_-&gt;off(); // Switch it off
<a name="__line3422"></a>  if(ctitle_.str()!="")
<a name="__line3423"></a>  {
<a name="__line3424"></a>  var new_title = colorlegend_-&gt;title();
<a name="__line3425"></a>  if(new_title.str() != "") new_title &amp;= ", ";
<a name="__line3426"></a>  new_title &amp;= ctitle_;
<a name="__line3427"></a>  colorlegend_-&gt;title(new_title);
<a name="__line3428"></a>  }
<a name="__line3429"></a>  }
<a name="__line3430"></a>  }
<a name="__line3431"></a>
<a name="__line3432"></a>  if(count==2)
<a name="__line3433"></a>  {
<a name="__line3434"></a>  // Let the colorlegend calculate the unified range for all
<a name="__line3435"></a>  // of its graphs
<a name="__line3436"></a>  if(colorlegend_)
<a name="__line3437"></a>  {
<a name="__line3438"></a>  colorlegend_-&gt;calculate_tics();
<a name="__line3439"></a>  if(draw_clegend_&gt;=2) colorlegend_-&gt;on();  // if any of the graphs have legend on...
<a name="__line3440"></a>  }
<a name="__line3441"></a>  }
<a name="__line3442"></a>  if(global::debug&gt;0) cout&lt;&lt;"[blop] [boxes] prepare_for_draw finished."&lt;&lt;endl;
<a name="__line3443"></a>  }
<a name="__line3444"></a>
<a name="__line3445"></a>  cboxes::cboxes(const cboxes &amp;rhs) : cbox_base(rhs)
<a name="__line3446"></a>  {
<a name="__line3447"></a>  dx_=rhs.dx_;
<a name="__line3448"></a>  dy_=rhs.dy_;
<a name="__line3449"></a>  frame_foreground_ = rhs.frame_foreground_;
<a name="__line3450"></a>  grid_foreground_  = rhs.grid_foreground_;
<a name="__line3451"></a>  skip_outrange_ = rhs.skip_outrange_;
<a name="__line3452"></a>  }
<a name="__line3453"></a>
<a name="__line3454"></a>  cboxes::cboxes(void *p) : cbox_base(p) {}
<a name="__line3455"></a>  cboxes::cboxes(color (*p)(double,double,double)) : cbox_base(p) {}
<a name="__line3456"></a>
<a name="__line3457"></a>  cboxes::cboxes(double mini, double maxi) : cbox_base(mini, maxi)
<a name="__line3458"></a>  {
<a name="__line3459"></a>  dx_ = dy_ = unset;
<a name="__line3460"></a>  frame_foreground_ = default_frame_foreground_;
<a name="__line3461"></a>  grid_foreground_  = default_grid_foreground_;
<a name="__line3462"></a>  skip_outrange_ = true;
<a name="__line3463"></a>  }
<a name="__line3464"></a>
<a name="__line3465"></a>  cboxes::cboxes(const color &amp;start, const color &amp;end) : cbox_base(start,end)
<a name="__line3466"></a>  {
<a name="__line3467"></a>  dx_ = dy_ = unset;
<a name="__line3468"></a>  frame_foreground_ = default_frame_foreground_;
<a name="__line3469"></a>  grid_foreground_  = default_grid_foreground_;
<a name="__line3470"></a>  skip_outrange_ = true;
<a name="__line3471"></a>	
<a name="__line3472"></a>  }
<a name="__line3473"></a>
<a name="__line3474"></a>  cboxes::cboxes() : cbox_base()
<a name="__line3475"></a>  {
<a name="__line3476"></a>  dx_ = dy_ = unset;
<a name="__line3477"></a>  frame_foreground_ = default_frame_foreground_;
<a name="__line3478"></a>  grid_foreground_  = default_grid_foreground_;
<a name="__line3479"></a>  skip_outrange_ = true;
<a name="__line3480"></a>  }
<a name="__line3481"></a>
<a name="__line3482"></a>  void cboxes::set_ranges(plottable *g,axis *x,axis *y)
<a name="__line3483"></a>  {
<a name="__line3484"></a>  // prepare_for_draw is called before this function, so everything
<a name="__line3485"></a>  // is set up already
<a name="__line3486"></a>
<a name="__line3487"></a>  x-&gt;autoextend_min_soft(false);
<a name="__line3488"></a>  x-&gt;autoextend_max_soft(false);
<a name="__line3489"></a>  y-&gt;autoextend_min_soft(false);
<a name="__line3490"></a>  y-&gt;autoextend_max_soft(false);
<a name="__line3491"></a>  }
<a name="__line3492"></a>
<a name="__line3493"></a>
<a name="__line3494"></a>  static void get_cellsize(plottable *g, const function &amp;getx, const function &amp;gety, const function &amp;getdx, const function &amp;getdy,
<a name="__line3495"></a>  double &amp;dx, double &amp;dy)
<a name="__line3496"></a>  {
<a name="__line3497"></a>  dx = dy = unset;
<a name="__line3498"></a>
<a name="__line3499"></a>  if(!getx.initialized() || !gety.initialized())
<a name="__line3500"></a>  {
<a name="__line3501"></a>  warning::print("getx or gety is uninitialized","get_cellsize(...)");
<a name="__line3502"></a>  return;
<a name="__line3503"></a>  }
<a name="__line3504"></a>
<a name="__line3505"></a>  if ( g-&gt;ordered() &gt;= 2 )
<a name="__line3506"></a>  {
<a name="__line3507"></a>  double xlast=unset, ylast=unset;
<a name="__line3508"></a>  for(plottable::size_type i1=0; i1&lt;g-&gt;size(); ++i1)
<a name="__line3509"></a>  {
<a name="__line3510"></a>  const var x_var = getx.eval(*(g-&gt;get(i1)));
<a name="__line3511"></a>  const var y_var = gety.eval(*(g-&gt;get(i1)));
<a name="__line3512"></a>  if(ignore::it(x_var) || ignore::it(y_var)) continue;
<a name="__line3513"></a>  double x = x_var.dbl();
<a name="__line3514"></a>  double y = y_var.dbl();
<a name="__line3515"></a>  if(g-&gt;xmin() != unset &amp;&amp; x &lt; g-&gt;xmin()) continue;
<a name="__line3516"></a>  if(g-&gt;xmax() != unset &amp;&amp; x &gt; g-&gt;xmax()) continue;
<a name="__line3517"></a>  if(g-&gt;ymin() != unset &amp;&amp; y &lt; g-&gt;ymin()) continue;
<a name="__line3518"></a>  if(g-&gt;ymax() != unset &amp;&amp; y &gt; g-&gt;ymax()) continue;
<a name="__line3519"></a>		    
<a name="__line3520"></a>  if(xlast != unset &amp;&amp; x != xlast)
<a name="__line3521"></a>  {
<a name="__line3522"></a>  if(dx == unset || ::fabs(x-xlast)&lt;dx) dx = ::fabs(x-xlast);
<a name="__line3523"></a>  }
<a name="__line3524"></a>  if(ylast != unset &amp;&amp; y != ylast)
<a name="__line3525"></a>  {
<a name="__line3526"></a>  if(dy == unset || ::fabs(y-ylast)&lt;dy) dy = ::fabs(y-ylast);
<a name="__line3527"></a>  }
<a name="__line3528"></a>  xlast = x;
<a name="__line3529"></a>  ylast = y;
<a name="__line3530"></a>  }
<a name="__line3531"></a>  }
<a name="__line3532"></a>	    
<a name="__line3533"></a>  else if( getdx.initialized() &amp;&amp; getdy.initialized() )
<a name="__line3534"></a>  {
<a name="__line3535"></a>  for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line3536"></a>  {
<a name="__line3537"></a>  const datapoint *pp = g-&gt;get(i);
<a name="__line3538"></a>  const var x_var=getx.eval(*pp);
<a name="__line3539"></a>  const var y_var=gety.eval(*pp);
<a name="__line3540"></a>  const var dx_tmp_var=getdx.eval(*pp);
<a name="__line3541"></a>  const var dy_tmp_var=getdy.eval(*pp);
<a name="__line3542"></a>  if ( ignore::it(x_var) || ignore::it(y_var) ||
<a name="__line3543"></a>  ignore::it(dx_tmp_var) || ignore::it(dy_tmp_var) ) continue;
<a name="__line3544"></a>  const double dx_tmp = dx_tmp_var.dbl();
<a name="__line3545"></a>  const double dy_tmp = dy_tmp_var.dbl();
<a name="__line3546"></a>  if(dx == unset || dx_tmp &lt; dx) dx = dx_tmp;
<a name="__line3547"></a>  if(dy == unset || dy_tmp &lt; dy) dy = dy_tmp;
<a name="__line3548"></a>  }
<a name="__line3549"></a>  }
<a name="__line3550"></a>
<a name="__line3551"></a>  // otherwise, if not ordered, and no dx/dy hints are given, then
<a name="__line3552"></a>  // loop over all data point pairs (very slow for large data!!!)
<a name="__line3553"></a>  else 
<a name="__line3554"></a>  {
<a name="__line3555"></a>  map&lt;double,bool&gt; xvalues,yvalues;
<a name="__line3556"></a>  for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line3557"></a>  {
<a name="__line3558"></a>  const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line3559"></a>  const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line3560"></a>  if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line3561"></a>  const double xorig = xorig_var.dbl();
<a name="__line3562"></a>  const double yorig = yorig_var.dbl();
<a name="__line3563"></a>  xvalues[xorig] = true;
<a name="__line3564"></a>  yvalues[yorig] = true;
<a name="__line3565"></a>  }
<a name="__line3566"></a>
<a name="__line3567"></a>  for(map&lt;double,bool&gt;::iterator i=xvalues.begin(); i!=xvalues.end(); ++i)
<a name="__line3568"></a>  {
<a name="__line3569"></a>  if(i != xvalues.begin())
<a name="__line3570"></a>  {
<a name="__line3571"></a>  map&lt;double,bool&gt;::iterator prev = i;
<a name="__line3572"></a>  --prev;
<a name="__line3573"></a>  if(dx == unset || ::fabs((*prev).first - (*i).first) &lt; dx)
<a name="__line3574"></a>  dx = ::fabs((*prev).first - (*i).first);
<a name="__line3575"></a>  }
<a name="__line3576"></a>  }
<a name="__line3577"></a>  for(map&lt;double,bool&gt;::iterator i=yvalues.begin(); i!=yvalues.end(); ++i)
<a name="__line3578"></a>  {
<a name="__line3579"></a>  if(i != yvalues.begin())
<a name="__line3580"></a>  {
<a name="__line3581"></a>  map&lt;double,bool&gt;::iterator prev = i;
<a name="__line3582"></a>  --prev;
<a name="__line3583"></a>  if(dy == unset || ::fabs((*prev).first - (*i).first) &lt; dy)
<a name="__line3584"></a>  dy = ::fabs((*prev).first - (*i).first);
<a name="__line3585"></a>  }
<a name="__line3586"></a>  }
<a name="__line3587"></a>  }
<a name="__line3588"></a>  }
<a name="__line3589"></a>
<a name="__line3590"></a>  void cboxes::calc(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line3591"></a>  TRY
<a name="__line3592"></a>  {
<a name="__line3593"></a>
<a name="__line3594"></a>  if(global::debug&gt;0) cout&lt;&lt;"[blop] [DEBUG] cboxes::calc starts..."&lt;&lt;endl;
<a name="__line3595"></a>  if(!g) err("Plottable to draw not set");
<a name="__line3596"></a>
<a name="__line3597"></a>  function getx = get_x(g);
<a name="__line3598"></a>  function gety = get_y(g);
<a name="__line3599"></a>  function getdx = g-&gt;dx_hint();
<a name="__line3600"></a>  function getdy = g-&gt;dy_hint();
<a name="__line3601"></a>
<a name="__line3602"></a>  function getz = g-&gt;z_hint();
<a name="__line3603"></a>  if(!getz.initialized()) getz = _3;
<a name="__line3604"></a>
<a name="__line3605"></a>  double dx_new=unset, dy_new = unset;
<a name="__line3606"></a>
<a name="__line3607"></a>  // only calculate the cellsize if any of dx_ or dy_ are unset. othersize it's not necessary
<a name="__line3608"></a>  if(dx_ == unset || dy_ == unset) get_cellsize(g,getx,gety,getdx,getdy,dx_new,dy_new);
<a name="__line3609"></a>
<a name="__line3610"></a>  if ( dx_==unset ) dx_=dx_new;
<a name="__line3611"></a>  if ( dy_==unset ) dy_=dy_new;
<a name="__line3612"></a>	
<a name="__line3613"></a>
<a name="__line3614"></a>  if(dx_ == unset || dx_ &lt;=0)
<a name="__line3615"></a>  {
<a name="__line3616"></a>  warning::print("Couldn't figure out boxwidth, using dx=1.0",
<a name="__line3617"></a>  "cboxes::calc(...)");
<a name="__line3618"></a>  dx_ = 1.0;
<a name="__line3619"></a>  }
<a name="__line3620"></a>  if(dy_ == unset || dy_ &lt;= 0)
<a name="__line3621"></a>  {
<a name="__line3622"></a>  warning::print("Couldn't figure out boxheight, using dy=1.0",
<a name="__line3623"></a>  "cboxes::calc(...)");
<a name="__line3624"></a>  dy_ = 1.0;
<a name="__line3625"></a>  }
<a name="__line3626"></a>	
<a name="__line3627"></a>  // Set ranges:
<a name="__line3628"></a>  if(g-&gt;xmin()!=unset) xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line3629"></a>  if(g-&gt;xmax()!=unset) xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line3630"></a>  if(g-&gt;ymin()!=unset) yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line3631"></a>  if(g-&gt;ymax()!=unset) yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line3632"></a>
<a name="__line3633"></a>  if ( g-&gt;xmin()==unset ||
<a name="__line3634"></a>  g-&gt;xmax()==unset ||
<a name="__line3635"></a>  g-&gt;ymin()==unset ||
<a name="__line3636"></a>  g-&gt;ymax()==unset ||
<a name="__line3637"></a>  color_min_fixed_==false ||
<a name="__line3638"></a>  color_max_fixed_==false )
<a name="__line3639"></a>  {
<a name="__line3640"></a>  double xmin=unset;
<a name="__line3641"></a>  double xmax=unset;
<a name="__line3642"></a>  double ymin=unset;
<a name="__line3643"></a>  double ymax=unset;
<a name="__line3644"></a>  double vmin=unset;
<a name="__line3645"></a>  double vmax=unset;
<a name="__line3646"></a>
<a name="__line3647"></a>  double xmin_accept = g-&gt;xmin();
<a name="__line3648"></a>  if(xaxis-&gt;min_fixed() &amp;&amp; (xmin_accept==unset || xaxis-&gt;min()&lt;xmin_accept))
<a name="__line3649"></a>  xmin_accept = xaxis-&gt;min();
<a name="__line3650"></a>  double xmax_accept = g-&gt;xmax();
<a name="__line3651"></a>  if(xaxis-&gt;max_fixed() &amp;&amp; (xmax_accept==unset || xaxis-&gt;max()&lt;xmax_accept))
<a name="__line3652"></a>  xmax_accept = xaxis-&gt;max();
<a name="__line3653"></a>  double ymin_accept = g-&gt;ymin();
<a name="__line3654"></a>  if(yaxis-&gt;min_fixed() &amp;&amp; (ymin_accept==unset || yaxis-&gt;min()&lt;ymin_accept))
<a name="__line3655"></a>  ymin_accept = yaxis-&gt;min();
<a name="__line3656"></a>  double ymax_accept = g-&gt;ymax();
<a name="__line3657"></a>  if(yaxis-&gt;max_fixed() &amp;&amp; (ymax_accept==unset || yaxis-&gt;max()&lt;ymax_accept))
<a name="__line3658"></a>  ymax_accept = yaxis-&gt;max();
<a name="__line3659"></a>
<a name="__line3660"></a>  if(xmin_accept!=unset) xmin = xmin_accept;
<a name="__line3661"></a>  if(xmax_accept!=unset) xmax = xmax_accept;
<a name="__line3662"></a>  if(ymin_accept!=unset) ymin = ymin_accept;
<a name="__line3663"></a>  if(ymax_accept!=unset) ymax = ymax_accept;
<a name="__line3664"></a>
<a name="__line3665"></a>  for(plottable::size_type i=0; i &lt; g-&gt;size(); ++i)
<a name="__line3666"></a>  {
<a name="__line3667"></a>  const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line3668"></a>  const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line3669"></a>  if ( ignore::it(xorig_var) || ignore::it(yorig_var) ) continue;
<a name="__line3670"></a>  const double xorig=xorig_var.dbl();
<a name="__line3671"></a>  const double yorig=yorig_var.dbl();
<a name="__line3672"></a>  if ( (xaxis-&gt;logscale() &amp;&amp; !(xorig-0.5*dx_&gt;0.0)) ||
<a name="__line3673"></a>  (yaxis-&gt;logscale() &amp;&amp; !(yorig-0.5*dy_&gt;0.0)) ) continue;
<a name="__line3674"></a>
<a name="__line3675"></a>  if ( (xmin_accept!=unset &amp;&amp; xorig+0.5*dx_&lt;xmin_accept) ||
<a name="__line3676"></a>  (xmax_accept!=unset &amp;&amp; xorig-0.5*dx_&gt;xmax_accept) ||
<a name="__line3677"></a>  (ymin_accept!=unset &amp;&amp; yorig+0.5*dy_&lt;ymin_accept) ||
<a name="__line3678"></a>  (ymax_accept!=unset &amp;&amp; yorig-0.5*dy_&gt;ymax_accept) ) continue;
<a name="__line3679"></a>
<a name="__line3680"></a>  if(xmin==unset || xorig-0.5*dx_&lt;xmin) xmin=xorig-0.5*dx_;
<a name="__line3681"></a>  if(xmax==unset || xorig+0.5*dx_&gt;xmax) xmax=xorig+0.5*dx_;
<a name="__line3682"></a>  if(ymin==unset || yorig-0.5*dy_&lt;ymin) ymin=yorig-0.5*dy_;
<a name="__line3683"></a>  if(ymax==unset || yorig+0.5*dy_&gt;ymax) ymax=yorig+0.5*dy_;
<a name="__line3684"></a>		
<a name="__line3685"></a>  const var v_var = getz.eval(*(g-&gt;get(i)));
<a name="__line3686"></a>  if ( ignore::it(v_var) ) continue;
<a name="__line3687"></a>  const double v = v_var.dbl();
<a name="__line3688"></a>  if(clogscale_ &amp;&amp; !(v&gt;0.0)) continue;
<a name="__line3689"></a>  if((color_min_fixed_ &amp;&amp; v&lt;color_min_) || (color_max_fixed_ &amp;&amp; v&gt;color_max_)) continue;
<a name="__line3690"></a>  if(vmin==unset &amp;&amp; vmax==unset) { vmin=v; vmax=v; }
<a name="__line3691"></a>  if( v &gt; vmax) vmax = v;
<a name="__line3692"></a>  else if( v &lt; vmin) vmin = v;
<a name="__line3693"></a>  }
<a name="__line3694"></a>  if(xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line3695"></a>  if(xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line3696"></a>  if(ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line3697"></a>  if(ymax!=unset) yaxis-&gt;extend_range(ymax);
<a name="__line3698"></a>  if(color_min_fixed_==false &amp;&amp; vmin!=unset) color_min_=vmin;
<a name="__line3699"></a>  if(color_max_fixed_==false &amp;&amp; vmax!=unset) color_max_=vmax;
<a name="__line3700"></a>
<a name="__line3701"></a>  }
<a name="__line3702"></a>  if(global::debug&gt;0) cout&lt;&lt;"[blop] [DEBUG] cboxes::calc finished."&lt;&lt;endl;
<a name="__line3703"></a>  }
<a name="__line3704"></a>  CATCH("cboxes::calc(...)")
<a name="__line3705"></a>
<a name="__line3706"></a>  void cboxes::draw(plottable *g,frame *f,terminal *t)
<a name="__line3707"></a>  TRY
<a name="__line3708"></a>  {
<a name="__line3709"></a>  if(!g || g-&gt;empty())  return;
<a name="__line3710"></a>	
<a name="__line3711"></a>  t-&gt;reset_transformation();
<a name="__line3712"></a>	
<a name="__line3713"></a>  axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line3714"></a>  axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line3715"></a>	
<a name="__line3716"></a>  double xmin = xaxis-&gt;min();
<a name="__line3717"></a>  if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line3718"></a>  double xmax = xaxis-&gt;max();
<a name="__line3719"></a>  if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line3720"></a>
<a name="__line3721"></a>  double ymin = yaxis-&gt;min();
<a name="__line3722"></a>  if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line3723"></a>  double ymax = yaxis-&gt;max();
<a name="__line3724"></a>  if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line3725"></a>	
<a name="__line3726"></a>  vector&lt;terminal::coord&gt; c;
<a name="__line3727"></a>	
<a name="__line3728"></a>  function getx = get_x(g);
<a name="__line3729"></a>  function gety = get_y(g);
<a name="__line3730"></a>  function getz = g-&gt;z_hint();
<a name="__line3731"></a>  if(!getz.initialized()) getz = _3;
<a name="__line3732"></a>	
<a name="__line3733"></a>  for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line3734"></a>  {
<a name="__line3735"></a>  const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line3736"></a>  const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line3737"></a>  if(ignore::it(xorig_var) || ignore::it(yorig_var)) continue;
<a name="__line3738"></a>  const double xorig = xorig_var.dbl();
<a name="__line3739"></a>  const double yorig = yorig_var.dbl();
<a name="__line3740"></a>	    
<a name="__line3741"></a>  if(xaxis-&gt;logscale() &amp;&amp; xorig-0.5*dx_&lt;=0.0) continue;
<a name="__line3742"></a>  if(yaxis-&gt;logscale() &amp;&amp; yorig-0.5*dy_&lt;=0.0) continue;
<a name="__line3743"></a>  if(xorig+0.5*dx_&lt;xmin || xorig-0.5*dx_&gt;xmax ||
<a name="__line3744"></a>  yorig+0.5*dy_&lt;ymin || yorig-0.5*dy_&gt;ymax) continue;
<a name="__line3745"></a>	    
<a name="__line3746"></a>  double x1 = xaxis-&gt;map_point(xorig - dx_/2);
<a name="__line3747"></a>  double x2 = xaxis-&gt;map_point(xorig + dx_/2);
<a name="__line3748"></a>
<a name="__line3749"></a>  double y1 = yaxis-&gt;map_point(yorig - dy_/2);
<a name="__line3750"></a>  double y2 = yaxis-&gt;map_point(yorig + dy_/2);
<a name="__line3751"></a>
<a name="__line3752"></a>  // make the boxes 'slightly' bigger - otherwise bitmap outputs (jpg, png) and
<a name="__line3753"></a>  // antialiased postscript/pdf will appear with white lines
<a name="__line3754"></a>  x1 -= ::fabs(x2-x1)/80;
<a name="__line3755"></a>  x2 += ::fabs(x2-x1)/80;
<a name="__line3756"></a>  y1 -= ::fabs(y2-y1)/80;
<a name="__line3757"></a>  y2 += ::fabs(y2-y1)/80;
<a name="__line3758"></a>	    
<a name="__line3759"></a>  if(0&lt;=x1 &amp;&amp; x1&lt;=1 &amp;&amp;
<a name="__line3760"></a>  0&lt;=x2 &amp;&amp; x2&lt;=1 &amp;&amp;
<a name="__line3761"></a>  0&lt;=y1 &amp;&amp; y1&lt;=1 &amp;&amp;
<a name="__line3762"></a>  0&lt;=y2 &amp;&amp; y2&lt;=1)
<a name="__line3763"></a>  {
<a name="__line3764"></a>  const var zorig_var = getz.eval(*(g-&gt;get(i)));
<a name="__line3765"></a>  if ( ignore::it(zorig_var) ) continue;
<a name="__line3766"></a>  double zorig = zorig_var.dbl();
<a name="__line3767"></a>  if (clogscale_ &amp;&amp; zorig&lt;=0.0) continue;
<a name="__line3768"></a>
<a name="__line3769"></a>  if(zorig&lt;color_min_ &amp;&amp; underflow_color_ == transparent &amp;&amp; skip_outrange_)
<a name="__line3770"></a>  {
<a name="__line3771"></a>  continue;
<a name="__line3772"></a>  }
<a name="__line3773"></a>  if(zorig&gt;color_max_ &amp;&amp; overflow_color_ == transparent &amp;&amp; skip_outrange_)
<a name="__line3774"></a>  {
<a name="__line3775"></a>  continue;
<a name="__line3776"></a>  }
<a name="__line3777"></a>
<a name="__line3778"></a>  double minimum = min();
<a name="__line3779"></a>  double maximum = max();
<a name="__line3780"></a>  if(colorlegend_)
<a name="__line3781"></a>  {
<a name="__line3782"></a>  minimum = colorlegend_-&gt;min();
<a name="__line3783"></a>  maximum = colorlegend_-&gt;max();
<a name="__line3784"></a>  }
<a name="__line3785"></a>  const color the_color = map_color(zorig,minimum,maximum);
<a name="__line3786"></a>  c.clear();
<a name="__line3787"></a>  c.push_back(terminal::coord(terminal::id(x1,1),terminal::id(y1,2)));
<a name="__line3788"></a>  c.push_back(terminal::coord(terminal::id(x1,1),terminal::id(y2,2)));
<a name="__line3789"></a>  c.push_back(terminal::coord(terminal::id(x2,1),terminal::id(y2,2)));
<a name="__line3790"></a>  c.push_back(terminal::coord(terminal::id(x2,1),terminal::id(y1,2)));
<a name="__line3791"></a>  c.push_back(terminal::coord(terminal::id(x1,1),terminal::id(y1,2)));
<a name="__line3792"></a>  t-&gt;set_color(the_color);
<a name="__line3793"></a>  t-&gt;fill_polygon(c);
<a name="__line3794"></a>  }
<a name="__line3795"></a>  }
<a name="__line3796"></a>  }
<a name="__line3797"></a>  CATCH("cboxes::draw(...)")
<a name="__line3798"></a>
<a name="__line3799"></a>  graph_drawer *cboxes::clone() const
<a name="__line3800"></a>  {
<a name="__line3801"></a>  cboxes *r =  new cboxes(*this);
<a name="__line3802"></a>  return r;
<a name="__line3803"></a>  }
<a name="__line3804"></a>
<a name="__line3805"></a>*/</span>
<a name="__line3806"></a>
<a name="__line3807"></a>    <span class=comment>// ---------- csboxes   -----------------------------------------------------------</span>
<a name="__line3808"></a>
<a name="__line3809"></a>    bool csboxes::default_frame_foreground_ = true;
<a name="__line3810"></a>    bool csboxes::default_grid_foreground_ = false;
<a name="__line3811"></a>
<a name="__line3812"></a>    csboxes &amp;csboxes::independent_xy(bool f)
<a name="__line3813"></a>    {
<a name="__line3814"></a>	if(f)
<a name="__line3815"></a>	{
<a name="__line3816"></a>	    if(color_func_.is_constant())
<a name="__line3817"></a>	    {
<a name="__line3818"></a>		boxsize_x_func_ = _3;
<a name="__line3819"></a>		boxsize_y_func_ = _4;
<a name="__line3820"></a>	    }
<a name="__line3821"></a>	    else
<a name="__line3822"></a>	    {
<a name="__line3823"></a>		boxsize_x_func_ = _4;
<a name="__line3824"></a>		boxsize_y_func_ = _5;
<a name="__line3825"></a>	    }
<a name="__line3826"></a>	}
<a name="__line3827"></a>	else
<a name="__line3828"></a>	{
<a name="__line3829"></a>	    if(color_func_.is_constant())
<a name="__line3830"></a>	    {
<a name="__line3831"></a>		boxsize_x_func_ = _3;
<a name="__line3832"></a>		boxsize_y_func_ = _3;
<a name="__line3833"></a>	    }
<a name="__line3834"></a>	    else
<a name="__line3835"></a>	    {
<a name="__line3836"></a>		boxsize_x_func_ = _4;
<a name="__line3837"></a>		boxsize_y_func_ = _4;
<a name="__line3838"></a>	    }
<a name="__line3839"></a>	}
<a name="__line3840"></a>	return *this;
<a name="__line3841"></a>    }
<a name="__line3842"></a>
<a name="__line3843"></a>    csboxes &amp;csboxes::xsize_min(double min)
<a name="__line3844"></a>    {
<a name="__line3845"></a>	xsize_min_ = min;
<a name="__line3846"></a>	if(xsize_min_ != unset) xsize_min_fixed_ = true;
<a name="__line3847"></a>	else xsize_min_fixed_ = false;
<a name="__line3848"></a>	return *this;
<a name="__line3849"></a>    }
<a name="__line3850"></a>    csboxes &amp;csboxes::xsize_max(double max)
<a name="__line3851"></a>    {
<a name="__line3852"></a>	xsize_max_ = max;
<a name="__line3853"></a>	if(xsize_max_ != unset) xsize_max_fixed_ = true;
<a name="__line3854"></a>	else xsize_max_fixed_ = false;
<a name="__line3855"></a>	return *this;
<a name="__line3856"></a>    }
<a name="__line3857"></a>    csboxes &amp;csboxes::xsize_range(double min, double max)
<a name="__line3858"></a>    {
<a name="__line3859"></a>	xsize_min(min);
<a name="__line3860"></a>	xsize_max(max);
<a name="__line3861"></a>	return *this;
<a name="__line3862"></a>    }
<a name="__line3863"></a>
<a name="__line3864"></a>    csboxes &amp;csboxes::ysize_min(double min)
<a name="__line3865"></a>    {
<a name="__line3866"></a>	ysize_min_ = min;
<a name="__line3867"></a>	if(ysize_min_ != unset) ysize_min_fixed_ = true;
<a name="__line3868"></a>	else ysize_min_fixed_ = false;
<a name="__line3869"></a>	return *this;
<a name="__line3870"></a>    }
<a name="__line3871"></a>    csboxes &amp;csboxes::ysize_max(double max)
<a name="__line3872"></a>    {
<a name="__line3873"></a>	ysize_max_ = max;
<a name="__line3874"></a>	if(ysize_max_ != unset) ysize_max_fixed_ = true;
<a name="__line3875"></a>	else ysize_max_fixed_ = false;
<a name="__line3876"></a>	return *this;
<a name="__line3877"></a>    }
<a name="__line3878"></a>
<a name="__line3879"></a>    csboxes &amp;csboxes::ysize_range(double min, double max)
<a name="__line3880"></a>    {
<a name="__line3881"></a>	ysize_min(min);
<a name="__line3882"></a>	ysize_max(max);
<a name="__line3883"></a>	return *this;
<a name="__line3884"></a>    }
<a name="__line3885"></a>
<a name="__line3886"></a>    csboxes &amp;csboxes::xsize_goal_range(double min, double max)
<a name="__line3887"></a>    {
<a name="__line3888"></a>	xsize_goal_min(min);
<a name="__line3889"></a>	xsize_goal_max(max);
<a name="__line3890"></a>	return *this; 
<a name="__line3891"></a>    }
<a name="__line3892"></a>    csboxes &amp;csboxes::xsize_goal_min(double min)
<a name="__line3893"></a>    {
<a name="__line3894"></a>	if(min!=unset) normalize_xsize_ = true;
<a name="__line3895"></a>	if(min&lt;0)
<a name="__line3896"></a>	{
<a name="__line3897"></a>	    warning::print("Negative number in xsize_goal_min. Setting value to 0");
<a name="__line3898"></a>	    min = 0;
<a name="__line3899"></a>	}
<a name="__line3900"></a>	xsize_goal_min_ = min;
<a name="__line3901"></a>	return *this;
<a name="__line3902"></a>    }
<a name="__line3903"></a>    csboxes &amp;csboxes::xsize_goal_max(double max)
<a name="__line3904"></a>    {
<a name="__line3905"></a>	if(max!=unset) normalize_xsize_ = true;
<a name="__line3906"></a>	xsize_goal_max_ = max;
<a name="__line3907"></a>	return *this;
<a name="__line3908"></a>    }
<a name="__line3909"></a>
<a name="__line3910"></a>    csboxes &amp;csboxes::ysize_goal_range(double min, double max)
<a name="__line3911"></a>    {
<a name="__line3912"></a>	ysize_goal_min(min);
<a name="__line3913"></a>	ysize_goal_max(max);
<a name="__line3914"></a>	return *this; 
<a name="__line3915"></a>    }
<a name="__line3916"></a>    csboxes &amp;csboxes::ysize_goal_min(double min)
<a name="__line3917"></a>    {
<a name="__line3918"></a>	if(min!=unset) normalize_ysize_ = true;
<a name="__line3919"></a>	if(min&lt;0)
<a name="__line3920"></a>	{
<a name="__line3921"></a>	    warning::print("Negative number in ysize_goal_min. Setting value to 0");
<a name="__line3922"></a>	    min = 0;
<a name="__line3923"></a>	}
<a name="__line3924"></a>	ysize_goal_min_ = min;
<a name="__line3925"></a>	return *this;
<a name="__line3926"></a>    }
<a name="__line3927"></a>    csboxes &amp;csboxes::ysize_goal_max(double max)
<a name="__line3928"></a>    {
<a name="__line3929"></a>	if(max!=unset) normalize_ysize_ = true;
<a name="__line3930"></a>	ysize_goal_max_ = max;
<a name="__line3931"></a>	return *this;
<a name="__line3932"></a>    }
<a name="__line3933"></a>
<a name="__line3934"></a>    csboxes &amp;csboxes::dx(double v)
<a name="__line3935"></a>    {
<a name="__line3936"></a>	cell_dx_ = v;
<a name="__line3937"></a>	if(cell_dx_ == unset) cell_dx_fixed_ = false;
<a name="__line3938"></a>	else cell_dx_fixed_ = true;
<a name="__line3939"></a>	return *this;
<a name="__line3940"></a>    }
<a name="__line3941"></a>
<a name="__line3942"></a>    csboxes &amp;csboxes::dy(double v)
<a name="__line3943"></a>    {
<a name="__line3944"></a>	cell_dy_ = v;
<a name="__line3945"></a>	if(cell_dy_ == unset) cell_dy_fixed_ = false;
<a name="__line3946"></a>	else cell_dy_fixed_ = true;
<a name="__line3947"></a>	return *this;
<a name="__line3948"></a>    }
<a name="__line3949"></a>
<a name="__line3950"></a>    void csboxes::prepare_for_draw(plottable *g, frame *f, int count)
<a name="__line3951"></a>    {
<a name="__line3952"></a>	if(global::debug&gt;0) cout&lt;&lt;"[blop] [csboxes] prepare_for_draw("&lt;&lt;g&lt;&lt;","&lt;&lt;f&lt;&lt;","&lt;&lt;count&lt;&lt;")"&lt;&lt;endl;
<a name="__line3953"></a>	if(count==1)
<a name="__line3954"></a>	{
<a name="__line3955"></a>            g-&gt;linewidth().register_me();
<a name="__line3956"></a>
<a name="__line3957"></a>	    if(frame_foreground_) f-&gt;foreground(true);
<a name="__line3958"></a>	    if(grid_foreground_) f-&gt;grid_foreground(true);
<a name="__line3959"></a>	    
<a name="__line3960"></a>	    axis *xaxis =
<a name="__line3961"></a>		(g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line3962"></a>	    axis *yaxis =
<a name="__line3963"></a>		(g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line3964"></a>	    
<a name="__line3965"></a>	    calc(g,xaxis,yaxis);
<a name="__line3966"></a>
<a name="__line3967"></a>	    if(colorlegend_)
<a name="__line3968"></a>	    {
<a name="__line3969"></a>		colorlegend_-&gt;clear_tics();
<a name="__line3970"></a>		if(draw_colorlegend_&lt;2) colorlegend_-&gt;off();
<a name="__line3971"></a>		if(color_title_.str()!="")
<a name="__line3972"></a>		{
<a name="__line3973"></a>		    var new_title = colorlegend_-&gt;title();
<a name="__line3974"></a>		    if(new_title.str() != "") new_title &amp;= ", ";
<a name="__line3975"></a>		    new_title &amp;= color_title_;
<a name="__line3976"></a>		    colorlegend_-&gt;title(new_title);
<a name="__line3977"></a>		}
<a name="__line3978"></a>	    }
<a name="__line3979"></a>	}
<a name="__line3980"></a>
<a name="__line3981"></a>
<a name="__line3982"></a>	if(count==2)
<a name="__line3983"></a>	{
<a name="__line3984"></a>	    <span class=comment>// Let the colorlegend calculate the unified range for all</span>
<a name="__line3985"></a>	    <span class=comment>// of its graphs</span>
<a name="__line3986"></a>	    if(colorlegend_)
<a name="__line3987"></a>	    {
<a name="__line3988"></a>		colorlegend_-&gt;calculate_tics();
<a name="__line3989"></a>		if(draw_colorlegend_&gt;=2) colorlegend_-&gt;on();  <span class=comment>// if any of the graphs have legend on...</span>
<a name="__line3990"></a>	    }
<a name="__line3991"></a>	}
<a name="__line3992"></a>	if(global::debug&gt;0) cout&lt;&lt;"[blop] [csboxes] prepare_for_draw finished"&lt;&lt;endl;
<a name="__line3993"></a>
<a name="__line3994"></a>    }
<a name="__line3995"></a>
<a name="__line3996"></a>    csboxes::csboxes(double min, double max)
<a name="__line3997"></a>    {
<a name="__line3998"></a>	init_csboxes_();
<a name="__line3999"></a>	color_range(min,max);
<a name="__line4000"></a>	xsize_range(min,max);
<a name="__line4001"></a>	ysize_range(min,max);
<a name="__line4002"></a>    }
<a name="__line4003"></a>
<a name="__line4004"></a>    csboxes::csboxes(const color &amp;startcolor, const color &amp;endcolor)
<a name="__line4005"></a>    {
<a name="__line4006"></a>	init_csboxes_();
<a name="__line4007"></a>	color_range(startcolor,endcolor);
<a name="__line4008"></a>    }
<a name="__line4009"></a>
<a name="__line4010"></a>    csboxes::csboxes(const std::vector&lt;blop::color&gt; &amp;colors)
<a name="__line4011"></a>    {
<a name="__line4012"></a>        init_csboxes_();
<a name="__line4013"></a>        color_mapping(colors);
<a name="__line4014"></a>    }
<a name="__line4015"></a>    csboxes::csboxes(const std::vector&lt;blop::color&gt; &amp;colors, const std::vector&lt;double&gt; &amp;values, bool values_normalized)
<a name="__line4016"></a>    {
<a name="__line4017"></a>        init_csboxes_();
<a name="__line4018"></a>        color_mapping(colors,values,values_normalized);
<a name="__line4019"></a>    }
<a name="__line4020"></a>
<a name="__line4021"></a>    csboxes::csboxes(const csboxes &amp;rhs) : cbox_base(rhs)
<a name="__line4022"></a>    {
<a name="__line4023"></a>	boxsize_x_func_ = rhs.boxsize_x_func_;
<a name="__line4024"></a>	boxsize_y_func_ = rhs.boxsize_y_func_;
<a name="__line4025"></a>	color_func_     = rhs.color_func_;
<a name="__line4026"></a>	cell_dx_ = rhs.cell_dx_;
<a name="__line4027"></a>	cell_dy_ = rhs.cell_dy_;
<a name="__line4028"></a>	cell_dx_fixed_ = rhs.cell_dx_fixed_;
<a name="__line4029"></a>	cell_dy_fixed_ = rhs.cell_dy_fixed_;
<a name="__line4030"></a>	normalize_xsize_ = rhs.normalize_xsize_;
<a name="__line4031"></a>	normalize_ysize_ = rhs.normalize_ysize_;
<a name="__line4032"></a>	xsize_min_ = rhs.xsize_min_;
<a name="__line4033"></a>	xsize_max_ = rhs.xsize_max_;
<a name="__line4034"></a>	ysize_min_ = rhs.ysize_min_;
<a name="__line4035"></a>	ysize_max_ = rhs.ysize_max_;
<a name="__line4036"></a>	xsize_min_fixed_ = rhs.xsize_min_fixed_;
<a name="__line4037"></a>	xsize_max_fixed_ = rhs.xsize_max_fixed_;
<a name="__line4038"></a>	ysize_min_fixed_ = rhs.ysize_min_fixed_;
<a name="__line4039"></a>	ysize_max_fixed_ = rhs.ysize_max_fixed_;
<a name="__line4040"></a>	xsize_goal_min_ = rhs.xsize_goal_min_;
<a name="__line4041"></a>	xsize_goal_max_ = rhs.xsize_goal_max_;
<a name="__line4042"></a>	ysize_goal_min_ = rhs.ysize_goal_min_;
<a name="__line4043"></a>	ysize_goal_max_ = rhs.ysize_goal_max_;
<a name="__line4044"></a>	skip_outrange_x_ = rhs.skip_outrange_x_;
<a name="__line4045"></a>	skip_outrange_y_ = rhs.skip_outrange_y_;
<a name="__line4046"></a>	skip_outrange_color_ = rhs.skip_outrange_color_;
<a name="__line4047"></a>	fill_ = true;
<a name="__line4048"></a>	frame_foreground_ = rhs.frame_foreground_;
<a name="__line4049"></a>	grid_foreground_  = rhs.grid_foreground_;
<a name="__line4050"></a>    }
<a name="__line4051"></a>
<a name="__line4052"></a>    csboxes::csboxes()
<a name="__line4053"></a>    {
<a name="__line4054"></a>	init_csboxes_();
<a name="__line4055"></a>    }
<a name="__line4056"></a>
<a name="__line4057"></a>    void csboxes::init_csboxes_()
<a name="__line4058"></a>    {
<a name="__line4059"></a>	boxsize_x_func_ = _4;
<a name="__line4060"></a>	boxsize_y_func_ = _5;
<a name="__line4061"></a>	color_func_     = _3;
<a name="__line4062"></a>	cell_dx_ = unset;
<a name="__line4063"></a>	cell_dy_ = unset;
<a name="__line4064"></a>	cell_dx_fixed_ = false;
<a name="__line4065"></a>	cell_dy_fixed_ = false;
<a name="__line4066"></a>	normalize_xsize_ = true;
<a name="__line4067"></a>	normalize_ysize_ = true;
<a name="__line4068"></a>	xsize_min_ = unset;
<a name="__line4069"></a>	xsize_max_ = unset;
<a name="__line4070"></a>	ysize_min_ = unset;
<a name="__line4071"></a>	ysize_max_ = unset;
<a name="__line4072"></a>	xsize_min_fixed_ = false;
<a name="__line4073"></a>	xsize_max_fixed_ = false;
<a name="__line4074"></a>	ysize_min_fixed_ = false;
<a name="__line4075"></a>	ysize_max_fixed_ = false;
<a name="__line4076"></a>	skip_outrange_x_ = true;
<a name="__line4077"></a>	skip_outrange_y_ = true;
<a name="__line4078"></a>	skip_outrange_color_ = true;
<a name="__line4079"></a>	xsize_goal_min_ = 0;
<a name="__line4080"></a>	xsize_goal_max_ = 1;
<a name="__line4081"></a>	ysize_goal_min_ = 0;
<a name="__line4082"></a>	ysize_goal_max_ = 1;
<a name="__line4083"></a>	fill_ = true;
<a name="__line4084"></a>	frame_foreground_ = default_frame_foreground_;
<a name="__line4085"></a>	grid_foreground_  = default_grid_foreground_;
<a name="__line4086"></a>    }
<a name="__line4087"></a>
<a name="__line4088"></a>
<a name="__line4089"></a>    void csboxes::get_functions(plottable *g,
<a name="__line4090"></a>				function &amp;getx, 
<a name="__line4091"></a>				function &amp;gety,
<a name="__line4092"></a>				function &amp;getboxsizex,
<a name="__line4093"></a>				function &amp;getboxsizey,
<a name="__line4094"></a>				function &amp;getcolor)
<a name="__line4095"></a>    {
<a name="__line4096"></a>	getx = get_x(g);
<a name="__line4097"></a>	gety = get_y(g);
<a name="__line4098"></a>
<a name="__line4099"></a>	if(color_func_.initialized()) getcolor = color_func_;
<a name="__line4100"></a>	else getcolor = _3;
<a name="__line4101"></a>
<a name="__line4102"></a>	if(boxsize_x_func_.initialized()) getboxsizex = boxsize_x_func_;
<a name="__line4103"></a>	else getboxsizex = _4;
<a name="__line4104"></a>	if(getboxsizex.equals(_4) &amp;&amp; g-&gt;columns() &lt; 4) getboxsizex = _3;
<a name="__line4105"></a>
<a name="__line4106"></a>	if(boxsize_y_func_.initialized()) getboxsizey = boxsize_y_func_;
<a name="__line4107"></a>	else getboxsizey = _5;
<a name="__line4108"></a>
<a name="__line4109"></a>	if(getboxsizey.nargs() &gt; g-&gt;columns()) getboxsizey = getboxsizex;
<a name="__line4110"></a>    }
<a name="__line4111"></a>
<a name="__line4112"></a>    void csboxes::set_ranges(plottable *g,axis *x,axis *y)
<a name="__line4113"></a>    {
<a name="__line4114"></a>	<span class=comment>// prepare_for_draw is already called, so everything is set up now.</span>
<a name="__line4115"></a>	x-&gt;autoextend_min_soft(false);
<a name="__line4116"></a>	x-&gt;autoextend_max_soft(false);
<a name="__line4117"></a>	y-&gt;autoextend_min_soft(false);
<a name="__line4118"></a>	y-&gt;autoextend_max_soft(false);
<a name="__line4119"></a>    }
<a name="__line4120"></a>
<a name="__line4121"></a>    void csboxes::calc_box_x_(double x, double dx, double *x1, double *x2)
<a name="__line4122"></a>    {
<a name="__line4123"></a>	const double a = (xsize_goal_max_-xsize_goal_min_)/(xsize_max_-xsize_min_);
<a name="__line4124"></a>	const double b = (xsize_goal_min_*(xsize_max_-xsize_min_)-xsize_min_*(xsize_goal_max_-xsize_goal_min_))/(xsize_max_-xsize_min_);
<a name="__line4125"></a>
<a name="__line4126"></a>	*x1 = x - 
<a name="__line4127"></a>	    (normalize_xsize_ ? (a*dx+b)*cell_dx_ : dx )/2;
<a name="__line4128"></a>	*x2 = x + 
<a name="__line4129"></a>	    (normalize_xsize_ ? (a*dx+b)*cell_dx_ : dx )/2;
<a name="__line4130"></a>    }
<a name="__line4131"></a>
<a name="__line4132"></a>    void csboxes::calc_box_y_(double y, double dy, double *y1, double *y2)
<a name="__line4133"></a>    {
<a name="__line4134"></a>	const double a = (ysize_goal_max_-ysize_goal_min_)/(ysize_max_-ysize_min_);
<a name="__line4135"></a>	const double b = (ysize_goal_min_*(ysize_max_-ysize_min_)-ysize_min_*(ysize_goal_max_-ysize_goal_min_))/(ysize_max_-ysize_min_);
<a name="__line4136"></a>	*y1 = y - 
<a name="__line4137"></a>	    (normalize_ysize_ ? (a*dy+b)*cell_dy_ : dy )/2;
<a name="__line4138"></a>	*y2 = y + 
<a name="__line4139"></a>	    (normalize_ysize_ ? (a*dy+b)*cell_dy_ : dy )/2;
<a name="__line4140"></a>    }
<a name="__line4141"></a>
<a name="__line4142"></a>    void csboxes::calc(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line4143"></a>	TRY
<a name="__line4144"></a>    {
<a name="__line4145"></a>	if(!g) err("Plottable to draw not set");
<a name="__line4146"></a>
<a name="__line4147"></a>	function getx, gety, getboxsizex, getboxsizey, getcolor;
<a name="__line4148"></a>	get_functions(g,getx,gety,getboxsizex,getboxsizey,getcolor);
<a name="__line4149"></a>
<a name="__line4150"></a>	<span class=comment>// Set ranges:</span>
<a name="__line4151"></a>	if(g-&gt;xmin()!=unset) xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line4152"></a>	if(g-&gt;xmax()!=unset) xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line4153"></a>	if(g-&gt;ymin()!=unset) yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line4154"></a>	if(g-&gt;ymax()!=unset) yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line4155"></a>	if ( g-&gt;xmin()==unset || g-&gt;xmax()==unset || g-&gt;ymin()==unset || g-&gt;ymax()==unset ||
<a name="__line4156"></a>	     (!getcolor.is_constant() &amp;&amp; (!color_min_fixed_ || !color_max_fixed_))  ||
<a name="__line4157"></a>	     (!getboxsizex.is_constant() &amp;&amp; normalize_xsize_ &amp;&amp; (!xsize_min_fixed_ || !xsize_max_fixed_)) ||
<a name="__line4158"></a>	     (!getboxsizey.is_constant() &amp;&amp; normalize_ysize_ &amp;&amp; (!ysize_min_fixed_ || !ysize_max_fixed_)) ||
<a name="__line4159"></a>	     (normalize_xsize_ &amp;&amp; !cell_dx_fixed_) ||
<a name="__line4160"></a>	     (normalize_ysize_ &amp;&amp; !cell_dy_fixed_) )
<a name="__line4161"></a>	{
<a name="__line4162"></a>	    double xmin=unset;
<a name="__line4163"></a>	    double xmax=unset;
<a name="__line4164"></a>	    double ymin=unset;
<a name="__line4165"></a>	    double ymax=unset;
<a name="__line4166"></a>
<a name="__line4167"></a>	    if(!color_min_fixed_) color_min_ = unset;
<a name="__line4168"></a>	    if(!color_max_fixed_) color_max_ = unset;
<a name="__line4169"></a>	    if(!cell_dx_fixed_) cell_dx_ = unset;
<a name="__line4170"></a>	    if(!cell_dy_fixed_) cell_dy_ = unset;
<a name="__line4171"></a>	    if(!xsize_min_fixed_) xsize_min_ = 0;
<a name="__line4172"></a>	    if(!xsize_max_fixed_) xsize_max_ = unset;
<a name="__line4173"></a>	    if(!ysize_min_fixed_) ysize_min_ = 0;
<a name="__line4174"></a>	    if(!ysize_max_fixed_) ysize_max_ = unset;
<a name="__line4175"></a>	    
<a name="__line4176"></a>	    map&lt;double,bool&gt; xvalues,yvalues;
<a name="__line4177"></a>	    double xlast=unset, ylast=unset;
<a name="__line4178"></a>
<a name="__line4179"></a>	    for(plottable::size_type i=0; i &lt; g-&gt;size(); ++i)
<a name="__line4180"></a>	    {
<a name="__line4181"></a>		const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line4182"></a>		const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line4183"></a>		const var boxsize_x_var = getboxsizex.eval(*(g-&gt;get(i)));
<a name="__line4184"></a>		const var boxsize_y_var = getboxsizey.eval(*(g-&gt;get(i)));
<a name="__line4185"></a>		const var color_var     = getcolor.eval(*(g-&gt;get(i)));
<a name="__line4186"></a>
<a name="__line4187"></a>		if ( ignore::it(xorig_var) || ignore::it(yorig_var) ||
<a name="__line4188"></a>		     ignore::it(boxsize_x_var) || ignore::it(boxsize_y_var) ||
<a name="__line4189"></a>		     ignore::it(color_var) )
<a name="__line4190"></a>		    continue;
<a name="__line4191"></a>
<a name="__line4192"></a>		if ( xaxis-&gt;logscale() &amp;&amp; xorig_var.dbl()&lt;=0.0 ) continue;
<a name="__line4193"></a>		if ( yaxis-&gt;logscale() &amp;&amp; yorig_var.dbl()&lt;=0.0 ) continue;
<a name="__line4194"></a>		if ( color_logscale_    &amp;&amp; color_var.dbl()&lt;=0.0 ) continue;
<a name="__line4195"></a>		<span class=comment>// check and skip points which are outside of g-&gt;xmin(), etc...</span>
<a name="__line4196"></a>
<a name="__line4197"></a><span class=comment>//		if ( xmin==unset ) xmin = xorig_var.dbl();</span>
<a name="__line4198"></a><span class=comment>//		if ( xmax==unset ) xmax = xorig_var.dbl();</span>
<a name="__line4199"></a><span class=comment>//		if ( ymin==unset ) ymin = yorig_var.dbl();</span>
<a name="__line4200"></a><span class=comment>//		if ( ymax==unset ) ymax = yorig_var.dbl();</span>
<a name="__line4201"></a>
<a name="__line4202"></a>		if(xmin==unset || xorig_var.dbl() &lt; xmin) xmin = xorig_var.dbl();
<a name="__line4203"></a>		if(xmax==unset || xorig_var.dbl() &gt; xmax) xmax = xorig_var.dbl();
<a name="__line4204"></a>		if(ymin==unset || yorig_var.dbl() &lt; ymin) ymin = yorig_var.dbl();
<a name="__line4205"></a>		if(ymax==unset || yorig_var.dbl() &gt; ymax) ymax = yorig_var.dbl();
<a name="__line4206"></a>
<a name="__line4207"></a>		if( color_min_fixed_ &amp;&amp; color_var.dbl()&lt;color_min_ ) continue;
<a name="__line4208"></a>		if( color_max_fixed_ &amp;&amp; color_var.dbl()&gt;color_max_ ) continue;
<a name="__line4209"></a>		
<a name="__line4210"></a>		if(!color_min_fixed_)
<a name="__line4211"></a>		{
<a name="__line4212"></a>		    if(color_min_ == unset) color_min_ = color_var.dbl();
<a name="__line4213"></a>		    if(color_var.dbl() &lt; color_min_) color_min_ = color_var.dbl();
<a name="__line4214"></a>		}
<a name="__line4215"></a>		if(!color_max_fixed_)
<a name="__line4216"></a>		{
<a name="__line4217"></a>		    if(color_max_ == unset) color_max_ = color_var.dbl();
<a name="__line4218"></a>		    if(color_var.dbl() &gt; color_max_) color_max_ = color_var.dbl();
<a name="__line4219"></a>		}
<a name="__line4220"></a>
<a name="__line4221"></a>		if(!xsize_min_fixed_)
<a name="__line4222"></a>		{
<a name="__line4223"></a>		    if(xsize_min_ == unset) xsize_min_ = boxsize_x_var.dbl();
<a name="__line4224"></a>		    if(boxsize_x_var.dbl() &lt; xsize_min_) xsize_min_ = boxsize_x_var.dbl();
<a name="__line4225"></a>		}
<a name="__line4226"></a>		if(!xsize_max_fixed_)
<a name="__line4227"></a>		{
<a name="__line4228"></a>		    if(xsize_max_ == unset) xsize_max_ = boxsize_x_var.dbl();
<a name="__line4229"></a>		    if(boxsize_x_var.dbl() &gt; xsize_max_) xsize_max_ = boxsize_x_var.dbl();
<a name="__line4230"></a>		}
<a name="__line4231"></a>		if(!ysize_min_fixed_)
<a name="__line4232"></a>		{
<a name="__line4233"></a>		    if(ysize_min_ == unset) ysize_min_ = boxsize_y_var.dbl();
<a name="__line4234"></a>		    if(boxsize_y_var.dbl() &lt; ysize_min_) ysize_min_ = boxsize_y_var.dbl();
<a name="__line4235"></a>		}
<a name="__line4236"></a>		if(!ysize_max_fixed_)
<a name="__line4237"></a>		{
<a name="__line4238"></a>		    if(ysize_max_ == unset) ysize_max_ = boxsize_y_var.dbl();
<a name="__line4239"></a>		    if(boxsize_y_var.dbl() &gt; ysize_max_) ysize_max_ = boxsize_y_var.dbl();
<a name="__line4240"></a>		}
<a name="__line4241"></a>
<a name="__line4242"></a>		if(!cell_dx_fixed_)
<a name="__line4243"></a>		{
<a name="__line4244"></a>		    if(g-&gt;ordered()&gt;=2)
<a name="__line4245"></a>		    {
<a name="__line4246"></a>			if(xlast!=unset &amp;&amp; xlast!=xorig_var.dbl() &amp;&amp; (cell_dx_==unset || ::fabs(xorig_var.dbl()-xlast)&lt;cell_dx_))
<a name="__line4247"></a>			    cell_dx_ = ::fabs(xorig_var.dbl()-xlast);
<a name="__line4248"></a>		    }
<a name="__line4249"></a>		    else xvalues[xorig_var.dbl()] = true;
<a name="__line4250"></a>		}
<a name="__line4251"></a>		if(!cell_dy_fixed_)
<a name="__line4252"></a>		{
<a name="__line4253"></a>		    if(g-&gt;ordered()&gt;=2)
<a name="__line4254"></a>		    {
<a name="__line4255"></a>			if(ylast!=unset &amp;&amp; ylast!=yorig_var.dbl() &amp;&amp; (cell_dy_==unset || ::fabs(yorig_var.dbl()-ylast)&lt;cell_dy_))
<a name="__line4256"></a>			    cell_dy_ = ::fabs(yorig_var.dbl()-ylast);
<a name="__line4257"></a>		    }
<a name="__line4258"></a>		    else yvalues[yorig_var.dbl()] = true;
<a name="__line4259"></a>		}
<a name="__line4260"></a>		xlast = xorig_var.dbl();
<a name="__line4261"></a>		ylast = yorig_var.dbl();
<a name="__line4262"></a>	    }
<a name="__line4263"></a>
<a name="__line4264"></a>	    if(g-&gt;xmin()==unset &amp;&amp; xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line4265"></a>	    if(g-&gt;xmax()==unset &amp;&amp; xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line4266"></a>	    if(g-&gt;ymin()==unset &amp;&amp; ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line4267"></a>	    if(g-&gt;ymax()==unset &amp;&amp; ymax!=unset) yaxis-&gt;extend_range(ymax);
<a name="__line4268"></a>
<a name="__line4269"></a>	    if(cell_dx_==unset)
<a name="__line4270"></a>	    {
<a name="__line4271"></a>		for(map&lt;double,bool&gt;::iterator i=xvalues.begin(); i!=xvalues.end(); ++i)
<a name="__line4272"></a>		{
<a name="__line4273"></a>		    if(i!=xvalues.begin())
<a name="__line4274"></a>		    {
<a name="__line4275"></a>			map&lt;double,bool&gt;::iterator prev=i;
<a name="__line4276"></a>			--prev;
<a name="__line4277"></a>			const double diff = ::fabs((*prev).first-(*i).first);
<a name="__line4278"></a>			if(cell_dx_==unset || diff &lt; cell_dx_) cell_dx_ = diff;
<a name="__line4279"></a>		    }
<a name="__line4280"></a>		}
<a name="__line4281"></a>	    }
<a name="__line4282"></a>	    if(cell_dy_==unset)
<a name="__line4283"></a>	    {
<a name="__line4284"></a>		for(map&lt;double,bool&gt;::iterator i=yvalues.begin(); i!=yvalues.end(); ++i)
<a name="__line4285"></a>		{
<a name="__line4286"></a>		    if(i!=yvalues.begin())
<a name="__line4287"></a>		    {
<a name="__line4288"></a>			map&lt;double,bool&gt;::iterator prev=i;
<a name="__line4289"></a>			--prev;
<a name="__line4290"></a>			const double diff = ::fabs((*prev).first-(*i).first);
<a name="__line4291"></a>			if(cell_dy_==unset || diff &lt; cell_dy_) cell_dy_ = diff;
<a name="__line4292"></a>		    }
<a name="__line4293"></a>		}
<a name="__line4294"></a>	    }
<a name="__line4295"></a>
<a name="__line4296"></a>	    for(plottable::size_type i=0; i &lt; g-&gt;size(); ++i)
<a name="__line4297"></a>	    {
<a name="__line4298"></a>		const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line4299"></a>		const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line4300"></a>		const var boxsize_x_var = getboxsizex.eval(*(g-&gt;get(i)));
<a name="__line4301"></a>		const var boxsize_y_var = getboxsizey.eval(*(g-&gt;get(i)));
<a name="__line4302"></a>		const var color_var     = getcolor.eval(*(g-&gt;get(i)));
<a name="__line4303"></a>
<a name="__line4304"></a>		if(ignore::it(xorig_var) || ignore::it(yorig_var) ||
<a name="__line4305"></a>		   ignore::it(boxsize_x_var) || ignore::it(boxsize_y_var) ||
<a name="__line4306"></a>		   ignore::it(color_var)) continue;
<a name="__line4307"></a>
<a name="__line4308"></a>		double x1=0, x2=0, y1=0, y2=0;
<a name="__line4309"></a>		calc_box_x_(xorig_var.dbl(), boxsize_x_var.dbl(), &amp;x1, &amp;x2);
<a name="__line4310"></a>		calc_box_y_(yorig_var.dbl(), boxsize_y_var.dbl(), &amp;y1, &amp;y2);
<a name="__line4311"></a>
<a name="__line4312"></a>		if(g-&gt;xmin()==unset) xaxis-&gt;extend_range(x1);
<a name="__line4313"></a>		if(g-&gt;xmax()==unset) xaxis-&gt;extend_range(x2);
<a name="__line4314"></a>		if(g-&gt;ymin()==unset) yaxis-&gt;extend_range(y1);
<a name="__line4315"></a>		if(g-&gt;ymax()==unset) yaxis-&gt;extend_range(y2);
<a name="__line4316"></a>	    }
<a name="__line4317"></a>            if(cell_dx_&lt;(xmax-xmin)/300) warning::print("The x cellsize was most probably not determined correctly (not a regular grid, or not exactly equal numbers)");
<a name="__line4318"></a>            if(cell_dy_&lt;(ymax-ymin)/300) warning::print("The y cellsize was most probably not determined correctly (not a regular grid, or not exactly equal numbers)");
<a name="__line4319"></a>	}
<a name="__line4320"></a>    }
<a name="__line4321"></a>    CATCH("csboxes::calc(...)")
<a name="__line4322"></a>
<a name="__line4323"></a>
<a name="__line4324"></a>    void csboxes::draw(plottable *g,frame *f,terminal *t)
<a name="__line4325"></a>    TRY
<a name="__line4326"></a>    {
<a name="__line4327"></a>
<a name="__line4328"></a>	if(!g || g-&gt;empty()) return;
<a name="__line4329"></a>
<a name="__line4330"></a>	if(!normalize_xsize_ &amp;&amp; xsize_min_&lt;0) warning::print("Requested xsize_min is negative, but xsize is not normalized. Negative values will be skipped",
<a name="__line4331"></a>							     "csboxes::draw");
<a name="__line4332"></a>	if(!normalize_ysize_ &amp;&amp; ysize_min_&lt;0) warning::print("Requested ysize_min is negative, but ysize is not normalized. Negative values will be skipped",
<a name="__line4333"></a>							     "csboxes::draw");
<a name="__line4334"></a>
<a name="__line4335"></a>	t-&gt;reset_transformation();
<a name="__line4336"></a>
<a name="__line4337"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line4338"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line4339"></a>
<a name="__line4340"></a>	double xmin = xaxis-&gt;min();                                         
<a name="__line4341"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line4342"></a>	double xmax = xaxis-&gt;max();
<a name="__line4343"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line4344"></a>
<a name="__line4345"></a>	double ymin = yaxis-&gt;min();
<a name="__line4346"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line4347"></a>	double ymax = yaxis-&gt;max();
<a name="__line4348"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line4349"></a>
<a name="__line4350"></a>	vector&lt;terminal::coord&gt; cc;
<a name="__line4351"></a>
<a name="__line4352"></a>	function getx, gety, getboxsizex, getboxsizey, getcolor;
<a name="__line4353"></a>	get_functions(g,getx,gety,getboxsizex,getboxsizey,getcolor);
<a name="__line4354"></a>
<a name="__line4355"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line4356"></a>	{
<a name="__line4357"></a>	    const var xorig_var     = getx.eval(*(g-&gt;get(i)));
<a name="__line4358"></a>	    const var yorig_var     = gety.eval(*(g-&gt;get(i)));
<a name="__line4359"></a>	    const var boxsize_x_var = getboxsizex.eval(*(g-&gt;get(i)));
<a name="__line4360"></a>	    const var boxsize_y_var = getboxsizey.eval(*(g-&gt;get(i)));
<a name="__line4361"></a>	    const var color_var     = getcolor.eval(*(g-&gt;get(i)));
<a name="__line4362"></a>
<a name="__line4363"></a>	    if(ignore::it(xorig_var) || ignore::it(yorig_var) ||
<a name="__line4364"></a>	       ignore::it(boxsize_x_var) || ignore::it(boxsize_y_var) ||
<a name="__line4365"></a>	       ignore::it(color_var)) continue;
<a name="__line4366"></a>
<a name="__line4367"></a>	    <span class=comment>// skip points outside of the limits.</span>
<a name="__line4368"></a>	    if( (boxsize_x_var.dbl()&lt;xsize_min_ || xsize_max_&lt;boxsize_x_var.dbl()) &amp;&amp; skip_outrange_x_) continue;
<a name="__line4369"></a>	    if( (boxsize_y_var.dbl()&lt;ysize_min_ || ysize_max_&lt;boxsize_y_var.dbl()) &amp;&amp; skip_outrange_y_) continue;
<a name="__line4370"></a>	    if( (color_var.dbl()&lt;color_min_ || color_max_&lt;color_var.dbl()) &amp;&amp; skip_outrange_color_) continue;
<a name="__line4371"></a>
<a name="__line4372"></a>	    double x1=0, x2=0, y1=0, y2=0;
<a name="__line4373"></a>	    calc_box_x_(xorig_var.dbl(), boxsize_x_var.dbl(), &amp;x1, &amp;x2);
<a name="__line4374"></a>	    calc_box_y_(yorig_var.dbl(), boxsize_y_var.dbl(), &amp;y1, &amp;y2);
<a name="__line4375"></a>
<a name="__line4376"></a>	    <span class=comment>// skip points which have 'negative' size, since they would just show up</span>
<a name="__line4377"></a>	    <span class=comment>// as normal boxes, confusing the user</span>
<a name="__line4378"></a>
<a name="__line4379"></a>	    if(x1 &gt;= xorig_var.dbl() || y1 &gt;= yorig_var.dbl())
<a name="__line4380"></a>	    {
<a name="__line4381"></a>		warning::print("Skipping undersized box","csboxes::draw");
<a name="__line4382"></a>		continue;
<a name="__line4383"></a>	    }
<a name="__line4384"></a>
<a name="__line4385"></a>	    if(xaxis-&gt;logscale() &amp;&amp; x1&lt;=0) continue;
<a name="__line4386"></a>	    if(xaxis-&gt;logscale() &amp;&amp; x2&lt;=0) continue;
<a name="__line4387"></a>	    if(yaxis-&gt;logscale() &amp;&amp; y1&lt;=0) continue;
<a name="__line4388"></a>	    if(yaxis-&gt;logscale() &amp;&amp; y2&lt;=0) continue;
<a name="__line4389"></a>	    if(x2&lt;xmin) continue;
<a name="__line4390"></a>	    if(x1&gt;xmax) continue;
<a name="__line4391"></a>	    if(y2&lt;ymin) continue;
<a name="__line4392"></a>	    if(y1&gt;ymax) continue;
<a name="__line4393"></a>
<a name="__line4394"></a>	    if(!color_func_.is_constant() &amp;&amp; color_logscale_ &amp;&amp; color_var.dbl()&lt;=0.0) continue;
<a name="__line4395"></a>
<a name="__line4396"></a>	    double x1_mapped = xaxis-&gt;map_point(x1);
<a name="__line4397"></a>	    double x2_mapped = xaxis-&gt;map_point(x2);
<a name="__line4398"></a>	    double y1_mapped = yaxis-&gt;map_point(y1);
<a name="__line4399"></a>	    double y2_mapped = yaxis-&gt;map_point(y2);
<a name="__line4400"></a>
<a name="__line4401"></a>            const double xmin_mapped = xaxis-&gt;map_point(xmin);
<a name="__line4402"></a>            const double xmax_mapped = xaxis-&gt;map_point(xmax);
<a name="__line4403"></a>            const double ymin_mapped = yaxis-&gt;map_point(ymin);
<a name="__line4404"></a>            const double ymax_mapped = yaxis-&gt;map_point(ymax);
<a name="__line4405"></a>
<a name="__line4406"></a>            if(x1_mapped&lt;xmin_mapped) x1_mapped = xmin_mapped;
<a name="__line4407"></a>            if(x2_mapped&gt;xmax_mapped) x2_mapped = xmax_mapped;
<a name="__line4408"></a>            if(y1_mapped&lt;ymin_mapped) y1_mapped = ymin_mapped;
<a name="__line4409"></a>            if(y2_mapped&gt;ymax_mapped) y2_mapped = ymax_mapped;
<a name="__line4410"></a>            if(x1_mapped &gt;= x2_mapped) continue;
<a name="__line4411"></a>            if(y1_mapped &gt;= y2_mapped) continue;
<a name="__line4412"></a>
<a name="__line4413"></a>	    <span class=comment>//if(-0.01&lt;=x1_mapped &amp;&amp; x1_mapped&lt;=1    &amp;&amp;</span>
<a name="__line4414"></a>	    <span class=comment>//   0    &lt;=x2_mapped &amp;&amp; x2_mapped&lt;=1.01 &amp;&amp;</span>
<a name="__line4415"></a>	    <span class=comment>//   -0.01&lt;=y1_mapped &amp;&amp; y1_mapped&lt;=1    &amp;&amp;</span>
<a name="__line4416"></a>	    <span class=comment>//   0    &lt;=y2_mapped &amp;&amp; y2_mapped&lt;=1.01)</span>
<a name="__line4417"></a>	    {
<a name="__line4418"></a>                
<a name="__line4419"></a>
<a name="__line4420"></a>                <span class=comment>//const double dx = x2_mapped-x1_mapped;</span>
<a name="__line4421"></a>                <span class=comment>//x1_mapped -= dx*cell_margin_;</span>
<a name="__line4422"></a>                <span class=comment>//x2_mapped += dx*cell_margin_;</span>
<a name="__line4423"></a>                <span class=comment>//const double dy = y2_mapped-y1_mapped;</span>
<a name="__line4424"></a>                <span class=comment>//y1_mapped -= dy*cell_margin_;</span>
<a name="__line4425"></a>                <span class=comment>//y2_mapped += dy*cell_margin_;</span>
<a name="__line4426"></a>
<a name="__line4427"></a>		cc.clear();
<a name="__line4428"></a>		cc.push_back(terminal::coord(terminal::id(x1_mapped,1),terminal::id(y1_mapped,2)));
<a name="__line4429"></a>		cc.push_back(terminal::coord(terminal::id(x1_mapped,1),terminal::id(y2_mapped,2)));
<a name="__line4430"></a>		cc.push_back(terminal::coord(terminal::id(x2_mapped,1),terminal::id(y2_mapped,2)));
<a name="__line4431"></a>		cc.push_back(terminal::coord(terminal::id(x2_mapped,1),terminal::id(y1_mapped,2)));
<a name="__line4432"></a>		cc.push_back(terminal::coord(terminal::id(x1_mapped,1),terminal::id(y1_mapped,2)));
<a name="__line4433"></a>		if(!color_func_.is_constant())
<a name="__line4434"></a>		{
<a name="__line4435"></a>		    double minimum = min();
<a name="__line4436"></a>		    double maximum = max();
<a name="__line4437"></a>		    if(colorlegend_ &amp;&amp; draw_colorlegend_&gt;=2)
<a name="__line4438"></a>		    {
<a name="__line4439"></a>			minimum = colorlegend_-&gt;min();
<a name="__line4440"></a>			maximum = colorlegend_-&gt;max();
<a name="__line4441"></a>		    }
<a name="__line4442"></a>		    const color the_color = map_color(color_var.dbl(),minimum,maximum);
<a name="__line4443"></a>		    t-&gt;set_color(the_color);
<a name="__line4444"></a>		}
<a name="__line4445"></a>		else
<a name="__line4446"></a>		{
<a name="__line4447"></a>		    if(fill_) t-&gt;set_color(g-&gt;fillcolor());
<a name="__line4448"></a>		    else      t-&gt;set_color(g-&gt;linecolor());
<a name="__line4449"></a>		}
<a name="__line4450"></a>		if(fill_) t-&gt;fill_polygon(cc);
<a name="__line4451"></a>		else
<a name="__line4452"></a>		{
<a name="__line4453"></a>		    t-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line4454"></a>		    t-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line4455"></a>		    t-&gt;draw_lines(cc);
<a name="__line4456"></a>		}
<a name="__line4457"></a>	    }
<a name="__line4458"></a>	}
<a name="__line4459"></a>
<a name="__line4460"></a>    }
<a name="__line4461"></a>    CATCH("csboxes::draw(...)")
<a name="__line4462"></a>
<a name="__line4463"></a>    graph_drawer *csboxes::clone() const
<a name="__line4464"></a>    {
<a name="__line4465"></a>	return new csboxes(*this);
<a name="__line4466"></a>    }
<a name="__line4467"></a>
<a name="__line4468"></a>    <span class=comment>// ---------- cboxes  -------------------------------------------------------------</span>
<a name="__line4469"></a>
<a name="__line4470"></a>    void cboxes::init_()
<a name="__line4471"></a>    {
<a name="__line4472"></a>	boxsize_x_func_ = 1;
<a name="__line4473"></a>	boxsize_y_func_ = 1;
<a name="__line4474"></a>	color_func_ = _3;
<a name="__line4475"></a>	xsize_range(0,1);
<a name="__line4476"></a>	ysize_range(0,1);
<a name="__line4477"></a>        <span class=comment>//cell_margin_ = 0.02;</span>
<a name="__line4478"></a>    }
<a name="__line4479"></a>    cboxes::cboxes() {init_();}
<a name="__line4480"></a>    cboxes::cboxes(const cboxes &amp;rhs) : csboxes(rhs) {init_();}
<a name="__line4481"></a>    cboxes::cboxes(const csboxes &amp;rhs) : csboxes(rhs) {init_();}
<a name="__line4482"></a>    cboxes::cboxes(double min, double max) { init_(); color_range(min,max); }
<a name="__line4483"></a>    cboxes::cboxes(const color &amp;start, const color &amp;end)
<a name="__line4484"></a>    {
<a name="__line4485"></a>	init_();
<a name="__line4486"></a>	color_range(start,end);
<a name="__line4487"></a>    }
<a name="__line4488"></a>    cboxes::cboxes(const std::vector&lt;blop::color&gt; &amp;colors)
<a name="__line4489"></a>    {
<a name="__line4490"></a>        init_();
<a name="__line4491"></a>        color_mapping(colors);
<a name="__line4492"></a>    }
<a name="__line4493"></a>    cboxes::cboxes(const std::vector&lt;blop::color&gt; &amp;colors, const std::vector&lt;double&gt; &amp;values, bool values_normalized)
<a name="__line4494"></a>    {
<a name="__line4495"></a>        init_();
<a name="__line4496"></a>        color_mapping(colors,values,values_normalized);
<a name="__line4497"></a>    }
<a name="__line4498"></a>
<a name="__line4499"></a>    cboxes::cboxes(void *p)
<a name="__line4500"></a>    {
<a name="__line4501"></a>	init_();
<a name="__line4502"></a>	operator()(p);
<a name="__line4503"></a>    }
<a name="__line4504"></a>    cboxes::cboxes(color (*p)(double,double,double))
<a name="__line4505"></a>    {
<a name="__line4506"></a>	init_();
<a name="__line4507"></a>	operator()(p);
<a name="__line4508"></a>    }
<a name="__line4509"></a>
<a name="__line4510"></a>    <span class=comment>// ---------- sboxes  -------------------------------------------------------------</span>
<a name="__line4511"></a>
<a name="__line4512"></a>    void sboxes::init_()
<a name="__line4513"></a>    {
<a name="__line4514"></a>	color_func_ = 1;
<a name="__line4515"></a>	draw_colorlegend_ = 0;
<a name="__line4516"></a>	boxsize_x_func_ = _3;
<a name="__line4517"></a>	boxsize_y_func_ = _3;
<a name="__line4518"></a>	fill_ = false;
<a name="__line4519"></a>    }
<a name="__line4520"></a>    sboxes::sboxes() {init_();}
<a name="__line4521"></a>    sboxes::sboxes(const sboxes &amp;rhs) : csboxes(rhs) {init_();}
<a name="__line4522"></a>    sboxes::sboxes(const csboxes &amp;rhs) : csboxes(rhs) {init_();}
<a name="__line4523"></a>    sboxes::sboxes(double min, double max) {init_(); xsize_range(min,max); ysize_range(min,max);}
<a name="__line4524"></a>    sboxes &amp;sboxes::operator()(double min, double max)
<a name="__line4525"></a>    {
<a name="__line4526"></a>	xsize_range(min,max);
<a name="__line4527"></a>	ysize_range(min,max);
<a name="__line4528"></a>	return *this;
<a name="__line4529"></a>    }
<a name="__line4530"></a>    void sboxes::draw_sample(const length &amp;x,
<a name="__line4531"></a>			     const length &amp;y,
<a name="__line4532"></a>			     const length &amp;size,
<a name="__line4533"></a>			     const plottable *s,
<a name="__line4534"></a>			     terminal *t)
<a name="__line4535"></a>    {
<a name="__line4536"></a>	vector&lt;terminal::coord&gt; cc;
<a name="__line4537"></a>	length l1 = !x - 0.5*!size;
<a name="__line4538"></a>	length l2 = !x + 0.5*!size;
<a name="__line4539"></a>	length l3 = !y - 0.5*0.8*EM;
<a name="__line4540"></a>	length l4 = !y + 0.5*0.8*EM;
<a name="__line4541"></a>	l1.specialize(t);
<a name="__line4542"></a>	l2.specialize(t);
<a name="__line4543"></a>	l3.specialize(t);
<a name="__line4544"></a>	l4.specialize(t);
<a name="__line4545"></a>	cc.push_back(terminal::coord(l1.termspecific_id(),l3.termspecific_id()));
<a name="__line4546"></a>	cc.push_back(terminal::coord(l2.termspecific_id(),l3.termspecific_id()));
<a name="__line4547"></a>	cc.push_back(terminal::coord(l2.termspecific_id(),l4.termspecific_id()));
<a name="__line4548"></a>	cc.push_back(terminal::coord(l1.termspecific_id(),l4.termspecific_id()));
<a name="__line4549"></a>	cc.push_back(terminal::coord(l1.termspecific_id(),l3.termspecific_id()));
<a name="__line4550"></a>	if(s-&gt;fill())
<a name="__line4551"></a>	{
<a name="__line4552"></a>	    t-&gt;set_color(s-&gt;fillcolor());
<a name="__line4553"></a>	    t-&gt;fill_polygon(cc);
<a name="__line4554"></a>	}
<a name="__line4555"></a>	else
<a name="__line4556"></a>	{
<a name="__line4557"></a>	    t-&gt;set_color(s-&gt;linecolor());
<a name="__line4558"></a>	    t-&gt;set_linewidth(s-&gt;linewidth().termspecific_id());
<a name="__line4559"></a>	    t-&gt;set_linestyle(s-&gt;linestyle());
<a name="__line4560"></a>	    t-&gt;draw_lines(cc);
<a name="__line4561"></a>	}
<a name="__line4562"></a>    }    
<a name="__line4563"></a>
<a name="__line4564"></a><span class=comment>/*
<a name="__line4565"></a>// ----------------------  sboxes  ------------------------------------
<a name="__line4566"></a>
<a name="__line4567"></a>void sboxes::prepare_for_draw(plottable *g, frame *f, int count)
<a name="__line4568"></a>{
<a name="__line4569"></a>if(count==1)
<a name="__line4570"></a>{
<a name="__line4571"></a>axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line4572"></a>axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line4573"></a>g-&gt;linewidth().register_me();
<a name="__line4574"></a>calc(g,xaxis,yaxis);
<a name="__line4575"></a>}
<a name="__line4576"></a>}
<a name="__line4577"></a>
<a name="__line4578"></a>sboxes::sboxes(const sboxes &amp;rhs)
<a name="__line4579"></a>{
<a name="__line4580"></a>dx_ = rhs.dx_;
<a name="__line4581"></a>dy_ = rhs.dy_;
<a name="__line4582"></a>min_ = rhs.min_;
<a name="__line4583"></a>max_ = rhs.max_;
<a name="__line4584"></a>min_fixed_ = rhs.min_fixed_;
<a name="__line4585"></a>max_fixed_ = rhs.max_fixed_;
<a name="__line4586"></a>}
<a name="__line4587"></a>
<a name="__line4588"></a>sboxes::sboxes(double minimum,double maximum)
<a name="__line4589"></a>{
<a name="__line4590"></a>dx_ = unset;
<a name="__line4591"></a>dy_ = unset;
<a name="__line4592"></a>min_ = minimum;
<a name="__line4593"></a>if(min_ == unset) min_fixed_ = false;
<a name="__line4594"></a>else min_fixed_ = true;
<a name="__line4595"></a>max_ = maximum;
<a name="__line4596"></a>if(max_ == unset) max_fixed_ = false;
<a name="__line4597"></a>else max_fixed_ = true;
<a name="__line4598"></a>}
<a name="__line4599"></a>
<a name="__line4600"></a>
<a name="__line4601"></a>void sboxes::set_ranges(plottable *g,axis *x,axis *y)
<a name="__line4602"></a>{
<a name="__line4603"></a>// As prepare_for_draw is already called, everything is set up.
<a name="__line4604"></a>x-&gt;autoextend_min_soft(false);
<a name="__line4605"></a>x-&gt;autoextend_max_soft(false);
<a name="__line4606"></a>y-&gt;autoextend_min_soft(false);
<a name="__line4607"></a>y-&gt;autoextend_max_soft(false);
<a name="__line4608"></a>}
<a name="__line4609"></a>
<a name="__line4610"></a>
<a name="__line4611"></a>void sboxes::calc(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line4612"></a>TRY
<a name="__line4613"></a>{
<a name="__line4614"></a>if(!g) err("Plottable to draw not set");
<a name="__line4615"></a>
<a name="__line4616"></a>function getx = get_x(g);
<a name="__line4617"></a>function gety = get_y(g);
<a name="__line4618"></a>function getdx = g-&gt;dx_hint();
<a name="__line4619"></a>function getdy = g-&gt;dy_hint();
<a name="__line4620"></a>function getz = g-&gt;z_hint();
<a name="__line4621"></a>if(!getz.initialized()) getz = _3;
<a name="__line4622"></a>
<a name="__line4623"></a>const bool calculate_dx = (dx_ == unset);
<a name="__line4624"></a>const bool calculate_dy = (dy_ == unset);
<a name="__line4625"></a>
<a name="__line4626"></a>if ( dx_==unset || dy_==unset )
<a name="__line4627"></a>{
<a name="__line4628"></a>if ( g-&gt;ordered() &gt;= 2)
<a name="__line4629"></a>{
<a name="__line4630"></a>double xmin=unset;
<a name="__line4631"></a>double xmax=unset;
<a name="__line4632"></a>double ymin=unset;
<a name="__line4633"></a>double ymax=unset;
<a name="__line4634"></a>int xbins=0;
<a name="__line4635"></a>int ybins=0;
<a name="__line4636"></a>int xdir=false;
<a name="__line4637"></a>int ydir=false;
<a name="__line4638"></a>double xfirst=unset;
<a name="__line4639"></a>double yfirst=unset;
<a name="__line4640"></a>double xsec=unset;
<a name="__line4641"></a>double ysec=unset;
<a name="__line4642"></a>for ( unsigned int i=0 ; i&lt;g-&gt;size() ; ++i )
<a name="__line4643"></a>{
<a name="__line4644"></a>const var x_var=getx.eval(*(g-&gt;get(i)));
<a name="__line4645"></a>const var y_var=gety.eval(*(g-&gt;get(i)));
<a name="__line4646"></a>if( ignore::it(x_var) || ignore::it(y_var) ) continue;
<a name="__line4647"></a>const double x=x_var.dbl();
<a name="__line4648"></a>const double y=y_var.dbl();
<a name="__line4649"></a>if ( xfirst!=unset &amp;&amp; xsec==unset &amp;&amp; yfirst!=unset &amp;&amp; ysec==unset )
<a name="__line4650"></a>{
<a name="__line4651"></a>xsec=x; 
<a name="__line4652"></a>ysec=y;
<a name="__line4653"></a>if ( xsec&gt;xfirst ) { xdir=true; ydir=false; ++xbins; }
<a name="__line4654"></a>else if ( ysec&gt;yfirst ) { ydir=true; xdir=false; ++ybins; }
<a name="__line4655"></a>else
<a name="__line4656"></a>{
<a name="__line4657"></a>warning::print("Cannot determine grid direction. "
<a name="__line4658"></a>"Assuming to be ordered in (y,x).",
<a name="__line4659"></a>"void cboxes::calc");
<a name="__line4660"></a>ydir=true;
<a name="__line4661"></a>xdir=false;
<a name="__line4662"></a>++ybins;
<a name="__line4663"></a>}
<a name="__line4664"></a>}
<a name="__line4665"></a>if ( xfirst==unset &amp;&amp; yfirst==unset )
<a name="__line4666"></a>{
<a name="__line4667"></a>xmin=x; xmax=x; xfirst=x;
<a name="__line4668"></a>ymin=y; ymax=y; yfirst=y;
<a name="__line4669"></a>}
<a name="__line4670"></a>if ( x&lt;xmin ) xmin=x;
<a name="__line4671"></a>else if ( xmax&lt;x ) xmax=x;
<a name="__line4672"></a>if ( y&lt;ymin ) ymin=y;
<a name="__line4673"></a>else if ( ymax&lt;y ) ymax=y;
<a name="__line4674"></a>if ( xdir &amp;&amp; !(y&gt;yfirst) ) ++xbins;
<a name="__line4675"></a>else if ( ydir &amp;&amp; !(x&gt;xfirst) ) ++ybins;
<a name="__line4676"></a>}
<a name="__line4677"></a>if ( xdir ) ybins=g-&gt;size()/xbins;
<a name="__line4678"></a>if ( ydir ) xbins=g-&gt;size()/ybins;
<a name="__line4679"></a>if ( calculate_dx ) dx_=(xmax-xmin)/(xbins-1);
<a name="__line4680"></a>if ( calculate_dy ) dy_=(ymax-ymin)/(ybins-1);
<a name="__line4681"></a>}
<a name="__line4682"></a>else if ( getdx.initialized() &amp;&amp; getdy.initialized() )
<a name="__line4683"></a>{
<a name="__line4684"></a>for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line4685"></a>{
<a name="__line4686"></a>const var x_var=getx.eval(*(g-&gt;get(i)));
<a name="__line4687"></a>const var y_var=gety.eval(*(g-&gt;get(i)));
<a name="__line4688"></a>const var dx_var=getdx.eval(*(g-&gt;get(i)));
<a name="__line4689"></a>const var dy_var=getdy.eval(*(g-&gt;get(i)));
<a name="__line4690"></a>if ( ignore::it(x_var) || ignore::it(y_var) || ignore::it(dx_var) || ignore::it(dy_var) ) continue;
<a name="__line4691"></a>double dx = dx_var.dbl();
<a name="__line4692"></a>double dy = dy_var.dbl();
<a name="__line4693"></a>if(calculate_dx &amp;&amp; (dx_==unset || dx &lt; dx_)) dx_ = dx;
<a name="__line4694"></a>if(calculate_dy &amp;&amp; (dy_==unset || dy &lt; dy_)) dy_ = dy;
<a name="__line4695"></a>}
<a name="__line4696"></a>}
<a name="__line4697"></a>else
<a name="__line4698"></a>{
<a name="__line4699"></a>map&lt;double,bool&gt; xvalues,yvalues;
<a name="__line4700"></a>for(plottable::size_type i1=0; i1&lt;g-&gt;size(); ++i1)
<a name="__line4701"></a>{
<a name="__line4702"></a>const var xorig1_var = getx.eval(*(g-&gt;get(i1)));
<a name="__line4703"></a>const var yorig1_var = gety.eval(*(g-&gt;get(i1)));
<a name="__line4704"></a>if(ignore::it(xorig1_var) || ignore::it(yorig1_var)) continue;
<a name="__line4705"></a>double xorig1 = xorig1_var.dbl();
<a name="__line4706"></a>double yorig1 = yorig1_var.dbl();
<a name="__line4707"></a>for(plottable::size_type i2=i1+1; i2&lt;g-&gt;size(); ++i2)
<a name="__line4708"></a>{
<a name="__line4709"></a>const var xorig2_var = getx.eval(*(g-&gt;get(i2)));
<a name="__line4710"></a>const var yorig2_var = gety.eval(*(g-&gt;get(i2)));
<a name="__line4711"></a>if(ignore::it(xorig2_var) || ignore::it(yorig2_var)) continue;
<a name="__line4712"></a>double xorig2 = xorig2_var.dbl();
<a name="__line4713"></a>double yorig2 = yorig2_var.dbl();
<a name="__line4714"></a>		    
<a name="__line4715"></a>if(calculate_dx &amp;&amp; xorig1!=xorig2)
<a name="__line4716"></a>{
<a name="__line4717"></a>if(xorig1 &gt; xorig2) swap(xorig1,xorig2);
<a name="__line4718"></a>if(dx_ == unset || (xorig2-xorig1) &lt; dx_) dx_ = (xorig2-xorig1);
<a name="__line4719"></a>}
<a name="__line4720"></a>		    
<a name="__line4721"></a>if(calculate_dy &amp;&amp; yorig1!=yorig2)
<a name="__line4722"></a>{
<a name="__line4723"></a>if(yorig1 &gt; yorig2) swap(yorig1,yorig2);
<a name="__line4724"></a>if(dy_ == unset || (yorig2-yorig1) &lt; dy_) dy_ = (yorig2-yorig1);
<a name="__line4725"></a>}
<a name="__line4726"></a>}
<a name="__line4727"></a>}
<a name="__line4728"></a>}
<a name="__line4729"></a>}
<a name="__line4730"></a>
<a name="__line4731"></a>if(dx_ == unset || dx_ &lt;=0)
<a name="__line4732"></a>{
<a name="__line4733"></a>warning::print("Couldn't figure out boxwidth, using dx=1","sboxes::calc(...)");
<a name="__line4734"></a>dx_ = 1;
<a name="__line4735"></a>}
<a name="__line4736"></a>if(dy_ == unset || dy_ &lt;=0)
<a name="__line4737"></a>{
<a name="__line4738"></a>warning::print("Couldn't figure out boxheight, using dx=1","sboxes::calc(...)");
<a name="__line4739"></a>dy_ = 1;
<a name="__line4740"></a>}
<a name="__line4741"></a>
<a name="__line4742"></a>// Set ranges:
<a name="__line4743"></a>if(g-&gt;xmin()!=unset) xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line4744"></a>if(g-&gt;xmax()!=unset) xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line4745"></a>if(g-&gt;ymin()!=unset) yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line4746"></a>if(g-&gt;ymax()!=unset) yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line4747"></a>if ( g-&gt;xmin()==unset || g-&gt;xmax()==unset || g-&gt;ymin()==unset || g-&gt;ymax()==unset || min_fixed_==false || max_fixed_==false )
<a name="__line4748"></a>{
<a name="__line4749"></a>double xmin=unset;
<a name="__line4750"></a>double xmax=unset;
<a name="__line4751"></a>double ymin=unset;
<a name="__line4752"></a>double ymax=unset;
<a name="__line4753"></a>double vmin=unset;
<a name="__line4754"></a>double vmax=unset;
<a name="__line4755"></a>for(plottable::size_type i=0; i &lt; g-&gt;size(); ++i)
<a name="__line4756"></a>{
<a name="__line4757"></a>const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line4758"></a>const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line4759"></a>if ( ignore::it(xorig_var) || ignore::it(yorig_var) ) continue;
<a name="__line4760"></a>const double xorig=xorig_var.dbl();
<a name="__line4761"></a>const double yorig=yorig_var.dbl();
<a name="__line4762"></a>if ( (xaxis-&gt;logscale() &amp;&amp; !(xorig-0.5*dx_&gt;0.0)) || (yaxis-&gt;logscale() &amp;&amp; !(yorig-0.5*dy_&gt;0.0)) ) continue;
<a name="__line4763"></a>if ( (g-&gt;xmin()!=unset &amp;&amp; xorig+0.5*dx_&lt;g-&gt;xmin()) || (g-&gt;xmax()!=unset &amp;&amp; xorig-0.5*dx_&gt;g-&gt;xmax()) || (g-&gt;ymin()!=unset &amp;&amp; yorig+0.5*dy_&lt;g-&gt;ymin()) || (g-&gt;ymax()!=unset &amp;&amp; yorig-0.5*dy_&gt;g-&gt;ymax()) ) continue;
<a name="__line4764"></a>if ( xmin==unset &amp;&amp; xmax==unset ) { xmin=xorig-0.5*dx_; xmax=xorig+0.5*dx_; }
<a name="__line4765"></a>if ( ymin==unset &amp;&amp; ymax==unset ) { ymin=yorig-0.5*dy_; ymax=yorig+0.5*dy_; }
<a name="__line4766"></a>if ( xorig-0.5*dx_&lt;xmin ) xmin=xorig-0.5*dx_;
<a name="__line4767"></a>else if ( xorig+0.5*dx_&gt;xmax ) xmax=xorig+0.5*dx_;
<a name="__line4768"></a>if ( yorig-0.5*dy_&lt;ymin ) ymin=yorig-0.5*dy_;
<a name="__line4769"></a>else if ( yorig+0.5*dy_&gt;ymax ) ymax=yorig+0.5*dy_;
<a name="__line4770"></a>
<a name="__line4771"></a>const var v_var = getz.eval(*(g-&gt;get(i)));
<a name="__line4772"></a>if ( ignore::it(v_var) ) continue;
<a name="__line4773"></a>const double v = v_var.dbl();
<a name="__line4774"></a>if((min_fixed_ &amp;&amp; v&lt;min_) || (max_fixed_ &amp;&amp; v&gt;max_)) continue;
<a name="__line4775"></a>if(vmin==unset &amp;&amp; vmax==unset) { vmin=v; vmax=v; }
<a name="__line4776"></a>if( v &gt; vmax) vmax = v;
<a name="__line4777"></a>else if( v &lt; vmin) vmin = v;
<a name="__line4778"></a>}
<a name="__line4779"></a>if(g-&gt;xmin()==unset &amp;&amp; xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line4780"></a>if(g-&gt;xmax()==unset &amp;&amp; xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line4781"></a>if(g-&gt;ymin()==unset &amp;&amp; ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line4782"></a>if(g-&gt;ymax()==unset &amp;&amp; ymax!=unset) yaxis-&gt;extend_range(ymax);
<a name="__line4783"></a>if(min_fixed_==false &amp;&amp; vmin!=unset) min_=vmin;
<a name="__line4784"></a>if(max_fixed_==false &amp;&amp; vmax!=unset) max_=vmax;
<a name="__line4785"></a>}
<a name="__line4786"></a>}
<a name="__line4787"></a>CATCH("sboxes::calc(...)")
<a name="__line4788"></a>
<a name="__line4789"></a>void sboxes::draw(plottable *g,frame *f,terminal *t)
<a name="__line4790"></a>TRY
<a name="__line4791"></a>{
<a name="__line4792"></a>if(!g || g-&gt;empty())  return;
<a name="__line4793"></a>
<a name="__line4794"></a>function getx = get_x(g);
<a name="__line4795"></a>function gety = get_y(g);
<a name="__line4796"></a>function getz = g-&gt;z_hint();
<a name="__line4797"></a>if(!getz.initialized()) getz = _3;
<a name="__line4798"></a>
<a name="__line4799"></a>if(g-&gt;fill())
<a name="__line4800"></a>{
<a name="__line4801"></a>t-&gt;set_color(g-&gt;fillcolor());
<a name="__line4802"></a>}
<a name="__line4803"></a>else
<a name="__line4804"></a>{
<a name="__line4805"></a>t-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line4806"></a>t-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line4807"></a>t-&gt;set_color(g-&gt;linecolor());
<a name="__line4808"></a>}
<a name="__line4809"></a>
<a name="__line4810"></a>t-&gt;reset_transformation();
<a name="__line4811"></a>
<a name="__line4812"></a>axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line4813"></a>axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line4814"></a>
<a name="__line4815"></a>double xmin = xaxis-&gt;min();
<a name="__line4816"></a>if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line4817"></a>double xmax = xaxis-&gt;max();
<a name="__line4818"></a>if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line4819"></a>
<a name="__line4820"></a>double ymin = yaxis-&gt;min();
<a name="__line4821"></a>if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line4822"></a>double ymax = yaxis-&gt;max();
<a name="__line4823"></a>if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line4824"></a>
<a name="__line4825"></a>vector&lt;terminal::coord&gt; cc;
<a name="__line4826"></a>
<a name="__line4827"></a>double maxi;
<a name="__line4828"></a>double mini;
<a name="__line4829"></a>
<a name="__line4830"></a>{
<a name="__line4831"></a>mini =  min_ - 0.1*(max_-min_);
<a name="__line4832"></a>maxi =  max_ + 0.1*(max_-min_);
<a name="__line4833"></a>}
<a name="__line4834"></a>if(min_fixed_) mini = min_;
<a name="__line4835"></a>if(max_fixed_) maxi = max_;
<a name="__line4836"></a>
<a name="__line4837"></a>for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line4838"></a>{	
<a name="__line4839"></a>const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line4840"></a>const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line4841"></a>const var zorig_var = getz.eval(*(g-&gt;get(i)));
<a name="__line4842"></a>if(ignore::it(xorig_var) || ignore::it(yorig_var) || ignore::it(zorig_var)) continue;
<a name="__line4843"></a>const double xorig = xorig_var.dbl();
<a name="__line4844"></a>const double yorig = yorig_var.dbl();
<a name="__line4845"></a>const double zorig = zorig_var.dbl();
<a name="__line4846"></a>
<a name="__line4847"></a>double dx = (zorig-mini)/(maxi-mini);
<a name="__line4848"></a>double dy = (zorig-mini)/(maxi-mini);
<a name="__line4849"></a>if ( dx&lt;0.0 ) dx=0.0;
<a name="__line4850"></a>if ( dx&gt;1.0 ) dx=1.0;
<a name="__line4851"></a>if ( dy&lt;0.0 ) dy=0.0;
<a name="__line4852"></a>if ( dy&gt;1.0 ) dy=1.0;
<a name="__line4853"></a>dx*=dx_;
<a name="__line4854"></a>dy*=dy_;
<a name="__line4855"></a>
<a name="__line4856"></a>if((xaxis-&gt;logscale() &amp;&amp; !(xorig-0.5*dx&gt;0.0)) || (yaxis-&gt;logscale() &amp;&amp; !(yorig-0.5*dy&gt;0.0))) continue;
<a name="__line4857"></a>if(xorig+0.5*dx&lt;xmin || xorig-0.5*dx&gt;xmax || yorig+0.5*dy&lt;ymin || yorig-0.5*dy&gt;ymax) continue;
<a name="__line4858"></a>
<a name="__line4859"></a>double x1 = xaxis-&gt;map_point(xorig - dx/2);
<a name="__line4860"></a>double x2 = xaxis-&gt;map_point(xorig + dx/2);
<a name="__line4861"></a>double y1 = yaxis-&gt;map_point(yorig - dy/2);
<a name="__line4862"></a>double y2 = yaxis-&gt;map_point(yorig + dy/2);
<a name="__line4863"></a>
<a name="__line4864"></a>if(0&lt;=x1 &amp;&amp; x1&lt;=1 &amp;&amp;
<a name="__line4865"></a>0&lt;=x2 &amp;&amp; x2&lt;=1 &amp;&amp;
<a name="__line4866"></a>0&lt;=y1 &amp;&amp; y1&lt;=1 &amp;&amp;
<a name="__line4867"></a>0&lt;=y2 &amp;&amp; y2&lt;=1)
<a name="__line4868"></a>{
<a name="__line4869"></a>cc.clear();
<a name="__line4870"></a>cc.push_back(terminal::coord(terminal::id(x1,1),terminal::id(y1,2)));
<a name="__line4871"></a>cc.push_back(terminal::coord(terminal::id(x1,1),terminal::id(y2,2)));
<a name="__line4872"></a>cc.push_back(terminal::coord(terminal::id(x2,1),terminal::id(y2,2)));
<a name="__line4873"></a>cc.push_back(terminal::coord(terminal::id(x2,1),terminal::id(y1,2)));
<a name="__line4874"></a>cc.push_back(terminal::coord(terminal::id(x1,1),terminal::id(y1,2)));
<a name="__line4875"></a>if(g-&gt;fill()) t-&gt;fill_polygon(cc);
<a name="__line4876"></a>else t-&gt;draw_lines(cc);
<a name="__line4877"></a>}
<a name="__line4878"></a>}
<a name="__line4879"></a>}
<a name="__line4880"></a>CATCH("sboxes::draw(...)")
<a name="__line4881"></a>
<a name="__line4882"></a>graph_drawer *sboxes::clone() const
<a name="__line4883"></a>{
<a name="__line4884"></a>return new sboxes(*this);
<a name="__line4885"></a>}
<a name="__line4886"></a>
<a name="__line4887"></a>void sboxes::set_range_(double mini, double maxi)
<a name="__line4888"></a>{
<a name="__line4889"></a>min_ = mini;
<a name="__line4890"></a>max_ = maxi;
<a name="__line4891"></a>if(mini == unset) min_fixed_ = false;
<a name="__line4892"></a>else min_fixed_ = true;
<a name="__line4893"></a>if(maxi == unset) max_fixed_ = false;
<a name="__line4894"></a>else max_fixed_ = true;
<a name="__line4895"></a>}
<a name="__line4896"></a>
<a name="__line4897"></a>
<a name="__line4898"></a>
<a name="__line4899"></a>*/</span>
<a name="__line4900"></a>
<a name="__line4901"></a><span class=comment>// ---------- band   --------------------------------------------------------------</span>
<a name="__line4902"></a>
<a name="__line4903"></a>function bands::get_x1_(plottable *g) const
<a name="__line4904"></a>{
<a name="__line4905"></a>    function result = g-&gt;x1_hint();
<a name="__line4906"></a>    if(!result.initialized()) result = _1;
<a name="__line4907"></a>    return result;
<a name="__line4908"></a>}
<a name="__line4909"></a>    function bands::get_x2_(plottable *g) const
<a name="__line4910"></a>    {
<a name="__line4911"></a>	function result = g-&gt;x2_hint();
<a name="__line4912"></a>	if(!result.initialized())
<a name="__line4913"></a>	{
<a name="__line4914"></a>	    if(x_) result = _2;
<a name="__line4915"></a>	    else return _1;
<a name="__line4916"></a>	}
<a name="__line4917"></a>	return result;
<a name="__line4918"></a>    }
<a name="__line4919"></a>    function bands::get_y1_(plottable *g) const
<a name="__line4920"></a>    {
<a name="__line4921"></a>	function result = g-&gt;y1_hint();
<a name="__line4922"></a>	if(!result.initialized())
<a name="__line4923"></a>	{
<a name="__line4924"></a>	    if(x_) result = _3;
<a name="__line4925"></a>	    else result = _2;
<a name="__line4926"></a>	}
<a name="__line4927"></a>	return result;
<a name="__line4928"></a>    }
<a name="__line4929"></a>    function bands::get_y2_(plottable *g) const
<a name="__line4930"></a>    {
<a name="__line4931"></a>	function result = g-&gt;y2_hint();
<a name="__line4932"></a>	if(!result.initialized())
<a name="__line4933"></a>	{
<a name="__line4934"></a>	    if(x_)
<a name="__line4935"></a>	    {
<a name="__line4936"></a>		if(y_) result = _4;
<a name="__line4937"></a>		else result = _3;
<a name="__line4938"></a>	    }
<a name="__line4939"></a>	    else
<a name="__line4940"></a>	    {
<a name="__line4941"></a>		if(y_) 	result = _3;
<a name="__line4942"></a>		else result = _2;
<a name="__line4943"></a>	    }
<a name="__line4944"></a>	}
<a name="__line4945"></a>	return result;
<a name="__line4946"></a>    }
<a name="__line4947"></a>
<a name="__line4948"></a>
<a name="__line4949"></a>    void bands::set_ranges(plottable *g,axis *xaxis,axis *yaxis)
<a name="__line4950"></a>	TRY
<a name="__line4951"></a>    {
<a name="__line4952"></a>	if(!g) err("Plottable to draw not set");
<a name="__line4953"></a>	if(!xaxis) err("Xaxis not set");
<a name="__line4954"></a>	if(!yaxis) err("Yaxis not set");
<a name="__line4955"></a>	if(g-&gt;empty()) return;
<a name="__line4956"></a>
<a name="__line4957"></a>	if(g-&gt;xmin()!=unset) xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line4958"></a>	if(g-&gt;xmax()!=unset) xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line4959"></a>	if(g-&gt;ymin()!=unset) yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line4960"></a>	if(g-&gt;ymax()!=unset) yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line4961"></a>
<a name="__line4962"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmax()!=unset &amp;&amp; g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymax()!=unset) return;
<a name="__line4963"></a>
<a name="__line4964"></a>	function gety1 = get_y1_(g);
<a name="__line4965"></a>	function gety2 = get_y2_(g);
<a name="__line4966"></a>	function getx1 = get_x1_(g);
<a name="__line4967"></a>	function getx2 = get_x2_(g);
<a name="__line4968"></a>
<a name="__line4969"></a>	double xmin=unset;
<a name="__line4970"></a>	double xmax=unset;
<a name="__line4971"></a>	double ymin=unset;
<a name="__line4972"></a>	double ymax=unset;
<a name="__line4973"></a>
<a name="__line4974"></a>	for ( unsigned int i=0 ; i&lt;g-&gt;size() ; ++i )
<a name="__line4975"></a>	{
<a name="__line4976"></a>
<a name="__line4977"></a>	    const var x1orig_var=getx1.eval(*g-&gt;get(i));
<a name="__line4978"></a>	    if ( !ignore::it(x1orig_var) )
<a name="__line4979"></a>	    {
<a name="__line4980"></a>		const double x1orig=x1orig_var.dbl();
<a name="__line4981"></a>		if ( !(xaxis-&gt;logscale() &amp;&amp; !(x1orig&gt;0.0)) )
<a name="__line4982"></a>		{
<a name="__line4983"></a>		    if ( !((g-&gt;xmin()!=unset &amp;&amp; x1orig&lt;g-&gt;xmin()) || (g-&gt;xmax()!=unset &amp;&amp; x1orig&gt;g-&gt;xmax())) )
<a name="__line4984"></a>		    {
<a name="__line4985"></a>			if ( xmin==unset &amp;&amp; xmax==unset ) { xmin=x1orig; xmax=x1orig; }
<a name="__line4986"></a>			if ( x1orig&lt;xmin ) xmin=x1orig;
<a name="__line4987"></a>			else if ( x1orig&gt;xmax ) xmax=x1orig;
<a name="__line4988"></a>
<a name="__line4989"></a>			const var y1orig_var=gety1.eval(*g-&gt;get(i));
<a name="__line4990"></a>			if ( !ignore::it(y1orig_var) )
<a name="__line4991"></a>			{
<a name="__line4992"></a>			    const double y1orig=y1orig_var.dbl();
<a name="__line4993"></a>			    if ( !(yaxis-&gt;logscale() &amp;&amp; !(y1orig&gt;0.0)) )
<a name="__line4994"></a>			    {
<a name="__line4995"></a>				if ( !((g-&gt;ymin()!=unset &amp;&amp; y1orig&lt;g-&gt;ymin()) || (g-&gt;ymax()!=unset &amp;&amp; y1orig&gt;g-&gt;ymax())) )
<a name="__line4996"></a>				{
<a name="__line4997"></a>				    if ( ymin==unset &amp;&amp; ymax==unset ) { ymin=y1orig; ymax=y1orig; }
<a name="__line4998"></a>				    if ( y1orig&lt;ymin ) ymin=y1orig;
<a name="__line4999"></a>				    else if ( y1orig&gt;ymax ) ymax=y1orig;
<a name="__line5000"></a>				}
<a name="__line5001"></a>			    }
<a name="__line5002"></a>			}
<a name="__line5003"></a>		    }
<a name="__line5004"></a>		}
<a name="__line5005"></a>	    }
<a name="__line5006"></a>
<a name="__line5007"></a>	    const var x2orig_var=getx2.eval(*g-&gt;get(i));
<a name="__line5008"></a>	    if ( !ignore::it(x2orig_var) )
<a name="__line5009"></a>	    {
<a name="__line5010"></a>		const double x2orig=x2orig_var.dbl();
<a name="__line5011"></a>		if ( !(xaxis-&gt;logscale() &amp;&amp; !(x2orig&gt;0.0)) )
<a name="__line5012"></a>		{
<a name="__line5013"></a>		    if ( !((g-&gt;xmin()!=unset &amp;&amp; x2orig&lt;g-&gt;xmin()) || (g-&gt;xmax()!=unset &amp;&amp; x2orig&gt;g-&gt;xmax())) )
<a name="__line5014"></a>		    {
<a name="__line5015"></a>			if ( xmin==unset &amp;&amp; xmax==unset ) { xmin=x2orig; xmax=x2orig; }
<a name="__line5016"></a>			if ( x2orig&lt;xmin ) xmin=x2orig;
<a name="__line5017"></a>			else if ( x2orig&gt;xmax ) xmax=x2orig;
<a name="__line5018"></a>
<a name="__line5019"></a>			const var y2orig_var=gety2.eval(*g-&gt;get(i));
<a name="__line5020"></a>			if ( !ignore::it(y2orig_var) )
<a name="__line5021"></a>			{
<a name="__line5022"></a>			    const double y2orig=y2orig_var.dbl();
<a name="__line5023"></a>			    if ( !(yaxis-&gt;logscale() &amp;&amp; !(y2orig&gt;0.0)) )
<a name="__line5024"></a>			    {
<a name="__line5025"></a>				if ( !((g-&gt;ymin()!=unset &amp;&amp; y2orig&lt;g-&gt;ymin()) || (g-&gt;ymax()!=unset &amp;&amp; y2orig&gt;g-&gt;ymax())) )
<a name="__line5026"></a>				{
<a name="__line5027"></a>				    if ( ymin==unset &amp;&amp; ymax==unset ) { ymin=y2orig; ymax=y2orig; }
<a name="__line5028"></a>				    if ( y2orig&lt;ymin ) ymin=y2orig;
<a name="__line5029"></a>				    else if ( y2orig&gt;ymax ) ymax=y2orig;
<a name="__line5030"></a>				}
<a name="__line5031"></a>			    }
<a name="__line5032"></a>			}
<a name="__line5033"></a>		    }
<a name="__line5034"></a>		}
<a name="__line5035"></a>	    }
<a name="__line5036"></a>
<a name="__line5037"></a>	}
<a name="__line5038"></a>
<a name="__line5039"></a>	if (g-&gt;xmin()==unset &amp;&amp; xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line5040"></a>	if (g-&gt;xmax()==unset &amp;&amp; xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line5041"></a>	if (g-&gt;ymin()==unset &amp;&amp; ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line5042"></a>	if (g-&gt;ymax()==unset &amp;&amp; ymax!=unset) yaxis-&gt;extend_range(ymax);
<a name="__line5043"></a>    }
<a name="__line5044"></a>    CATCH("bands::set_ranges()")
<a name="__line5045"></a>
<a name="__line5046"></a>    void bands::draw(plottable *g,frame *f,terminal *t)
<a name="__line5047"></a>    TRY
<a name="__line5048"></a>    {
<a name="__line5049"></a>	if(!g) err("Plottable to draw not set");
<a name="__line5050"></a>	if(g-&gt;empty())  return;
<a name="__line5051"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line5052"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line5053"></a>	if(xaxis == 0 || yaxis == 0) return;
<a name="__line5054"></a>
<a name="__line5055"></a>	double xmin = xaxis-&gt;min();
<a name="__line5056"></a>	if(g-&gt;xmin() != unset &amp;&amp; g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line5057"></a>	double xmax = xaxis-&gt;max();
<a name="__line5058"></a>	if(g-&gt;xmax() != unset &amp;&amp; g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line5059"></a>	    
<a name="__line5060"></a>	double ymin = yaxis-&gt;min();
<a name="__line5061"></a>	if(g-&gt;ymin() != unset &amp;&amp; g-&gt;ymin() &gt; ymin) ymin = g-&gt;ymin();
<a name="__line5062"></a>	double ymax = yaxis-&gt;max();
<a name="__line5063"></a>	if(g-&gt;ymax() != unset &amp;&amp; g-&gt;ymax() &lt; ymax) ymax = g-&gt;ymax();
<a name="__line5064"></a>
<a name="__line5065"></a>	function gety1 = get_y1_(g);
<a name="__line5066"></a>	function gety2 = get_y2_(g);
<a name="__line5067"></a>	function getx1 = get_x1_(g);
<a name="__line5068"></a>	function getx2 = get_x2_(g);
<a name="__line5069"></a>
<a name="__line5070"></a>	vector&lt;terminal::coord&gt; cc;
<a name="__line5071"></a>
<a name="__line5072"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line5073"></a>	{
<a name="__line5074"></a>	    const var x1orig = getx1.eval(*(g-&gt;get(i)));
<a name="__line5075"></a>	    const var y1orig = gety1.eval(*(g-&gt;get(i)));
<a name="__line5076"></a>	    const var x2orig = getx2.eval(*(g-&gt;get(i)));
<a name="__line5077"></a>	    const var y2orig = gety2.eval(*(g-&gt;get(i)));
<a name="__line5078"></a>	    if(ignore::it(x1orig) || ignore::it(x2orig) ||
<a name="__line5079"></a>	       ignore::it(y1orig) || ignore::it(y2orig)) continue;
<a name="__line5080"></a>	    if((xaxis-&gt;logscale() &amp;&amp; !(x1orig.dbl()&gt;0.0)) ||
<a name="__line5081"></a>	       (xaxis-&gt;logscale() &amp;&amp; !(x2orig.dbl()&gt;0.0)) ||
<a name="__line5082"></a>	       (yaxis-&gt;logscale() &amp;&amp; !(y1orig.dbl()&gt;0.0)) ||
<a name="__line5083"></a>	       (yaxis-&gt;logscale() &amp;&amp; !(y2orig.dbl()&gt;0.0))) continue;
<a name="__line5084"></a>
<a name="__line5085"></a>	    const double x = xaxis-&gt;map_point(x1orig.dbl());
<a name="__line5086"></a>	    const double y = yaxis-&gt;map_point(y1orig.dbl());
<a name="__line5087"></a>
<a name="__line5088"></a>	    cc.push_back(terminal::coord(terminal::id(x,1),terminal::id(y,2)));
<a name="__line5089"></a>	}
<a name="__line5090"></a>
<a name="__line5091"></a>	for(int i=g-&gt;size()-1; i &gt;= 0; --i)
<a name="__line5092"></a>	{
<a name="__line5093"></a>	    const var x1orig = getx1.eval(*(g-&gt;get(i)));
<a name="__line5094"></a>	    const var y1orig = gety1.eval(*(g-&gt;get(i)));
<a name="__line5095"></a>	    const var x2orig = getx2.eval(*(g-&gt;get(i)));
<a name="__line5096"></a>	    const var y2orig = gety2.eval(*(g-&gt;get(i)));
<a name="__line5097"></a>	    if(ignore::it(x1orig) || ignore::it(x2orig) ||
<a name="__line5098"></a>	       ignore::it(y1orig) || ignore::it(y2orig)) continue;
<a name="__line5099"></a>	    if((xaxis-&gt;logscale() &amp;&amp; !(x1orig.dbl()&gt;0.0)) ||
<a name="__line5100"></a>	       (xaxis-&gt;logscale() &amp;&amp; !(x2orig.dbl()&gt;0.0)) ||
<a name="__line5101"></a>	       (yaxis-&gt;logscale() &amp;&amp; !(y1orig.dbl()&gt;0.0)) ||
<a name="__line5102"></a>	       (yaxis-&gt;logscale() &amp;&amp; !(y2orig.dbl()&gt;0.0))) continue;
<a name="__line5103"></a>
<a name="__line5104"></a>	    double x = xaxis-&gt;map_point(x2orig.dbl());
<a name="__line5105"></a>	    double y = yaxis-&gt;map_point(y2orig.dbl());
<a name="__line5106"></a>
<a name="__line5107"></a>	    cc.push_back(terminal::coord(terminal::id(x,1),terminal::id(y,2)));
<a name="__line5108"></a>	}
<a name="__line5109"></a>
<a name="__line5110"></a>	t-&gt;set_color(g-&gt;fillcolor());
<a name="__line5111"></a>	bool termclip = t-&gt;clip(terminal::coord(terminal::id(xaxis-&gt;map_point(xmin),1),
<a name="__line5112"></a>						terminal::id(yaxis-&gt;map_point(ymin),2)),
<a name="__line5113"></a>				terminal::coord(terminal::id(xaxis-&gt;map_point(xmax),1),
<a name="__line5114"></a>						terminal::id(yaxis-&gt;map_point(ymax),2)));
<a name="__line5115"></a>	if(!termclip) warning::print("This terminal does not support clipping. "
<a name="__line5116"></a>				     "Graph drawn with band style might reach out of frame",
<a name="__line5117"></a>				     "bands::draw(...)");
<a name="__line5118"></a>	t-&gt;fill_polygon(cc);
<a name="__line5119"></a>	if(termclip) t-&gt;noclip();
<a name="__line5120"></a>    }
<a name="__line5121"></a>    CATCH("bands::draw(plottable *,frame *,terminal *)")
<a name="__line5122"></a>
<a name="__line5123"></a>    void bands::draw_sample(const length &amp;x,const length &amp;y,
<a name="__line5124"></a>			    const length &amp;size,
<a name="__line5125"></a>			    const plottable *g,terminal *t)
<a name="__line5126"></a>    {
<a name="__line5127"></a>	length x1 = -0.5*!size;
<a name="__line5128"></a>	length x2 =  0.5*!size;
<a name="__line5129"></a>	length y1 = -0.5*EX;
<a name="__line5130"></a>	length y2 = 0.5*EX;
<a name="__line5131"></a>
<a name="__line5132"></a>	x1.specialize(t);
<a name="__line5133"></a>	x2.specialize(t);
<a name="__line5134"></a>	y1.specialize(t);
<a name="__line5135"></a>	y2.specialize(t);
<a name="__line5136"></a>	
<a name="__line5137"></a>	vector&lt;terminal::coord&gt; cc;
<a name="__line5138"></a>
<a name="__line5139"></a>	cc.push_back(terminal::coord(x1.termspecific_id(),y1.termspecific_id()));
<a name="__line5140"></a>	cc.push_back(terminal::coord(x2.termspecific_id(),y1.termspecific_id()));
<a name="__line5141"></a>	cc.push_back(terminal::coord(x2.termspecific_id(),y2.termspecific_id()));
<a name="__line5142"></a>	cc.push_back(terminal::coord(x1.termspecific_id(),y2.termspecific_id()));
<a name="__line5143"></a>	cc.push_back(terminal::coord(x1.termspecific_id(),y1.termspecific_id()));
<a name="__line5144"></a>	t-&gt;translate(x.termspecific_id(),y.termspecific_id());
<a name="__line5145"></a>	t-&gt;set_color(g-&gt;fillcolor());
<a name="__line5146"></a>	t-&gt;fill_polygon(cc);
<a name="__line5147"></a>	t-&gt;reset_transformation();
<a name="__line5148"></a>
<a name="__line5149"></a>    }
<a name="__line5150"></a>
<a name="__line5151"></a>    graph_drawer *bands::clone() const
<a name="__line5152"></a>    {
<a name="__line5153"></a>	return new bands(*this);
<a name="__line5154"></a>    }
<a name="__line5155"></a>
<a name="__line5156"></a>
<a name="__line5157"></a>    <span class=comment>// ---------- mosaic  -------------------------------------------------------------</span>
<a name="__line5158"></a>
<a name="__line5159"></a>    bool mosaic::default_frame_foreground_ = true;
<a name="__line5160"></a>    bool mosaic::default_grid_foreground_ = false;
<a name="__line5161"></a>
<a name="__line5162"></a>    mosaic::mosaic(const mosaic &amp;rhs)
<a name="__line5163"></a>	: cbox_base(rhs), params_to_xy_(rhs.params_to_xy_), fixdp_(rhs.fixdp_),
<a name="__line5164"></a>	  frame_foreground_(rhs.frame_foreground_), grid_foreground_(rhs.grid_foreground_)
<a name="__line5165"></a>    {
<a name="__line5166"></a>    }
<a name="__line5167"></a>
<a name="__line5168"></a>
<a name="__line5169"></a>    mosaic::mosaic(const function &amp;f1)
<a name="__line5170"></a>	: params_to_xy_(f1), fixdp_(true),
<a name="__line5171"></a>	  frame_foreground_(mosaic::default_frame_foreground_),
<a name="__line5172"></a>	  grid_foreground_(mosaic::default_grid_foreground_)
<a name="__line5173"></a>    {
<a name="__line5174"></a>    }
<a name="__line5175"></a>
<a name="__line5176"></a>    mosaic::mosaic(const function &amp;f1, const function &amp;f2)
<a name="__line5177"></a>	: params_to_xy_(f1,f2), fixdp_(true),
<a name="__line5178"></a>	  frame_foreground_(mosaic::default_frame_foreground_),
<a name="__line5179"></a>	  grid_foreground_(mosaic::default_grid_foreground_)
<a name="__line5180"></a>    {
<a name="__line5181"></a>    }
<a name="__line5182"></a>
<a name="__line5183"></a>    void mosaic::set_ranges(plottable *g, axis *x, axis *y)
<a name="__line5184"></a>    {
<a name="__line5185"></a>	vector&lt;var&gt; params(2), xy(2);
<a name="__line5186"></a>	for(unsigned int i=0; i&lt;g-&gt;size(); ++i)
<a name="__line5187"></a>	{
<a name="__line5188"></a>	    params[0] = (*g-&gt;get(i))[0];
<a name="__line5189"></a>	    params[1] = (*g-&gt;get(i))[1];
<a name="__line5190"></a>	    params_to_xy_.meval(params,xy);
<a name="__line5191"></a>	    x-&gt;extend_range(xy[0].dbl());
<a name="__line5192"></a>	    y-&gt;extend_range(xy[1].dbl());
<a name="__line5193"></a>
<a name="__line5194"></a>	}
<a name="__line5195"></a>    }
<a name="__line5196"></a>
<a name="__line5197"></a>    void mosaic::prepare_for_draw(plottable *g, frame *f, int count)
<a name="__line5198"></a>    {
<a name="__line5199"></a>	if(count==1)
<a name="__line5200"></a>	{
<a name="__line5201"></a>	    if(frame_foreground_) f-&gt;foreground(true);
<a name="__line5202"></a>	    double zmin=unset, zmax=unset;
<a name="__line5203"></a>	    for(unsigned int i=0; i&lt;g-&gt;size(); ++i)
<a name="__line5204"></a>	    {
<a name="__line5205"></a>		const double z = (*g-&gt;get(i))[2];
<a name="__line5206"></a>		if(zmin == unset || z&lt;zmin) zmin = z;
<a name="__line5207"></a>		if(zmax == unset || z&gt;zmax) zmax = z;
<a name="__line5208"></a>	    }
<a name="__line5209"></a>	    if(!color_min_fixed_ &amp;&amp; zmin!=unset) color_min_ = zmin;
<a name="__line5210"></a>	    if(!color_max_fixed_ &amp;&amp; zmax!=unset) color_max_ = zmax;
<a name="__line5211"></a>	    if(colorlegend_)
<a name="__line5212"></a>	    {
<a name="__line5213"></a>		colorlegend_-&gt;clear_tics();
<a name="__line5214"></a>		if(draw_colorlegend_&lt;2) colorlegend_-&gt;off();
<a name="__line5215"></a>		if(color_title_.str()!="")
<a name="__line5216"></a>		{
<a name="__line5217"></a>		    var new_title = colorlegend_-&gt;title();
<a name="__line5218"></a>		    if(new_title.str() != "") new_title &amp;= ", ";
<a name="__line5219"></a>		    new_title &amp;= color_title_;
<a name="__line5220"></a>		    colorlegend_-&gt;title(new_title);
<a name="__line5221"></a>		}
<a name="__line5222"></a>	    }
<a name="__line5223"></a>	}
<a name="__line5224"></a>
<a name="__line5225"></a>	if(count==2)
<a name="__line5226"></a>	{
<a name="__line5227"></a>	    <span class=comment>// Let the colorlegend calculate the unified range for all</span>
<a name="__line5228"></a>	    <span class=comment>// of its graphs</span>
<a name="__line5229"></a>	    if(colorlegend_)
<a name="__line5230"></a>	    {
<a name="__line5231"></a>		colorlegend_-&gt;calculate_tics();
<a name="__line5232"></a>		if(draw_colorlegend_&gt;=2) colorlegend_-&gt;on();  <span class=comment>// if any of the graphs have legend on...</span>
<a name="__line5233"></a>	    }		
<a name="__line5234"></a>	}
<a name="__line5235"></a>    }
<a name="__line5236"></a>
<a name="__line5237"></a>    void mosaic::draw(plottable *g, frame *f, terminal *term)
<a name="__line5238"></a>    {
<a name="__line5239"></a>	if(!g || g-&gt;empty()) return;
<a name="__line5240"></a>	term-&gt;reset_transformation();
<a name="__line5241"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line5242"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line5243"></a>
<a name="__line5244"></a>	std::map&lt;double,bool&gt; p1map, p2map;
<a name="__line5245"></a>	double zmin = unset, zmax = unset;
<a name="__line5246"></a>
<a name="__line5247"></a>	<span class=comment>// first loop over the whole graph, and collect the values of the parameters</span>
<a name="__line5248"></a>	for(unsigned int i=0; i&lt;g-&gt;size(); ++i)
<a name="__line5249"></a>	{
<a name="__line5250"></a>	    p1map[(*g-&gt;get(i))[0].dbl()];
<a name="__line5251"></a>	    p2map[(*g-&gt;get(i))[1].dbl()];
<a name="__line5252"></a>
<a name="__line5253"></a>	    const double z = (*g-&gt;get(i))[2];
<a name="__line5254"></a>	    if(zmin == unset || z &lt; zmin) zmin = z;
<a name="__line5255"></a>	    if(zmax == unset || z &gt; zmax) zmax = z;
<a name="__line5256"></a>	}
<a name="__line5257"></a>
<a name="__line5258"></a>	if(color_min_fixed_) zmin = color_min_;
<a name="__line5259"></a>	if(color_max_fixed_) zmax = color_max_;
<a name="__line5260"></a>
<a name="__line5261"></a>	<span class=comment>// if we assume a fix stepsize in both parameters, then loop over</span>
<a name="__line5262"></a>	<span class=comment>// all neighbouring parameter values, and calculate the smallest</span>
<a name="__line5263"></a>	<span class=comment>// difference between them</span>
<a name="__line5264"></a>	double dp1=unset, dp2=unset;
<a name="__line5265"></a>	if(fixdp_)
<a name="__line5266"></a>	{
<a name="__line5267"></a>	    {
<a name="__line5268"></a>		std::map&lt;double,bool&gt;::iterator i=p1map.begin();
<a name="__line5269"></a>		for(++i; i != p1map.end(); ++i)
<a name="__line5270"></a>		{
<a name="__line5271"></a>		    std::map&lt;double,bool&gt;::iterator prev = i; --prev;
<a name="__line5272"></a>		    const double diff = ::fabs((*i).first-(*prev).first);
<a name="__line5273"></a>		    if(dp1 == unset || diff&lt;dp1) dp1=diff;
<a name="__line5274"></a>		}
<a name="__line5275"></a>	    }
<a name="__line5276"></a>	    {
<a name="__line5277"></a>		std::map&lt;double,bool&gt;::iterator i=p2map.begin();
<a name="__line5278"></a>		for(++i; i != p2map.end(); ++i)
<a name="__line5279"></a>		{
<a name="__line5280"></a>		    std::map&lt;double,bool&gt;::iterator prev = i; --prev;
<a name="__line5281"></a>		    const double diff = ::fabs((*i).first-(*prev).first);
<a name="__line5282"></a>		    if(dp2 == unset || diff&lt;dp2) dp2=diff;
<a name="__line5283"></a>		}
<a name="__line5284"></a>	    }
<a name="__line5285"></a>	}
<a name="__line5286"></a>
<a name="__line5287"></a>	std::vector&lt;blop::var&gt; param(2);
<a name="__line5288"></a>	std::vector&lt;blop::var&gt; xy   (2);
<a name="__line5289"></a>	for(unsigned int i=0; i&lt;g-&gt;size(); ++i)
<a name="__line5290"></a>	{
<a name="__line5291"></a>	    const double z = (*g-&gt;get(i))[2];
<a name="__line5292"></a>	    if(z&lt;zmin || zmax&lt;z) continue;
<a name="__line5293"></a>	    param[0] = (*g-&gt;get(i))[0];
<a name="__line5294"></a>	    param[1] = (*g-&gt;get(i))[1];
<a name="__line5295"></a>	    
<a name="__line5296"></a>	    double p1_1, p1_2, p2_1, p2_2;
<a name="__line5297"></a>
<a name="__line5298"></a>	    if(fixdp_)
<a name="__line5299"></a>	    {
<a name="__line5300"></a>		p1_1 = param[0].dbl()-0.5*dp1;
<a name="__line5301"></a>		p1_2 = param[0].dbl()+0.5*dp1;
<a name="__line5302"></a>		p2_1 = param[1].dbl()-0.5*dp2;
<a name="__line5303"></a>		p2_2 = param[1].dbl()+0.5*dp2;
<a name="__line5304"></a>	    }
<a name="__line5305"></a>	    else
<a name="__line5306"></a>	    {
<a name="__line5307"></a>		const std::map&lt;double,bool&gt;::iterator p1i = p1map.find(param[0].dbl());
<a name="__line5308"></a>		const std::map&lt;double,bool&gt;::iterator p2i = p2map.find(param[1].dbl());
<a name="__line5309"></a>		
<a name="__line5310"></a>		map&lt;double,bool&gt;::iterator other;
<a name="__line5311"></a>		
<a name="__line5312"></a>		if(p1i == p1map.begin())
<a name="__line5313"></a>		{
<a name="__line5314"></a>		    other = p1i; ++other; <span class=comment>// get the next one</span>
<a name="__line5315"></a>		    p1_1 = 1.5*(*p1i).first-0.5*(*other).first;
<a name="__line5316"></a>		}
<a name="__line5317"></a>		else
<a name="__line5318"></a>		{
<a name="__line5319"></a>		    other = p1i; --other;  <span class=comment>// get the previous one</span>
<a name="__line5320"></a>		    p1_1 = 0.5*( (*other).first + (*p1i).first );
<a name="__line5321"></a>		}
<a name="__line5322"></a>		
<a name="__line5323"></a>		<span class=comment>// set upper limit of p1</span>
<a name="__line5324"></a>		other = p1i; ++other;
<a name="__line5325"></a>		if(other == p1map.end())
<a name="__line5326"></a>		{
<a name="__line5327"></a>		    other = p1i; --other;  <span class=comment>// get previous one</span>
<a name="__line5328"></a>		    p1_2 = 1.5*(*p1i).first - 0.5*(*other).first;
<a name="__line5329"></a>		}
<a name="__line5330"></a>		else
<a name="__line5331"></a>		{
<a name="__line5332"></a>		    p1_2 = 0.5*( (*p1i).first + (*other).first );
<a name="__line5333"></a>		}
<a name="__line5334"></a>		
<a name="__line5335"></a>		if(p2i == p2map.begin())
<a name="__line5336"></a>		{
<a name="__line5337"></a>		    other = p2i; ++other; <span class=comment>// get the next one</span>
<a name="__line5338"></a>		    p2_1 = 1.5*(*p2i).first-0.5*(*other).first;
<a name="__line5339"></a>		}
<a name="__line5340"></a>		else
<a name="__line5341"></a>		{
<a name="__line5342"></a>		    other = p2i; --other;  <span class=comment>// get the previous one</span>
<a name="__line5343"></a>		    p2_1 = 0.5*( (*other).first + (*p2i).first );
<a name="__line5344"></a>		}
<a name="__line5345"></a>		
<a name="__line5346"></a>		<span class=comment>// set upper limit of p2</span>
<a name="__line5347"></a>		other = p2i; ++other;
<a name="__line5348"></a>		if(other == p2map.end())
<a name="__line5349"></a>		{
<a name="__line5350"></a>		    other = p2i; --other;  <span class=comment>// get previous one</span>
<a name="__line5351"></a>		    p2_2 = 1.5*(*p2i).first - 0.5*(*other).first;
<a name="__line5352"></a>		}
<a name="__line5353"></a>		else
<a name="__line5354"></a>		{
<a name="__line5355"></a>		    p2_2 = 0.5*( (*p2i).first + (*other).first );
<a name="__line5356"></a>		}
<a name="__line5357"></a>	    }
<a name="__line5358"></a>
<a name="__line5359"></a>	    vector&lt;double&gt; x, y;
<a name="__line5360"></a>
<a name="__line5361"></a>	    const int N = 5;
<a name="__line5362"></a>
<a name="__line5363"></a>	    <span class=comment>// fix the first param to p1_1, and scan the second param</span>
<a name="__line5364"></a>	    param[0] = p1_1;  
<a name="__line5365"></a>	    for(int n=0; n&lt;N; ++n)
<a name="__line5366"></a>	    {
<a name="__line5367"></a>		param[1] = p2_1 + n*(p2_2-p2_1)/N;
<a name="__line5368"></a>		params_to_xy_.meval(param,xy);
<a name="__line5369"></a>		x.push_back(xaxis-&gt;map_point(xy[0].dbl()));
<a name="__line5370"></a>		y.push_back(yaxis-&gt;map_point(xy[1].dbl()));
<a name="__line5371"></a>	    }
<a name="__line5372"></a>
<a name="__line5373"></a>	    <span class=comment>// now fix second param to p2_2, and scan the first param</span>
<a name="__line5374"></a>	    param[1] = p2_2;
<a name="__line5375"></a>	    for(int n=0; n&lt;N; ++n)
<a name="__line5376"></a>	    {
<a name="__line5377"></a>		param[0] = p1_1 + n*(p1_2-p1_1)/N;
<a name="__line5378"></a>		params_to_xy_.meval(param,xy);
<a name="__line5379"></a>		x.push_back(xaxis-&gt;map_point(xy[0].dbl()));
<a name="__line5380"></a>		y.push_back(yaxis-&gt;map_point(xy[1].dbl()));
<a name="__line5381"></a>	    }
<a name="__line5382"></a>
<a name="__line5383"></a>	    <span class=comment>// now fix the first param to p1_2, and scan the second param</span>
<a name="__line5384"></a>	    param[0] = p1_2;
<a name="__line5385"></a>	    for(int n=0; n&lt;N; ++n)
<a name="__line5386"></a>	    {
<a name="__line5387"></a>		param[1] = p2_2 - n*(p2_2-p2_1)/N;
<a name="__line5388"></a>		params_to_xy_.meval(param,xy);
<a name="__line5389"></a>		x.push_back(xaxis-&gt;map_point(xy[0].dbl()));
<a name="__line5390"></a>		y.push_back(yaxis-&gt;map_point(xy[1].dbl()));
<a name="__line5391"></a>	    }
<a name="__line5392"></a>
<a name="__line5393"></a>	    <span class=comment>// and finally fix second param to p2_1, and scan the first param</span>
<a name="__line5394"></a>	    param[1] = p2_1;
<a name="__line5395"></a>	    for(int n=0; n&lt;N; ++n)
<a name="__line5396"></a>	    {
<a name="__line5397"></a>		param[0] = p1_2 - n*(p1_2-p1_1)/N;
<a name="__line5398"></a>		params_to_xy_.meval(param,xy);
<a name="__line5399"></a>		x.push_back(xaxis-&gt;map_point(xy[0].dbl()));
<a name="__line5400"></a>		y.push_back(yaxis-&gt;map_point(xy[1].dbl()));
<a name="__line5401"></a>	    }
<a name="__line5402"></a>
<a name="__line5403"></a>	    term-&gt;set_color(map_color(z,zmin,zmax));
<a name="__line5404"></a>	    draw_lines_raw(x,y,0,1,0,1,term,true);
<a name="__line5405"></a>	}
<a name="__line5406"></a>	<span class=comment>//draw_legend(term,g);</span>
<a name="__line5407"></a>    }
<a name="__line5408"></a>
<a name="__line5409"></a>
<a name="__line5410"></a>    <span class=comment>// --------------------------------------------------------------------------------</span>
<a name="__line5411"></a>
<a name="__line5412"></a>    bool isolines::default_center_labels_ = false;
<a name="__line5413"></a>
<a name="__line5414"></a>    isolines::isolines()
<a name="__line5415"></a>	: isovalues_specified_(false),
<a name="__line5416"></a>	  min_(unset), max_(unset), step_(unset),
<a name="__line5417"></a>	  minfixed_(false), maxfixed_(false), stepfixed_(false),
<a name="__line5418"></a>	  logscale_(false), draw_labels_(true), turn_labels_(true), labelformat_("%g"),
<a name="__line5419"></a>	  center_labels_(default_center_labels_),
<a name="__line5420"></a>	  x1repulsion_(2.5), x2repulsion_(2.5), y1repulsion_(2.5), y2repulsion_(2.5),
<a name="__line5421"></a>	  label_xalign_(sym::center), label_yalign_(sym::center)
<a name="__line5422"></a>    {
<a name="__line5423"></a>        init_();
<a name="__line5424"></a>    }
<a name="__line5425"></a>
<a name="__line5426"></a>    isolines::isolines(double Min, double Max)
<a name="__line5427"></a>	: isovalues_specified_(false),
<a name="__line5428"></a>	  min_(Min), max_(Max), step_(unset),
<a name="__line5429"></a>	  minfixed_(Min!=unset), maxfixed_(Max!=unset), stepfixed_(false),
<a name="__line5430"></a>	  logscale_(false), draw_labels_(true), turn_labels_(true), labelformat_("%g"),
<a name="__line5431"></a>	  center_labels_(default_center_labels_),
<a name="__line5432"></a>	  x1repulsion_(1), x2repulsion_(1), y1repulsion_(1), y2repulsion_(1),
<a name="__line5433"></a>	  label_xalign_(sym::center), label_yalign_(sym::center)
<a name="__line5434"></a>    {
<a name="__line5435"></a>        if(min_!=unset &amp;&amp; max_!=unset &amp;&amp; min_&gt;max_) swap(min_,max_);
<a name="__line5436"></a>        init_();
<a name="__line5437"></a>    }
<a name="__line5438"></a>
<a name="__line5439"></a>    void isolines::init_()
<a name="__line5440"></a>    {
<a name="__line5441"></a>	labelrepulsion_[0] = 1;
<a name="__line5442"></a>	labelrepulsion_[1] = 0.7;
<a name="__line5443"></a>	labelrepulsion_[2] = 0.4;
<a name="__line5444"></a>	colors_.push_back(black);
<a name="__line5445"></a>	colors_.push_back(red);
<a name="__line5446"></a>	colors_.push_back(blue);
<a name="__line5447"></a>	colors_.push_back(green);
<a name="__line5448"></a>	colors_.push_back(magenta);
<a name="__line5449"></a>	colors_.push_back(cyan);
<a name="__line5450"></a>	colors_.push_back(orange);
<a name="__line5451"></a>    }
<a name="__line5452"></a>
<a name="__line5453"></a>    isolines &amp;isolines::label_align(sym::position xalign, sym::position yalign)
<a name="__line5454"></a>    {
<a name="__line5455"></a>	label_xalign_ = xalign;
<a name="__line5456"></a>	label_yalign_ = yalign;
<a name="__line5457"></a>	return *this;
<a name="__line5458"></a>    }
<a name="__line5459"></a>
<a name="__line5460"></a>    isolines &amp;isolines::label_repulsion_axis(int axis_id, double w)
<a name="__line5461"></a>    {
<a name="__line5462"></a>        if(axis_id==axis::x1) x1repulsion_ = w;
<a name="__line5463"></a>        else if(axis_id==axis::x2) x2repulsion_ = w;
<a name="__line5464"></a>        else if(axis_id==axis::y1) y1repulsion_ = w;
<a name="__line5465"></a>        else if(axis_id==axis::y2) y2repulsion_ = w;
<a name="__line5466"></a>        return *this;
<a name="__line5467"></a>    }
<a name="__line5468"></a>
<a name="__line5469"></a>    isolines &amp;isolines::label_repulsion_frame(double w)
<a name="__line5470"></a>    {
<a name="__line5471"></a>	x1repulsion_ = x2repulsion_ = y1repulsion_ = y2repulsion_ = w;
<a name="__line5472"></a>	return *this;
<a name="__line5473"></a>    }
<a name="__line5474"></a>
<a name="__line5475"></a>    isolines &amp;isolines::label_repulsion_label(double w1, double w2, double w3)
<a name="__line5476"></a>    {
<a name="__line5477"></a>	labelrepulsion_[0] = w1;
<a name="__line5478"></a>	labelrepulsion_[1] = w2;
<a name="__line5479"></a>	labelrepulsion_[2] = w3;
<a name="__line5480"></a>	return *this;
<a name="__line5481"></a>    }
<a name="__line5482"></a>
<a name="__line5483"></a>    void isolines::set_ranges(plottable *g, axis *x, axis *y)
<a name="__line5484"></a>    {
<a name="__line5485"></a>	set_ranges_default(g,x,y,1,2);
<a name="__line5486"></a>    }
<a name="__line5487"></a>
<a name="__line5488"></a>    bool isolines::skip_(const var &amp;xorig_var,
<a name="__line5489"></a>			 const var &amp;yorig_var,
<a name="__line5490"></a>			 const var &amp;zorig_var,
<a name="__line5491"></a>			 axis *xaxis,
<a name="__line5492"></a>			 axis *yaxis,
<a name="__line5493"></a>			 double xmin, double xmax,
<a name="__line5494"></a>			 double ymin, double ymax )
<a name="__line5495"></a>    {
<a name="__line5496"></a>	if(ignore::it(xorig_var) ||
<a name="__line5497"></a>	   ignore::it(yorig_var) ||
<a name="__line5498"></a>	   ignore::it(zorig_var)) return true;
<a name="__line5499"></a>	
<a name="__line5500"></a>	const double xorig = xorig_var.dbl();
<a name="__line5501"></a>	const double yorig = yorig_var.dbl();
<a name="__line5502"></a>	
<a name="__line5503"></a>	if(xaxis-&gt;logscale() &amp;&amp; xorig&lt;=0.0) return true;
<a name="__line5504"></a>	if(yaxis-&gt;logscale() &amp;&amp; yorig&lt;=0.0) return true;
<a name="__line5505"></a>
<a name="__line5506"></a>	if(xorig&lt;xmin || xmax&lt;xorig || yorig&lt;ymin || ymax&lt;yorig) return true;
<a name="__line5507"></a>
<a name="__line5508"></a>	const double xx = xaxis-&gt;map_point(xorig);
<a name="__line5509"></a>	const double yy = yaxis-&gt;map_point(yorig);
<a name="__line5510"></a>
<a name="__line5511"></a>	if(xx == unset || yy == unset) return true;
<a name="__line5512"></a>	if(xx&lt;0 || 1&lt;xx || yy&lt;0 || 1&lt;yy) return true;
<a name="__line5513"></a>
<a name="__line5514"></a>	return false;
<a name="__line5515"></a>    }
<a name="__line5516"></a>
<a name="__line5517"></a>
<a name="__line5518"></a>    void isolines::draw(plottable *g, frame *f, terminal *term)
<a name="__line5519"></a>    {
<a name="__line5520"></a>#ifdef HAVE_GTS_H
<a name="__line5521"></a>
<a name="__line5522"></a>	if(!g || g-&gt;empty()) return;
<a name="__line5523"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line5524"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line5525"></a>
<a name="__line5526"></a>	double xmin = xaxis-&gt;min();
<a name="__line5527"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmin()&gt;xmin) xmin = g-&gt;xmin();
<a name="__line5528"></a>	double xmax = xaxis-&gt;max();
<a name="__line5529"></a>	if(g-&gt;xmax()!=unset &amp;&amp; g-&gt;xmax()&lt;xmax) xmax = g-&gt;xmax();
<a name="__line5530"></a>	
<a name="__line5531"></a>	double ymin = yaxis-&gt;min();
<a name="__line5532"></a>	if(g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymin()&gt;ymin) ymin = g-&gt;ymin();
<a name="__line5533"></a>	double ymax = yaxis-&gt;max();
<a name="__line5534"></a>	if(g-&gt;ymax()!=unset &amp;&amp; g-&gt;ymax()&lt;ymax) ymax = g-&gt;ymax();
<a name="__line5535"></a>	
<a name="__line5536"></a>	function getx = get_x(g);
<a name="__line5537"></a>	function gety = get_y(g);
<a name="__line5538"></a>	function getz = g-&gt;z_hint();
<a name="__line5539"></a>	if(!getz.initialized()) getz = _3;
<a name="__line5540"></a>
<a name="__line5541"></a>	<span class=comment>// first loop over all points to calculate number of vertices</span>
<a name="__line5542"></a>	double zmin = unset, zmax = unset;
<a name="__line5543"></a>	if(minfixed_) zmin = min_;
<a name="__line5544"></a>	if(maxfixed_) zmax = max_;
<a name="__line5545"></a>	for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line5546"></a>	{
<a name="__line5547"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line5548"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line5549"></a>	    const var zorig_var = getz.eval(*(g-&gt;get(i)));
<a name="__line5550"></a>	    if(skip_(xorig_var,yorig_var,zorig_var,xaxis,yaxis,xmin,xmax,ymin,ymax))
<a name="__line5551"></a>		continue;
<a name="__line5552"></a>	    if(!minfixed_ &amp;&amp; (zmin == unset || zorig_var.dbl()&lt;zmin)) zmin=zorig_var.dbl();
<a name="__line5553"></a>	    if(!maxfixed_ &amp;&amp; (zmax == unset || zorig_var.dbl()&gt;zmax)) zmax=zorig_var.dbl();
<a name="__line5554"></a>	}
<a name="__line5555"></a>
<a name="__line5556"></a>	if(!isovalues_specified_)
<a name="__line5557"></a>	{
<a name="__line5558"></a>	    isovalues_.clear();
<a name="__line5559"></a>	    std::vector&lt;blop::tic&gt; tics;
<a name="__line5560"></a>	    std::vector&lt;std::pair&lt;double,double&gt; &gt; cuts;
<a name="__line5561"></a>	    tic scale;
<a name="__line5562"></a>	    scale.value(1).label("1");
<a name="__line5563"></a>	    double zmin_local = zmin;
<a name="__line5564"></a>	    if(minfixed_) zmin_local = min_;
<a name="__line5565"></a>	    double zmax_local = zmax;
<a name="__line5566"></a>	    if(maxfixed_) zmax_local = max_;
<a name="__line5567"></a>	    double step = step_;
<a name="__line5568"></a>
<a name="__line5569"></a>	    if(stepfixed_ &amp;&amp; spec_val_ != unset)
<a name="__line5570"></a>	    {
<a name="__line5571"></a>		for(double v = spec_val_; v&lt;zmax; v += step_)
<a name="__line5572"></a>		{
<a name="__line5573"></a>		    isovalues_.push_back(v);
<a name="__line5574"></a>		}
<a name="__line5575"></a>		for(double v = spec_val_-step_; v&gt;zmin; v -= step_)
<a name="__line5576"></a>		{
<a name="__line5577"></a>		    isovalues_.push_back(v);
<a name="__line5578"></a>		}
<a name="__line5579"></a>	    }
<a name="__line5580"></a>	    else
<a name="__line5581"></a>	    {
<a name="__line5582"></a>		calculate_tics(zmin_local, minfixed_,  
<a name="__line5583"></a>			       zmax_local, maxfixed_,   
<a name="__line5584"></a>			       step, stepfixed_,  
<a name="__line5585"></a>			       unset, unset,
<a name="__line5586"></a>			       scale,
<a name="__line5587"></a>			       1.0,
<a name="__line5588"></a>			       cuts,
<a name="__line5589"></a>			       logscale_,
<a name="__line5590"></a>			       false, <span class=comment>// normalform_tics</span>
<a name="__line5591"></a>			       false, <span class=comment>// normalform_scale</span>
<a name="__line5592"></a>			       tics);
<a name="__line5593"></a>		
<a name="__line5594"></a>		for(unsigned int i=0; i&lt;tics.size(); ++i)
<a name="__line5595"></a>		{
<a name="__line5596"></a>		    const double val = tics[i].value();
<a name="__line5597"></a>		    if(zmin&lt;val &amp;&amp; val&lt;zmax) isovalues_.push_back(val);
<a name="__line5598"></a>		}
<a name="__line5599"></a>	    }
<a name="__line5600"></a>	}
<a name="__line5601"></a>	if(isovalues_.empty())
<a name="__line5602"></a>	{
<a name="__line5603"></a>	    warning::print("No isovalues could be calculated","isolines::draw(...)");
<a name="__line5604"></a>	    return;
<a name="__line5605"></a>	}
<a name="__line5606"></a>
<a name="__line5607"></a>	delaunay_surface surface;
<a name="__line5608"></a>
<a name="__line5609"></a>	<span class=comment>// Now collect the vertices. The x and y coordinates already the</span>
<a name="__line5610"></a>	<span class=comment>// mapped values (that is, between 0 and 1)</span>
<a name="__line5611"></a>	for(plottable::size_type aa=0; aa&lt;g-&gt;size(); ++aa)
<a name="__line5612"></a>	{
<a name="__line5613"></a>	    int i=aa-1;
<a name="__line5614"></a>	    if(i&lt;0) i = g-&gt;size()-1;
<a name="__line5615"></a>	    const var xorig_var = getx.eval(*(g-&gt;get(i)));
<a name="__line5616"></a>	    const var yorig_var = gety.eval(*(g-&gt;get(i)));
<a name="__line5617"></a>	    const var zorig_var = getz.eval(*(g-&gt;get(i)));
<a name="__line5618"></a>	    if(skip_(xorig_var,yorig_var,zorig_var,xaxis,yaxis,xmin,xmax,ymin,ymax)) continue;
<a name="__line5619"></a>
<a name="__line5620"></a>	    const double x = xaxis-&gt;map_point(xorig_var.dbl());
<a name="__line5621"></a>	    const double y = yaxis-&gt;map_point(yorig_var.dbl());
<a name="__line5622"></a>	    const double z = zorig_var.dbl();
<a name="__line5623"></a>
<a name="__line5624"></a>	    surface.add_vertex(x,y,z);
<a name="__line5625"></a>	}
<a name="__line5626"></a>
<a name="__line5627"></a>	double last_label[3][2] = {{unset,unset},{unset,unset},{unset,unset}};
<a name="__line5628"></a>
<a name="__line5629"></a>	term-&gt;reset_transformation();
<a name="__line5630"></a>
<a name="__line5631"></a>	<span class=comment>// now loop over the isovalues, create a cutting plane at this</span>
<a name="__line5632"></a>	<span class=comment>// value, and let gts calculate the intersection of the surface</span>
<a name="__line5633"></a>	<span class=comment>// with this cutting plane</span>
<a name="__line5634"></a>	for(unsigned int izcut=0; izcut&lt;isovalues_.size(); ++izcut)
<a name="__line5635"></a>	{
<a name="__line5636"></a>	    const double zcut = isovalues_[izcut];
<a name="__line5637"></a>
<a name="__line5638"></a>	    if(isovalues_specified_ &amp;&amp; (zcut&lt;zmin || zmax&lt;zcut))
<a name="__line5639"></a>	    {
<a name="__line5640"></a>		warning::print(var("Specified isovalue ") &amp; zcut &amp; var(" is out of range"));
<a name="__line5641"></a>		continue;
<a name="__line5642"></a>	    }
<a name="__line5643"></a>
<a name="__line5644"></a>	    <span class=comment>// take the intersection of the surface with a z=zcut plane surface,</span>
<a name="__line5645"></a>	    <span class=comment>// the (x,y) coordinates are returned in the xx and yy arrays, unset values</span>
<a name="__line5646"></a>	    <span class=comment>// indicating a discontinuity.</span>
<a name="__line5647"></a>	    vector&lt;double&gt; xx, yy;
<a name="__line5648"></a>	    intersection_z(surface,zcut,xx,yy);
<a name="__line5649"></a>
<a name="__line5650"></a>	    double largest_distance = 0;
<a name="__line5651"></a>	    double labelp1[2] = {unset,unset};
<a name="__line5652"></a>	    double labelp2[2] = {unset,unset};
<a name="__line5653"></a>
<a name="__line5654"></a>	    for(unsigned int i=0; i&lt;xx.size()-1; ++i)
<a name="__line5655"></a>	    {
<a name="__line5656"></a>		if(xx[i]==unset || xx[i+1]==unset) continue;
<a name="__line5657"></a>
<a name="__line5658"></a>		<span class=comment>// skip point-pairs which are too close</span>
<a name="__line5659"></a>		const double dx = xx[i+1]-xx[i];
<a name="__line5660"></a>		const double dy = yy[i+1]-yy[i];
<a name="__line5661"></a>		if(std::sqrt(dx*dx+dy*dy)&lt;1e-3) continue;
<a name="__line5662"></a>
<a name="__line5663"></a>		<span class=comment>// the coordinates of the isovalue label are set to the midpoint between this</span>
<a name="__line5664"></a>		<span class=comment>// and the next point</span>
<a name="__line5665"></a>		const double label_x = 0.5*(xx[i]+xx[i+1]);
<a name="__line5666"></a>		const double label_y = 0.5*(yy[i]+yy[i+1]);
<a name="__line5667"></a>
<a name="__line5668"></a>		double d =
<a name="__line5669"></a>		    x1repulsion_*::sqrt(::fabs(label_y)) +
<a name="__line5670"></a>		    x2repulsion_*::sqrt(::fabs(1-label_y)) +
<a name="__line5671"></a>		    y1repulsion_*::sqrt(::fabs(label_x)) +
<a name="__line5672"></a>		    y2repulsion_*::sqrt(::fabs(1-label_x));
<a name="__line5673"></a>		for(int a=0; a&lt;3; ++a)
<a name="__line5674"></a>		{
<a name="__line5675"></a>		    if(last_label[a][0] != unset)
<a name="__line5676"></a>		    {
<a name="__line5677"></a>			d += labelrepulsion_[a] *
<a name="__line5678"></a>			    (::sqrt(::fabs(last_label[a][0]-label_x))+
<a name="__line5679"></a>			     ::sqrt(::fabs(last_label[a][1]-label_y)));
<a name="__line5680"></a>		    }
<a name="__line5681"></a>		}
<a name="__line5682"></a>		if(d &gt;= largest_distance)
<a name="__line5683"></a>		{
<a name="__line5684"></a>		    labelp1[0] = xx[i];
<a name="__line5685"></a>		    labelp1[1] = yy[i];
<a name="__line5686"></a>		    labelp2[0] = xx[i+1];
<a name="__line5687"></a>		    labelp2[1] = yy[i+1];
<a name="__line5688"></a>		    largest_distance = d;
<a name="__line5689"></a>		}
<a name="__line5690"></a>	    }
<a name="__line5691"></a>
<a name="__line5692"></a>	    term-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line5693"></a>	    term-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line5694"></a>	    term-&gt;set_color(colors_[izcut%colors_.size()]);
<a name="__line5695"></a>	    draw_lines_raw(xx,yy,
<a name="__line5696"></a>			   xaxis-&gt;map_point(xmin), xaxis-&gt;map_point(xmax),
<a name="__line5697"></a>			   yaxis-&gt;map_point(ymin), yaxis-&gt;map_point(ymax),
<a name="__line5698"></a>			   term,false);
<a name="__line5699"></a>
<a name="__line5700"></a>	    if(draw_labels_)
<a name="__line5701"></a>	    {
<a name="__line5702"></a>		if(center_labels_)
<a name="__line5703"></a>		{
<a name="__line5704"></a>		    for(unsigned int i=xx.size()/2; i&lt;xx.size()-1; ++i)
<a name="__line5705"></a>		    {
<a name="__line5706"></a>			if(xx[i]!=unset &amp;&amp; xx[i+1]!=unset)
<a name="__line5707"></a>			{
<a name="__line5708"></a>			    labelp1[0] = xx[i];
<a name="__line5709"></a>			    labelp1[1] = yy[i];
<a name="__line5710"></a>			    labelp2[0] = xx[i+1];
<a name="__line5711"></a>			    labelp2[1] = yy[i+1];
<a name="__line5712"></a>			    break;
<a name="__line5713"></a>			}
<a name="__line5714"></a>		    }
<a name="__line5715"></a>		}
<a name="__line5716"></a>
<a name="__line5717"></a>		if(labelp1[0] != unset &amp;&amp; labelp1[1] != unset &amp;&amp;
<a name="__line5718"></a>		   labelp2[0] != unset &amp;&amp; labelp2[1] != unset)
<a name="__line5719"></a>		{
<a name="__line5720"></a>		    double dx = labelp2[0] - labelp1[0];
<a name="__line5721"></a>		    double dy = labelp2[1] - labelp1[1];
<a name="__line5722"></a>
<a name="__line5723"></a>		    if(dx&lt;0) { dx *= -1; dy *= -1; }
<a name="__line5724"></a>
<a name="__line5725"></a>		    if(::fabs(dx) &lt; numeric_limits&lt;double&gt;::epsilon()*100 &amp;&amp; 
<a name="__line5726"></a>		       ::fabs(dy) &lt; numeric_limits&lt;double&gt;::epsilon()*100)
<a name="__line5727"></a>		    {
<a name="__line5728"></a>			dx = 1;
<a name="__line5729"></a>			dy = 0;
<a name="__line5730"></a>		    }
<a name="__line5731"></a>		    else if(::fabs(dx)&lt;numeric_limits&lt;double&gt;::epsilon()*100)
<a name="__line5732"></a>		    {
<a name="__line5733"></a>			dx = 0;
<a name="__line5734"></a>			dy = 1;
<a name="__line5735"></a>		    }
<a name="__line5736"></a>		    else if(::fabs(dy)&lt;numeric_limits&lt;double&gt;::epsilon()*100)
<a name="__line5737"></a>		    {
<a name="__line5738"></a>			dy = 0;
<a name="__line5739"></a>			dx = 1;
<a name="__line5740"></a>		    }
<a name="__line5741"></a>		    else if(::fabs(dy/dx) &lt; 0.001) dy = 0;
<a name="__line5742"></a>		    else if(::fabs(dx/dy) &lt; 0.001) dx = 0;
<a name="__line5743"></a>		    else
<a name="__line5744"></a>		    {
<a name="__line5745"></a>			dy /= dx;
<a name="__line5746"></a>			dx = 1;
<a name="__line5747"></a>		    }
<a name="__line5748"></a>
<a name="__line5749"></a>		    const double x  = 0.5*(labelp1[0]+labelp2[0]);
<a name="__line5750"></a>		    const double y  = 0.5*(labelp1[1]+labelp2[1]);
<a name="__line5751"></a>
<a name="__line5752"></a>		    string lab;
<a name="__line5753"></a>		    if(!labels_.empty()) lab = labels_[izcut%labels_.size()].str();
<a name="__line5754"></a>		    else
<a name="__line5755"></a>		    {
<a name="__line5756"></a>			char s[256];
<a name="__line5757"></a>			sprintf(s,labelformat_.c_str(),zcut);
<a name="__line5758"></a>			lab = s;
<a name="__line5759"></a>		    }
<a name="__line5760"></a>
<a name="__line5761"></a>		    term-&gt;translate(terminal::id(x ,1),terminal::id(y ,2));
<a name="__line5762"></a>		    if(turn_labels_)
<a name="__line5763"></a>		    {
<a name="__line5764"></a>			term-&gt;draw_text(terminal::coord(terminal::id(0.0,1), terminal::id(0.0,2)),
<a name="__line5765"></a>					lab, label_xalign_, label_yalign_, terminal::id(dx,1),terminal::id(dy,2));
<a name="__line5766"></a>		    }
<a name="__line5767"></a>		    else
<a name="__line5768"></a>		    {
<a name="__line5769"></a>			term-&gt;draw_text(terminal::coord(terminal::id(0.0,1), terminal::id(0.0,2)),
<a name="__line5770"></a>					lab, label_xalign_, label_yalign_, 0);
<a name="__line5771"></a>		    }
<a name="__line5772"></a>		    term-&gt;reset_transformation();
<a name="__line5773"></a>
<a name="__line5774"></a>		    last_label[2][0] = last_label[1][0];
<a name="__line5775"></a>		    last_label[2][1] = last_label[1][1];
<a name="__line5776"></a>		    last_label[1][0] = last_label[0][0];
<a name="__line5777"></a>		    last_label[1][1] = last_label[0][1];
<a name="__line5778"></a>		    last_label[0][0] = x;
<a name="__line5779"></a>		    last_label[0][1] = y;
<a name="__line5780"></a>		}
<a name="__line5781"></a>		else
<a name="__line5782"></a>		{
<a name="__line5783"></a>		    warning::print(var("For some reason did not find the optimum "
<a name="__line5784"></a>				       "point to print the isovalue (") &amp; zcut &amp; ") label",
<a name="__line5785"></a>				   "isolines::draw(...)");
<a name="__line5786"></a>		}
<a name="__line5787"></a>	    }
<a name="__line5788"></a>
<a name="__line5789"></a>	} <span class=comment>// end of looping over isovalues (cutvalues)</span>
<a name="__line5790"></a>
<a name="__line5791"></a><span class=comment>// HAVE_GTS_H</span>
<a name="__line5792"></a>#else
<a name="__line5793"></a>	warning::print("Install libgts-dev package to have isolines");
<a name="__line5794"></a>#endif
<a name="__line5795"></a>    }
<a name="__line5796"></a>
<a name="__line5797"></a>    isolines &amp;isolines::at(const vector&lt;double&gt; &amp;values)
<a name="__line5798"></a>    {
<a name="__line5799"></a>        isovalues_ = values;
<a name="__line5800"></a>	isovalues_specified_ = true;
<a name="__line5801"></a>	return *this; 
<a name="__line5802"></a>    }
<a name="__line5803"></a>
<a name="__line5804"></a>    isolines &amp;isolines::at(double val1,
<a name="__line5805"></a>			   double val2,
<a name="__line5806"></a>			   double val3,
<a name="__line5807"></a>			   double val4,
<a name="__line5808"></a>			   double val5,
<a name="__line5809"></a>			   double val6,
<a name="__line5810"></a>			   double val7,
<a name="__line5811"></a>			   double val8,
<a name="__line5812"></a>			   double val9,
<a name="__line5813"></a>			   double val10,
<a name="__line5814"></a>			   double val11,
<a name="__line5815"></a>			   double val12,
<a name="__line5816"></a>			   double val13,
<a name="__line5817"></a>			   double val14,
<a name="__line5818"></a>			   double val15,
<a name="__line5819"></a>			   double val16,
<a name="__line5820"></a>			   double val17,
<a name="__line5821"></a>			   double val18,
<a name="__line5822"></a>			   double val19,
<a name="__line5823"></a>			   double val20)
<a name="__line5824"></a>    {
<a name="__line5825"></a>
<a name="__line5826"></a>	isovalues_.push_back(val1);
<a name="__line5827"></a>	if(val2!=unset) isovalues_.push_back(val2);
<a name="__line5828"></a>	if(val3!=unset) isovalues_.push_back(val3);
<a name="__line5829"></a>	if(val4!=unset) isovalues_.push_back(val4);
<a name="__line5830"></a>	if(val5!=unset) isovalues_.push_back(val5);
<a name="__line5831"></a>	if(val6!=unset) isovalues_.push_back(val6);
<a name="__line5832"></a>	if(val7!=unset) isovalues_.push_back(val7);
<a name="__line5833"></a>	if(val8!=unset) isovalues_.push_back(val8);
<a name="__line5834"></a>	if(val9!=unset) isovalues_.push_back(val9);
<a name="__line5835"></a>	if(val10!=unset) isovalues_.push_back(val10);
<a name="__line5836"></a>	if(val11!=unset) isovalues_.push_back(val11);
<a name="__line5837"></a>	if(val12!=unset) isovalues_.push_back(val12);
<a name="__line5838"></a>	if(val13!=unset) isovalues_.push_back(val13);
<a name="__line5839"></a>	if(val14!=unset) isovalues_.push_back(val14);
<a name="__line5840"></a>	if(val15!=unset) isovalues_.push_back(val15);
<a name="__line5841"></a>	if(val16!=unset) isovalues_.push_back(val16);
<a name="__line5842"></a>	if(val17!=unset) isovalues_.push_back(val17);
<a name="__line5843"></a>	if(val18!=unset) isovalues_.push_back(val18);
<a name="__line5844"></a>	if(val19!=unset) isovalues_.push_back(val19);
<a name="__line5845"></a>	if(val20!=unset) isovalues_.push_back(val20);
<a name="__line5846"></a>	isovalues_specified_ = true;
<a name="__line5847"></a>	return *this; 
<a name="__line5848"></a>    }
<a name="__line5849"></a>
<a name="__line5850"></a>
<a name="__line5851"></a>    isolines &amp;isolines::colors(const color &amp;c1,
<a name="__line5852"></a>			       const color &amp;c2,
<a name="__line5853"></a>			       const color &amp;c3,
<a name="__line5854"></a>			       const color &amp;c4,
<a name="__line5855"></a>			       const color &amp;c5,
<a name="__line5856"></a>			       const color &amp;c6,
<a name="__line5857"></a>			       const color &amp;c7,
<a name="__line5858"></a>			       const color &amp;c8,
<a name="__line5859"></a>			       const color &amp;c9,
<a name="__line5860"></a>			       const color &amp;c10)
<a name="__line5861"></a>    {
<a name="__line5862"></a>	colors_.clear();
<a name="__line5863"></a>	colors_.push_back(c1);
<a name="__line5864"></a>	if(c2.red()&gt;=0) colors_.push_back(c2);
<a name="__line5865"></a>	if(c3.red()&gt;=0) colors_.push_back(c3);
<a name="__line5866"></a>	if(c4.red()&gt;=0) colors_.push_back(c4);
<a name="__line5867"></a>	if(c5.red()&gt;=0) colors_.push_back(c5);
<a name="__line5868"></a>	if(c6.red()&gt;=0) colors_.push_back(c6);
<a name="__line5869"></a>	if(c7.red()&gt;=0) colors_.push_back(c7);
<a name="__line5870"></a>	if(c8.red()&gt;=0) colors_.push_back(c8);
<a name="__line5871"></a>	if(c9.red()&gt;=0) colors_.push_back(c9);
<a name="__line5872"></a>	if(c10.red()&gt;=0) colors_.push_back(c10);
<a name="__line5873"></a>	return *this;
<a name="__line5874"></a>    }
<a name="__line5875"></a>
<a name="__line5876"></a>    isolines &amp;isolines::labels(const var &amp;c1,
<a name="__line5877"></a>			       const var &amp;c2,
<a name="__line5878"></a>			       const var &amp;c3,
<a name="__line5879"></a>			       const var &amp;c4,
<a name="__line5880"></a>			       const var &amp;c5,
<a name="__line5881"></a>			       const var &amp;c6,
<a name="__line5882"></a>			       const var &amp;c7,
<a name="__line5883"></a>			       const var &amp;c8,
<a name="__line5884"></a>			       const var &amp;c9,
<a name="__line5885"></a>			       const var &amp;c10)
<a name="__line5886"></a>    {
<a name="__line5887"></a>	labels_.clear();
<a name="__line5888"></a>	labels_.push_back(c1);
<a name="__line5889"></a>	if(c2.dbl() != unset) labels_.push_back(c2);
<a name="__line5890"></a>	if(c3.dbl() != unset) labels_.push_back(c3);
<a name="__line5891"></a>	if(c4.dbl() != unset) labels_.push_back(c4);
<a name="__line5892"></a>	if(c5.dbl() != unset) labels_.push_back(c5);
<a name="__line5893"></a>	if(c6.dbl() != unset) labels_.push_back(c6);
<a name="__line5894"></a>	if(c7.dbl() != unset) labels_.push_back(c7);
<a name="__line5895"></a>	if(c8.dbl() != unset) labels_.push_back(c8);
<a name="__line5896"></a>	if(c9.dbl() != unset) labels_.push_back(c9);
<a name="__line5897"></a>	if(c10.dbl() != unset) labels_.push_back(c10);
<a name="__line5898"></a>	return *this;
<a name="__line5899"></a>    }
<a name="__line5900"></a>
<a name="__line5901"></a>    graph_drawer *isolines::clone() const
<a name="__line5902"></a>    {
<a name="__line5903"></a>	return new isolines(*this);
<a name="__line5904"></a>    }
<a name="__line5905"></a>
<a name="__line5906"></a>    void isolines::prepare_for_draw(plottable *g, frame *, int count)
<a name="__line5907"></a>    {
<a name="__line5908"></a>	if(count==1) g-&gt;linewidth().register_me();
<a name="__line5909"></a>    }
<a name="__line5910"></a>
<a name="__line5911"></a>    void isolines::draw_sample(const length &amp;x,
<a name="__line5912"></a>			       const length &amp;y,
<a name="__line5913"></a>			       const length &amp;size,
<a name="__line5914"></a>			       const plottable *style,
<a name="__line5915"></a>			       terminal *t)
<a name="__line5916"></a>    {
<a name="__line5917"></a>	t-&gt;set_linewidth(style-&gt;linewidth().termspecific_id());
<a name="__line5918"></a>	t-&gt;set_linestyle(style-&gt;linestyle());
<a name="__line5919"></a>	length l1 = !x - 0.5*!size;
<a name="__line5920"></a>	length l2 = !x + 0.5*!size;
<a name="__line5921"></a>	length l3 = height(style-&gt;legend()); <span class=comment>//3*style-&gt;linewidth();</span>
<a name="__line5922"></a>	l1.specialize(t);
<a name="__line5923"></a>	l2.specialize(t);
<a name="__line5924"></a>	l3.specialize(t);
<a name="__line5925"></a>	for ( unsigned int l=0 ; l&lt;isovalues_.size() ; ++l )
<a name="__line5926"></a>	{
<a name="__line5927"></a>	    double n = isovalues_.size();
<a name="__line5928"></a>	    length l5 = !y + (l-n/2)/n*l3;
<a name="__line5929"></a>	    l5.specialize(t);
<a name="__line5930"></a>	    t-&gt;set_color(colors_[l%colors_.size()]);
<a name="__line5931"></a>	    t-&gt;draw_line(terminal::coord(l1.termspecific_id(), l5.termspecific_id()),
<a name="__line5932"></a>			 terminal::coord(l2.termspecific_id(), l5.termspecific_id()));
<a name="__line5933"></a>	}
<a name="__line5934"></a>    }
<a name="__line5935"></a>
<a name="__line5936"></a>    <span class=comment>// ---------- vectors  ------------------------------------------------------------</span>
<a name="__line5937"></a>
<a name="__line5938"></a>    vectors::~vectors()
<a name="__line5939"></a>    {
<a name="__line5940"></a>	delete arrow_;
<a name="__line5941"></a>    }
<a name="__line5942"></a>
<a name="__line5943"></a>    void vectors::setup_when_added(plottable *g,frame *f)
<a name="__line5944"></a>    {
<a name="__line5945"></a>	if(g &amp;&amp; f &amp;&amp; use_color_) graphd_colorscale::setup_when_added(g,f);
<a name="__line5946"></a>	else colorlegend_ = 0;
<a name="__line5947"></a>    }
<a name="__line5948"></a>
<a name="__line5949"></a>    vectors::vectors(const vectors &amp;rhs) : graphd_colorscale(rhs)
<a name="__line5950"></a>    {
<a name="__line5951"></a>	colorfunc_ = rhs.colorfunc_;
<a name="__line5952"></a>	colorlegend_ = 0;
<a name="__line5953"></a>	scale_arrow_ = rhs.scale_arrow_;
<a name="__line5954"></a>	use_color_ = rhs.use_color_;
<a name="__line5955"></a>	xunit_ = rhs.xunit_;
<a name="__line5956"></a>	yunit_ = rhs.yunit_;
<a name="__line5957"></a>	arrow_ = rhs.arrow_-&gt;clone();
<a name="__line5958"></a>	dx_ = rhs.dx_;
<a name="__line5959"></a>	dy_ = rhs.dy_;
<a name="__line5960"></a>	norm_ = rhs.norm_;
<a name="__line5961"></a>	norm_fixed_ = rhs.norm_fixed_;
<a name="__line5962"></a>	min_length_cut_ = rhs.min_length_cut_;
<a name="__line5963"></a>	min_length_cut_fixed_ = rhs.min_length_cut_fixed_;
<a name="__line5964"></a>        max_length_cut_ = rhs.max_length_cut_;
<a name="__line5965"></a>	pos_ = rhs.pos_;
<a name="__line5966"></a>	clip_ = rhs.clip_;
<a name="__line5967"></a>    }
<a name="__line5968"></a>
<a name="__line5969"></a>    vectors::vectors()
<a name="__line5970"></a>    {
<a name="__line5971"></a>	arrow_ = new arrowhead::simple(EX);
<a name="__line5972"></a>	dx_ = dy_ = norm_ = unset;
<a name="__line5973"></a>	min_length_cut_ = unset;
<a name="__line5974"></a>	max_length_cut_ = unset;
<a name="__line5975"></a>	norm_fixed_ = false;
<a name="__line5976"></a>	min_length_cut_fixed_ = false;
<a name="__line5977"></a>	pos_ = sym::center;
<a name="__line5978"></a>	min_length_ = max_length_ = unset;
<a name="__line5979"></a>	scale_arrow_ = true;
<a name="__line5980"></a>	use_color_ = false;
<a name="__line5981"></a>	colorfunc_ = sqrt(_3*_3+_4*_4);
<a name="__line5982"></a>	colorlegend_ = 0;
<a name="__line5983"></a>	clip_ = true;
<a name="__line5984"></a>    }
<a name="__line5985"></a>
<a name="__line5986"></a>    graph_drawer *vectors::clone() const
<a name="__line5987"></a>    {
<a name="__line5988"></a>	return new vectors(*this);
<a name="__line5989"></a>    }
<a name="__line5990"></a>
<a name="__line5991"></a>    int vectors::req_components() const
<a name="__line5992"></a>    {
<a name="__line5993"></a>	int result = 4;
<a name="__line5994"></a>	if(use_color_ &amp;&amp; colorfunc_.nargs()&gt;4) result = colorfunc_.nargs();
<a name="__line5995"></a>	return result;
<a name="__line5996"></a>    }
<a name="__line5997"></a>
<a name="__line5998"></a>    void vectors::prepare_for_draw(plottable *g, frame *f, int count)
<a name="__line5999"></a>    {
<a name="__line6000"></a>	if(g-&gt;empty()) return;
<a name="__line6001"></a>
<a name="__line6002"></a>	if(count==1)
<a name="__line6003"></a>	{
<a name="__line6004"></a>	    g-&gt;linewidth().register_me();
<a name="__line6005"></a>	    
<a name="__line6006"></a>	    axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line6007"></a>	    axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line6008"></a>	    
<a name="__line6009"></a>	    function getx=g-&gt;x_hint();
<a name="__line6010"></a>	    if (!getx.initialized()) getx=ARG(1);
<a name="__line6011"></a>	    function gety=g-&gt;y_hint();
<a name="__line6012"></a>	    if (!gety.initialized()) gety=ARG(2);
<a name="__line6013"></a>	    function getvx = ARG(3);
<a name="__line6014"></a>	    function getvy = ARG(4);
<a name="__line6015"></a>	    
<a name="__line6016"></a>	    map&lt;double,bool&gt; xvalues,yvalues;
<a name="__line6017"></a>
<a name="__line6018"></a>	    double xmin = unset, ymin = unset, xmax = unset, ymax = unset;
<a name="__line6019"></a>	    if(xaxis-&gt;min_fixed()) xmin = xaxis-&gt;min();
<a name="__line6020"></a>	    if(xaxis-&gt;max_fixed()) xmax = xaxis-&gt;max();
<a name="__line6021"></a>	    if(yaxis-&gt;min_fixed()) ymin = yaxis-&gt;min();
<a name="__line6022"></a>	    if(yaxis-&gt;max_fixed()) ymax = yaxis-&gt;max();
<a name="__line6023"></a>	    
<a name="__line6024"></a>	    if(g-&gt;xmin() != unset)
<a name="__line6025"></a>	    {
<a name="__line6026"></a>		if(xmin == unset || g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line6027"></a>	    }
<a name="__line6028"></a>	    if(g-&gt;xmax() != unset)
<a name="__line6029"></a>	    {
<a name="__line6030"></a>		if(xmax == unset || g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line6031"></a>	    }
<a name="__line6032"></a>	    if(g-&gt;ymin() != unset)
<a name="__line6033"></a>	    {
<a name="__line6034"></a>		if(ymin == unset || g-&gt;ymin() &gt; ymin) ymin = g-&gt;ymin();
<a name="__line6035"></a>	    }
<a name="__line6036"></a>	    if(g-&gt;ymax() != unset)
<a name="__line6037"></a>	    {
<a name="__line6038"></a>		if(ymax == unset || g-&gt;ymax() &lt; ymax) ymax = g-&gt;ymax();
<a name="__line6039"></a>	    }
<a name="__line6040"></a>	    
<a name="__line6041"></a>	    if(!norm_fixed_) norm_ = 0;
<a name="__line6042"></a>
<a name="__line6043"></a>	    max_length_ = min_length_ = unset;
<a name="__line6044"></a>	    if(!color_min_fixed_) color_min_ = unset;
<a name="__line6045"></a>	    if(!color_max_fixed_) color_max_ = unset;
<a name="__line6046"></a>	    for(plottable::size_type i=0; i&lt;g-&gt;size(); ++i)
<a name="__line6047"></a>	    {
<a name="__line6048"></a>		const var x = getx.eval(*(g-&gt;get(i)));
<a name="__line6049"></a>		const var y = gety.eval(*(g-&gt;get(i)));
<a name="__line6050"></a>		const var vx = getvx.eval(*(g-&gt;get(i)));
<a name="__line6051"></a>		const var vy = getvy.eval(*(g-&gt;get(i)));
<a name="__line6052"></a>		
<a name="__line6053"></a>		if(ignore::it(x) || ignore::it(y) || ignore::it(vx) || ignore::it(vy)) continue;
<a name="__line6054"></a>		if(xmin != unset &amp;&amp; x.dbl() &lt; xmin) continue;
<a name="__line6055"></a>		if(xmax != unset &amp;&amp; x.dbl() &gt; xmax) continue;
<a name="__line6056"></a>		if(ymin != unset &amp;&amp; y.dbl() &lt; ymin) continue;
<a name="__line6057"></a>		if(ymax != unset &amp;&amp; y.dbl() &gt; ymax) continue;
<a name="__line6058"></a>		
<a name="__line6059"></a>		xvalues[x.dbl()] = true;
<a name="__line6060"></a>		yvalues[y.dbl()] = true;
<a name="__line6061"></a>		
<a name="__line6062"></a>		const double l = ::sqrt(vx.dbl()*vx.dbl()+vy.dbl()*vy.dbl());
<a name="__line6063"></a>		if(max_length_ == unset || l &gt; max_length_) max_length_ = l;
<a name="__line6064"></a>		if(min_length_ == unset || l &lt; min_length_) min_length_ = l;
<a name="__line6065"></a>		
<a name="__line6066"></a>		if(use_color_)
<a name="__line6067"></a>		{
<a name="__line6068"></a>		    double c = colorfunc_.eval(*(g-&gt;get(i)));
<a name="__line6069"></a>		    if(!color_min_fixed_) if(color_min_ == unset || c &lt; color_min_) color_min_ = c;
<a name="__line6070"></a>		    if(!color_max_fixed_) if(color_max_ == unset || c &gt; color_max_) color_max_ = c;
<a name="__line6071"></a>		}
<a name="__line6072"></a>	    }
<a name="__line6073"></a>
<a name="__line6074"></a>	    if(!min_length_cut_fixed_) min_length_cut_ = 0.05*max_length_;
<a name="__line6075"></a>	    min_length_ = min_length_cut_;
<a name="__line6076"></a>	    if(!norm_fixed_) norm_   = max_length_;
<a name="__line6077"></a>	    
<a name="__line6078"></a>	    dx_ = unset;
<a name="__line6079"></a>	    dy_ = unset;
<a name="__line6080"></a>	    double xaver = 0, yaver = 0;
<a name="__line6081"></a>	    for(map&lt;double,bool&gt;::iterator i=xvalues.begin(); i!=xvalues.end(); ++i)
<a name="__line6082"></a>	    {
<a name="__line6083"></a>		xaver += (*i).first;
<a name="__line6084"></a>		if(i != xvalues.begin())
<a name="__line6085"></a>		{
<a name="__line6086"></a>		    map&lt;double,bool&gt;::iterator prev = i;
<a name="__line6087"></a>		    --prev;
<a name="__line6088"></a>		    if(dx_ == unset || ::fabs((*prev).first - (*i).first)&lt;dx_)
<a name="__line6089"></a>		    {
<a name="__line6090"></a>			dx_ = ::fabs((*prev).first - (*i).first);
<a name="__line6091"></a>		    }
<a name="__line6092"></a>		}
<a name="__line6093"></a>	    }
<a name="__line6094"></a>	    for(map&lt;double,bool&gt;::iterator i=yvalues.begin(); i!=yvalues.end(); ++i)
<a name="__line6095"></a>	    {
<a name="__line6096"></a>		yaver += (*i).first;
<a name="__line6097"></a>		if(i != yvalues.begin())
<a name="__line6098"></a>		{
<a name="__line6099"></a>		    map&lt;double,bool&gt;::iterator prev = i;
<a name="__line6100"></a>		    --prev;
<a name="__line6101"></a>		    if(dy_ == unset || ::fabs((*prev).first - (*i).first)&lt;dy_)
<a name="__line6102"></a>		    {
<a name="__line6103"></a>			dy_ = ::fabs((*prev).first - (*i).first);
<a name="__line6104"></a>		    }
<a name="__line6105"></a>		}
<a name="__line6106"></a>	    }
<a name="__line6107"></a>	    xaver /= xvalues.size();
<a name="__line6108"></a>	    yaver /= yvalues.size();
<a name="__line6109"></a>	    
<a name="__line6110"></a>	    if(dx_ == unset) dx_ = 1;
<a name="__line6111"></a>	    if(dy_ == unset) dy_ = 1;
<a name="__line6112"></a>	    double delta = ::min(dx_,dy_);
<a name="__line6113"></a>	    
<a name="__line6114"></a>	    xunit_ = length::base_axis_t(xaxis, xaver, xaver+delta);
<a name="__line6115"></a>	    yunit_ = length::base_axis_t(yaxis, yaver, yaver+delta);
<a name="__line6116"></a>	    xunit_.register_me();
<a name="__line6117"></a>	    yunit_.register_me();
<a name="__line6118"></a>	    
<a name="__line6119"></a>	    arrow_-&gt;prepare_for_draw();
<a name="__line6120"></a>
<a name="__line6121"></a>	    if(colorlegend_) colorlegend_-&gt;clear_tics();
<a name="__line6122"></a>	} <span class=comment>// end if(count==1)</span>
<a name="__line6123"></a>
<a name="__line6124"></a>	if(count==2)
<a name="__line6125"></a>	{
<a name="__line6126"></a>	    <span class=comment>// Let the colorlegend calculate the unified range for all</span>
<a name="__line6127"></a>	    <span class=comment>// of its graphs</span>
<a name="__line6128"></a>	    if(colorlegend_) colorlegend_-&gt;calculate_tics();
<a name="__line6129"></a>	}
<a name="__line6130"></a>    }
<a name="__line6131"></a>
<a name="__line6132"></a>    vectors &amp;vectors::pos(sym::position p)
<a name="__line6133"></a>    {
<a name="__line6134"></a>	if(p != sym::center &amp;&amp; p != sym::begin &amp;&amp; p != sym::end)
<a name="__line6135"></a>	{
<a name="__line6136"></a>	    warning::print("Argument should be either of sym::begin, sym::end or sym::center. Using sym::center!",
<a name="__line6137"></a>			   "vectors::pos(symbolic p)");
<a name="__line6138"></a>	    p = sym::center;
<a name="__line6139"></a>	    
<a name="__line6140"></a>	}
<a name="__line6141"></a>	pos_ = p;
<a name="__line6142"></a>	return *this; 
<a name="__line6143"></a>    }
<a name="__line6144"></a>
<a name="__line6145"></a>
<a name="__line6146"></a>    vectors &amp;vectors::arrow(const arrowhead &amp;a)
<a name="__line6147"></a>    {
<a name="__line6148"></a>	delete arrow_;
<a name="__line6149"></a>	arrow_ = a.clone();
<a name="__line6150"></a>	return *this; 
<a name="__line6151"></a>    }
<a name="__line6152"></a>
<a name="__line6153"></a>    vectors &amp;vectors::norm(double value)
<a name="__line6154"></a>    {
<a name="__line6155"></a>	norm_ = value;
<a name="__line6156"></a>	if(value == unset) norm_fixed_ = false;
<a name="__line6157"></a>	else norm_fixed_ = true;
<a name="__line6158"></a>	return *this;
<a name="__line6159"></a>    }
<a name="__line6160"></a>
<a name="__line6161"></a>    vectors &amp;vectors::min(double value)
<a name="__line6162"></a>    {
<a name="__line6163"></a>	min_length_cut_ = value;
<a name="__line6164"></a>	if(value == unset) min_length_cut_fixed_ = false;
<a name="__line6165"></a>	else min_length_cut_fixed_ = true;
<a name="__line6166"></a>	return *this;
<a name="__line6167"></a>    }
<a name="__line6168"></a>
<a name="__line6169"></a>    vectors &amp;vectors::max(double value)
<a name="__line6170"></a>    {
<a name="__line6171"></a>	max_length_cut_ = value;
<a name="__line6172"></a>	return *this;
<a name="__line6173"></a>    }
<a name="__line6174"></a>
<a name="__line6175"></a>
<a name="__line6176"></a>    void vectors::set_ranges(plottable *g, axis *xaxis, axis *yaxis)
<a name="__line6177"></a>    {
<a name="__line6178"></a>	if(!g) err("Plottagle to draw is zero");
<a name="__line6179"></a>	if(!xaxis) err("Xaxis not set");
<a name="__line6180"></a>	if(!yaxis) err("yaxis not set");
<a name="__line6181"></a>
<a name="__line6182"></a>	if(g-&gt;empty())
<a name="__line6183"></a>	{                                                                       
<a name="__line6184"></a>	    warning::print("Warning: empty plottable!",
<a name="__line6185"></a>			   "void set_ranges_default(plottable*, axis*, axis*, int, int)");
<a name="__line6186"></a>	    return;                                                             
<a name="__line6187"></a>	}
<a name="__line6188"></a>
<a name="__line6189"></a>	if(g-&gt;xmin()!=unset) xaxis-&gt;extend_range(g-&gt;xmin());
<a name="__line6190"></a>	if(g-&gt;xmax()!=unset) xaxis-&gt;extend_range(g-&gt;xmax());
<a name="__line6191"></a>	if(g-&gt;ymin()!=unset) yaxis-&gt;extend_range(g-&gt;ymin());
<a name="__line6192"></a>	if(g-&gt;ymax()!=unset) yaxis-&gt;extend_range(g-&gt;ymax());
<a name="__line6193"></a>
<a name="__line6194"></a>	<span class=comment>// if all ranges are defined, then simply return at this point</span>
<a name="__line6195"></a>	if(g-&gt;xmin()!=unset &amp;&amp; g-&gt;xmax()!=unset &amp;&amp;
<a name="__line6196"></a>	   g-&gt;ymin()!=unset &amp;&amp; g-&gt;ymax()!=unset) return;
<a name="__line6197"></a>
<a name="__line6198"></a>	double xmin=unset;
<a name="__line6199"></a>	double xmax=unset;
<a name="__line6200"></a>	double ymin=unset;
<a name="__line6201"></a>	double ymax=unset;
<a name="__line6202"></a>	function getx=g-&gt;x_hint();
<a name="__line6203"></a>	if (!getx.initialized()) getx=_1;
<a name="__line6204"></a>	function gety=g-&gt;y_hint();
<a name="__line6205"></a>	if (!gety.initialized()) gety=_2;
<a name="__line6206"></a>
<a name="__line6207"></a>	for ( unsigned int i=0 ; i&lt;g-&gt;size() ; ++i )
<a name="__line6208"></a>	{
<a name="__line6209"></a>	    const var xorig_var=getx.eval(*g-&gt;get(i));
<a name="__line6210"></a>	    if( ignore::it(xorig_var) ) continue;
<a name="__line6211"></a>	    const double xorig=xorig_var.dbl();
<a name="__line6212"></a>	    if( xaxis-&gt;logscale() &amp;&amp; xorig&lt;=0.0 ) continue;
<a name="__line6213"></a>	    if( g-&gt;xmin() != unset &amp;&amp; xorig&lt;g-&gt;xmin() ) continue;
<a name="__line6214"></a>	    if( g-&gt;xmax() != unset &amp;&amp; xorig&gt;g-&gt;xmax() ) continue;
<a name="__line6215"></a>	    if(xmin == unset || xorig&lt;xmin) xmin = xorig;
<a name="__line6216"></a>	    if(xmax == unset || xorig&gt;xmax) xmax = xorig;
<a name="__line6217"></a>
<a name="__line6218"></a>	    const var yorig_var=gety.eval(*g-&gt;get(i));
<a name="__line6219"></a>	    if ( ignore::it(yorig_var) ) continue;
<a name="__line6220"></a>	    const double yorig=yorig_var.dbl();
<a name="__line6221"></a>	    if( yaxis-&gt;logscale() &amp;&amp; yorig&lt;=0.0 ) continue;
<a name="__line6222"></a>	    if( g-&gt;ymin()!=unset &amp;&amp; yorig&lt;g-&gt;ymin()) continue;
<a name="__line6223"></a>	    if( g-&gt;ymax()!=unset &amp;&amp; yorig&gt;g-&gt;ymax()) continue;
<a name="__line6224"></a>	    if(ymin == unset || yorig &lt; ymin) ymin = yorig;
<a name="__line6225"></a>	    if(ymax == unset || yorig &gt; ymax) ymax = yorig;
<a name="__line6226"></a>
<a name="__line6227"></a>	}
<a name="__line6228"></a>
<a name="__line6229"></a>	if(xmin != unset) xmin -= dx_/2;
<a name="__line6230"></a>	if(xmax != unset) xmax += dx_/2;
<a name="__line6231"></a>	if(ymin != unset) ymin -= dy_/2;
<a name="__line6232"></a>	if(ymax != unset) ymax += dy_/2;
<a name="__line6233"></a>	if (g-&gt;xmin()==unset &amp;&amp; xmin!=unset) xaxis-&gt;extend_range(xmin);
<a name="__line6234"></a>	if (g-&gt;xmax()==unset &amp;&amp; xmax!=unset) xaxis-&gt;extend_range(xmax);
<a name="__line6235"></a>	if (g-&gt;ymin()==unset &amp;&amp; ymin!=unset) yaxis-&gt;extend_range(ymin);
<a name="__line6236"></a>	if (g-&gt;ymax()==unset &amp;&amp; ymax!=unset) yaxis-&gt;extend_range(ymax);	
<a name="__line6237"></a>    }
<a name="__line6238"></a>
<a name="__line6239"></a>    void vectors::draw(plottable *g, frame *f, terminal *t)
<a name="__line6240"></a>    {
<a name="__line6241"></a>	if(g-&gt;empty()) return;
<a name="__line6242"></a>
<a name="__line6243"></a>	bool call_noclip = false;
<a name="__line6244"></a>	if(clip_) call_noclip = t-&gt;clip(terminal::coord(terminal::id(0,1),terminal::id(0,2)),
<a name="__line6245"></a>					terminal::coord(terminal::id(1,1),terminal::id(1,2)));
<a name="__line6246"></a>
<a name="__line6247"></a>	axis *xaxis = (g-&gt;xaxis() == axis::x1 ? f-&gt;x1axis() : f-&gt;x2axis());
<a name="__line6248"></a>	axis *yaxis = (g-&gt;yaxis() == axis::y1 ? f-&gt;y1axis() : f-&gt;y2axis());
<a name="__line6249"></a>
<a name="__line6250"></a>	function getx=g-&gt;x_hint();
<a name="__line6251"></a>	if (!getx.initialized()) getx=ARG(1);
<a name="__line6252"></a>	function gety=g-&gt;y_hint();
<a name="__line6253"></a>	if (!gety.initialized()) gety=ARG(2);
<a name="__line6254"></a>	function getvx = ARG(3);
<a name="__line6255"></a>	function getvy = ARG(4);
<a name="__line6256"></a>
<a name="__line6257"></a>	int x1id = t-&gt;newlength();
<a name="__line6258"></a>	int y1id = t-&gt;newlength();
<a name="__line6259"></a>	int x2id = t-&gt;newlength();
<a name="__line6260"></a>	int y2id = t-&gt;newlength();
<a name="__line6261"></a>
<a name="__line6262"></a>	double xmin = unset, ymin = unset, xmax = unset, ymax = unset;
<a name="__line6263"></a>	if(xaxis-&gt;min_fixed()) xmin = xaxis-&gt;min();
<a name="__line6264"></a>	if(xaxis-&gt;max_fixed()) xmax = xaxis-&gt;max();
<a name="__line6265"></a>	if(yaxis-&gt;min_fixed()) ymin = yaxis-&gt;min();
<a name="__line6266"></a>	if(yaxis-&gt;max_fixed()) ymax = yaxis-&gt;max();
<a name="__line6267"></a>
<a name="__line6268"></a>	if(g-&gt;xmin() != unset)
<a name="__line6269"></a>	{
<a name="__line6270"></a>	    if(xmin == unset || g-&gt;xmin() &gt; xmin) xmin = g-&gt;xmin();
<a name="__line6271"></a>	}
<a name="__line6272"></a>	if(g-&gt;xmax() != unset)
<a name="__line6273"></a>	{
<a name="__line6274"></a>	    if(xmax == unset || g-&gt;xmax() &lt; xmax) xmax = g-&gt;xmax();
<a name="__line6275"></a>	}
<a name="__line6276"></a>	if(g-&gt;ymin() != unset)
<a name="__line6277"></a>	{
<a name="__line6278"></a>	    if(ymin == unset || g-&gt;ymin() &gt; ymin) ymin = g-&gt;ymin();
<a name="__line6279"></a>	}
<a name="__line6280"></a>	if(g-&gt;ymax() != unset)
<a name="__line6281"></a>	{
<a name="__line6282"></a>	    if(ymax == unset || g-&gt;ymax() &lt; ymax) ymax = g-&gt;ymax();
<a name="__line6283"></a>	}
<a name="__line6284"></a>
<a name="__line6285"></a>	t-&gt;set_color(g-&gt;linecolor());
<a name="__line6286"></a>	t-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line6287"></a>	t-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line6288"></a>
<a name="__line6289"></a>        int plotted = 0;
<a name="__line6290"></a>
<a name="__line6291"></a>	for(plottable::size_type i = 0; i&lt;g-&gt;size(); ++i)
<a name="__line6292"></a>	{
<a name="__line6293"></a>	    var x = getx.eval(*(g-&gt;get(i)));
<a name="__line6294"></a>	    var y = gety.eval(*(g-&gt;get(i)));
<a name="__line6295"></a>	    var vx = getvx.eval(*(g-&gt;get(i)));
<a name="__line6296"></a>	    var vy = getvy.eval(*(g-&gt;get(i)));
<a name="__line6297"></a>
<a name="__line6298"></a>	    if(ignore::it(x) || ignore::it(y) || ignore::it(vx) || ignore::it(vy)) continue;
<a name="__line6299"></a>	    if(xmin != unset &amp;&amp; x.dbl() &lt; xmin) continue;
<a name="__line6300"></a>	    if(xmax != unset &amp;&amp; x.dbl() &gt; xmax) continue;
<a name="__line6301"></a>	    if(ymin != unset &amp;&amp; y.dbl() &lt; ymin) continue;
<a name="__line6302"></a>	    if(ymax != unset &amp;&amp; y.dbl() &gt; ymax) continue;
<a name="__line6303"></a>
<a name="__line6304"></a>	    const double length = ::sqrt(vx.dbl()*vx.dbl() + vy.dbl()*vy.dbl());
<a name="__line6305"></a>	    if(min_length_cut_ != unset &amp;&amp; length&lt;min_length_cut_) continue;
<a name="__line6306"></a>            if(max_length_cut_ != unset &amp;&amp; length&gt;max_length_cut_) continue;
<a name="__line6307"></a>
<a name="__line6308"></a>	    double xx = xaxis-&gt;map_point(x.dbl());
<a name="__line6309"></a>	    double yy = yaxis-&gt;map_point(y.dbl());
<a name="__line6310"></a>
<a name="__line6311"></a>	    const double vxdbl = vx.dbl()/norm_;
<a name="__line6312"></a>	    const double vydbl = vy.dbl()/norm_;
<a name="__line6313"></a>
<a name="__line6314"></a>            if(!finite(vxdbl) || !finite(vydbl)) continue;
<a name="__line6315"></a>
<a name="__line6316"></a>	    if(use_color_)
<a name="__line6317"></a>	    {
<a name="__line6318"></a>		double minimum = color_min();
<a name="__line6319"></a>		double maximum = color_max();
<a name="__line6320"></a>		if(colorlegend_)
<a name="__line6321"></a>		{
<a name="__line6322"></a>		    minimum = colorlegend_-&gt;min();
<a name="__line6323"></a>		    maximum = colorlegend_-&gt;max();
<a name="__line6324"></a>		}
<a name="__line6325"></a>		const double colorkey = colorfunc_.eval(*(g-&gt;get(i)));
<a name="__line6326"></a>		t-&gt;set_color(color_mapping_-&gt;map(colorkey, minimum, maximum));
<a name="__line6327"></a>	    }
<a name="__line6328"></a>            else
<a name="__line6329"></a>            {
<a name="__line6330"></a>                t-&gt;set_color(g-&gt;linecolor());
<a name="__line6331"></a>            }
<a name="__line6332"></a>
<a name="__line6333"></a>	    if(pos_ == sym::center)
<a name="__line6334"></a>	    {
<a name="__line6335"></a>		t-&gt;overwrite(x1id, 1, terminal::id(xx,1), -0.5*vxdbl, xunit_.termspecific_id());
<a name="__line6336"></a>		t-&gt;overwrite(x2id, 1, terminal::id(xx,1),  0.5*vxdbl, xunit_.termspecific_id());
<a name="__line6337"></a>		t-&gt;overwrite(y1id, 1, terminal::id(yy,2), -0.5*vydbl, yunit_.termspecific_id());
<a name="__line6338"></a>		t-&gt;overwrite(y2id, 1, terminal::id(yy,2),  0.5*vydbl, yunit_.termspecific_id());
<a name="__line6339"></a>	    }
<a name="__line6340"></a>	    else if(pos_ == sym::begin)
<a name="__line6341"></a>	    {
<a name="__line6342"></a>		t-&gt;overwrite(x1id, 1, terminal::id(xx,1),  0*vxdbl, xunit_.termspecific_id());
<a name="__line6343"></a>		t-&gt;overwrite(x2id, 1, terminal::id(xx,1),  1*vxdbl, xunit_.termspecific_id());
<a name="__line6344"></a>		t-&gt;overwrite(y1id, 1, terminal::id(yy,2),  0*vydbl, yunit_.termspecific_id());
<a name="__line6345"></a>		t-&gt;overwrite(y2id, 1, terminal::id(yy,2),  1*vydbl, yunit_.termspecific_id());
<a name="__line6346"></a>	    }
<a name="__line6347"></a>	    else
<a name="__line6348"></a>	    {
<a name="__line6349"></a>		t-&gt;overwrite(x1id, 1, terminal::id(xx,1), -1*vxdbl, xunit_.termspecific_id());
<a name="__line6350"></a>		t-&gt;overwrite(x2id, 1, terminal::id(xx,1),  0*vxdbl, xunit_.termspecific_id());
<a name="__line6351"></a>		t-&gt;overwrite(y1id, 1, terminal::id(yy,2), -1*vydbl, yunit_.termspecific_id());
<a name="__line6352"></a>		t-&gt;overwrite(y2id, 1, terminal::id(yy,2),  0*vydbl, yunit_.termspecific_id());
<a name="__line6353"></a>	    }
<a name="__line6354"></a>
<a name="__line6355"></a>	    t-&gt;draw_line(terminal::coord(terminal::id(x1id),terminal::id(y1id)),
<a name="__line6356"></a>			 terminal::coord(terminal::id(x2id),terminal::id(y2id)));
<a name="__line6357"></a>
<a name="__line6358"></a>	    t-&gt;overwrite(x1id, -1, x1id, 1, x2id);
<a name="__line6359"></a>	    t-&gt;overwrite(y1id, -1, y1id, 1, y2id);
<a name="__line6360"></a>
<a name="__line6361"></a>	    if(scale_arrow_) t-&gt;scale(length/norm_);
<a name="__line6362"></a>	    t-&gt;rotate(x1id,y1id);
<a name="__line6363"></a>	    t-&gt;translate(terminal::id(x2id),terminal::id(y2id));
<a name="__line6364"></a>	    arrow_-&gt;print(t);
<a name="__line6365"></a>	    t-&gt;reset_transformation();
<a name="__line6366"></a>            ++plotted;
<a name="__line6367"></a>	}
<a name="__line6368"></a>	if(call_noclip) t-&gt;noclip();
<a name="__line6369"></a>
<a name="__line6370"></a>        if(plotted == 0) warning::print("No vector could be plotted (graph empty or all vectors have 0 length)","vectors::draw(...)");
<a name="__line6371"></a>    }
<a name="__line6372"></a>
<a name="__line6373"></a>
<a name="__line6374"></a>
<a name="__line6375"></a>    void vectors::draw_sample(const length &amp;x, const length &amp;y, const length &amp;size,
<a name="__line6376"></a>			      const plottable *g, terminal *t)
<a name="__line6377"></a>    {
<a name="__line6378"></a>	t-&gt;set_linewidth(g-&gt;linewidth().termspecific_id());
<a name="__line6379"></a>	t-&gt;set_color(g-&gt;linecolor());
<a name="__line6380"></a>	t-&gt;set_linestyle(g-&gt;linestyle());
<a name="__line6381"></a>	length l1 = !x - 0.5*!size;
<a name="__line6382"></a>	length l2 = !x + 0.5*!size;
<a name="__line6383"></a>	l1.specialize(t);
<a name="__line6384"></a>	l2.specialize(t);
<a name="__line6385"></a>	t-&gt;draw_line(terminal::coord(l1.termspecific_id(), y.termspecific_id()),
<a name="__line6386"></a>		     terminal::coord(l2.termspecific_id(), y.termspecific_id()));
<a name="__line6387"></a>
<a name="__line6388"></a>	t-&gt;translate(l2.termspecific_id(),y.termspecific_id());
<a name="__line6389"></a>	arrow_-&gt;print(t);
<a name="__line6390"></a>	t-&gt;reset_transformation();
<a name="__line6391"></a>    }
<a name="__line6392"></a>
<a name="__line6393"></a>
<a name="__line6394"></a>
<a name="__line6395"></a>}
<a name="__line6396"></a>
<a name="__line6397"></a>

</pre>
<hr> 
<a href="../index.html" title="Home"> 
<img src="../home.png"  style="border-width:0cm;"> 
</a>
<a href="source.html" title="List of sourcefiles"> 
<img src="../up.png"    style="border-width:0cm;"> 
</a>

</body></html>
